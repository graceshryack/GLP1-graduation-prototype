<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#1a1f2e" />
  <title>Signos · GLP-1 Graduation</title>
  <style>
    :root {
      --bg: #e8eaed;
      --surface: #fff;
      --text: #1e293b;
      --text-muted: #64748b;
      --accent: #1e3a5f;
      --phase-accent: #7c3aed;
      --phase-accent-light: #ede9fe;
      --phase-accent-bg: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
      --nav-bg: #1a1f2e;
      --nav-text: #e2e8f0;
      --nav-active: #fff;
      --tir: #ea580c;
      --spd: #dc2626;
      --lst: #16a34a;
      --purple: #7c3aed;
      --pink: #db2777;
      --nav-height: 88px;
      --signos-blue: #2563eb;
      --signos-blue-light: #93c5fd;
      --signos-gold: #eab308;
      --signos-gold-light: #fde047;
      --signos-pink: #ec4899;
      --signos-pink-light: #f9a8d4;
    }
    /* Single program color — purple throughout */
    * { box-sizing: border-box; }
    html, body { height: 100%; width: 100%; margin: 0; padding: 0; min-height: 100vh; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; color: var(--text); background: var(--bg); -webkit-font-smoothing: antialiased; }
    body { max-width: 480px; margin: 0 auto; box-shadow: 0 0 0 1px rgba(0,0,0,0.04); }
    #app { height: 100%; min-height: 100vh; }
    .screen { display: none; min-height: 100%; padding-bottom: calc(var(--nav-height) + 24px); }
    .screen.active { display: block; }
    .page-header { padding: 44px 16px 14px; background: var(--surface); border-bottom: 2px solid var(--phase-accent); display: flex; align-items: center; justify-content: space-between; min-height: 56px; }
    .header-title { font-size: 1.0625rem; font-weight: 600; color: var(--text); }
    .header-btn { width: 36px; height: 36px; border-radius: 50%; background: #f1f5f9; border: none; display: flex; align-items: center; justify-content: center; color: var(--text-muted); cursor: pointer; font-size: 1.1rem; }
    .card { background: var(--surface); border-radius: 16px; padding: 18px; margin: 12px 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border: 1px solid rgba(0,0,0,0.06); }
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 20px; border-radius: 12px; font-weight: 600; cursor: pointer; border: none; font-size: 1rem; }
    .btn-primary { background: var(--phase-accent); color: #fff; width: 100%; }
    .btn-outline { background: var(--surface); color: var(--phase-accent); border: 2px solid var(--phase-accent); }
    .btn-outline .plus-circle { width: 24px; height: 24px; border-radius: 50%; background: var(--phase-accent-light); color: var(--phase-accent); display: flex; align-items: center; justify-content: center; font-size: 18px; }
    .btn-start { background: var(--pink); color: #fff; }
    .bottom-nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 480px; min-height: var(--nav-height); display: flex; align-items: center; justify-content: space-around; background: var(--nav-bg); padding-top: 8px; padding-bottom: calc(10px + env(safe-area-inset-bottom, 0)); z-index: 100; }
    .nav-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 10px 12px; color: var(--nav-text); font-size: 10px; background: none; border: none; cursor: pointer; font: inherit; min-height: 100%; }
    .nav-btn.active { color: var(--nav-active); font-weight: 600; }
    .nav-btn .icon-wrap { width: 28px; height: 28px; margin-bottom: 2px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
    .nav-btn .big { width: 44px; height: 44px; border-radius: 50%; background: var(--phase-accent); color: #fff; display: flex; align-items: center; justify-content: center; font-size: 22px; margin-bottom: 2px; }
    .phase-opt { display: block; width: 100%; text-align: left; padding: 14px 16px; margin-bottom: 10px; border: 2px solid #e2e8f0; border-radius: 12px; background: var(--surface); font-size: 0.95rem; cursor: pointer; }
    .phase-opt.selected { border-color: var(--phase-accent); background: var(--phase-accent-light); }
    .phase-opt strong { display: block; }
    .phase-opt span { color: var(--text-muted); font-size: 0.85rem; }
    .phase-table h4 { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.04em; color: var(--text-muted); margin: 14px 0 4px; }
    .phase-table p { margin: 0 0 6px; font-size: 0.875rem; line-height: 1.45; }
    .onboarding h1 { text-align: center; font-size: 1.75rem; margin: 0 0 8px; }
    .onboarding p { text-align: center; color: var(--text-muted); margin: 0 0 24px; font-size: 0.95rem; }
    .glucose-section { padding: 16px 16px 12px; }
    .glucose-label { font-size: 0.8125rem; color: var(--text-muted); margin: 0 0 4px; }
    .glucose-value { font-size: 2.25rem; font-weight: 700; color: var(--text); letter-spacing: -0.02em; }
    .glucose-unit { font-size: 0.9375rem; color: var(--text-muted); font-weight: 400; margin-left: 4px; }
    .metrics-row { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 14px; align-items: center; }
    .metric-pill { display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px; border-radius: 10px; font-size: 12px; font-weight: 500; }
    .metric-pill.tir { background: #fff7ed; color: var(--tir); }
    .metric-pill.spd { background: #fef2f2; color: var(--spd); }
    .metric-pill.lst { background: #f0fdf4; color: var(--lst); }
    .metric-pill .info-dot { width: 14px; height: 14px; border-radius: 50%; background: rgba(0,0,0,0.08); font-size: 10px; display: inline-flex; align-items: center; justify-content: center; }
    .today-card .card-head { display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px; }
    .today-card .card-head h3 { margin: 0; font-size: 1.125rem; font-weight: 700; }
    .today-card .completed { font-size: 0.8125rem; color: var(--text-muted); }
    .focus-line { font-size: 0.875rem; color: var(--text-muted); margin: 0 0 8px; }
    .pinned { display: inline-flex; align-items: center; gap: 4px; font-size: 0.6875rem; font-weight: 600; color: var(--purple); letter-spacing: 0.04em; margin-bottom: 12px; }
    .habit-item { display: flex; align-items: center; gap: 12px; padding: 12px 0; border-bottom: 1px solid #f1f5f9; }
    .habit-item:last-of-type { border-bottom: none; }
    .habit-icon { font-size: 1.25rem; flex-shrink: 0; }
    .habit-label { flex: 1; font-size: 0.9375rem; }
    .habit-progress { width: 48px; height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden; }
    .habit-progress .fill { height: 100%; background: var(--phase-accent); border-radius: 3px; width: 50%; }
    .habit-frac { font-size: 0.8125rem; color: var(--text-muted); }
    .habit-more { width: 24px; height: 24px; border: none; background: none; color: var(--text-muted); font-size: 18px; cursor: pointer; padding: 0; line-height: 1; }
    .habits-refresh { font-size: 0.75rem; color: var(--text-muted); margin: 12px 0 10px; }
    .see-all { background: none; border: none; color: var(--phase-accent); font-size: 0.9375rem; font-weight: 500; cursor: pointer; padding: 0; }
    .phase-pill { text-align: center; font-size: 0.75rem; color: var(--text-muted); margin: 16px; }
    .section-title { font-size: 1.0625rem; font-weight: 700; color: var(--text); margin: 16px 16px 10px; }
    .dailies-icon { width: 56px; height: 56px; margin: 0 auto 12px; border-radius: 14px; background: var(--phase-accent-light); color: var(--phase-accent); font-size: 1.75rem; display: flex; align-items: center; justify-content: center; }
    .dailies-msg { text-align: center; color: var(--text-muted); font-size: 0.9375rem; margin: 0 0 16px; }
    .segment-bar { display: flex; background: var(--nav-bg); border-radius: 12px; padding: 6px; margin: 12px 16px; }
    .segment { flex: 1; padding: 12px 10px; text-align: center; font-size: 0.875rem; font-weight: 500; color: var(--nav-text); background: none; border: none; border-radius: 8px; cursor: pointer; }
    .segment.active { background: rgba(255,255,255,0.22); color: #fff; }
    .insights-date { text-align: center; font-size: 0.875rem; color: var(--text-muted); margin: 8px 0 16px; }
    .metric-card { background: var(--surface); border-radius: 16px; padding: 16px; margin: 12px 16px; box-shadow: 0 1px 4px rgba(0,0,0,0.06); }
    .metric-card .m-title { font-size: 0.875rem; font-weight: 600; color: var(--text); margin: 0 0 6px; display: flex; align-items: center; gap: 6px; }
    .metric-card .m-value { font-size: 1.5rem; font-weight: 700; color: var(--text); }
    .metric-card .m-goal { font-size: 0.8125rem; color: var(--text-muted); margin-top: 6px; }
    input[type="text"] { width: 100%; padding: 12px 16px; border: 1px solid #e2e8f0; border-radius: 12px; font-size: 1rem; margin-bottom: 16px; }
    .glucose-graph-card { padding: 12px 16px 16px; overflow: hidden; }
    .glucose-graph-wrap { position: relative; width: 100%; height: 0; padding-bottom: 52%; }
    .glucose-graph-wrap svg { position: absolute; left: 0; top: 0; width: 100%; height: 100%; }
    .graph-axis-y { font-size: 10px; fill: var(--text-muted); }
    .graph-axis-x { font-size: 10px; fill: var(--text-muted); }
    .graph-ref-line { stroke: #cbd5e1; stroke-width: 1; stroke-dasharray: 4 3; }
    .graph-lst-line { stroke: #94a3b8; stroke-width: 1; }
    .graph-current-dot { fill: var(--purple); stroke: var(--purple); stroke-width: 2; }
    .graph-current-dot-outer { fill: none; stroke: var(--purple); stroke-width: 1.5; opacity: 0.6; }
    .graph-current-dot-outer2 { fill: none; stroke: var(--purple); stroke-width: 1; opacity: 0.35; }
    .graph-peak-label { font-size: 9px; font-weight: 600; fill: var(--text); }
    .graph-hline { stroke: #e2e8f0; stroke-width: 1; }
    .graph-timeline { margin-top: 10px; padding-top: 10px; border-top: 1px solid #f1f5f9; }
    .graph-timeline-row { display: flex; align-items: center; gap: 6px; overflow-x: auto; padding-bottom: 6px; width: 100%; }
    .graph-timeline-arrow { width: 24px; height: 24px; border: none; background: none; color: #94a3b8; font-size: 14px; cursor: pointer; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
    .graph-timeline-icons { display: flex; align-items: center; gap: 6px; flex-shrink: 0; }
.graph-timeline-spacer { flex: 1; min-width: 8px; }
    .graph-timeline-icon { width: 32px; height: 32px; border-radius: 50%; background: #fff; border: 1px solid #e2e8f0; color: var(--text); display: flex; align-items: center; justify-content: center; font-size: 14px; box-shadow: 0 1px 2px rgba(0,0,0,0.06); }
    .graph-timeline-icon.meal { font-size: 12px; }
    .graph-timeline-icon.unknown { background: #fef3c7; border-color: #fde047; color: #b45309; }
    .graph-timeline-meal-badge { font-size: 10px; font-weight: 600; color: var(--text-muted); margin-left: -2px; }
    .graph-updated-wrap { text-align: center; margin-top: 4px; }
    .graph-updated { font-size: 0.6875rem; color: var(--text-muted); }
    .graph-timeline-right { display: flex; align-items: center; justify-content: space-between; margin-top: 4px; }
    .graph-add-btn { width: 44px; height: 44px; border-radius: 50%; background: var(--nav-bg); color: #fff; border: none; display: flex; align-items: center; justify-content: center; font-size: 22px; cursor: pointer; flex-shrink: 0; }
    .banner { background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 12px; padding: 14px 16px; margin: 12px 16px; }
    .banner.tapering { background: #fff7ed; border-color: #fed7aa; }
    .banner.off { background: #f0fdf4; border-color: #bbf7d0; }
    .banner h4 { margin: 0 0 6px; font-size: 0.9375rem; font-weight: 600; color: var(--text); }
    .banner p { margin: 0; font-size: 0.875rem; color: var(--text-muted); line-height: 1.45; }
    .focus-card { margin: 12px 16px; }
    .focus-card h3 { font-size: 1rem; margin: 0 0 10px; font-weight: 700; }
    .focus-card ul { margin: 0; padding-left: 20px; font-size: 0.875rem; color: var(--text-muted); line-height: 1.6; }
    .program-metric { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f1f5f9; }
    .program-metric:last-child { border-bottom: none; }
    .program-metric .label { font-size: 0.875rem; color: var(--text-muted); }
    .program-metric .value { font-size: 0.9375rem; font-weight: 600; }
    .readiness-bar { height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; margin-top: 6px; }
    .readiness-bar .fill { height: 100%; background: var(--phase-accent); border-radius: 4px; transition: width 0.2s; }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 200; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .modal { background: var(--surface); border-radius: 16px; padding: 20px; max-width: 360px; width: 100%; box-shadow: 0 8px 32px rgba(0,0,0,0.15); }
    .modal h3 { margin: 0 0 10px; font-size: 1.125rem; }
    .modal p { margin: 0 0 16px; font-size: 0.875rem; color: var(--text-muted); line-height: 1.5; }
    .modal-actions { display: flex; gap: 10px; justify-content: flex-end; }
    .dose-event { padding: 10px 12px; background: #f8fafc; border-radius: 10px; margin-bottom: 8px; font-size: 0.875rem; }
    .dose-event .type { font-weight: 600; color: var(--text); }
    .dose-event .date { color: var(--text-muted); font-size: 0.8125rem; }
    .sub-section { margin-top: 20px; padding-top: 16px; border-top: 1px solid #e2e8f0; }
    .banner-actions { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
    .banner-actions .link { background: none; border: none; color: var(--phase-accent); font-size: 0.875rem; font-weight: 500; cursor: pointer; padding: 0; }
    .widget { margin: 12px 16px; }
    .metrics-strip { display: flex; gap: 10px; flex-wrap: wrap; margin: 12px 16px; }
    .metrics-strip .score-pill { background: var(--surface); border-radius: 12px; padding: 12px 16px; flex: 1; min-width: 100px; box-shadow: 0 1px 4px rgba(0,0,0,0.06); }
    .metrics-strip .score-pill .score-value { font-size: 1.5rem; font-weight: 700; }
    .metrics-strip .score-pill .score-label { font-size: 0.75rem; color: var(--text-muted); }
    .quick-action { display: flex; align-items: center; gap: 10px; padding: 12px 0; border-bottom: 1px solid #f1f5f9; }
    .quick-action:last-child { border-bottom: none; }
    .game-progress { padding: 14px; background: #f8fafc; border-radius: 12px; margin-top: 10px; }
    .game-progress .game-title { font-weight: 600; font-size: 0.9375rem; margin-bottom: 6px; }
    .game-progress .game-desc { font-size: 0.8125rem; color: var(--text-muted); margin-bottom: 8px; }
    .game-progress .game-steps { font-size: 0.8125rem; }
    .insight-card { margin-bottom: 12px; }
    .insight-card .insight-cta { margin-top: 8px; font-size: 0.875rem; color: var(--phase-accent); font-weight: 500; cursor: pointer; background: none; border: none; padding: 0; }
    .hunger-row { display: flex; align-items: center; gap: 12px; margin: 8px 0; }
    .hunger-row label { font-size: 0.875rem; min-width: 100px; }
    .hunger-row input[type="range"] { flex: 1; }
    .hunger-value { font-size: 0.875rem; font-weight: 600; min-width: 24px; text-align: right; }
    .log-item-done { opacity: 0.85; border-left: 3px solid var(--lst); }
    .hunger-correlate { display: flex; align-items: flex-start; gap: 10px; padding: 10px 0; border-bottom: 1px solid #f1f5f9; font-size: 0.875rem; }
    .hunger-correlate:last-child { border-bottom: none; }
    .hunger-correlate .correlate-icon { font-size: 1rem; flex-shrink: 0; }
    .hunger-correlate .correlate-text { flex: 1; }
    .hunger-correlate .correlate-label { font-weight: 600; color: var(--text); }
    .hunger-reminder-card { border-left: 4px solid var(--pink); }
    .gpa-card { display: flex; align-items: center; gap: 16px; padding: 16px; margin: 12px 16px; background: var(--surface); border-radius: 16px; box-shadow: 0 1px 4px rgba(0,0,0,0.06); }
    .gpa-circle { width: 72px; height: 72px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 1.75rem; font-weight: 700; color: #fff; }
    .gpa-circle.a { background: linear-gradient(135deg, #16a34a, #15803d); }
    .gpa-circle.b { background: linear-gradient(135deg, #2563eb, #1d4ed8); }
    .gpa-circle.c { background: linear-gradient(135deg, #eab308, #ca8a04); }
    .gpa-circle.d { background: linear-gradient(135deg, #ea580c, #c2410c); }
    .gpa-circle.f { background: linear-gradient(135deg, #dc2626, #b91c1c); }
    .gpa-details { flex: 1; min-width: 0; }
    .gpa-details .gpa-label { font-size: 0.875rem; font-weight: 600; margin-bottom: 4px; }
    .gpa-details .gpa-breakdown { font-size: 0.8125rem; color: var(--text-muted); line-height: 1.5; }
    .readiness-plan-card { margin: 12px 16px; }
    .readiness-plan-card .plan-list { margin: 0; padding-left: 20px; font-size: 0.875rem; color: var(--text-muted); line-height: 1.7; }
    .consistency-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; font-size: 0.875rem; border-bottom: 1px solid #f1f5f9; }
    .consistency-row:last-child { border-bottom: none; }
    .log-grid { margin: 12px 16px; }
    .log-item { display: flex; align-items: center; gap: 14px; padding: 16px; background: var(--surface); border-radius: 16px; margin-bottom: 10px; box-shadow: 0 1px 4px rgba(0,0,0,0.06); border: none; width: 100%; text-align: left; cursor: pointer; font: inherit; }
    .log-item .log-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; flex-shrink: 0; }
    .log-item .log-icon.exercise { background: var(--phase-accent-light); color: var(--phase-accent); }
    .log-item .log-icon.sleep { background: #e0e7ff; color: #4f46e5; }
    .log-item .log-icon.food { background: #fef3c7; color: #b45309; }
    .log-item .log-icon.water { background: #cffafe; color: #0891b2; }
    .log-item .log-icon.weight { background: #e2e8f0; color: var(--text-muted); }
    .log-item .log-icon.hunger { background: #fce7f3; color: #be185d; }
    .log-item .log-icon.bodyscan { background: #d1fae5; color: #059669; }
    .log-item-done { opacity: 0.7; }
    .log-item-done .log-label::after { content: ' \u2713'; color: #16a34a; }
    .body-scan-preview { width: 100%; aspect-ratio: 3/4; background: #000; border-radius: 16px; overflow: hidden; position: relative; display: flex; align-items: center; justify-content: center; margin-bottom: 16px; }
    .body-scan-preview video { width: 100%; height: 100%; object-fit: cover; }
    .body-scan-overlay { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; pointer-events: none; }
    .body-scan-silhouette { width: 120px; height: 240px; border: 2px dashed rgba(255,255,255,0.5); border-radius: 60px; }
    .body-scan-hint { color: rgba(255,255,255,0.8); font-size: 0.8125rem; margin-top: 12px; }
    .scan-results-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 16px 0; }
    .scan-result-card { background: var(--surface); border-radius: 14px; padding: 16px; text-align: center; box-shadow: 0 1px 4px rgba(0,0,0,0.06); }
    .scan-result-value { font-size: 1.75rem; font-weight: 700; color: var(--phase-accent); }
    .scan-result-label { font-size: 0.8125rem; color: var(--text-muted); margin-top: 4px; }
    .scan-result-card.lifestyle { grid-column: 1 / -1; background: linear-gradient(135deg, #eff6ff, #f0fdf4); }
    .scan-result-card.lifestyle .scan-result-value { background: linear-gradient(135deg, #2563eb, #059669); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 2rem; }
    .log-item .log-label { font-weight: 600; font-size: 1rem; margin-bottom: 2px; }
    .log-item .log-hint { font-size: 0.8125rem; color: var(--text-muted); }
    .toolkit-header { padding: 16px 16px 8px; }
    .toolkit-header h1 { font-size: 1.25rem; margin: 0 0 4px; }
    .toolkit-header p { font-size: 0.875rem; color: var(--text-muted); margin: 0; }
    .toolkit-header .subtitle-text { display: none; }
    .gpa-gauge-wrap { padding: 20px 16px 12px; }
    .gpa-gauge-title { font-size: 0.875rem; color: var(--text-muted); margin: 0 0 8px; }
    .gpa-gauge-svg { width: 100%; height: 100px; display: block; }
    .gpa-gauge-score { text-align: center; font-size: 2.5rem; font-weight: 700; margin: -8px 0 8px; }
    .gpa-gauge-score .gpa-out-of { font-size: 0.45em; font-weight: 500; color: var(--text-muted); }
    .gpa-gauge-scale { display: flex; justify-content: space-between; padding: 0 20%; font-size: 0.75rem; color: var(--text-muted); }
    .gpa-metric-row { padding: 12px 16px; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; gap: 12px; cursor: pointer; }
    .gpa-metric-row:last-of-type { border-bottom: none; }
    .gpa-metric-row .metric-info { flex: 1; min-width: 0; }
    .gpa-metric-row .metric-title { font-size: 0.8125rem; color: var(--text-muted); margin-bottom: 2px; }
    .gpa-metric-row .metric-value { font-size: 1rem; font-weight: 700; }
    .gpa-metric-row .metric-slider-wrap { flex: 1 1 120px; min-width: 100px; max-width: 160px; height: 6px; border-radius: 3px; background: linear-gradient(90deg, #dc2626, #7c3aed, #2563eb, #eab308); position: relative; }
    .gpa-metric-row .metric-slider-thumb { position: absolute; width: 16px; height: 16px; border-radius: 50%; background: #fff; border: 2px solid var(--phase-accent); top: 50%; transform: translate(-50%, -50%); box-sizing: border-box; }
    .gpa-metric-row .metric-chevron { color: #94a3b8; font-size: 0.875rem; }
    .gpa-section-card { margin: 12px 16px 12px; background: var(--surface); border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border: 1px solid rgba(0,0,0,0.06); overflow: hidden; }
    .gpa-section-card .gpa-section-title { padding: 12px 16px 8px; font-size: 0.875rem; color: var(--text-muted); }
    .gpa-section-card[data-gpa-type] { cursor: pointer; transition: transform 0.1s; }
    .gpa-section-card[data-gpa-type]:active { transform: scale(0.98); }
    .gpa-modal-overlay { position: fixed; inset: 0; z-index: 1000; background: rgba(0,0,0,0.45); display: flex; align-items: flex-end; justify-content: center; animation: gpaFadeIn 0.2s ease; }
    .gpa-modal { background: var(--surface); border-radius: 20px 20px 0 0; width: 100%; max-height: 85vh; overflow-y: auto; padding: 0 0 env(safe-area-inset-bottom, 20px); animation: gpaSlideUp 0.25s ease; }
    @keyframes gpaFadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes gpaSlideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .gpa-modal-handle { width: 36px; height: 4px; border-radius: 2px; background: #cbd5e1; margin: 10px auto 0; }
    .gpa-modal-header { padding: 16px 20px 12px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #f1f5f9; }
    .gpa-modal-header h2 { font-size: 1.125rem; font-weight: 700; margin: 0; }
    .gpa-modal-close { width: 32px; height: 32px; border-radius: 50%; background: #f1f5f9; border: none; font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text-muted); }
    .gpa-modal-score-hero { text-align: center; padding: 20px 20px 16px; }
    .gpa-modal-score-hero .hero-score { font-size: 3rem; font-weight: 800; background: linear-gradient(135deg, #7c3aed, #2563eb); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .gpa-modal-score-hero .hero-label { font-size: 0.8125rem; color: var(--text-muted); margin-top: 2px; }
    .gpa-modal-section { padding: 16px 20px; border-top: 1px solid #f1f5f9; }
    .gpa-modal-section h3 { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--phase-accent); font-weight: 700; margin: 0 0 10px; }
    .gpa-modal-component { padding: 12px 0; border-bottom: 1px solid #f1f5f9; cursor: pointer; transition: background 0.15s; }
    .gpa-modal-component:last-child { border-bottom: none; }
    .gpa-modal-component:active { background: #f8fafc; }
    .gpa-modal-component .comp-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
    .gpa-modal-component .comp-name { font-size: 0.9375rem; font-weight: 600; flex: 1; }
    .gpa-modal-component .comp-value { font-size: 0.9375rem; font-weight: 700; color: var(--phase-accent); margin-right: 8px; }
    .gpa-modal-component .comp-chevron { color: #94a3b8; font-size: 1.1rem; flex-shrink: 0; }
    .gpa-modal-component .comp-desc { font-size: 0.8125rem; color: var(--text-muted); line-height: 1.4; }
    .gpa-modal-detail { animation: gpaSlideLeft 0.2s ease; }
    @keyframes gpaSlideLeft { from { transform: translateX(30px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    .gpa-modal-detail-back { display: flex; align-items: center; gap: 6px; padding: 0; border: none; background: none; color: var(--phase-accent); font-size: 0.875rem; font-weight: 600; cursor: pointer; font-family: inherit; margin-bottom: 12px; }
    .gpa-modal-detail-back:active { opacity: 0.7; }
    .comp-detail-hero { display: flex; align-items: center; justify-content: space-between; padding: 16px; background: linear-gradient(135deg, #eff6ff, #f0fdf4); border-radius: 14px; margin-bottom: 16px; }
    .comp-detail-hero .cdh-left .cdh-name { font-size: 1.0625rem; font-weight: 700; margin-bottom: 4px; }
    .comp-detail-hero .cdh-left .cdh-value { font-size: 1.5rem; font-weight: 800; color: var(--phase-accent); }
    .comp-detail-hero .cdh-ideal { font-size: 0.75rem; color: var(--text-muted); text-align: right; }
    .comp-detail-hero .cdh-ideal strong { display: block; font-size: 0.875rem; color: var(--text); }
    .comp-detail-desc { font-size: 0.9375rem; color: var(--text); line-height: 1.55; margin-bottom: 16px; }
    .comp-detail-tips { list-style: none; margin: 0; padding: 0; }
    .comp-detail-tips li { padding: 10px 0; border-bottom: 1px solid #f1f5f9; font-size: 0.875rem; color: var(--text); line-height: 1.5; display: flex; gap: 10px; align-items: flex-start; }
    .comp-detail-tips li:last-child { border-bottom: none; }
    .comp-detail-tips .tip-num { width: 24px; height: 24px; border-radius: 50%; background: var(--phase-accent); color: #fff; font-size: 0.75rem; font-weight: 700; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 1px; }
    .comp-detail-tips .tip-content { flex: 1; }
    .gpa-modal-week-row { display: flex; justify-content: space-between; align-items: flex-end; gap: 4px; padding: 8px 0; }
    .gpa-modal-week-day { display: flex; flex-direction: column; align-items: center; flex: 1; }
    .gpa-modal-week-day .day-bar { width: 100%; max-width: 28px; border-radius: 4px 4px 0 0; background: linear-gradient(180deg, #7c3aed, #2563eb); min-height: 4px; }
    .gpa-modal-week-day .day-label { font-size: 0.625rem; color: var(--text-muted); margin-top: 4px; }
    .gpa-modal-week-day .day-score { font-size: 0.6875rem; font-weight: 600; margin-bottom: 4px; }
    .gpa-modal-best-worst { display: flex; gap: 12px; }
    .gpa-modal-best-worst .bw-card { flex: 1; border-radius: 12px; padding: 12px; text-align: center; }
    .gpa-modal-best-worst .bw-card.best { background: #f0fdf4; border: 1px solid #bbf7d0; }
    .gpa-modal-best-worst .bw-card.worst { background: #fef2f2; border: 1px solid #fecaca; }
    .gpa-modal-best-worst .bw-value { font-size: 1.5rem; font-weight: 700; }
    .gpa-modal-best-worst .bw-card.best .bw-value { color: #16a34a; }
    .gpa-modal-best-worst .bw-card.worst .bw-value { color: #dc2626; }
    .gpa-modal-best-worst .bw-label { font-size: 0.75rem; color: var(--text-muted); margin-top: 2px; }
    .gpa-modal-tip { display: flex; gap: 10px; align-items: flex-start; padding: 10px 0; border-bottom: 1px solid #f8fafc; }
    .gpa-modal-tip:last-child { border-bottom: none; }
    .gpa-modal-tip .tip-icon { font-size: 1.25rem; flex-shrink: 0; margin-top: 1px; }
    .gpa-modal-tip .tip-text { font-size: 0.875rem; color: var(--text); line-height: 1.45; }
    .edit-factors { display: flex; align-items: center; justify-content: center; gap: 6px; padding: 12px 16px; color: var(--phase-accent); font-size: 0.875rem; font-weight: 500; border-top: 1px solid #f1f5f9; cursor: pointer; width: 100%; border: none; background: transparent; font-family: inherit; }
    .edit-factors .edit-factors-icon { opacity: 0.85; font-size: 0.875rem; }
    .toolkit-edu { font-size: 0.875rem; color: var(--text-muted); line-height: 1.5; margin: 12px 16px; padding: 14px; background: #f8fafc; border-radius: 12px; }
    .toolkit-edu h4 { font-size: 0.9375rem; color: var(--text); margin: 0 0 8px; }
    .toolkit-edu-goal { background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border: 1px solid #bfdbfe; border-radius: 14px; padding: 20px 20px; margin-bottom: 16px; }
    .toolkit-edu-goal .goal-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.06em; color: var(--phase-accent); font-weight: 700; margin-bottom: 6px; }
    .toolkit-edu-goal .goal-text { font-size: 1.125rem; font-weight: 700; color: var(--text); margin: 0; line-height: 1.4; }
    .toolkit-edu-goal .goal-normalize { font-size: 0.9375rem !important; color: var(--text) !important; font-weight: 500 !important; line-height: 1.5; margin-top: 10px !important; }
    .toolkit-edu-goal .goal-section { margin-top: 14px; padding-top: 14px; border-top: 1px solid rgba(37,99,235,0.15); }
    .toolkit-edu-goal .goal-section-title { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--phase-accent); font-weight: 700; margin: 0 0 6px; }
    .toolkit-edu-goal .goal-section-text { font-size: 0.875rem; color: var(--text); margin: 0; line-height: 1.5; }
    .toolkit-edu-goal .goal-bullets { margin: 6px 0 0; padding-left: 18px; font-size: 0.875rem; color: var(--text); line-height: 1.6; }
    .toolkit-edu-goal .goal-bullets li { margin-bottom: 2px; }
    .toolkit-edu-section { margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid #f1f5f9; }
    .toolkit-edu-section:last-child { margin-bottom: 0; padding-bottom: 0; border-bottom: none; }
    .toolkit-edu-section h4 { font-size: 0.875rem; font-weight: 600; color: var(--text); margin: 0 0 8px; }
    .toolkit-edu-section ul { margin: 0; padding-left: 20px; font-size: 0.8125rem; color: var(--text-muted); line-height: 1.6; }
    .toolkit-edu-section p { margin: 0; font-size: 0.8125rem; color: var(--text-muted); line-height: 1.5; }
    .home-gpa-strip-wrap { margin: 12px 16px; background: var(--surface); border-radius: 16px; padding: 12px 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border: 1px solid rgba(0,0,0,0.06); }
    .home-gpa-strip { display: flex; gap: 10px; cursor: pointer; transition: opacity 0.15s ease; }
    .home-gpa-strip:active { opacity: 0.9; }
    .home-gpa-pill { flex: 1; min-width: 0; background: #f8fafc; border-radius: 12px; padding: 12px; text-align: center; transition: background 0.15s ease; }
    .home-gpa-strip:active .home-gpa-pill { background: #f1f5f9; }
    .home-gpa-pill .home-gpa-value { font-size: 1.5rem; font-weight: 700; color: var(--phase-accent); line-height: 1.2; }
    .home-gpa-pill .home-gpa-label { font-size: 0.6875rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.03em; margin-top: 4px; }
    .home-gpa-strip-hint { display: flex; align-items: center; justify-content: center; gap: 4px; margin-top: 10px; font-size: 0.75rem; color: var(--text-muted); }
    .home-gpa-strip-hint .hint-chevron { font-size: 0.625rem; }
    .readiness-components { padding: 12px 0 8px; border-top: 1px solid #f1f5f9; }
    .readiness-components .m-title { margin: 0 0 4px; padding: 0 16px; }
    .readiness-component-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 16px; font-size: 0.875rem; border-top: 1px solid #f1f5f9; }
    .readiness-component-row:first-of-type { border-top: none; }
    .readiness-component-row span:last-child { font-weight: 600; color: var(--text); }
    .readiness-toolkit-note { margin: 0 16px 12px; padding: 0; font-size: 0.75rem; color: var(--text-muted); }
    .toolkit-module-list { display: flex; flex-direction: column; gap: 8px; }
    .toolkit-module-btn { display: flex; align-items: center; justify-content: space-between; width: 100%; padding: 14px 16px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; font-size: 0.9375rem; font-weight: 500; color: var(--text); text-align: left; cursor: pointer; font-family: inherit; }
    .toolkit-module-btn .toolkit-module-chevron { color: var(--text-muted); font-size: 1rem; }
    .edu-section-title { font-size: 1.25rem; font-weight: 800; color: var(--text); margin: 0 0 8px; letter-spacing: -0.02em; }
    .edu-section-subtitle { font-size: 1rem; color: var(--text-muted); margin: 0 0 14px; line-height: 1.5; max-width: 36em; }
    .edu-phase-tabs { display: flex; gap: 8px; margin-bottom: 16px; }
    .edu-phase-tab { padding: 10px 16px; border-radius: 12px; border: 2px solid #e2e8f0; background: var(--surface); font-size: 0.875rem; font-weight: 500; color: var(--text-muted); cursor: pointer; font-family: inherit; }
    .edu-phase-tab.selected { border-color: var(--signos-blue); background: #eff6ff; color: var(--signos-blue); }
    .edu-module-list { display: flex; flex-direction: column; gap: 14px; }
    .edu-module-card { background: var(--surface); border-radius: 18px; padding: 20px; box-shadow: 0 4px 16px rgba(0,0,0,0.06); border: 1px solid rgba(37,99,235,0.12); text-align: left; }
    .edu-module-card .edu-module-title { font-size: 1.125rem; font-weight: 700; color: var(--text); margin: 0 0 10px; }
    .edu-module-card .edu-module-desc { font-size: 1rem; color: var(--text-muted); line-height: 1.55; margin: 0 0 14px; }
    .edu-module-card .edu-module-meta { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px; }
    .edu-module-time { font-size: 0.8125rem; color: var(--text-muted); }
    .edu-module-card .btn { margin-top: 0; width: auto; min-width: 100px; }
    .edu-browse-wrap { margin-top: 18px; padding-top: 16px; border-top: 1px solid #e2e8f0; text-align: center; }
    .edu-browse-link { background: none; border: none; color: var(--phase-accent); font-size: 0.9375rem; font-weight: 600; cursor: pointer; padding: 0; font-family: inherit; }
    .edu-browse-phase { margin-bottom: 24px; }
    .edu-browse-phase:last-child { margin-bottom: 0; }
    .edu-browse-phase-title { font-size: 0.8125rem; text-transform: uppercase; letter-spacing: 0.04em; color: var(--text-muted); margin: 0 0 12px; font-weight: 600; }
    .edu-section-block { margin-top: 24px; padding-top: 20px; border-top: 2px solid #e2e8f0; }
    .edu-section-block:first-of-type { margin-top: 14px; padding-top: 0; border-top: none; }
    .edu-section-block.glucose_cgm .edu-section-head { color: var(--signos-blue); border-left: 4px solid var(--signos-blue); padding-left: 12px; }
    .edu-section-block.exercise .edu-section-head { color: var(--signos-pink); border-left: 4px solid var(--signos-pink); padding-left: 12px; }
    .edu-section-block.nutrition .edu-section-head { color: var(--signos-gold); border-left: 4px solid var(--signos-gold); padding-left: 12px; }
    .edu-section-block.sleep .edu-section-head { color: var(--signos-blue); border-left: 4px solid var(--signos-blue-light); padding-left: 12px; }
    .edu-section-block.stress .edu-section-head { color: var(--signos-pink-light); border-left: 4px solid var(--signos-pink); padding-left: 12px; }
    .edu-section-head { font-size: 1.0625rem; font-weight: 700; margin: 0 0 14px; }
    .edu-game-card .btn-outline { border-color: var(--phase-accent); color: var(--phase-accent); }
    .edu-build-meal { display: flex; flex-direction: column; gap: 16px; }
    .edu-meal-group { display: flex; flex-wrap: wrap; gap: 8px; }
    .edu-meal-label { font-size: 0.8125rem; font-weight: 600; color: var(--text-muted); width: 100%; margin-bottom: 4px; }
    .edu-meal-opt { flex: 1; min-width: 0; font-size: 0.875rem; }
    .edu-meal-opt.selected { background: var(--phase-accent-light); border-color: var(--phase-accent); color: var(--phase-accent); }
    .edu-muscle-options { display: flex; flex-direction: column; gap: 10px; }
    .edu-muscle-options .btn { width: 100%; }
    .edu-meditation-card { text-align: center; }
    .edu-meditation-timer { font-size: 2.5rem; font-weight: 700; color: var(--phase-accent); margin: 16px 0; }
    .edu-meditation-prompt { font-size: 1rem; line-height: 1.6; margin: 12px 0; min-height: 4em; }
    .module-progress { font-size: 0.8125rem; color: var(--text-muted); margin-bottom: 14px; font-weight: 500; }
    .module-step-title { font-size: 1.25rem; font-weight: 700; margin: 0 0 14px; color: var(--text); }
    .module-step-body { font-size: 1.0625rem; color: var(--text); line-height: 1.7; margin: 0 0 14px; max-width: 42em; }
    .module-step-body:last-of-type { margin-bottom: 0; }
    .edu-reading-card .module-step-body { font-size: 1.0625rem; line-height: 1.75; }
    .edu-highlight-blue { background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-left: 4px solid var(--signos-blue); padding: 14px 16px; border-radius: 12px; margin: 14px 0; }
    .edu-highlight-pink { background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 100%); border-left: 4px solid var(--signos-pink); padding: 14px 16px; border-radius: 12px; margin: 14px 0; }
    .edu-highlight-gold { background: linear-gradient(135deg, #fefce8 0%, #fef9c3 100%); border-left: 4px solid var(--signos-gold); padding: 14px 16px; border-radius: 12px; margin: 14px 0; }
    .module-step-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; padding-top: 16px; border-top: 1px solid #f1f5f9; }
    .protein-guess-options { display: flex; flex-direction: column; gap: 10px; }
    .build-workout-list { display: flex; flex-direction: column; gap: 8px; }
    .build-workout-item { display: flex; align-items: center; gap: 10px; font-size: 0.9375rem; cursor: pointer; }
    .metric-card { box-shadow: 0 2px 8px rgba(0,0,0,0.08); border: 1px solid rgba(0,0,0,0.06); }
    .readiness-plan-card { box-shadow: 0 2px 8px rgba(0,0,0,0.08); border: 1px solid rgba(0,0,0,0.06); }
    .log-item { box-shadow: 0 2px 8px rgba(0,0,0,0.08); border: 1px solid rgba(0,0,0,0.06); }
    .edu-module-card.completed { border-color: #22c55e; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); }
    .edu-module-card.completed .edu-module-title::before { content: '\2713 '; color: #22c55e; font-weight: 700; }
    .edu-progress-bar { height: 6px; background: #e2e8f0; border-radius: 3px; margin: 8px 0 0; overflow: hidden; }
    .edu-progress-bar .edu-progress-fill { height: 100%; background: linear-gradient(90deg, #22c55e, #16a34a); border-radius: 3px; transition: width 0.3s ease; }
    .edu-section-progress { font-size: 0.75rem; color: var(--text-muted); margin: 4px 0 10px; }
    .weekly-checkin-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.45); z-index: 250; display: flex; align-items: flex-end; justify-content: center; padding: 0; animation: fadeIn 0.3s ease; }
    .weekly-checkin-modal { background: var(--surface); border-radius: 24px 24px 0 0; padding: 28px 20px 32px; width: 100%; max-width: 420px; box-shadow: 0 -8px 40px rgba(0,0,0,0.18); animation: slideUp 0.35s ease; }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .weekly-q-label { font-size: 0.9375rem; font-weight: 600; color: var(--text); margin: 0 0 6px; }
    .weekly-q-sub { font-size: 0.8125rem; color: var(--text-muted); margin: 0 0 14px; }
    .weekly-emoji-row { display: flex; gap: 6px; margin-bottom: 20px; }
    .weekly-emoji-btn { flex: 1; padding: 10px 4px; border-radius: 12px; border: 2px solid #e2e8f0; background: var(--surface); font-size: 1.25rem; cursor: pointer; text-align: center; transition: all 0.15s ease; }
    .weekly-emoji-btn.selected { border-color: var(--phase-accent); background: var(--phase-accent-light); transform: scale(1.08); }
    .weekly-emoji-btn span { display: block; font-size: 0.6875rem; color: var(--text-muted); margin-top: 2px; }
    .weekly-textarea { width: 100%; min-height: 60px; border-radius: 12px; border: 1.5px solid #e2e8f0; padding: 10px 12px; font-size: 0.875rem; font-family: inherit; resize: vertical; margin-bottom: 16px; }
    .weekly-textarea:focus { outline: none; border-color: var(--phase-accent); }
    .phase-badge { display: inline-flex; align-items: center; gap: 6px; padding: 5px 14px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; letter-spacing: 0.02em; color: var(--phase-accent); background: var(--phase-accent-light); margin: 12px 16px 0; }
    .phase-badge-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--phase-accent); }
    .phase-hero { margin: 8px 16px 12px; padding: 16px; border-radius: 16px; background: var(--phase-accent-bg); border-left: 4px solid var(--phase-accent); }
    .phase-hero-title { margin: 0 0 4px; font-size: 1rem; font-weight: 700; color: var(--phase-accent); }
    .phase-hero-body { margin: 0; font-size: 0.8125rem; color: var(--text); line-height: 1.5; }
    .hunger-mastery-card { padding: 14px 16px; border-radius: 14px; background: var(--surface); box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    .hunger-mastery-title { font-size: 0.9375rem; font-weight: 700; margin: 0 0 4px; }
    .hunger-mastery-score { font-size: 2rem; font-weight: 800; color: var(--phase-accent); line-height: 1; }
    .hunger-mastery-sub { font-size: 0.75rem; color: var(--text-muted); margin: 2px 0 0; }
    .hunger-mastery-bar { height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; margin: 10px 0 6px; }
    .hunger-mastery-fill { height: 100%; border-radius: 4px; transition: width 0.3s ease; }
    .hunger-scale-labels { display: flex; justify-content: space-between; margin-bottom: 4px; }
    .hunger-scale-label { font-size: 0.625rem; color: var(--text-muted); text-align: center; flex: 1; line-height: 1.2; }
    .hunger-scale-label.active { color: var(--phase-accent); font-weight: 700; }
    .grad-timeline { display: flex; align-items: center; gap: 0; padding: 16px 16px 8px; overflow-x: auto; -webkit-overflow-scrolling: touch; flex-wrap: nowrap; scrollbar-width: none; }
    .grad-timeline::-webkit-scrollbar { display: none; }
    .grad-week { display: flex; flex-direction: column; align-items: center; min-width: 36px; position: relative; flex-shrink: 0; }
    .grad-week-dot { width: 22px; height: 22px; border-radius: 50%; border: 2px solid #cbd5e1; background: var(--surface); display: flex; align-items: center; justify-content: center; font-size: 0.5rem; font-weight: 700; color: #94a3b8; transition: all 0.2s ease; position: relative; z-index: 2; }
    .grad-week.done .grad-week-dot { border-color: #22c55e; background: #22c55e; color: #fff; }
    .grad-week.current .grad-week-dot { border-color: var(--phase-accent); background: var(--phase-accent-light); color: var(--phase-accent); box-shadow: 0 0 0 4px rgba(124,58,237,0.15); }
    .grad-week.graduation .grad-week-dot { border-color: #f59e0b; background: #fef3c7; color: #f59e0b; width: 24px; height: 24px; font-size: 0.625rem; }
    .grad-week.graduation.done .grad-week-dot { background: #f59e0b; color: #fff; }
    .grad-week-label { font-size: 0.4375rem; color: #94a3b8; margin-top: 2px; white-space: nowrap; }
    .grad-week.current .grad-week-label { color: var(--phase-accent); font-weight: 600; }
    .grad-week.graduation .grad-week-label { color: #f59e0b; font-weight: 700; font-size: 0.625rem; }
    .grad-week-line { flex: 0 0 10px; height: 2.5px; background: #e2e8f0; margin: 0 -1px; position: relative; top: -8px; z-index: 1; }
    .grad-week-line.done { background: #22c55e; }
    .grad-week.clickable { cursor: pointer; }
    .grad-week.clickable:active .grad-week-dot { transform: scale(1.15); }
    .grad-week.locked .grad-week-dot { border-color: #cbd5e1; background: #f1f5f9; color: #94a3b8; font-size: 0.5rem; }
    .grad-week.locked .grad-week-label { color: #cbd5e1; }
    .grad-week-line.locked { background: #e2e8f0; background-image: repeating-linear-gradient(90deg, #cbd5e1 0, #cbd5e1 4px, transparent 4px, transparent 8px); }
    .edu-module-card.this-week { border-left: 3px solid var(--phase-accent); }
    .grad-timeline-wrap { background: var(--surface); border-radius: 16px; margin: 0 16px 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); position: relative; }
    .grad-timeline-wrap::after { content: ''; position: absolute; top: 40px; right: 0; width: 32px; height: 60px; background: linear-gradient(to right, transparent, var(--surface)); pointer-events: none; border-radius: 0 16px 16px 0; z-index: 2; }
    .grad-timeline-title { padding: 14px 16px 0; font-size: 0.9375rem; font-weight: 700; color: var(--text); }
    .grad-timeline-sub { padding: 2px 16px 0; font-size: 0.75rem; color: var(--text-muted); }
    .grad-trend-card { background: var(--surface); border-radius: 16px; padding: 16px; margin-bottom: 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    .grad-trend-title { font-size: 0.9375rem; font-weight: 700; margin: 0 0 4px; }
    .grad-trend-sub { font-size: 0.75rem; color: var(--text-muted); margin: 0 0 12px; }
    .grad-trend-legend { display: flex; gap: 14px; margin-top: 10px; flex-wrap: wrap; }
    .grad-trend-legend-item { display: flex; align-items: center; gap: 5px; font-size: 0.75rem; color: var(--text-muted); }
    .grad-trend-legend-dot { width: 10px; height: 10px; border-radius: 50%; }
    .coach-bubble { background: var(--phase-accent-light); border-radius: 16px 16px 16px 4px; padding: 14px 16px; margin-bottom: 12px; font-size: 0.8125rem; color: var(--text); line-height: 1.55; position: relative; }
    .coach-bubble::before { content: ''; position: absolute; top: -24px; left: 12px; font-size: 1.5rem; }
    .coach-avatar { width: 36px; height: 36px; border-radius: 50%; background: var(--phase-accent); color: #fff; display: flex; align-items: center; justify-content: center; font-size: 1.125rem; flex-shrink: 0; }
    .coach-option { display: block; width: 100%; padding: 12px 14px; margin-bottom: 8px; border-radius: 12px; border: 2px solid #e2e8f0; background: #fff; text-align: left; font-size: 0.8125rem; color: var(--text); cursor: pointer; transition: all 0.15s; }
    .coach-option:active, .coach-option:hover { border-color: var(--phase-accent); background: var(--phase-accent-light); color: var(--phase-accent); }
    .coach-option .coach-opt-icon { font-size: 1.125rem; margin-right: 8px; }
    .coach-option .coach-opt-label { font-weight: 600; }
    .coach-option .coach-opt-desc { font-size: 0.75rem; color: var(--text-muted); margin-top: 2px; }
    .coach-timer-ring { width: 120px; height: 120px; border-radius: 50%; border: 6px solid #e2e8f0; display: flex; align-items: center; justify-content: center; margin: 16px auto; position: relative; }
    .coach-timer-ring.active { border-color: var(--phase-accent); animation: coach-pulse 2s infinite; }
    @keyframes coach-pulse { 0%,100% { box-shadow: 0 0 0 0 rgba(124,58,237,0.2); } 50% { box-shadow: 0 0 0 12px rgba(124,58,237,0); } }
    .coach-timer-text { font-size: 1.75rem; font-weight: 800; color: var(--phase-accent); }
    .coach-action-card { background: #f8fafc; border-radius: 12px; padding: 14px 16px; margin-bottom: 10px; border-left: 3px solid var(--phase-accent); }
    .coach-action-title { font-size: 0.8125rem; font-weight: 700; color: var(--phase-accent); margin: 0 0 4px; }
    .coach-action-body { font-size: 0.8125rem; color: var(--text); margin: 0; line-height: 1.5; }
    .halt-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px; }
    .halt-btn { padding: 14px 10px; border-radius: 12px; border: 2px solid #e2e8f0; background: #fff; text-align: center; cursor: pointer; transition: all 0.15s; }
    .halt-btn.selected { border-color: var(--phase-accent); background: var(--phase-accent-light); }
    .halt-btn .halt-letter { font-size: 1.5rem; font-weight: 800; color: var(--phase-accent); display: block; }
    .halt-btn .halt-label { font-size: 0.75rem; color: var(--text-muted); margin-top: 2px; display: block; }
    .halt-btn.selected .halt-label { color: var(--phase-accent); font-weight: 600; }
  </style>
</head>
<body>
  <div id="app"></div>
  <div id="app-loading" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#e8eaed;font-family:system-ui;font-size:24px;color:#1e293b;text-align:center;padding:20px;">Loading…</div>
  <script>
    setTimeout(function() {
      var el = document.getElementById('app-loading');
      if (el) { el.textContent = 'App failed to load. The app may need to be rebuilt.'; el.style.fontSize = '18px'; }
    }, 6000);
  </script>
  <script>
    (function() {
      function showError(title, msg) {
        console.error(title, msg);
        var div = document.getElementById('js-error-overlay');
        if (!div) {
          div = document.createElement('div');
          div.id = 'js-error-overlay';
          div.style.cssText = 'position:fixed;inset:0;z-index:99999;background:#c00;color:#fff;padding:20px;font-family:system-ui;overflow:auto;';
          document.body.appendChild(div);
        }
        div.innerHTML = '<h2>' + title + '</h2><pre style="white-space:pre-wrap;word-break:break-all;">' + (msg || '').replace(/</g, '&lt;') + '</pre>';
      }
      window.onerror = function(msg, url, line, col, err) {
        var s = (err && err.stack) ? err.stack : (msg + (url ? ' at ' + url + ':' + line + ':' + col : ''));
        showError('Uncaught error', s);
        return false;
      };
      window.addEventListener('unhandledrejection', function(e) {
        showError('Unhandled promise rejection', e.reason != null ? String(e.reason) : 'unknown');
      });
    })();
  </script>
  <script>
    try {
    (function() {
      var loadingEl = document.getElementById('app-loading');
      if (loadingEl) loadingEl.remove();
      var STORAGE_KEY = 'signos-glp1';
      var PROGRAM_NAME = 'GLP-1 Graduation';
      var PROGRAM_PRIMARY_GOAL = 'Build durable habits, stable glucose, and confidence in your body\u2019s signals as you transition off GLP-1.';
      var CORE_PRINCIPLES = [
        'Consistency beats perfection',
        'Muscle preservation is your metabolic insurance',
        'Hunger is information \u2014 respond to it, don\u2019t fight it',
        'Small weight regain is maintenance, not failure'
      ];
      var PROGRAM_HERO = { title: 'Your 16-Week Graduation', body: 'Whether you\u2019re tapering or already off GLP-1, this program builds the habits you need from foundation to mastery. Each week has a structural goal \u2014 complete them all and you\u2019ll graduate with the skills, scores, and confidence to thrive.' };
      var HUNGER_FRAME = { label: 'Hunger awareness', tip: 'Hunger is a signal to respond to, not resist. Each check-in builds your ability to recognize real hunger, eat at the right time, and trust your body\u2019s signals. Satiety is a skill \u2014 and it gets stronger with practice.' };
      var HUNGER_MICRO_TIPS = [
        'Hunger at a 3 is your sweet spot \u2014 it means your body is communicating well.',
        'Feeling a 4 or 5? That usually means you waited too long. Next time, eat at a 3.',
        'Satiety improves with practice. Protein, fiber, and eating speed all help you feel fuller with less.',
        'Hunger returning as medication changes is a sign your metabolism is activating \u2014 that\u2019s good.',
        'Post-meal fullness of 3\u20134 means you nailed the portion. Over 4 means slightly too much.',
        'Pair protein + fiber at every meal to extend your fullness window by 1\u20132 hours.',
        'A 10-minute walk after eating improves both glucose and satiety signals.',
        'Poor sleep raises ghrelin (hunger hormone) by ~15\u201320%. Prioritize sleep to manage hunger.',
        'Eating slowly (20+ min per meal) lets fullness signals reach your brain before you overeat.',
        'Hunger is information, not an emergency. Observe it, respond to it, don\u2019t fight it.'
      ];
      var HUNGER_SCALE_LABELS = {
        hunger: [
          { val: 1, short: 'No signal', desc: 'Not hungry at all' },
          { val: 2, short: 'Mildly aware', desc: 'Slight hunger' },
          { val: 3, short: 'Ready to eat', desc: 'Comfortably hungry' },
          { val: 4, short: 'Very hungry', desc: 'Hard to focus' },
          { val: 5, short: 'Urgent', desc: 'Overly hungry' }
        ],
        fullness: [
          { val: 1, short: 'Still hungry', desc: 'Not satisfied' },
          { val: 2, short: 'Slightly full', desc: 'Could eat more' },
          { val: 3, short: 'Satisfied', desc: 'Comfortable \u2014 ideal' },
          { val: 4, short: 'Full', desc: 'Slightly too much' },
          { val: 5, short: 'Stuffed', desc: 'Uncomfortably full' }
        ]
      };

      var COACH_SCENARIOS = [
        { id: 'about_to_eat', icon: '&#127793;', label: 'I\u2019m about to eat \u2014 help me prepare', desc: 'Get coached before a meal', category: 'proactive' },
        { id: 'post_meal', icon: '&#128221;', label: 'I just finished eating \u2014 let me reflect', desc: 'Post-meal check-in and learning', category: 'proactive' },
        { id: 'ate_still_hungry', icon: '&#127860;', label: 'I just ate but I\u2019m still hungry', desc: 'Finished a meal and want more', category: 'reactive' },
        { id: 'starving', icon: '&#128293;', label: 'I\u2019m starving and need to eat now', desc: 'Haven\u2019t eaten and hunger is intense', category: 'reactive' },
        { id: 'craving', icon: '&#127849;', label: 'I\u2019m craving something specific', desc: 'Want a particular food or flavor', category: 'reactive' },
        { id: 'not_hungry_want_eat', icon: '&#129300;', label: 'I\u2019m not hungry but I want to eat', desc: 'No physical hunger but drawn to food', category: 'reactive' },
        { id: 'unsure', icon: '&#129335;', label: 'I\u2019m not sure if I\u2019m hungry', desc: 'Can\u2019t tell if it\u2019s real hunger', category: 'reactive' },
        { id: 'unusual_time', icon: '&#128336;', label: 'I feel hungry at an unusual time', desc: 'Late night, mid-afternoon, etc.', category: 'reactive' },
        { id: 'hunger_changing', icon: '&#127793;', label: 'My hunger feels different lately', desc: 'Appetite is changing as medication changes', category: 'learn' },
        { id: 'learn_hunger', icon: '&#128218;', label: 'Teach me about hunger', desc: 'Understand your hunger signals better', category: 'learn' }
      ];
      var HUNGER_LESSONS = [
        { id: 'types', icon: '&#129504;', title: 'The 5 types of hunger',
          body: '<p style="margin:0 0 10px;font-size:0.875rem;line-height:1.6"><strong>Stomach hunger</strong> \u2014 Physical signals: growling, emptiness, gnawing. This is your body asking for fuel. Always respond to this one.</p>' +
            '<p style="margin:0 0 10px;font-size:0.875rem;line-height:1.6"><strong>Mouth hunger</strong> \u2014 You want the taste, texture, or experience of eating. Your stomach is fine, but your mouth wants something to do. Gum, tea, or brushing teeth often helps.</p>' +
            '<p style="margin:0 0 10px;font-size:0.875rem;line-height:1.6"><strong>Eye hunger</strong> \u2014 Triggered by seeing food, a photo, or watching someone eat. This is environmental, not physical. It fades when the stimulus is removed.</p>' +
            '<p style="margin:0 0 10px;font-size:0.875rem;line-height:1.6"><strong>Heart hunger</strong> \u2014 Emotional eating. You\u2019re not hungry \u2014 you\u2019re sad, bored, anxious, or lonely and food feels like comfort. The HALT check helps here.</p>' +
            '<p style="margin:0;font-size:0.875rem;line-height:1.6"><strong>Habit hunger</strong> \u2014 It\u2019s noon, so you eat. You sit on the couch, so you snack. This is clock-driven or routine-driven. Check in with your body before defaulting.</p>',
          takeaway: 'Only stomach hunger requires food. The others need different solutions \u2014 and recognizing which one you\u2019re feeling IS the skill.' },
        { id: 'scale', icon: '&#128200;', title: 'The hunger scale explained',
          body: '<div style="margin-bottom:12px">' +
            '<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid #f1f5f9"><div style="width:32px;height:32px;border-radius:50%;background:#ef4444;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;flex-shrink:0">1</div><div><strong style="font-size:0.875rem">Not hungry at all</strong><div style="font-size:0.8125rem;color:var(--text-muted)">No signals. You might have just eaten or may be over-suppressed by medication. Don\u2019t force food, but eat on schedule to protect muscle.</div></div></div>' +
            '<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid #f1f5f9"><div style="width:32px;height:32px;border-radius:50%;background:#f59e0b;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;flex-shrink:0">2</div><div><strong style="font-size:0.875rem">Slightly aware</strong><div style="font-size:0.8125rem;color:var(--text-muted)">Mild signals starting. Good time to plan your next meal. Not urgent yet.</div></div></div>' +
            '<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid #f1f5f9"><div style="width:32px;height:32px;border-radius:50%;background:#22c55e;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;flex-shrink:0">3</div><div><strong style="font-size:0.875rem">Comfortably hungry \u2014 the sweet spot</strong><div style="font-size:0.8125rem;color:var(--text-muted)">You\u2019re aware of hunger but in control. This is the ideal time to eat. You\u2019ll make better choices and stop more naturally.</div></div></div>' +
            '<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid #f1f5f9"><div style="width:32px;height:32px;border-radius:50%;background:#f59e0b;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;flex-shrink:0">4</div><div><strong style="font-size:0.875rem">Very hungry</strong><div style="font-size:0.8125rem;color:var(--text-muted)">Hard to focus. You waited a bit too long. Eat now, but slow down \u2014 your brain needs time to register fullness.</div></div></div>' +
            '<div style="display:flex;align-items:center;gap:10px;padding:8px 0"><div style="width:32px;height:32px;border-radius:50%;background:#ef4444;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;flex-shrink:0">5</div><div><strong style="font-size:0.875rem">Urgent / starving</strong><div style="font-size:0.8125rem;color:var(--text-muted)">Overly hungry. At this point, your brain is in survival mode and will push toward fast, high-calorie food. Eat immediately, start with protein.</div></div></div></div>',
          takeaway: 'The goal is to eat at level 3 and stop at fullness 3\u20134. This "sweet spot" gets easier to find with practice.' },
        { id: 'glp1_hunger', icon: '&#128137;', title: 'How GLP-1 changes your hunger',
          body: '<p style="margin:0 0 10px;font-size:0.875rem;line-height:1.6">GLP-1 medications work by slowing gastric emptying and acting on appetite centers in your brain. This means hunger signals become much quieter \u2014 sometimes disappearing entirely.</p>' +
            '<p style="margin:0 0 10px;font-size:0.875rem;line-height:1.6"><strong>On medication:</strong> Hunger may rarely exceed a 1\u20132. You might forget to eat. This is when structured meals matter most \u2014 eating by the clock protects muscle and metabolism even when appetite is low.</p>' +
            '<p style="margin:0 0 10px;font-size:0.875rem;line-height:1.6"><strong>Tapering or stopping:</strong> Hunger returns gradually, sometimes in waves. You may feel hungrier than "normal" for a period \u2014 this is your body recalibrating, not a failure. Ghrelin (hunger hormone) overshoots temporarily before settling.</p>' +
            '<p style="margin:0;font-size:0.875rem;line-height:1.6"><strong>After medication:</strong> Your new baseline hunger will be higher than on medication but lower than before if you\u2019ve built the right habits. Protein, fiber, sleep, and exercise all act as natural appetite regulators.</p>',
          takeaway: 'Your hunger signals will change throughout this program. Each phase is normal. The goal is to build skills that work at every hunger level.' },
        { id: 'satiation', icon: '&#127860;', title: 'The satiation toolkit',
          body: '<p style="margin:0 0 10px;font-size:0.875rem;line-height:1.6">Satiation (feeling full during a meal) and satiety (staying full between meals) are different skills. Here\u2019s your toolkit for both:</p>' +
            '<p style="margin:0 0 6px;font-size:0.875rem;line-height:1.6"><strong>&#129385; Protein first</strong> \u2014 Eat protein at the start of your meal. It triggers CCK and PYY (fullness hormones) faster than carbs or fat. Aim for 25\u201330g per meal.</p>' +
            '<p style="margin:0 0 6px;font-size:0.875rem;line-height:1.6"><strong>&#129382; Fiber for volume</strong> \u2014 Vegetables, beans, and whole grains physically stretch your stomach, activating stretch receptors that signal fullness. More volume = more satisfaction for fewer calories.</p>' +
            '<p style="margin:0 0 6px;font-size:0.875rem;line-height:1.6"><strong>&#129361; Healthy fats</strong> \u2014 Fat slows gastric emptying, extending how long food stays in your stomach. A meal with adequate fat (15\u201320g) keeps you full 2x longer.</p>' +
            '<p style="margin:0 0 6px;font-size:0.875rem;line-height:1.6"><strong>&#128167; Water</strong> \u2014 Drink water before and during meals. Mild dehydration mimics hunger. A glass of water 15 minutes before eating can reduce meal size by ~13%.</p>' +
            '<p style="margin:0 0 6px;font-size:0.875rem;line-height:1.6"><strong>&#9202; Slow down</strong> \u2014 Eat over 20+ minutes. Fullness signals take 15\u201320 minutes to reach your brain via the vagus nerve. Eating fast overrides this system.</p>' +
            '<p style="margin:0;font-size:0.875rem;line-height:1.6"><strong>&#127793; Eat at level 3</strong> \u2014 Starting meals at comfortable hunger (not starving) gives you control over portions and choices.</p>',
          takeaway: 'You don\u2019t need willpower to feel full. You need the right combination of nutrients, timing, and awareness.' },
        { id: 'glucose_hunger', icon: '&#128200;', title: 'How glucose drives your hunger',
          body: '<p style="margin:0 0 12px;font-size:0.875rem;line-height:1.6"><strong>The spike-crash cycle</strong></p>' +
            '<p style="margin:0 0 10px;font-size:0.875rem;line-height:1.6">When you eat carbohydrates without protein or fiber, glucose spikes rapidly. Your pancreas overreacts with a surge of insulin, crashing glucose below where it started. That crash \u2014 even if you just ate \u2014 triggers intense hunger, carb cravings, and brain fog. This is called <strong>reactive hypoglycemia</strong>.</p>' +
            '<div style="background:#f8fafc;border-radius:10px;padding:12px;margin-bottom:12px">' +
            '<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px"><span style="font-size:1.25rem">&#128200;</span><strong style="font-size:0.8125rem">The crash timeline</strong></div>' +
            '<div style="font-size:0.8125rem;line-height:1.6;color:var(--text)">' +
            '<div style="margin-bottom:4px"><strong>0\u201315 min:</strong> Glucose rises rapidly (carbs hit fast)</div>' +
            '<div style="margin-bottom:4px"><strong>15\u201345 min:</strong> Glucose peaks (+40\u201380 mg/dL above baseline)</div>' +
            '<div style="margin-bottom:4px"><strong>45\u201390 min:</strong> Insulin overreacts \u2192 glucose crashes below baseline</div>' +
            '<div><strong>60\u2013120 min:</strong> Brain senses low fuel \u2192 triggers hunger + carb cravings</div></div></div>' +
            '<p style="margin:0 0 12px;font-size:0.875rem;line-height:1.6"><strong>Below-baseline hunger</strong></p>' +
            '<p style="margin:0 0 10px;font-size:0.875rem;line-height:1.6">Your brain has a "glucose thermostat" \u2014 a personal baseline (typically 85\u2013100 mg/dL). When glucose drops below it \u2014 even slightly \u2014 your hypothalamus triggers an <strong>urgent need for fast carbs</strong>. This is why you crave bread, candy, or soda specifically, not chicken or salad. Your brain wants the fastest possible glucose restoration.</p>' +
            '<p style="margin:0 0 12px;font-size:0.875rem;line-height:1.6"><strong>Stable glucose = stable hunger</strong></p>' +
            '<p style="margin:0 0 10px;font-size:0.875rem;line-height:1.6">Meals with protein first, fiber, and healthy fat keep glucose within a 20\u201330 mg/dL range of baseline. No spike means no crash. No crash means no rebound hunger. Your CGM is the proof: look for meals where glucose stays flat \u2014 those are the meals that kept you full for 3\u20134 hours.</p>' +
            '<p style="margin:0 0 12px;font-size:0.875rem;line-height:1.6"><strong>How to read your CGM for hunger clues</strong></p>' +
            '<div style="font-size:0.8125rem;line-height:1.7;color:var(--text)">' +
            '<div style="margin-bottom:4px">&#128994; <strong>Drop &lt;20 mg/dL from peak:</strong> Stable \u2014 hunger will be predictable</div>' +
            '<div style="margin-bottom:4px">&#128992; <strong>Drop 20\u201340 mg/dL:</strong> Moderate dip \u2014 mild hunger may return in 2 hrs</div>' +
            '<div>&#128308; <strong>Drop &gt;40 mg/dL or below 80:</strong> Crash \u2014 expect strong hunger + carb cravings</div></div>',
          takeaway: 'Most unexplained hunger is a glucose crash in disguise. Eat protein first, add fiber, and watch your CGM \u2014 stable glucose means stable hunger.' }
      ];

      function getGlucoseContext() {
        var hour = new Date().getHours();
        var lastHunger = null;
        if (state.hungerEntries) {
          var todayK = getTodayKey();
          if (state.hungerEntries[todayK]) lastHunger = state.hungerEntries[todayK];
        }
        var baseline = 95;
        if (state.profile && state.profile.weight) {
          baseline = state.profile.weight > 200 ? 100 : state.profile.weight < 140 ? 88 : 95;
        }

        var ctx = { current: 0, baseline: baseline, trend: '', type: '', message: '', shortLabel: '', icon: '', color: '' };

        var isPostMealWindow = (hour >= 7 && hour <= 9) || (hour >= 12 && hour <= 14) || (hour >= 18 && hour <= 20);
        var isPostCrash = (hour >= 9 && hour <= 11) || (hour >= 14 && hour <= 16) || (hour >= 20 && hour <= 22);
        var highHunger = lastHunger && lastHunger.overallHunger >= 4;
        var lowFullness = lastHunger && lastHunger.postMealFullness <= 2;

        var seed = (new Date().getDate() * 7 + hour * 13) % 100;

        if (isPostCrash && (highHunger || seed < 35)) {
          var peak = baseline + 45 + (seed % 30);
          var drop = 40 + (seed % 25);
          ctx.current = Math.max(68, peak - drop - 10);
          ctx.trend = 'dropping';
          ctx.type = 'crash';
          ctx.message = 'Your glucose spiked to ' + peak + ' mg/dL after your last meal and crashed to ' + ctx.current + ' \u2014 a ' + drop + ' mg/dL drop. This rapid crash triggers hunger and carb cravings, even if your stomach is still full.';
          ctx.shortLabel = ctx.current + ' mg/dL \u2014 post-meal crash';
          ctx.icon = '&#128308;';
          ctx.color = '#ef4444';
        } else if (isPostCrash && seed >= 35 && seed < 55) {
          ctx.current = baseline - 8 - (seed % 12);
          ctx.trend = 'below_baseline';
          ctx.type = 'below_baseline';
          ctx.message = 'Your glucose is ' + ctx.current + ' mg/dL \u2014 below your typical baseline of ' + baseline + '. When glucose drops below baseline, your brain specifically craves fast carbs to restore fuel. This is biochemical, not a lack of willpower.';
          ctx.shortLabel = ctx.current + ' mg/dL \u2014 below baseline';
          ctx.icon = '&#128992;';
          ctx.color = '#f59e0b';
        } else if (isPostMealWindow) {
          ctx.current = baseline + 15 + (seed % 20);
          ctx.trend = 'rising';
          ctx.type = 'post_meal';
          ctx.message = 'Your glucose is ' + ctx.current + ' mg/dL and rising after your meal. This is normal. Watch for how quickly it comes back down \u2014 a gentle return to ' + baseline + ' means this meal had good protein and fiber balance.';
          ctx.shortLabel = ctx.current + ' mg/dL \u2014 post-meal rise';
          ctx.icon = '&#128200;';
          ctx.color = '#f59e0b';
        } else {
          ctx.current = baseline + (seed % 10) - 3;
          ctx.trend = 'stable';
          ctx.type = 'stable';
          ctx.message = 'Your glucose is ' + ctx.current + ' mg/dL \u2014 stable and near your baseline of ' + baseline + '. When glucose is stable, any hunger you feel is likely genuine physical hunger, not a crash-driven craving.';
          ctx.shortLabel = ctx.current + ' mg/dL \u2014 stable';
          ctx.icon = '&#128994;';
          ctx.color = '#16a34a';
        }

        return ctx;
      }

      function getGlucoseHungerInsight(hungerVal, fullnessVal) {
        var gCtx = getGlucoseContext();
        var insight = { title: '', body: '', icon: gCtx.icon, color: gCtx.color, glucoseVal: gCtx.current };

        if (gCtx.type === 'crash' && hungerVal >= 4) {
          insight.title = 'Your hunger matches a glucose crash';
          insight.body = 'Your glucose dropped rapidly after your last meal (' + gCtx.current + ' mg/dL). That crash is driving this intense hunger. Eat protein now \u2014 it stabilizes glucose without re-triggering the spike-crash cycle. Next meal: eat protein first, carbs last.';
        } else if (gCtx.type === 'crash' && hungerVal <= 2) {
          insight.title = 'Glucose crashed but hunger is low';
          insight.body = 'Your glucose dropped to ' + gCtx.current + ' mg/dL, but you\u2019re not feeling hungry. Your medication may be masking the hunger signal. Eat a structured snack anyway \u2014 low glucose still affects concentration and energy.';
        } else if (gCtx.type === 'below_baseline' && hungerVal >= 3) {
          insight.title = 'Below-baseline glucose is driving carb cravings';
          insight.body = 'At ' + gCtx.current + ' mg/dL (baseline: ' + gCtx.baseline + '), your brain is specifically requesting fast carbs. This is biochemistry, not weakness. Satisfy it with protein + a small carb (apple + peanut butter, yogurt + berries) to restore glucose without a spike.';
        } else if (gCtx.type === 'stable' && hungerVal === 3) {
          insight.title = 'Glucose stable, hunger at sweet spot';
          insight.body = 'Your glucose (' + gCtx.current + ' mg/dL) is steady and your hunger is at level 3. This is the ideal state \u2014 your body is communicating genuine hunger without glucose interference. Whatever you ate last is working well.';
          insight.color = '#16a34a';
        } else if (gCtx.type === 'stable' && hungerVal >= 4) {
          insight.title = 'Glucose is stable \u2014 this is real hunger';
          insight.body = 'Your glucose is steady at ' + gCtx.current + ' mg/dL, so this hunger isn\u2019t from a crash. This is genuine physical hunger \u2014 your body needs fuel. Eat a protein-forward meal now.';
        } else if (gCtx.type === 'post_meal' && fullnessVal <= 2) {
          insight.title = 'Rising glucose but low fullness';
          insight.body = 'Your glucose is ' + gCtx.current + ' mg/dL and rising. You\u2019re not full yet, which may mean the meal was too small or carb-heavy. If glucose spikes high (160+), the crash in 45\u201360 minutes will bring hunger back. Add protein or fiber now to slow the rise.';
          insight.color = '#f59e0b';
        } else if (gCtx.type === 'stable') {
          insight.title = 'Glucose is in a good place';
          insight.body = 'At ' + gCtx.current + ' mg/dL, your glucose is stable. Any hunger signals right now are from your body, not from a glucose rollercoaster. Trust what you\u2019re feeling.';
          insight.color = '#16a34a';
        } else {
          insight.title = 'Glucose: ' + gCtx.current + ' mg/dL';
          insight.body = gCtx.message;
        }

        return insight;
      }

      var COACH_BRANCHES = {
        ate_still_hungry: {
          question: 'When did you finish eating?',
          options: [
            { id: 'lt15', label: 'Less than 15 minutes ago' },
            { id: '15to30', label: '15\u201330 minutes ago' },
            { id: 'gt30', label: 'More than 30 minutes ago' }
          ],
          responses: {
            lt15: {
              title: 'Give your brain a moment to catch up',
              body: 'Fullness signals take 15\u201320 minutes to travel from your stomach to your brain. You may already have enough food \u2014 your body just hasn\u2019t registered it yet.',
              actions: ['Drink a full glass of water', 'Set a 10-minute timer and wait', 'Go for a short walk or change rooms'],
              why: 'The vagus nerve transmits satiety signals, but it\u2019s slow. Eating more before the signal arrives almost always leads to overeating.',
              showTimer: true
            },
            '15to30': {
              followUp: 'what_did_you_eat'
            },
            gt30: {
              followUp: 'stomach_or_mouth'
            }
          }
        },
        what_did_you_eat: {
          question: 'What did your meal look like?',
          options: [
            { id: 'carb_heavy', label: 'Mostly carbs / quick meal', desc: 'Bread, pasta, rice, cereal, etc.' },
            { id: 'had_protein', label: 'Had protein but still hungry', desc: 'Meat, eggs, fish with sides' },
            { id: 'balanced', label: 'A full balanced meal', desc: 'Protein + fiber + carb' }
          ],
          responses: {
            carb_heavy: {
              title: 'Your glucose is likely spiking and crashing',
              body: 'Carb-heavy meals spike blood sugar fast but don\u2019t sustain fullness. Your CGM probably shows a sharp rise followed by a drop \u2014 that drop triggers hunger even though you just ate. This is called reactive hypoglycemia.',
              actions: ['Have a small protein snack now (Greek yogurt, handful of nuts, cheese stick)', 'Next meal: eat protein FIRST, then carbs last', 'Add fiber (veggies, beans) to slow glucose absorption'],
              why: 'Protein and fiber slow gastric emptying, keeping glucose stable for 2\u20133 hours instead of the 45-minute spike-crash cycle from carbs alone.'
            },
            had_protein: {
              followUp: 'stomach_or_mouth'
            },
            balanced: {
              title: 'Your portion may need adjusting',
              body: 'If you ate a balanced meal and still feel hungry after 20+ minutes, your body may genuinely need more fuel. As appetite returns after GLP-1, you may realize you were undereating \u2014 which slows metabolism and costs lean muscle.',
              actions: ['Have a small additional serving, prioritizing protein', 'Track this \u2014 if it happens often, your baseline portion may be too small', 'Check your hunger level: if it\u2019s a 4\u20135, eat; if it\u2019s a 2\u20133, wait'],
              why: 'Undereating while on GLP-1 medication was more common than you might think. Your body still needs fuel for muscle preservation and metabolic health.'
            }
          }
        },
        stomach_or_mouth: {
          question: 'Put your hand on your stomach. What do you feel?',
          options: [
            { id: 'stomach', label: '&#128163; Physical hunger', desc: 'Growling, empty, gnawing feeling' },
            { id: 'mouth', label: '&#128067; Mouth/brain hunger', desc: 'Want more taste or the experience of eating' }
          ],
          responses: {
            stomach: {
              title: 'This is real hunger \u2014 respond to it',
              body: 'Your body is genuinely asking for more fuel. As medication effects fade, the hunger you feel is increasingly real \u2014 your body is recalibrating its signals. Trust this signal.',
              actions: ['Have a protein-forward snack (25g+ protein)', 'Consider if your meals are large enough', 'Log this \u2014 consistent post-meal hunger means your portions need adjusting'],
              why: 'Ignoring real hunger leads to overeating later, metabolic slowdown, and muscle loss. Responding appropriately builds the exact skills you need post-medication.'
            },
            mouth: {
              title: 'This is hedonic hunger \u2014 your brain wants pleasure',
              body: 'Your stomach is satisfied but your brain is seeking the dopamine hit from food. This is one of the most common patterns, and one of the most important to recognize \u2014 especially as medication effects change.',
              actions: ['Brush your teeth or chew gum (flavor reset)', 'Make a cup of tea or flavored water', 'Go for a 5-minute walk or change environments', 'Set a 10-minute timer \u2014 if the urge passes, it was hedonic'],
              why: 'Hedonic hunger fires in the reward centers (nucleus accumbens), not the hunger centers (hypothalamus). Environment changes interrupt the reward loop.',
              showTimer: true
            }
          }
        },
        starving: {
          question: 'When was your last meal?',
          options: [
            { id: 'long_ago', label: '4+ hours ago or skipped a meal' },
            { id: 'recent', label: '2\u20134 hours ago' },
            { id: 'just_woke', label: 'I just woke up / morning hunger' }
          ],
          responses: {
            long_ago: {
              title: 'You\u2019ve waited too long \u2014 eat now',
              body: 'Going 4+ hours without eating drops blood sugar and spikes ghrelin. At this point your body is in "urgent refuel" mode, which makes it harder to make good choices and easier to overeat.',
              actions: ['Eat a meal NOW \u2014 don\u2019t wait for the "perfect" option', 'Lead with protein to stabilize your glucose quickly', 'Eat slowly (set a 20-minute meal timer) to avoid overshooting fullness', 'Plan tomorrow: set a meal alarm so you don\u2019t skip again'],
              why: 'Level 4\u20135 hunger overrides rational decision-making. Eating at level 3 (comfortably hungry) is the goal \u2014 it gives you control over what and how much you eat.'
            },
            recent: {
              title: 'Intense hunger after a recent meal \u2014 let\u2019s investigate',
              body: 'Feeling starving 2\u20134 hours after eating usually points to a meal composition issue. Your last meal likely didn\u2019t include enough protein or fiber to sustain blood sugar.',
              actions: ['Have a protein-rich snack to bridge to your next meal', 'Review what you ate \u2014 was there 25g+ protein?', 'Next meal: add a vegetable and slow down your eating pace'],
              why: 'Meals with protein + fiber keep you satisfied 2\u20133x longer than carb-only meals. Your CGM data can confirm this \u2014 look for meals where glucose stayed flat vs. spiked.'
            },
            just_woke: {
              title: 'Morning hunger is a good sign',
              body: 'Waking up hungry means your metabolism is active and your circadian rhythm is working. Many GLP-1 users lose morning hunger entirely \u2014 if yours is returning, that\u2019s healthy adaptation.',
              actions: ['Eat within 60\u201390 minutes of waking', 'Make breakfast protein-forward (eggs, Greek yogurt, protein shake)', 'Don\u2019t skip it \u2014 morning protein sets your satiety tone for the day'],
              why: 'Cortisol peaks in the morning, mobilizing energy. Eating breakfast anchors your glucose and prevents the mid-morning crash that leads to poor food choices.'
            }
          }
        },
        craving: {
          question: 'What are you craving?',
          options: [
            { id: 'sweet', label: '&#127852; Something sweet', desc: 'Dessert, candy, chocolate, fruit' },
            { id: 'salty', label: '&#129380; Something salty or crunchy', desc: 'Chips, pretzels, popcorn, crackers' },
            { id: 'rich', label: '&#129472; Something rich or fatty', desc: 'Pizza, burgers, cheese, fried food' },
            { id: 'specific', label: '&#127829; A very specific food', desc: 'Can\u2019t stop thinking about one thing' }
          ],
          responses: {
            sweet: {
              title: 'Sweet cravings often signal a glucose dip',
              body: 'Your brain uses glucose as its primary fuel. When blood sugar drops (even slightly), it sends strong signals for quick-energy foods \u2014 sweets. Check your CGM: if glucose dipped below 80 in the last hour, this craving is biochemical, not weakness.',
              actions: ['Try berries with Greek yogurt \u2014 sweet + protein (glucose spike: ~15 mg/dL vs. ~60 for candy)', 'A protein shake with cocoa powder hits the chocolate craving with minimal glucose impact', 'Dark chocolate (70%+): 2 squares satisfy the craving at ~5g sugar', 'If you eat something sweet, pair it with nuts or cheese to blunt the spike'],
              why: 'Sweet cravings after a glucose dip are your brain\u2019s survival mechanism. Satisfying them with protein + a little sweetness prevents the spike-crash-crave cycle.'
            },
            salty: {
              title: 'Salty cravings can mean dehydration or stress',
              body: 'Salt cravings often indicate mild dehydration (your body wants to retain water) or elevated cortisol from stress. GLP-1 medications can also affect electrolyte balance, amplifying these cravings.',
              actions: ['Drink 16oz of water first and wait 10 minutes', 'Salted nuts (almonds, cashews) \u2014 same salt satisfaction with protein and healthy fat', 'Olives, pickles, or cheese \u2014 salty with minimal glucose impact', 'Salted cucumber slices or celery with hummus for crunch + volume'],
              why: 'The crunch-seeking part of salt cravings is often about stress relief (jaw tension). Crunchy vegetables can satisfy that mechanical need without the processed carbs.'
            },
            rich: {
              title: 'Your body may need more fat',
              body: 'Cravings for rich, fatty foods can signal that your diet has been too restrictive in fat. Fat is essential for hormone production, brain function, and vitamin absorption. While on GLP-1, people often under-eat fat because appetite is low. As appetite returns, make sure fat is part of your meals.',
              actions: ['Avocado toast on whole grain \u2014 satisfies richness with healthy fat', 'A small portion of what you\u2019re craving is better than a large portion of a "substitute"', 'Add olive oil or cheese to your next meal to increase satiety', 'If it\u2019s pizza/burger specifically, plan it for your next meal rather than snacking'],
              why: 'Fat slows gastric emptying, which means it keeps you fuller longer. A meal with adequate fat (15\u201320g) sustains satisfaction 2x longer than fat-free alternatives.'
            },
            specific: {
              title: 'Specific food fixation \u2014 the 10-minute rule',
              body: 'When you can\u2019t stop thinking about one food, it\u2019s usually hedonic (reward-driven) rather than nutritional. Your brain has locked onto the memory of how that food made you feel. This is normal and not a failure.',
              actions: ['Set a 10-minute timer. If you still want it after, have a reasonable portion', 'Have a small serving deliberately: plate it, sit down, eat slowly, enjoy it', 'Don\u2019t label it "bad" \u2014 restriction amplifies cravings', 'Log it: understanding your trigger patterns is more valuable than avoiding them'],
              why: 'Rigid food rules increase binge-risk by 3x (research). Flexible restraint (80/20 approach) is the evidence-based strategy for long-term maintenance.',
              showTimer: true
            }
          }
        },
        not_hungry_want_eat: {
          isHalt: true,
          question: 'Let\u2019s do a quick HALT check. What\u2019s really going on?',
          subtitle: 'HALT stands for Hungry, Angry/Anxious, Lonely/Bored, Tired. Most non-hunger eating falls into one of these.',
          options: [
            { id: 'hungry_actual', letter: 'H', label: 'Actually hungry', desc: 'Maybe I am a little hungry' },
            { id: 'angry', letter: 'A', label: 'Angry / Anxious / Stressed', desc: 'Tension, worry, or frustration' },
            { id: 'lonely', letter: 'L', label: 'Lonely / Bored', desc: 'Understimulated or disconnected' },
            { id: 'tired', letter: 'T', label: 'Tired / Exhausted', desc: 'Low energy, need of rest' }
          ],
          responses: {
            hungry_actual: {
              title: 'You may be physically hungry after all',
              body: 'Sometimes low-level hunger is hard to detect, especially as your body adjusts after GLP-1 which can make hunger signals feel unfamiliar. If you feel even slightly hungry, that signal is worth responding to.',
              actions: ['Check your hunger on the 1\u20135 scale \u2014 if it\u2019s 2+, eat a structured snack', 'Choose protein + fiber to get the most satiety from the snack', 'Note the time \u2014 if this happens regularly, your meal timing may need adjusting'],
              why: 'As your body adjusts after GLP-1, learning to trust your hunger signals is key. Even subtle signals deserve attention.'
            },
            angry: {
              title: 'Stress eating \u2014 cortisol is driving this',
              body: 'When you\u2019re stressed or anxious, cortisol rises and your brain seeks quick comfort \u2014 usually through food. Your CGM may show elevated fasting glucose on stressful days, confirming the cortisol link. Eating won\u2019t solve the stress; it will just add a blood sugar rollercoaster on top of it.',
              actions: ['Box breathing: 4 counts in, 4 hold, 4 out, 4 hold \u2014 repeat 4 times (2 minutes)', 'Step outside for 3 minutes of fresh air', 'Write down what\u2019s stressing you \u2014 externalizing it reduces the urge', 'If you still want to eat after 10 minutes, choose something with protein'],
              why: 'Box breathing activates the parasympathetic nervous system, reducing cortisol by ~15% within 5 minutes. It\u2019s physiologically the opposite of the stress response.',
              showTimer: true
            },
            lonely: {
              title: 'Boredom eating \u2014 your brain wants stimulation',
              body: 'When you\u2019re understimulated, your brain seeks dopamine. Food is the easiest, most accessible dopamine source. This is the #1 reason people eat when not hungry \u2014 and it\u2019s the most important pattern to recognize for long-term success.',
              actions: ['Text or call someone \u2014 social connection releases oxytocin, which reduces cravings', 'Start a small task (5-minute clean, short walk, puzzle)', 'Change your physical environment (move rooms, go outside)', 'Set a 10-minute timer \u2014 if you still want food after, have a planned snack'],
              why: 'Boredom eating accounts for ~35% of non-hunger eating episodes. Recognizing the pattern is the hardest part \u2014 once you can name it, you can redirect it.',
              showTimer: true
            },
            tired: {
              title: 'Fatigue mimics hunger \u2014 your body wants energy',
              body: 'When you\u2019re tired, ghrelin (hunger hormone) rises 15\u201320% and leptin (fullness hormone) drops. Your brain interprets this as hunger, but what you actually need is rest. Eating when tired usually leads to high-carb, high-sugar choices because your brain wants quick energy.',
              actions: ['If possible: a 20-minute nap is more effective than eating', 'If you must eat: choose protein + fat, NOT sugar (it\u2019ll spike and crash harder when tired)', 'Splash cold water on your face or step outside for 2 minutes', 'Plan for better sleep tonight \u2014 this is the root cause'],
              why: 'Sleep debt is cumulative. One night of <6 hours increases next-day calorie intake by ~300 calories on average, almost entirely from snacking.'
            }
          }
        },
        unsure: {
          question: 'Let\u2019s figure it out. Try this body scan:',
          isBodyScan: true,
          steps: [
            { prompt: 'Close your eyes and take 3 deep breaths.', duration: 8 },
            { prompt: 'Put your hand on your stomach. Is there any physical sensation? Growling, emptiness, gnawing?', duration: 10 },
            { prompt: 'Think about a plain, boring food \u2014 like steamed broccoli or plain chicken. Would you eat it right now?', duration: 8 },
            { prompt: 'Now think about your favorite indulgent food. Does the desire feel different? Stronger? More emotional?', duration: 8 }
          ],
          afterScan: [
            { id: 'physical_yes', label: 'I felt physical stomach signals \u2014 I\u2019m hungry', icon: '&#9989;' },
            { id: 'would_eat_boring', label: 'I\u2019d eat the plain food \u2014 probably real hunger', icon: '&#127793;' },
            { id: 'only_want_good', label: 'I only want the indulgent food \u2014 not real hunger', icon: '&#128161;' },
            { id: 'still_unsure', label: 'I\u2019m still not sure', icon: '&#129300;' }
          ],
          responses: {
            physical_yes: {
              title: 'That\u2019s real hunger \u2014 eat',
              body: 'Your body is giving you clear physical signals. Trust them. After GLP-1, your appetite signals are recalibrating \u2014 but the physical signals (growling, emptiness) don\u2019t lie.',
              actions: ['Eat a meal or substantial snack with protein', 'Eat at a table, slowly, without screens', 'Check in after: aim for fullness level 3 (satisfied, not stuffed)'],
              why: 'Physical hunger signals originate in the gut and hypothalamus. They\u2019re distinct from cravings, which originate in reward centers.'
            },
            would_eat_boring: {
              title: 'Likely real hunger',
              body: 'The "boring food test" is one of the most reliable ways to distinguish real hunger from cravings. If you\u2019d eat plain food, your body needs fuel. Go eat \u2014 choose something nutritious.',
              actions: ['Have a balanced meal or snack', 'Don\u2019t overthink the choice \u2014 protein + anything is a good default', 'Note the time \u2014 this helps you learn your natural hunger rhythms'],
              why: 'Hedonic hunger is food-specific (you want THAT thing). Physical hunger is food-general (you\u2019d eat anything). This distinction is a key skill for long-term maintenance.'
            },
            only_want_good: {
              title: 'This is a craving, not hunger',
              body: 'Your body doesn\u2019t need fuel right now \u2014 your brain wants a specific food experience. That\u2019s completely normal and nothing to feel guilty about. The skill is recognizing it and choosing your response.',
              actions: ['Wait 10\u201315 minutes \u2014 most cravings pass on their own', 'Change your environment (different room, go outside, call someone)', 'If you decide to eat it anyway, do it deliberately: plate it, sit down, savor it', 'Log the craving \u2014 noticing patterns is more valuable than fighting them'],
              why: 'Cravings peak at about 5\u20137 minutes and almost always fade within 15. The urge feels permanent but it\u2019s not.',
              showTimer: true
            },
            still_unsure: {
              title: 'When in doubt, wait 15 minutes',
              body: 'Uncertainty about hunger is common, especially as your body adjusts after GLP-1 and signals are still recalibrating. The safest approach: wait a short time and check again. If you\u2019re still thinking about food in 15 minutes, eat something with protein.',
              actions: ['Set a 15-minute timer', 'Drink a glass of water (mild dehydration mimics hunger)', 'Do something mildly engaging (walk, small task)', 'If still hungry in 15 min, eat \u2014 don\u2019t second-guess it'],
              why: 'Building hunger awareness is a skill that improves with practice. Every time you pause and check in, you\u2019re strengthening the neural pathways for interoception (body awareness).',
              showTimer: true
            }
          }
        },
        unusual_time: {
          question: 'When is this happening?',
          options: [
            { id: 'late_night', label: '&#127769; Late night (after 9pm)', desc: 'Bedtime snacking urge' },
            { id: 'afternoon', label: '&#9728; Mid-afternoon (2\u20135pm)', desc: 'The afternoon slump' },
            { id: 'early_morning', label: '&#127748; Very early morning', desc: 'Hunger before your usual time' },
            { id: 'right_after', label: '&#128260; Right after exercising', desc: 'Post-workout hunger' }
          ],
          responses: {
            late_night: {
              title: 'Nighttime hunger \u2014 usually not physical',
              body: 'Late-night eating is rarely driven by physical hunger. It\u2019s usually a combination of habit, fatigue (ghrelin rises when tired), stress wind-down, and reduced willpower at the end of the day. Your CGM will show that late-night eating raises overnight glucose, disrupting sleep quality.',
              actions: ['Brush your teeth \u2014 this signals "kitchen is closed" to your brain', 'Herbal tea (warm liquid satisfies the ritual without the calories)', 'If genuinely hungry: a small protein snack (turkey roll-ups, cottage cheese)', 'Set a "kitchen closes at 8pm" rule for 1 week and track how it feels'],
              why: 'Eating within 2\u20133 hours of sleep raises overnight glucose by 10\u201320 mg/dL and reduces sleep quality. Poor sleep then raises next-day hunger \u2014 creating a cycle.'
            },
            afternoon: {
              title: 'The 3pm slump is circadian, not a character flaw',
              body: 'Between 2\u20134pm, your circadian rhythm triggers a natural dip in alertness and blood sugar. This is biological, not a sign of poor habits. Most people reach for sugar or caffeine \u2014 but there\u2019s a better approach.',
              actions: ['A protein snack at 2:30pm BEFORE the slump hits (prevention > reaction)', 'A 10-minute walk outside \u2014 light and movement reset your circadian clock', 'If you need caffeine, have it before 2pm so it doesn\u2019t disrupt tonight\u2019s sleep', 'Afternoon hunger often means lunch wasn\u2019t enough protein \u2014 aim for 30g+ at lunch'],
              why: 'The post-lunch circadian dip is driven by your suprachiasmatic nucleus. It happens regardless of what you ate. Planning for it is smarter than fighting it.'
            },
            early_morning: {
              title: 'Early hunger can mean your metabolism is waking up',
              body: 'If you\u2019re newly experiencing morning hunger after your GLP-1 transition, this is often a sign of metabolic recovery. Your hunger hormones are recalibrating to a normal rhythm \u2014 this is progress, not a problem.',
              actions: ['Eat when you feel hungry \u2014 don\u2019t force yourself to wait', 'Make breakfast protein-heavy (eggs, Greek yogurt, protein shake)', 'This is a good time to eat your most balanced meal of the day', 'Track the pattern \u2014 if it\u2019s consistent for a week, adjust your meal schedule'],
              why: 'Morning hunger correlates with healthy ghrelin cycling. The absence of morning hunger (which was common on GLP-1) often meant appetite suppression was too strong.'
            },
            right_after: {
              title: 'Post-workout hunger is your body rebuilding',
              body: 'Exercise depletes glycogen and creates micro-tears in muscle. Your body needs protein and carbs to repair and grow. Post-workout hunger is one of the most "legitimate" hunger signals you\u2019ll get.',
              actions: ['Eat within 30\u201360 minutes of finishing (the recovery window)', 'Prioritize protein: 20\u201330g to support muscle repair', 'Include some carbs \u2014 your muscles need glycogen replenishment', 'Don\u2019t restrict here \u2014 underfueling after exercise costs muscle and slows recovery'],
              why: 'The post-exercise anabolic window is real. Protein synthesis increases 50\u2013100% for 24\u201348 hours after resistance training. Fueling this process is essential for body composition.'
            }
          }
        },
        about_to_eat: {
          question: 'Great \u2014 let\u2019s set you up for a satisfying meal. What\u2019s your hunger level right now?',
          options: [
            { id: 'low', label: '&#128528; 1\u20132: Not really hungry', desc: 'Eating by schedule or socially' },
            { id: 'sweet_spot', label: '&#127793; 3: Comfortably hungry', desc: 'The ideal time to eat' },
            { id: 'high', label: '&#128293; 4\u20135: Very hungry / starving', desc: 'Need to eat now' }
          ],
          responses: {
            low: {
              title: 'Eating when not hungry \u2014 here\u2019s how to do it right',
              body: 'During your GLP-1 transition, appetite can fluctuate \u2014 some days you may not feel hungry at all. Structured eating protects your muscle and metabolism. The key is eating enough of the right things, even when your body isn\u2019t asking.',
              actions: ['Eat a smaller meal but make it protein-dense (30g+ protein)', 'Don\u2019t skip \u2014 under-eating on medication leads to lean mass loss over time', 'Eat slowly and check in halfway \u2014 even small meals can build fullness awareness', 'Set a post-meal check-in: come back in 30 minutes and rate your fullness'],
              why: 'Even without hunger signals, your muscles, brain, and metabolism still need fuel. Structured meals maintain metabolic rate and protect the lean mass that keeps you healthy long-term.',
              showMealTimer: true
            },
            sweet_spot: {
              title: 'You\u2019re at the perfect hunger level',
              body: 'Hunger level 3 is where the magic happens. You\u2019re hungry enough to enjoy your food, but not so hungry that you\u2019ll eat too fast or too much. This is the skill you\u2019re building.',
              actions: ['Lead with protein \u2014 eat it first on your plate', 'Add a vegetable or fiber source for volume and nutrients', 'Set a 20-minute meal pace \u2014 slow enough for fullness signals to arrive', 'Aim to stop at fullness 3\u20134 (satisfied, not stuffed)', 'After finishing, wait 10 minutes before deciding if you want more'],
              why: 'Eating at hunger level 3 gives you executive control over food choices. At level 4\u20135, your brain shifts to survival mode and overrides rational decision-making.',
              showMealTimer: true
            },
            high: {
              title: 'You\u2019re very hungry \u2014 let\u2019s manage this meal',
              body: 'At this hunger level, your brain is pushing you toward fast, calorie-dense food. That\u2019s biology, not weakness. The good news: with a few small strategies, you can still eat a satisfying meal without overshooting.',
              actions: ['Drink a full glass of water before you start eating', 'Put protein on your plate first and eat it before anything else', 'Eat slowly \u2014 set your fork down between bites for the first 5 minutes', 'Serve yourself a normal portion; you can always have more after 15 minutes', 'Next time: try to eat 30\u201360 minutes earlier to catch yourself at a 3'],
              why: 'Level 4\u20135 hunger triggers ghrelin surges that override your prefrontal cortex. Slowing down and starting with protein are the two most effective buffers.',
              showMealTimer: true
            }
          }
        },
        post_meal: {
          question: 'How do you feel after eating?',
          options: [
            { id: 'still_hungry', label: '&#128533; Still hungry \u2014 want more', desc: 'The meal didn\u2019t satisfy me' },
            { id: 'just_right', label: '&#128154; Satisfied \u2014 just right', desc: 'Comfortable and content' },
            { id: 'too_full', label: '&#129396; Too full \u2014 overdid it', desc: 'Ate more than I needed' },
            { id: 'not_sure', label: '&#129300; Can\u2019t tell yet', desc: 'Need a few more minutes' }
          ],
          responses: {
            still_hungry: {
              followUp: 'post_meal_hungry'
            },
            just_right: {
              title: 'That\u2019s the target \u2014 well done',
              body: 'Landing at satisfied means you read your hunger, ate the right amount, and stopped before excess. This is the satiety skill in action. Every meal like this strengthens the neural pathways for interoception \u2014 your ability to read your own body.',
              actions: ['Note what you ate \u2014 this meal composition works for you', 'Check in again in 2\u20133 hours to see how long the fullness lasts', 'If it keeps you full for 3+ hours, this is your template meal', 'Celebrate the win \u2014 consistency here is what builds lasting habits'],
              why: 'Fullness level 3 correlates with the best long-term outcomes: sustained energy, stable glucose, and no compensatory overeating later.',
              trackStrategy: true
            },
            too_full: {
              title: 'Overshooting happens \u2014 here\u2019s what to learn from it',
              body: 'Feeling overly full isn\u2019t a failure \u2014 it\u2019s data. Something about this meal went past comfortable. The goal isn\u2019t perfection; it\u2019s building awareness so you can adjust next time.',
              actions: ['Don\u2019t compensate by skipping your next meal \u2014 that starts a restrict-binge cycle', 'Think about what happened: did you eat too fast? Was the portion too large? Were you distracted?', 'A gentle walk (10\u201315 minutes) can help with both glucose and physical comfort', 'Next meal: try serving 75% of what you normally would, then pause before adding more'],
              why: 'The restrict-compensate cycle is one of the biggest risks post-GLP-1. Treating overeating as information (not punishment) is the mindset that prevents spiraling.',
              trackStrategy: true
            },
            not_sure: {
              title: 'Give it 15 minutes',
              body: 'Fullness signals travel via the vagus nerve and take 15\u201320 minutes to register. You may have eaten exactly the right amount \u2014 your brain just hasn\u2019t caught up yet. This is completely normal.',
              actions: ['Set a 15-minute timer and do something non-food-related', 'Drink some water \u2014 this helps activate stretch receptors', 'When the timer goes off, rate your fullness on the 1\u20135 scale', 'Come back and tell me how you feel'],
              why: 'The vagus nerve is a slow communicator. Learning to pause and wait for the signal is one of the most valuable satiety skills you can develop.',
              showTimer: true
            }
          }
        },
        post_meal_hungry: {
          question: 'What did your meal look like?',
          options: [
            { id: 'low_protein', label: '&#127834; Mostly carbs, not much protein', desc: 'Rice, bread, pasta, cereal' },
            { id: 'small_portion', label: '&#129371; Small or light meal', desc: 'Might not have been enough food' },
            { id: 'ate_fast', label: '&#9889; Ate pretty quickly', desc: 'Finished in under 10 minutes' },
            { id: 'balanced_meal', label: '&#127860; Had protein, veggies, and carbs', desc: 'A balanced meal but still hungry' }
          ],
          responses: {
            low_protein: {
              title: 'Your meal was missing its anchor',
              body: 'Carb-heavy meals spike blood sugar fast but crash just as quickly, leaving you hungry again within 45\u201360 minutes. Protein is the single most satiating macronutrient \u2014 it triggers fullness hormones (CCK, PYY, GLP-1) that carbs alone don\u2019t.',
              actions: ['Have a small protein snack now: Greek yogurt, handful of nuts, string cheese', 'For your next meal: eat 25\u201330g protein FIRST, before touching carbs', 'Build the habit: "protein on the plate first" is your most powerful satiety tool', 'Check your CGM \u2014 you\u2019ll likely see a spike-crash pattern from this meal'],
              why: 'Protein takes 4\u20135 hours to digest vs. 1\u20132 hours for simple carbs. It\u2019s the difference between sustained fullness and a hunger rollercoaster.',
              trackStrategy: true
            },
            small_portion: {
              title: 'You may simply need more food',
              body: 'During GLP-1 transition, it\u2019s common to under-eat as appetite fluctuates. But your body still needs adequate fuel for muscle preservation and metabolic health. If you\u2019re consistently hungry after meals, your portions may be too small.',
              actions: ['Have an additional serving now, prioritizing protein', 'Track this: if it happens 3+ times this week, your baseline portions need adjusting', 'Aim for meals that keep you satisfied for 3\u20134 hours', 'Don\u2019t be afraid to eat more \u2014 under-eating is as problematic as overeating for long-term health'],
              why: 'Chronic under-eating reduces resting metabolic rate by 10\u201315% and accelerates lean mass loss. Your body adapts to restriction by burning less.',
              trackStrategy: true
            },
            ate_fast: {
              title: 'Your brain didn\u2019t have time to catch up',
              body: 'Eating in under 10 minutes means you finished before your fullness signals even started. The food is in your stomach, but the satiety cascade hasn\u2019t fired yet. Wait 15 minutes \u2014 you may feel very different.',
              actions: ['Wait 15 minutes before eating anything else', 'Next meal: set a 20-minute timer and pace yourself', 'Try putting your fork down between bites for the first 5 minutes', 'Eating with others, without screens, naturally slows your pace'],
              why: 'Studies show eating the same meal over 30 minutes vs. 5 minutes increases fullness hormone release by 25\u201330% and reduces total intake by ~12%.',
              showTimer: true,
              trackStrategy: true
            },
            balanced_meal: {
              title: 'Sometimes your body just needs more',
              body: 'If you ate a balanced meal and still feel hungry after 20+ minutes, this is likely genuine physiological hunger. Your body may be in a higher-demand period \u2014 especially if you\u2019re exercising more, sleeping less, or adjusting to life after GLP-1.',
              actions: ['Have an additional protein-rich serving \u2014 trust the signal', 'Note what you ate and the portion sizes for pattern tracking', 'Check if your activity level increased recently \u2014 more movement = more fuel needed', 'If this happens daily, consider increasing your meal sizes by 15\u201320%'],
              why: 'Real hunger after a balanced meal is information. Your body is communicating a need. Responding to it \u2014 rather than ignoring it \u2014 is the foundation of intuitive eating.',
              trackStrategy: true
            }
          }
        },
        hunger_changing: {
          question: 'What feels different about your hunger?',
          options: [
            { id: 'more_hungry', label: '&#128200; I\u2019m hungrier than before', desc: 'Appetite is increasing' },
            { id: 'less_hungry', label: '&#128201; I\u2019m less hungry than expected', desc: 'Appetite is very low' },
            { id: 'unpredictable', label: '&#127754; It comes and goes in waves', desc: 'Some days starving, some days nothing' },
            { id: 'different_type', label: '&#129300; The hunger feels different', desc: 'It\u2019s a different sensation than before' }
          ],
          responses: {
            more_hungry: {
              title: 'Increasing hunger is expected \u2014 and it\u2019s not permanent',
              body: 'As GLP-1 medication changes (tapering, switching, or stopping), the appetite suppression effect fades. Your ghrelin levels temporarily overshoot their new baseline before settling. This "rebound hunger" typically peaks 2\u20134 weeks after a dose change and then normalizes.<br><br>This is <strong>not</strong> you losing control. This is your body\u2019s hormonal system recalibrating. The habits you\u2019re building in this program are specifically designed to carry you through this phase.',
              actions: ['Increase meal protein to 30g+ per meal to maximize satiety', 'Eat on schedule even if hunger feels unpredictable \u2014 structure prevents spiraling', 'Add fiber and volume to meals (large salads, roasted vegetables, soup)', 'Track your hunger scores daily \u2014 you\u2019ll see the normalization happen over 2\u20134 weeks', 'Be compassionate with yourself \u2014 this is the hardest part and it\u2019s temporary'],
              why: 'Ghrelin rebound after GLP-1 discontinuation typically resolves within 4\u20138 weeks. During this period, the protein + fiber + structure trifecta is your strongest defense.'
            },
            less_hungry: {
              title: 'Low appetite \u2014 protect your foundation',
              body: 'Very low appetite is common during GLP-1 transition, especially as your body adjusts. While it might feel like a non-issue, it poses a real risk: under-eating leads to muscle loss, metabolic slowdown, and nutrient deficiencies that create problems later.',
              actions: ['Eat at least 3 structured meals per day, even if portions are small', 'Prioritize protein at every meal \u2014 it\u2019s the most important thing to protect muscle', 'Protein shakes can help when solid food feels unappealing', 'Track your weight alongside protein intake \u2014 rapid loss usually means muscle loss too', 'Don\u2019t celebrate extreme appetite suppression \u2014 it\u2019s not the goal'],
              why: 'Losing weight too fast (>1% body weight per week) significantly increases the ratio of lean mass lost. Adequate protein (1.2\u20131.6g per kg body weight) is the primary defense.'
            },
            unpredictable: {
              title: 'Hunger waves are your body finding its new normal',
              body: 'Fluctuating hunger \u2014 starving one day, nothing the next \u2014 is common during medication transitions. Your hypothalamus is adjusting its appetite thermostat, and the process isn\u2019t linear. Some days ghrelin overshoots, other days it undershoots.',
              actions: ['Eat on a consistent schedule regardless of hunger level \u2014 this anchors your circadian eating rhythm', 'On high-hunger days: increase protein and fiber, add an extra snack', 'On low-hunger days: eat smaller portions but don\u2019t skip meals', 'Log your hunger daily \u2014 patterns will emerge (often tied to sleep, stress, or exercise)', 'The waves will smooth out over 3\u20136 weeks'],
              why: 'Circadian eating (meals at consistent times) helps stabilize ghrelin cycling. Your body learns when to expect food and adjusts hunger signals accordingly.'
            },
            different_type: {
              title: 'You\u2019re developing hunger literacy',
              body: 'Noticing that hunger feels different is actually a sign of progress \u2014 your awareness is sharpening. While on GLP-1, many people only experienced a muted "I should eat" signal. As medication changes, you may start feeling true stomach hunger, mouth hunger, or emotional hunger for the first time in months or years.',
              actions: ['Use the 5 types of hunger framework: stomach, mouth, eye, heart, habit', 'When you feel hungry, pause and ask: "Where is this coming from?"', 'Physical (stomach) hunger builds gradually and is satisfied by any food', 'Non-physical hunger is sudden, specific, and often triggered by an emotion or environment', 'Check out "Teach me about hunger" for a deep dive on the 5 types'],
              why: 'Hunger literacy \u2014 the ability to identify and respond to different types of hunger \u2014 is the single most protective skill for long-term weight maintenance.'
            }
          }
        }
      };
      var TOTAL_BLOCKS = 8;
      var TOTAL_WEEKS = 16;
      function blockToWeeks(b) { return [b * 2 - 1, b * 2]; }
      function weekToBlock(w) { return Math.ceil(w / 2); }
      var CGM_BLOCKS = { 1: true, 2: false, 3: true, 4: false, 5: false, 6: true, 7: false, 8: true };
      var CGM_SCHEDULE = {};
      for (var _b = 1; _b <= TOTAL_BLOCKS; _b++) { var _wks = blockToWeeks(_b); CGM_SCHEDULE[_wks[0]] = !!CGM_BLOCKS[_b]; CGM_SCHEDULE[_wks[1]] = !!CGM_BLOCKS[_b]; }
      var CGM_PERIODS = [
        { id: 1, block: 1, label: 'CGM 1: Baseline', weeks: [1, 2], purpose: 'Learn your glucose patterns and establish baseline data' },
        { id: 2, block: 3, label: 'CGM 2: Movement', weeks: [5, 6], purpose: 'See how walking and resistance training change your glucose' },
        { id: 3, block: 6, label: 'CGM 3: Validation', weeks: [11, 12], purpose: 'Validate your full system is working' },
        { id: 4, block: 8, label: 'CGM 4: Graduation', weeks: [15, 16], purpose: 'Final assessment \u2014 prove it with data' }
      ];
      function isCGMWeek(wk) { return !!CGM_SCHEDULE[wk]; }
      function isCGMBlock(b) { return !!CGM_BLOCKS[b]; }
      function getCGMPeriod(wk) { for (var i = 0; i < CGM_PERIODS.length; i++) { if (CGM_PERIODS[i].weeks.indexOf(wk) >= 0) return CGM_PERIODS[i]; } return null; }
      function getNextCGMWeek(wk) { for (var w = wk + 1; w <= 16; w++) { if (CGM_SCHEDULE[w]) return w; } return null; }
      function getNextCGMBlock(b) { for (var i = b + 1; i <= TOTAL_BLOCKS; i++) { if (CGM_BLOCKS[i]) return i; } return null; }
      function getLastCGMPeriod(wk) { for (var i = CGM_PERIODS.length - 1; i >= 0; i--) { if (CGM_PERIODS[i].weeks[1] < wk) return CGM_PERIODS[i]; } return null; }

      var BLOCK_MILESTONES = {
        1: 'Baseline & Learn Your Glucose',
        2: 'Nutrition Foundation',
        3: 'Movement & CGM Proof',
        4: 'Full System Build',
        5: 'Personalized Focus',
        6: 'Validation & CGM Check',
        7: 'Refinement & Stress Test',
        8: 'Graduation'
      };
      var GRADUATION_MILESTONES = {};
      for (var _mb = 1; _mb <= TOTAL_BLOCKS; _mb++) { var _mw = blockToWeeks(_mb); GRADUATION_MILESTONES[_mw[0]] = BLOCK_MILESTONES[_mb]; GRADUATION_MILESTONES[_mw[1]] = BLOCK_MILESTONES[_mb]; }

      var BLOCK_GOALS = {
        1: { title: 'Baseline & Learn Your Glucose', desc: 'Your first CGM sensor is on for 2 weeks. Don\u2019t change anything \u2014 just observe. Learn to read your glucose graph: what causes spikes? What keeps you stable? Notice your hunger patterns, activity level, and sleep. By the end of this block, you\u2019ll have a full personal baseline to measure all future progress against.', metric: 'Log meals, sleep, and hunger daily \u2014 review CGM after each meal', cgm: true },
        2: { title: 'Protein + Fiber Foundation', desc: 'CGM is off. Build your nutrition foundation over 2 weeks. Week 1: include protein at every meal (25g+). Week 2: add fiber \u2014 one extra serving of vegetables or fiber-rich food per day. Pair them together for maximum satiety. Use your hunger check-ins as your data source.', metric: '25g+ protein per meal, +1 fiber serving/day', cgm: false },
        3: { title: 'Movement & CGM Proof', desc: 'Your second CGM sensor goes on. This block is all about movement. Add a 10\u201315 minute walk after meals and start 2 strength training sessions per week. Watch your CGM \u2014 see how walking blunts spikes by 20\u201330 mg/dL and how resistance training improves glucose for 24\u201348 hours. Compare your data to your Block 1 baseline.', metric: '7,000+ steps/day, 2 strength sessions/wk \u2014 compare CGM 2 to CGM 1', cgm: true },
        4: { title: 'Satiating Meals + Sleep & Stress', desc: 'CGM is off. Put it all together: protein + fiber + healthy fat + volume. Practice building meals that keep you full for 3\u20134 hours. Then add sleep consistency \u2014 same bedtime within 30 minutes. Add one stress management tool. This is your full system without CGM training wheels.', metric: 'Build balanced meals 5+ days, consistent bedtime 5/7 nights', cgm: false },
        5: { title: 'Your Personalized Focus', desc: 'Complete the post-block-4 check-in to unlock your personalized focus. Signos will show where your scores lag and you\u2019ll choose your deep-dive topic. Spend 2 weeks going deeper on what you need most while keeping all foundation habits running.', metric: 'Complete check-in, choose focus, maintain all habits', cgm: false },
        6: { title: 'Validation & CGM Check', desc: 'Your third CGM sensor goes on. This is your validation check \u2014 compare your glucose to CGM 1 (baseline) and CGM 2 (movement). Are your habits holding? Handle a disruption (travel, social meal, busy day) with CGM on \u2014 see how your system holds under pressure.', metric: 'Compare CGM 3 to CGM 1 & 2, navigate 1+ disruption', cgm: true },
        7: { title: 'Refinement & Stress Test', desc: 'CGM is off. Refine your approach based on what CGM 3 revealed. What meals work best? What time of day do you struggle most? Build your "minimum viable day" plan \u2014 the baseline you maintain no matter what. Fine-tune for real life: hard days, travel, social events.', metric: 'Fix 2 weak spots, create minimum viable day plan', cgm: false },
        8: { title: 'Graduation', desc: 'Your final CGM sensor goes on. This is your graduation assessment. Run your full system for 2 weeks with CGM data. Compare to your very first baseline from Block 1. The difference is the proof that your habits work. If you\u2019ve met your graduation criteria \u2014 congratulations.', metric: 'All criteria met \u2014 graduate', cgm: true }
      };
      var WEEKLY_GOALS = {};
      for (var _gb = 1; _gb <= TOTAL_BLOCKS; _gb++) { var _gw = blockToWeeks(_gb); WEEKLY_GOALS[_gw[0]] = BLOCK_GOALS[_gb]; WEEKLY_GOALS[_gw[1]] = BLOCK_GOALS[_gb]; }

      var BLOCK_EDUCATION = {
        1: { focus: ['glucose_cgm', 'hunger'], modules: ['cgm_basics', 'glp1_basics', 'patterns_101', 'hunger_basics', 'hunger_signals', 'understanding_fullness', 'protein_anchor_p1', 'meal_structure'] },
        2: { focus: ['nutrition', 'hunger'], modules: ['protein_muscle', 'fullness_signals', 'fiber_intro', 'gi_comfort', 'appetite_return', 'hunger_medication'] },
        3: { focus: ['exercise', 'glucose_cgm'], modules: ['post_meal_move', 'post_meal_walk', 'resistance_first', 'strength_taper', 'recovery_p1', 'cgm_transition', 'pairing_glucose'] },
        4: { focus: ['nutrition', 'sleep', 'stress', 'hunger'], modules: ['satiety_playbook', 'satiety_skill', 'carb_strategy', 'hydration_p1', 'sleep_consistency_p1', 'sleep_taper', 'stress_glucose_p1', 'stress_taper', 'hydration_p2'] }
      };
      var WEEKLY_EDUCATION = {};
      for (var _eb = 1; _eb <= 4; _eb++) { var _ew = blockToWeeks(_eb); WEEKLY_EDUCATION[_ew[0]] = BLOCK_EDUCATION[_eb]; WEEKLY_EDUCATION[_ew[1]] = BLOCK_EDUCATION[_eb]; }

      var BLOCK_TOPICS = {
        baseline_cgm:  { goal: BLOCK_GOALS[1], edu: BLOCK_EDUCATION[1], milestone: 'Baseline & Glucose', fixed: true },
        nutrition:     { goal: BLOCK_GOALS[2], edu: BLOCK_EDUCATION[2], milestone: 'Nutrition Foundation' },
        movement_cgm:  { goal: BLOCK_GOALS[3], edu: BLOCK_EDUCATION[3], milestone: 'Movement & CGM', fixed: true },
        full_system:   { goal: BLOCK_GOALS[4], edu: BLOCK_EDUCATION[4], milestone: 'Full System Build' }
      };
      var WEEK_TOPICS = BLOCK_TOPICS;
      var DEFAULT_BLOCK_ORDER = ['baseline_cgm', 'nutrition', 'movement_cgm', 'full_system'];
      var DEFAULT_WEEK_ORDER = DEFAULT_BLOCK_ORDER;

      var STRUGGLE_OPTIONS = [
        { id: 'portion_control', icon: '&#127860;', label: 'Portion control', desc: 'Eating too much or not knowing when to stop' },
        { id: 'emotional_eating', icon: '&#128546;', label: 'Emotional / stress eating', desc: 'Eating when stressed, anxious, or upset' },
        { id: 'late_night', icon: '&#127769;', label: 'Late-night snacking', desc: 'Eating after dinner or before bed' },
        { id: 'low_activity', icon: '&#128564;', label: 'Low activity / exercise', desc: 'Sedentary lifestyle, not enough movement' },
        { id: 'poor_sleep', icon: '&#128164;', label: 'Poor sleep', desc: 'Inconsistent bedtime, not enough rest' },
        { id: 'sugar_cravings', icon: '&#127852;', label: 'Sugar & carb cravings', desc: 'Can\u2019t resist sweets or starchy foods' },
        { id: 'glucose_confusion', icon: '&#128200;', label: 'Understanding my glucose', desc: 'Not sure how to read or use my CGM data' },
        { id: 'inconsistent_meals', icon: '&#128336;', label: 'Inconsistent meals', desc: 'Skipping meals or eating at random times' },
        { id: 'low_protein', icon: '&#129385;', label: 'Not enough protein', desc: 'Meals are mostly carbs, low protein' },
        { id: 'staying_full', icon: '&#129368;', label: 'Staying full / satisfied', desc: 'Meals don\u2019t keep me full long enough' },
        { id: 'stress', icon: '&#129504;', label: 'Chronic stress', desc: 'High baseline stress, no coping tools' },
        { id: 'no_strength', icon: '&#127947;', label: 'No strength / resistance training', desc: 'Not doing any resistance or weight training' }
      ];

      var REASON_OFF_GLP1 = [
        { id: 'cost', label: 'Cost / insurance', icon: '&#128176;' },
        { id: 'side_effects', label: 'Side effects', icon: '&#129298;' },
        { id: 'reached_goal', label: 'Reached my goal weight', icon: '&#127942;' },
        { id: 'doctor', label: 'Doctor recommended', icon: '&#129657;' },
        { id: 'try_without', label: 'Want to try without it', icon: '&#128170;' },
        { id: 'pregnancy', label: 'Pregnancy / planning', icon: '&#128118;' },
        { id: 'other', label: 'Other', icon: '&#10067;' }
      ];

      var STRUGGLE_TO_TOPIC = {
        portion_control: ['full_system', 'nutrition'],
        emotional_eating: ['full_system', 'nutrition'],
        late_night: ['full_system', 'nutrition'],
        low_activity: ['nutrition', 'full_system'],
        poor_sleep: ['full_system', 'nutrition'],
        sugar_cravings: ['nutrition', 'full_system'],
        glucose_confusion: ['nutrition', 'full_system'],
        inconsistent_meals: ['nutrition', 'full_system'],
        low_protein: ['nutrition', 'full_system'],
        staying_full: ['nutrition', 'full_system'],
        stress: ['full_system', 'nutrition'],
        no_strength: ['nutrition', 'full_system']
      };

      function buildPersonalizedWeekOrder(struggles) {
        if (!struggles || struggles.length === 0) return DEFAULT_BLOCK_ORDER.slice();
        var topicPriority = {};
        var movable = ['nutrition', 'full_system'];
        movable.forEach(function(t) { topicPriority[t] = 0; });
        struggles.forEach(function(s, idx) {
          var mapped = STRUGGLE_TO_TOPIC[s];
          if (!mapped) return;
          var weight = struggles.length - idx;
          mapped.forEach(function(topic, ti) {
            if (movable.indexOf(topic) < 0) return;
            topicPriority[topic] = (topicPriority[topic] || 0) + weight * (ti === 0 ? 2 : 1);
          });
        });
        var sorted = movable.slice().sort(function(a, b) { return (topicPriority[b] || 0) - (topicPriority[a] || 0); });
        return ['baseline_cgm', sorted[0], 'movement_cgm', sorted[1]];
      }

      function getBlockTopic(blockNum) {
        if (blockNum >= 5) return null;
        var order = (state.weekOrder && state.weekOrder.length === 4) ? state.weekOrder : DEFAULT_BLOCK_ORDER;
        var topicId = order[blockNum - 1];
        return topicId ? BLOCK_TOPICS[topicId] : null;
      }
      function getWeekTopic(weekNum) { return getBlockTopic(weekToBlock(weekNum)); }
      function pBlockGoal(b) {
        if (b >= 5) return BLOCK_GOALS[b] || BLOCK_GOALS[5];
        var t = getBlockTopic(b);
        return t ? t.goal : (BLOCK_GOALS[b] || BLOCK_GOALS[1]);
      }
      function pWeekGoal(wk) { return pBlockGoal(weekToBlock(wk)); }
      function pBlockEdu(b) {
        if (b >= 5) return null;
        var t = getBlockTopic(b);
        return t ? t.edu : (BLOCK_EDUCATION[b] || null);
      }
      function pWeekEdu(wk) { return pBlockEdu(weekToBlock(wk)); }
      function pBlockMilestone(b) {
        if (b >= 5) return BLOCK_MILESTONES[b] || '';
        var t = getBlockTopic(b);
        return t ? t.milestone : (BLOCK_MILESTONES[b] || '');
      }
      function pWeekMilestone(wk) { return pBlockMilestone(weekToBlock(wk)); }

      var FOCUS_AREA_OPTIONS = {
        nutrition: { title: 'Nutrition & Meal Building', desc: 'Go deeper on meal construction, flexible restraint, carb pairing, and maintenance nutrition.', icon: '&#127860;', modules: ['maintenance_playbook', 'alcohol_maintenance', 'holidays_travel', 'carb_strategy'] },
        hunger: { title: 'Hunger & Satiety', desc: 'Master your hunger signals, emotional eating patterns, and advanced satiety strategies.', icon: '&#129368;', modules: ['satiety_mastery', 'hunger_vs_emotional', 'emotional_hunger', 'satiety_skill'] },
        exercise: { title: 'Exercise & Movement', desc: 'Periodization, progressive overload, NEAT optimization, and long-term training plans.', icon: '&#127939;', modules: ['long_term_strength', 'post_meal_maintenance', 'strength_taper', 'recovery_p1'] },
        sleep_stress: { title: 'Sleep & Stress', desc: 'Sleep architecture, allostatic load, HPA axis management, and daily stress tools.', icon: '&#128164;', modules: ['stress_sleep_glucose', 'stress_maintenance', 'sleep_taper', 'hydration_p2'] },
        glucose: { title: 'Glucose & CGM Mastery', desc: 'Drift detection, maintenance CGM strategy, fasting glucose trends, and variability analysis.', icon: '&#128200;', modules: ['drift_prevention', 'cgm_maintenance', 'weight_after_glp1', 'scale_during_transition'] },
        weight: { title: 'Weight & Maintenance', desc: 'Maintenance band, acceptable regain, scale interpretation, and the 3-step reset protocol.', icon: '&#9878;', modules: ['maintenance_band_education', 'weight_after_glp1', 'scale_during_transition', 'quick_reset', 'quick_reset_p3'] }
      };
      var GRADUATION_CRITERIA = [
        { label: 'Glucose GPA \u2265 3.5 for 3 weeks', key: 'glucose', threshold: 3.5, weeksNeeded: 3 },
        { label: 'Lifestyle GPA \u2265 3.0 for 3 weeks', key: 'lifestyle', threshold: 3.0, weeksNeeded: 3 },
        { label: 'Weight within maintenance band', key: 'weight', threshold: null, weeksNeeded: 2 },
        { label: 'Education \u2265 80% completed', key: 'education', threshold: 80, weeksNeeded: 1 }
      ];
      var PROGRAM_TABLE = {
        goal: PROGRAM_PRIMARY_GOAL,
        do: 'Consistent protein, meal structure, resistance training, post-meal walking, sleep consistency.',
        dont: 'Aggressive restriction, perfect glucose chasing, reactive dieting, all-or-nothing resets.',
        cgm: '4 sensor periods across 8 blocks: Block 1 (baseline) \u2192 Block 3 (movement) \u2192 Block 6 (validation) \u2192 Block 8 (graduation).',
        optimize: 'Build habits in early weeks, refine and stress-test in later weeks, graduate with confidence.'
      };
      var TOOLKIT_EDUCATION_SINGLE = {
        risks: { title: 'Common pitfalls', bullets: ['Under-eating (appetite may still be suppressed or fluctuating)', 'Lean mass loss (inadequate protein + no resistance training)', 'Reactive dieting when the scale moves', 'All-or-nothing mindset when things aren\u2019t perfect'] },
        nutrition: { title: 'Nutrition emphasis', bullets: ['Protein anchor: daily minimum at each meal', 'Structured meals even without hunger', 'Satiety skills: protein + fiber pairing', 'Flexible structure (80/20) for long-term success'] },
        exercise: { title: 'Exercise emphasis', bullets: ['Resistance training for lean mass preservation', 'Post-meal walking (10\u201315 min)', 'Daily steps/NEAT for energy expenditure', 'Exercise as preservation, not punishment'] },
        cgm: { title: 'CGM education', bullets: ['4 sensor periods (Blocks 1, 3, 6, 8) for targeted data', 'Compare each sensor to your Block 1 baseline', 'Off-CGM blocks build habits; on-CGM blocks validate them', 'Drift detection through periodic monitoring'] },
        sleepStress: { title: 'Sleep & stress', bullets: ['Sleep consistency supports hunger hormones', 'Stress raises cortisol and blood sugar', 'Recovery days are part of the plan', 'Five minutes of daily breathing beats weekly meditation'] },
        successMetrics: { title: 'Success metrics', bullets: ['Habit adoption and consistency', 'Weight within maintenance band (\u00b13\u20135%)', 'Glucose stability improving over time', 'Education completion \u226580%'] }
      };

      var DOSE_EVENT_TYPE = { DECREASED_DOSE: 'DECREASED_DOSE', SWITCHED_FORMULATION: 'SWITCHED_FORMULATION', STOPPED: 'STOPPED' };

      var COPY = {
        drift_alert: 'Trend rising. Here are 3 stabilizing actions: 1) Protein anchor at next meal 2) 15 min walk 3) Check sleep and stress.',
        safety_clinician: 'Encourage clinician involvement for any adverse symptoms.'
      };

      var EDUCATION_MODULES = [
        { module_id: 'glp1_basics', title: 'GLP-1 basics', estimated_time: 1 },
        { module_id: 'protein_muscle', title: 'Protein & muscle', estimated_time: 2 },
        { module_id: 'meal_structure', title: 'Meal structure', estimated_time: 1 },
        { module_id: 'cgm_basics', title: 'CGM basics', estimated_time: 1 },
        { module_id: 'appetite_return', title: 'Appetite return', estimated_time: 2 },
        { module_id: 'carb_strategy', title: 'Carb strategy', estimated_time: 2 },
        { module_id: 'satiety_playbook', title: 'Satiety playbook', estimated_time: 2 },
        { module_id: 'maintenance_playbook', title: 'Maintenance playbook', estimated_time: 3 },
        { module_id: 'drift_prevention', title: 'Drift prevention', estimated_time: 3 },
        { module_id: 'holidays_travel', title: 'Holidays & travel', estimated_time: 3 },
        { module_id: 'long_term_strength', title: 'Long-term strength plan', estimated_time: 3 },
        { module_id: 'quick_reset', title: 'Quick reset routine', estimated_time: 2 },
        { module_id: 'hunger_basics', title: 'What hunger actually is', estimated_time: 1 },
        { module_id: 'hunger_signals', title: 'Reading your hunger levels', estimated_time: 1 },
        { module_id: 'fullness_signals', title: 'Reading your fullness levels', estimated_time: 1 },
        { module_id: 'hunger_medication', title: 'How medication changes hunger', estimated_time: 2 },
        { module_id: 'emotional_hunger', title: 'Emotional vs. physical hunger', estimated_time: 2 },
        { module_id: 'satiety_skill', title: 'Satiety as a skill', estimated_time: 3 }
      ];
      var MODULE_BODIES = {

        /* ===== PHASE 1 — FOUNDATION (very basic, jargon-free) ===== */

        cgm_basics: 'You have a small sensor on your arm. It reads your blood sugar and shows it on your phone as a line that goes up and down throughout the day.\n\nAfter you eat, the line goes up. That is completely normal — your body is turning food into energy. After a while, the line comes back down. Some meals make it go up more than others, and that is okay. There are no "bad" numbers.\n\nYour only job this week is to glance at the line a few times a day and start noticing. Which meals make it spike high? Which ones keep it pretty flat? You do not need to do anything about it yet — just look and get curious.\n\nThink of the sensor like a weather app for your body. You check it, you notice patterns, and over time you learn what works for you.',

        glp1_basics: 'GLP-1 medications work by reducing appetite, stabilizing blood sugar, and making smaller meals feel satisfying. While you were on medication, it gave you a window where healthy habits were easier to build.\n\nNow that you are tapering or off medication, those effects are fading. Hunger is returning, glucose may be less stable, and meals that used to fill you up might not anymore. This is normal — your body is adjusting.\n\nThe good news: the habits you build during this program replace what the medication was doing. Protein keeps you fuller. Fiber slows digestion. Walking after meals helps glucose. Resistance training preserves muscle. Together, these tools give you what the medication provided — just through your own effort.\n\nWe do not give medication advice. Your doctor handles your dose and timing. Our job is to help you build a strong foundation of habits that carry you forward.',

        patterns_101: 'Now that you have been wearing your sensor for a bit, it is time to start noticing patterns. A pattern is just something that happens more than once.\n\nFor example, maybe cereal at breakfast makes your line spike high, but eggs and toast keep it pretty flat. That is a pattern. Or maybe your numbers are always better on days you take a walk after lunch. That is a pattern too.\n\nHere is what to watch for: check your graph about an hour after each meal. Did the line go up a lot or a little? How long before it came back down? You do not need to write anything down. Just notice.\n\nThe goal is curiosity, not perfection. Everyone is different. Some people spike from rice, others from bread. There is no single right answer — just what works for your body. Let the sensor teach you.',

        resistance_first: 'When you lose weight, your body can lose muscle along with fat. That is not what we want. The best way to tell your body to keep its muscle is to use it — and that means some kind of strength exercise.\n\nYou do not need a gym or heavy weights. Squats, push-ups, and simple band exercises all count. Even 20 minutes, two or three times a week, makes a real difference.\n\nWhy does muscle matter? It keeps you strong, protects your joints, and helps your body burn energy even when you are resting. Keeping your muscle now means better results later.\n\nDo not worry about doing it perfectly. The goal is just to start and be consistent. Pick a few movements you feel comfortable with and do them regularly. That is it. We will build from here.',

        post_meal_move: 'One of the easiest and most helpful habits you can start is a short walk after eating. Just 10 to 15 minutes of easy walking after a meal helps your body use the sugar from your food more smoothly.\n\nIt does not need to be fast or far. A slow stroll around your home, your block, or your office is plenty. The trick is timing — walking soon after you finish eating works best.\n\nThink of it like a "meal closer." You eat, you walk for a few minutes, and then you go about your day. It becomes automatic pretty quickly.\n\nThis habit is worth building now because it will be even more valuable later, when your medication changes. A post-meal walk is a simple tool that works every time, no matter what phase you are in.',

        meal_structure: 'Your medication might make you not hungry at all. That is normal. But skipping meals is not a good idea, even when you do not feel like eating.\n\nWhy? Because your body still needs fuel to keep your energy up and protect your muscles. And eating at regular times helps train your body into a routine that will matter a lot later when appetite comes back.\n\nMeal structure just means eating something at roughly the same times each day — breakfast, lunch, and dinner. The meals can be small. Even a few bites count. What matters is the routine.\n\nYou do not need to count anything or follow a complicated plan. Just eat three times a day, even if the portions are small. Think of it as practice — you are building a habit, not passing a test.',

        protein_anchor_p1: 'Here is one simple rule: try to include some protein every time you eat. Eggs at breakfast, chicken or beans at lunch, fish or yogurt at dinner — any source works.\n\nProtein does two important things. First, it helps protect your muscles while you are losing weight. Second, it keeps you feeling full longer than other foods.\n\nHow much? A palm-sized portion at each meal is a great starting point. You do not need to weigh or measure anything. If every meal has some protein in it, you are doing well.\n\nOne tip: when your appetite is low, eat the protein on your plate first. That way, even if you cannot finish everything, you got the most important part. This "protein first" habit is one of the best things you can build during this program.',

        fiber_intro: 'Fiber comes from plants — vegetables, fruits, beans, whole grains, nuts, and seeds. It helps with digestion, keeps your blood sugar steadier, and helps you feel full.\n\nSince your medication already slows digestion, adding a lot of fiber all at once can cause bloating or discomfort. So go slow. Maybe add one extra serving of vegetables a day, or try some oatmeal at breakfast.\n\nGood pairings: an apple with peanut butter, a salad with chicken, or some beans with rice. Combining fiber with protein keeps you satisfied longer and helps smooth out your blood sugar.\n\nThere is no rush. Just aim to eat a little more plants each week. Small, steady increases are the way to go. Your body will adjust, and you will feel the difference over time.',

        sleep_consistency_p1: 'Sleep affects everything — your hunger, your energy, your mood, and your blood sugar. When you do not sleep well, you tend to feel hungrier the next day and crave less healthy foods.\n\nThe single best sleep habit is a consistent schedule. Try to go to bed and wake up at roughly the same time every day, even on weekends. Your body works better when it knows what to expect.\n\nSome people notice their sleep changed while on GLP-1 medication — more vivid dreams or lighter sleep. As medication effects fade, sleep patterns often shift again. If that happens, it is not unusual. Mention it to your doctor if it bothers you.\n\nA few easy tips: dim the lights before bed, keep your room cool and dark, and put your phone down a little earlier. You do not need to change everything at once. Just pick one thing to try this week.',

        hydration_p1: 'Your medication can make you less thirsty, which means you might not drink enough water without realizing it. Not drinking enough can cause headaches, tiredness, and constipation.\n\nA simple goal: about 8 cups of water a day. But you do not need to count exactly. If your pee is pale yellow, you are doing fine. If it is dark, drink more.\n\nSince you might not feel thirsty, set up a routine. Have a glass when you wake up, one before each meal, and one before bed. Keeping a water bottle where you can see it helps a lot.\n\nIf plain water is boring, add lemon, cucumber, or try herbal tea. All of these count. Staying hydrated is one of the easiest things you can do, and it helps with almost everything else — energy, digestion, and how you feel overall.',

        stress_glucose_p1: 'Ever notice your blood sugar is higher on stressful days, even when you ate the same things? That is because stress makes your body release extra sugar into your blood. It is a leftover survival instinct.\n\nStress is not just big events. Work pressure, bad sleep, money worries, and even overdoing it at the gym all count. You cannot eliminate stress, but you can help your body handle it better.\n\nThree simple tools: take a few slow, deep breaths when you feel tense (even two minutes helps). Go for a short walk — movement helps your body process stress. And protect your sleep, because rest is one of the best stress-recovery tools there is.\n\nYou do not need a fancy routine. Just pick one of these and try it the next time you feel stressed. Small steps add up over time.',

        recovery_p1: 'Rest days are not lazy days — they are when your body actually gets stronger. Exercise creates tiny wear on your muscles, and rest is when the repair happens.\n\nIf you skip rest days, your body does not get a chance to recover. That leads to tiredness, soreness, and worse results over time.\n\nA good rest day can include light activity like a walk or some stretching. The key is to keep it easy — no hard workouts.\n\nIt is tempting to push harder when you are seeing results, but more is not always better. Two to three strength sessions per week with rest days in between is the plan that works. Trust the process and let your body recover.',

        protein_muscle: 'Think of protein as building blocks and exercise as the instruction manual. Together, they tell your body to keep its muscle while losing weight.\n\nWithout enough protein, your muscles do not have what they need to repair. Without exercise, your body has no reason to keep muscle around. You need both.\n\nThe good news: you do not need to be perfect. A palm-sized portion of protein at each meal, plus strength training two to three times a week, covers the basics. That is dramatically better than doing nothing.\n\nThese two habits — eating protein and doing some strength exercise — are the foundation that everything else in this program builds on. Get these right and the rest gets easier.',

        /* ===== PHASE 2 — TAPER / TRANSITION (intermediate) ===== */

        cgm_transition: 'While you were on GLP-1, your medication was quietly doing several things to keep your glucose stable. It slowed how fast food left your stomach (called gastric emptying), which meant sugar entered your blood gradually. It reduced your appetite, so meals were naturally smaller. And it helped your body clear sugar from the blood more efficiently after eating.\n\nAs your dose decreases or stops, these effects reverse — not overnight, but gradually. Food moves through your stomach faster, so glucose spikes happen quicker and higher than you are used to. Your appetite returns, meaning meals are larger. And your body is adjusting how it handles the sugar load.\n\nThe important principle: the goal is controlled variability, not perfect stability. You will see bigger post-meal spikes than before. That is expected. What matters is the recovery — how quickly your glucose comes back down. A spike to 150 that settles in an hour is very different from one that stays at 180 for three hours.\n\nThis is where the habits you are building pay off. Pairing carbs with protein and fiber slows absorption and reduces spike height. Walking after meals helps your muscles pull sugar from your blood. Eating at consistent times helps your body prepare for glucose processing. You are shifting from "the medication handles my glucose" to "my habits handle my glucose." Some days will be smoother than others, and that variability is part of the process.',

        pairing_glucose: 'You have been working on including protein at every meal. Now we build on that with macro pairing — the strategy of deliberately combining carbs with protein, fat, and fiber to flatten your glucose curve.\n\nHere is why it works: when you eat carbs alone (like a plain bagel), your body converts them to sugar quickly, causing a sharp spike. Add cream cheese, smoked salmon, and a side of vegetables to that same bagel, and the spike is much smaller and slower. The protein and fat slow digestion, and the fiber adds another layer of control. Same carbs, very different result.\n\nDuring taper, this matters more because your medication is no longer buffering the glucose response as strongly. Think of every meal as having three components: a protein source, a fiber source, and your carbs. When all three are present, your glucose curve stays smoother.\n\nPractical rules: eat the protein and vegetables on your plate first, then the carbs. Add a healthy fat to carb-heavy meals — olive oil, avocado, or nuts. Choose complex carbs over refined ones when it is easy — sweet potatoes instead of white bread, berries instead of juice. And remember, a 10-minute walk after the meal adds yet another layer. These strategies stack, and together they give you strong glucose control without medication doing the work.',

        strength_taper: 'Building the habit of strength training two to three times per week is critical. As your dose decreases and appetite returns, the risk of losing muscle actually increases. Your body is going through a metabolic adjustment, and consistent strength training sends a clear signal that your muscle tissue is needed.\n\nThis is a good time to introduce progressive overload — the idea of gradually making your workouts a little harder over time. Add a small amount of weight, do one extra rep, or add an extra set. Your muscles adapt to whatever demand you place on them, so a small increase drives continued improvement. You do not need big jumps — small and steady wins.\n\nA common trap during taper is panic-driven exercise escalation. When the scale fluctuates or appetite returns, the temptation is to dramatically increase workouts or pile on cardio. This almost always backfires. Overtraining raises cortisol (a stress hormone), increases fatigue, and can actually break down muscle — the opposite of what you want.\n\nStick to your plan: strength training two to three times per week, post-meal walks, and moderate cardio. If time is limited, always prioritize the strength session over extra cardio. The combination of strength training, adequate protein, and structured meals is your best defense against the muscle loss and metabolic slowdown that can accompany dose changes.',

        appetite_return: 'After weeks or months of reduced hunger on your medication, feeling genuinely hungry again can be surprising or even alarming. This is one of the biggest transitions during your GLP-1 journey, and it is important to understand: this is normal and expected. It is not a sign that something has gone wrong.\n\nWhat is happening: as your dose decreases or stops, ghrelin — the hormone that makes you feel hungry — starts to reassert itself. Meals that used to leave you satisfied may not feel like enough. You might think about food more often, want bigger portions, or crave specific things. This is your body recalibrating, not failing.\n\nThis is exactly where the habits you are building start doing the heavy lifting. Meal structure keeps you from going too long without eating, which prevents extreme hunger and reactive overeating. The protein anchor ensures you are eating the most filling foods first. Fiber and volume foods — like big salads, soups, and vegetables — take up space in your stomach and send fullness signals to your brain. Together, these habits create a "satiety toolkit" that replaces some of what the medication was doing.\n\nSome temporary weight regain during this transition is also normal. This is adjustment, not failure. Your body is finding a new equilibrium. What matters is the overall trend and your consistency with habits. If you are training, eating structured meals with protein, walking after eating, and sleeping well, you are doing everything right. Trust the process.',

        carb_strategy: 'Carbs are not the enemy — they fuel your brain, your muscles, and your daily life. The goal during taper is not to eliminate them but to eat them intentionally, in a way that supports stable glucose and lasting fullness.\n\nThe core principle is pairing (from the macro pairing module). Whenever you eat carbs, combine them with protein, fat, or fiber. Pasta with chicken and vegetables produces a much gentler glucose curve than pasta alone. The pairing slows digestion and keeps you satisfied longer.\n\nPortion awareness matters more now. When your appetite was suppressed, portions were naturally small. As hunger returns, you might eat larger carb portions without thinking about it. A simple visual guide: fill half your plate with vegetables, a quarter with protein, and a quarter with your carb. This naturally moderates portions without counting calories.\n\nTiming is another tool. Many people see better glucose numbers when they eat carbs earlier in the day, when the body tends to process them more efficiently. This is not a strict rule, but it is worth testing with your CGM — compare how the same meal affects you at lunch versus dinner.\n\nSwap where it is easy: whole grains instead of refined, sweet potatoes instead of white, fruit instead of juice. These add fiber, which slows digestion. You do not need to be perfect — just intentional about how you build your plate.',

        satiety_playbook: 'Satiety — feeling full and satisfied after eating — is a skill, and it becomes your most important one as medication-driven appetite suppression fades. The playbook has three pillars.\n\nPillar one: protein density. Choose foods that pack the most protein relative to their calories — Greek yogurt, chicken breast, fish, eggs, cottage cheese. When protein is the star of your plate, you naturally stay fuller longer.\n\nPillar two: fiber and volume. These are foods that take up a lot of physical space in your stomach relative to their calories — big salads, vegetable soups, steamed broccoli, berries, beans. When your stomach is physically stretched by volume foods, it sends strong fullness signals to your brain. This is a reliable, mechanical way to feel full that does not depend on medication.\n\nPillar three: meal construction. Eat the protein and vegetables first, then the carbs. Eat slowly — it takes about 20 minutes for your brain to register fullness, so rushing a meal in 8 minutes means you miss the signal. Plate your food rather than eating from packages, so you can see your portion.\n\nAn important mindset note: avoid labeling foods as "good" or "bad." Instead, think of them as "more stabilizing" or "less stabilizing." A less stabilizing meal is not a failure — it is information for next time. This removes guilt and helps you make practical choices consistently.',

        post_meal_walk: 'Post-meal walking is one of the most powerful habits in your toolkit. Now let us optimize it for this stage, when your body is handling more glucose regulation on its own.\n\nTiming matters most. Starting your walk within 15 to 30 minutes after finishing a meal has the biggest impact. Your muscles actively use glucose during movement, so walking during the peak absorption window intercepts the spike before it gets too high. If you can only walk after one meal, pick the one that spikes you most — usually dinner.\n\nPace: a moderate pace works best. Brisk enough to hold a conversation, but not so fast that you are winded. Duration: 10 to 15 minutes is the sweet spot. Even 5 minutes helps. The returns diminish after about 20 to 30 minutes for glucose-specific purposes.\n\nDuring taper, walking after eating also helps psychologically. It creates a natural break between the meal and any urge to keep eating or snack. It gives your brain time to register fullness and shifts your focus from food to movement.\n\nConsistency beats duration every time. A daily 10-minute walk after dinner is worth more than an occasional 45-minute one. Build it into the meal routine: eat, clear your plate, shoes on, walk. This single habit can reduce your post-meal peak by 20 to 30 mg/dL.',

        sleep_taper: 'During your transition, sleep becomes even more important because of its direct link to hunger hormones. As your GLP-1 dose decreases or stops, ghrelin (your hunger hormone) rises and leptin (your fullness hormone) becomes less suppressed. Poor sleep amplifies this: even one bad night can increase ghrelin by 15 to 20 percent and decrease leptin by a similar amount.\n\nWhat that means in practice: a bad night of sleep during this transition makes the next day feel much hungrier than it should be. You may crave more carbs, want bigger portions, and feel less satisfied after meals. This is not a willpower problem — it is a hormonal response to sleep deprivation compounding with the hormonal shifts from dose changes.\n\nBuild on the consistency habit you are developing with some intermediate strategies. Keep your bedroom cool (65 to 68 degrees works for most people). Cut caffeine after early afternoon. If you wake at night, resist the urge to check your phone — the light and stimulation make it harder to fall back asleep.\n\nHere is a practical link: on nights when you sleep poorly, be extra intentional the next day about your meal structure and protein. This compensates for the hunger hormone shift and prevents a bad night from cascading into a bad eating day. Sleep and nutrition are deeply connected during this phase — supporting one directly helps the other.',

        hydration_p2: 'While on GLP-1, hydration was about making sure you drank enough water despite reduced thirst. Now, hydration becomes a more strategic tool that supports satiety, digestion, and glucose management.\n\nAs appetite returns, water helps with fullness. A glass of water 15 to 20 minutes before a meal can help your body calibrate how much food it actually needs. During taper, when hunger signals are recalibrating, this extra input is valuable.\n\nAs medication effects decrease, your digestion speeds up. Food that used to sit in your stomach for hours now passes through more quickly. Staying hydrated keeps this transition smooth and prevents constipation, which can flare up when gastrointestinal motility changes.\n\nPractical upgrade: spread your water throughout the day rather than gulping large amounts at once. Consistent sipping keeps hydration steady. Keep a water bottle with you and take small sips between meals. If you are strength training, drink extra before and after sessions — even mild dehydration impairs workout performance and recovery.',

        stress_taper: 'Transitioning off your medication is a major change, and change is stressful — even when you are on board with the process. Appetite is returning, glucose patterns are shifting, and the safety net is changing. It is completely natural for this to feel unsettling.\n\nHere is why managing stress matters physically: cortisol, your stress hormone, directly raises blood sugar by telling your liver to release stored glucose. It promotes fat storage around your midsection and increases cravings for high-calorie comfort foods. So stress during this transition is not just emotional — it has a measurable impact on the numbers you are tracking.\n\nThe foundational tools — breathing, movement, and sleep — remain your base. Now add one intermediate technique: naming your emotions. When you feel anxious about appetite returning or the scale moving, say it to yourself: "I am feeling anxious about my transition." This simple act reduces the cortisol response and helps you choose a response rather than just react.\n\nAn important reframe: do not obsess over daily weight. The scale will move in both directions during taper, and fixating on it creates unnecessary cortisol. Instead, look at the trend over weeks. Focus on what you can control — are you training, eating structured meals, walking after meals, and sleeping well? These process metrics determine long-term success, not any single weigh-in.',

        quick_reset: 'There will be days when things go sideways — glucose is higher than expected, you skipped workouts, meals were unstructured. This is not failure. It is a normal part of the process. What matters is how quickly you get back on track.\n\nThe 3-step reset is your protocol for these moments. Step one: protein anchor your next meal — whatever you eat next, make sure it has a solid protein source. Step two: take a 15-minute walk — this clears glucose, lowers cortisol, and gives you a mental reset. Step three: check your sleep — if sleep has slipped, that alone can explain higher glucose, increased hunger, and low energy.\n\nThe power of this protocol is its simplicity. You do not need to overhaul your day, start a crash diet, or do an intense workout. Three actions — protein, walk, sleep check — address the most common causes of drift and get momentum going immediately.\n\nThe key mindset: "reset, not detox." When things go off track, the temptation is to punish yourself with restriction or extra exercise. This always backfires — it raises cortisol and promotes muscle breakdown. Instead, execute the three steps and move on. Every meal is a new opportunity. One bad day does not undo weeks of consistent habits.',

        /* ===== PHASE 3 — MAINTENANCE (advanced, research-backed, precise) ===== */

        cgm_maintenance: 'In maintenance, your CGM relationship shifts from continuous monitoring to strategic surveillance. After months of learning your patterns, you have built an intuitive sense of your glycemic responses. The CGM now serves as a periodic auditing tool — confirming that habits are maintaining your metabolic baseline and providing early detection of drift.\n\nDrift is the central concept in maintenance CGM strategy. It refers to a slow, insidious increase in fasting glucose, postprandial peak amplitude, or intraday glucose variability that develops over weeks to months. Unlike the acute changes you tracked during taper, drift is subtle enough to escape day-to-day awareness. Common drivers include caloric creep (gradually increasing portion sizes), declining NEAT (non-exercise activity thermogenesis), accumulated sleep debt, and unmanaged chronic stress elevating hepatic glucose output via cortisol.\n\nThe recommended protocol is periodic wear: one to two weeks of continuous monitoring every four to eight weeks. During these check-in periods, focus on three metrics: (1) mean fasting glucose — compare to your established taper-phase baseline; a sustained increase of 5 to 10 mg/dL signals early drift. (2) Postprandial peak amplitude — if your typical meals are producing peaks 20+ mg/dL higher than baseline, your meal construction or activity patterns have shifted. (3) Glycemic variability (standard deviation or coefficient of variation) — rising variability indicates less consistent glucose regulation overall.\n\nCorrection protocols are not dramatic interventions. They are the same habit stack you have refined throughout Phases 1 and 2, applied with renewed intention: tighten protein anchoring, verify post-meal walking consistency, audit sleep schedule adherence, and critically review whether portion sizes have inflated. The research on weight maintenance consistently shows that early course correction — catching a 5 mg/dL fasting glucose increase rather than a 20 mg/dL one — is the difference between a minor adjustment and a major intervention.',

        drift_prevention: 'Drift prevention requires understanding the metabolic surveillance hierarchy: which markers to track, how frequently to assess them, and when to escalate from awareness to intervention. Without GLP-1 pharmacological support, your metabolic stability depends entirely on behavioral consistency, and drift prevention is your systematic approach to maintaining that consistency.\n\nFasting glucose is your primary sentinel marker. Measured first thing in the morning before food or drink, it reflects your hepatic glucose output overnight — a process largely driven by cortisol patterns, sleep quality, and the previous day\'s caloric load. Because it is less influenced by acute meal choices than postprandial readings, it provides the clearest signal of underlying metabolic trend. Track your 7-day fasting glucose average during each CGM wear period. A sustained increase exceeding 5 mg/dL warrants investigation; exceeding 10 mg/dL warrants active correction.\n\nGlucose variability is your secondary marker. Quantified by standard deviation or coefficient of variation (CV) of your 24-hour glucose readings, it captures the amplitude and frequency of glucose excursions. A CV consistently above 20 percent in a non-diabetic individual suggests that meal composition, timing, stress, or activity patterns have meaningfully shifted. Your Glucose GPA in this app reflects variability, but understanding the underlying metric helps you interpret the score.\n\nWhen drift is detected, deploy a structured two-week recommitment block rather than a reactive overhaul. The protocol: (1) Re-anchor every meal with 25+ grams of protein. (2) Walk 10 to 15 minutes after your two largest meals daily. (3) Audit sleep — are you within 30 minutes of your target bed and wake times? (4) Assess portion creep — the most common and hardest-to-detect drift source. Research on weight-maintenance relapse identifies unconscious portion increase as the leading behavioral predictor of regain. (5) Evaluate stress load — elevated cortisol directly increases hepatic glucose output and promotes visceral adiposity.\n\nThe critical principle: correction is maintenance, not punishment. Your metabolic system requires periodic recalibration the same way any complex system does. Normalizing this process — and catching deviations early — is the hallmark of successful long-term maintenance.',

        post_meal_maintenance: 'In maintenance, your daily energy expenditure profile becomes as important as — or more important than — your structured exercise sessions. This is captured by the concept of NEAT: non-exercise activity thermogenesis, which accounts for all energy expended through daily activities that are not formal exercise. Research consistently identifies NEAT as a stronger predictor of long-term weight maintenance than gym attendance alone.\n\nThe physiology is straightforward: a person who strength trains three times per week but remains sedentary for the remaining 110+ waking hours per week has a fundamentally different energy expenditure profile than someone who also accumulates 8,000 to 10,000 steps daily and stays generally active. NEAT can account for 200 to 800 additional kilocalories per day depending on occupation and lifestyle, making it a larger contributor to total daily energy expenditure than most structured workouts.\n\nData from GLP-1 withdrawal studies highlight that participants who maintained both structured exercise and high daily NEAT had significantly better weight-maintenance outcomes than those who relied on structured exercise alone. The combination creates metabolic redundancy — even if a gym session is missed, high baseline NEAT provides a buffer against caloric surplus.\n\nPost-meal walking remains your highest-ROI NEAT activity, providing both glucose disposal benefits (via skeletal muscle GLUT4-mediated glucose uptake) and significant contribution to daily step counts. Beyond post-meal walks, engineer NEAT into your environment: standing desks, walking phone calls, stairs over elevators, parking at lot perimeters. These micro-decisions compound.\n\nThe complete maintenance exercise profile combines three elements: structured resistance training (2 to 3 sessions per week for lean mass preservation and glucose disposal capacity), moderate cardiovascular exercise (1 to 2 sessions for cardiometabolic health and mood regulation), and high daily NEAT (7,000 to 10,000 steps). This triad creates a comprehensive preservation system that sustains your results without requiring unsustainable effort levels.',

        maintenance_playbook: 'Maintenance nutrition operates on fundamentally different principles than a caloric deficit. The goal shifts from energy deficit to energy balance — consuming enough to fuel your body, preserve lean mass, and support metabolic function without net weight gain. This requires both a strategic framework and psychological flexibility.\n\nThe evidence-based model is "flexible restraint," sometimes termed the 80/20 approach. The construct is well-studied in obesity maintenance literature: individuals who maintain moderate, consistent dietary structure with planned flexibility (social meals, celebrations, occasional indulgences) achieve significantly better long-term outcomes than those who attempt rigid restriction. Rigid control paradoxically predicts relapse through the restrict-binge cycle. Flexible restraint allows you to maintain your protein anchoring, meal structure, and pairing habits 80 percent of the time while fully participating in life\'s social and emotional dimensions 20 percent of the time.\n\nMaintenance caloric requirements are higher than what you may have been eating on medication — often significantly so. This can trigger anxiety if you have internalized a restriction mindset. The metabolic reality is that chronically under-eating at maintenance drives adaptive thermogenesis (metabolic rate suppression), accelerates lean mass loss, and dysregulates hunger hormones — all of which promote the weight regain you are trying to prevent. Eating at true maintenance is metabolically protective.\n\nMeal timing structure continues to serve an important regulatory function. Regular meals prevent the extreme ghrelin surges that drive impulsive, unstructured eating. Continued protein anchoring at 1.6 to 2.2 g/kg lean body mass per day preserves lean tissue. On alcohol: it provides 7 kcal/gram with zero satiety value, suppresses deep sleep and REM (reducing metabolic restoration), impairs hepatic glucose regulation for 12 to 24 hours, lowers prefrontal inhibition around food choices, and preferentially promotes visceral adiposity. Strategic moderation — not elimination — is the evidence-based recommendation.',

        holidays_travel: 'Navigating restaurants, holidays, travel, and social eating represents the highest-frequency maintenance challenge, and the literature on weight-maintenance relapse identifies these scenarios as common inflection points where habits begin to erode. The disruption is multidimensional: routine disruption, reduced food-preparation control, social pressure, emotional associations, and often simultaneous sleep and activity decrements.\n\nFor restaurant dining, employ the preview-and-anchor strategy: review the menu before arrival and identify a protein-anchored entree. This eliminates decision fatigue in a high-temptation environment. At the table, consider ordering a fiber-rich appetizer (salad, vegetable soup) to pre-load satiety volume before the entree. Apply your pairing architecture: identify the protein source, the fiber component, and moderate the refined carbohydrate load. Note that restaurant portions in the US typically provide 1.5 to 2.5 times a standard serving — awareness of this norm helps calibrate intake without rigid restriction.\n\nHoliday meals and celebrations carry emotional weight that rigid dietary rules cannot accommodate without psychological cost. The flexible restraint model applies precisely here: participate fully, enjoy the meal, and return to your established structure at the next eating opportunity. One meal deviation from your routine has negligible metabolic impact. The research is unambiguous: pattern consistency over weeks predicts maintenance success, not individual meal perfection.\n\nTravel creates a compounding disruption — sleep, activity, meal timing, and food environment all shift simultaneously. Prepare by packing protein-dense portable foods (jerky, protein bars, nuts, cheese sticks) as a nutritional floor. Prioritize sleep schedule maintenance across time zones using graduated adjustment (15 to 30 minutes per day). Maintain movement through hotel bodyweight training and walking. The governing principle is fidelity to the spirit of your habits when the specific execution must adapt. Consistency of intent supersedes consistency of execution.',

        fiber_intro: 'As you progress, fiber strategy moves beyond the foundation of "eat more plants" into targeted optimization of fiber types, timing, fermentation profiles, and their specific effects on glycemic regulation and satiety signaling.\n\nSoluble fiber — found in oats (beta-glucan), beans, lentils, barley, flax seeds, and certain fruits (pectin) — dissolves in water to form a viscous gel that physically slows glucose absorption in the small intestine. This gel-forming property is dose-dependent: higher soluble fiber intake produces a proportionally flatter postprandial glucose curve. Soluble fiber also serves as a prebiotic, feeding beneficial colonic bacteria that produce short-chain fatty acids (SCFAs), particularly butyrate, propionate, and acetate. These SCFAs improve insulin sensitivity, reduce systemic inflammation, and support gut barrier integrity. Beta-glucan and psyllium husk have the strongest evidence base for glycemic attenuation.\n\nInsoluble fiber — found in whole wheat, vegetable stalks, and fruit skins — does not gel, but adds fecal bulk and accelerates colonic transit time. While its direct glycemic impact is modest, it contributes meaningfully to meal volume and physical satiety, and supports digestive regularity.\n\nFor optimized glucose management in maintenance, strategically prioritize soluble fiber at higher-carbohydrate meals. Practical applications: a tablespoon of ground flax in morning oatmeal, lentil-based soups, a side of beans with dinner, or a psyllium supplement before a carb-heavier meal. Target total daily fiber intake of 25 to 35 grams from whole food sources, with emphasis on soluble sources.\n\nGI tolerance remains individual and dose-dependent. Increase intake by 3 to 5 grams per day with a one-week adaptation period between increments. Adequate hydration is non-negotiable when increasing fiber — soluble fiber is hygroscopic (absorbs water), and insufficient fluid intake can paradoxically worsen constipation and bloating rather than alleviate them.',

        stress_sleep_glucose: 'Sleep architecture — the cyclical structure of sleep stages throughout the night — has a profound and well-documented impact on glucose homeostasis, appetite hormone regulation, and metabolic recovery. In maintenance without pharmacological support, understanding and optimizing sleep architecture becomes a high-leverage intervention.\n\nA normal sleep cycle progresses through four stages over approximately 90 minutes: Stage N1 (light transition), Stage N2 (consolidation, sleep spindles), Stage N3 (slow-wave sleep / deep sleep), and REM (rapid eye movement). You cycle through 4 to 6 complete cycles per night. Stage N3 deep sleep is where the critical metabolic restoration occurs: growth hormone secretion peaks, skeletal muscle repair is initiated, and the glymphatic system clears central nervous system metabolic waste.\n\nThe glucose connection is particularly striking. Research by Tasali et al. demonstrated that selectively suppressing Stage N3 deep sleep — without reducing total sleep duration — impairs glucose tolerance by approximately 25 percent the following day. This metabolic effect is comparable to the insulin resistance seen in individuals 20 to 30 pounds heavier. The implication is clear: sleep quality is as important as sleep duration, and six hours of deep, consolidated sleep may support glucose regulation more effectively than eight hours of fragmented sleep.\n\nOptimize N3 deep sleep through regular exercise (but not within 2 to 3 hours of bedtime), cool sleeping environment (65 to 68 degrees Fahrenheit), complete darkness, alcohol avoidance before bed (alcohol dose-dependently suppresses N3 and REM), and strict schedule consistency. If you use a sleep tracker that monitors stages, trend your deep sleep percentage over weeks — declining N3 time may explain deteriorating glucose metrics despite stable diet and exercise.\n\nThe appetite hormone amplification in maintenance is significant. Without GLP-1 receptor agonist buffering, every night of poor sleep drives a measurable ghrelin increase and leptin decrease, making the following day\'s hunger management substantially harder. Sleep is not a wellness luxury in maintenance — it is a first-order metabolic variable.',

        long_term_strength: 'As you progress through the program, resistance training\'s role shifts from habit building to metabolic preservation. Evidence from a landmark trial published in Lancet eClinicalMedicine demonstrated that supervised, structured exercise during and after GLP-1 receptor agonist treatment significantly improved body composition outcomes and weight maintenance compared to medication alone. Exercise in maintenance is not optional — it is one of the strongest independent predictors of sustained results.\n\nPeriodization — the systematic variation of training variables over time — prevents adaptation plateaus and manages cumulative fatigue. The simplest evidence-based model is linear periodization: progressively increase load over 4 to 6 weeks (accumulation phase), then reduce intensity by 40 to 50 percent for one week (deload). This undulating pattern allows neuromuscular recovery, connective tissue adaptation, and psychological reprieve. Schedule deloads every 4th or 5th week as a programmed component, not a concession.\n\nProgressive overload is the non-negotiable principle underlying muscle maintenance. Skeletal muscle is metabolically expensive tissue; without continued stimulus exceeding current capacity, the body preferentially catabolizes it during periods of caloric equilibrium or surplus. Overload can take multiple forms: add 2.5 to 5 pounds per lift every 2 to 4 weeks, add one additional repetition at the same load, increase time under tension through controlled eccentric phases (3 to 4 second lowering), or add a set. Micro-progressions compound into significant strength and hypertrophy gains over months.\n\nThe complete maintenance exercise profile integrates three modalities: (1) Structured resistance training, 2 to 3 sessions per week — preserves lean mass, maintains resting metabolic rate, and improves insulin-mediated glucose disposal via increased GLUT4 transporter density. (2) Moderate cardiovascular exercise, 1 to 2 sessions — supports VO2max, cardiometabolic health, mood regulation via endorphin and BDNF release. (3) High daily NEAT — 7,000 to 10,000 steps, post-meal ambulation, and lifestyle movement engineering. Population-level data consistently identifies NEAT as a stronger predictor of long-term weight maintenance than structured exercise frequency alone. This triad creates metabolic redundancy and sustainability.',

        stress_maintenance: 'Allostatic load — the cumulative physiological cost of chronic stress exposure — becomes a critical management target in maintenance. Unlike acute stress, which triggers an adaptive cortisol response that resolves within hours, chronic stress maintains elevated baseline activation of the hypothalamic-pituitary-adrenal (HPA) axis. Over months to years, this sustained activation exacts measurable metabolic costs: impaired glucose homeostasis, appetite hormone dysregulation, degraded sleep architecture, preferential visceral adipogenesis, and diminished immune surveillance.\n\nWithout GLP-1 pharmacological buffering, your cortisol-mediated glucose response operates without a safety net. Elevated cortisol directly stimulates hepatic gluconeogenesis (liver glucose production), increases ghrelin-driven appetite, suppresses leptin signaling, fragments sleep via inappropriate evening cortisol elevation, and promotes visceral fat deposition — the most metabolically pathogenic adipose depot. High allostatic load makes every other maintenance behavior harder simultaneously.\n\nHPA axis dysregulation under chronic stress manifests as a flattened diurnal cortisol curve: elevated evening cortisol (disrupting sleep onset and N3 depth) and blunted morning cortisol awakening response (causing fatigue and low motivation). This pattern is bidirectional — poor sleep further dysregulates the HPA axis, creating a self-reinforcing cycle.\n\nEvidence-based allostatic load reduction strategies: regular exercise reduces cortisol reactivity to acute stressors. Consistent sleep restores diurnal HPA axis patterning. Social connection and emotional expression lower baseline stress hormones — loneliness and suppression are independently associated with elevated allostatic load. Nature exposure, even 20 minutes, produces measurable salivary cortisol reduction. Mindfulness-based stress reduction (MBSR) protocols demonstrate improved cortisol recovery velocity — the speed at which cortisol returns to baseline after a stressor.\n\nThe operational principle is sustainability over intensity. Five minutes of daily diaphragmatic breathing produces greater cumulative cortisol reduction than a weekly 60-minute meditation session that is frequently skipped. Embed practices into your existing routine with the same non-negotiable status as strength training and protein anchoring.',

        /* ===== HUNGER EDUCATION ===== */

        hunger_basics: 'Hunger is one of your body\'s most fundamental signals. It tells you that your energy stores are running low and it is time to refuel. While on GLP-1 medication, this signal was turned way down — which helped with weight loss but may have made you forget what real hunger feels like.\n\nThere are two main hunger hormones: ghrelin (which makes you hungry) and leptin (which tells you to stop eating). Your medication suppressed ghrelin and enhanced leptin signaling, which is why eating less felt easy. Now those signals are returning.\n\nThe goal during this program is not to ignore hunger or fight it — it is to understand it. When you can recognize what a "3 out of 5" hunger level feels like, you can eat at the right time: not too early (boredom eating) and not too late (ravenous overeating).\n\nThink of hunger as information, like a fuel gauge. You would not wait until the gas light comes on to fill up, and you would not top off when the tank is three-quarters full. Learning to respond to hunger at the right level is one of the most valuable skills you can build right now.',

        hunger_signals: 'Your body sends hunger signals in a specific order, and learning to recognize each stage helps you eat at the right time.\n\nLevel 1 — No signal: You feel nothing. No hunger, no thoughts about food. This is normal for the first few hours after a meal, especially on medication.\n\nLevel 2 — Mildly aware: A subtle awareness that food sounds good. You might notice your stomach feels empty, but it is easy to ignore. This is a good time to plan your next meal.\n\nLevel 3 — Ready to eat: Clear hunger. Your stomach may growl, and you are thinking about food. This is the ideal time to eat — you are hungry enough to enjoy the meal but not so hungry that you will overeat.\n\nLevel 4 — Very hungry: Hard to concentrate. You feel irritable or distracted. Meals eaten at this level tend to be rushed and larger than needed because your body is in "refuel urgently" mode.\n\nLevel 5 — Urgent: Shaky, headache, unable to think about anything else. At this point, your body is in emergency mode and you are likely to grab whatever is fastest, regardless of quality.\n\nThe sweet spot is eating at a 2 or 3. As medication changes, practice checking in before each meal: "Where am I on the scale?" This awareness alone changes behavior.',

        fullness_signals: 'Just as hunger has levels, so does fullness. Learning to stop eating at the right point is just as important as starting at the right time.\n\nLevel 1 — Still hungry: You have eaten something, but your body is not satisfied. You still feel empty and would keep eating. This may mean the meal was too small or lacked protein and fiber.\n\nLevel 2 — Slightly full: You could eat more, but the edge is off. This is common after a protein-rich snack or a small appetizer.\n\nLevel 3 — Satisfied: This is the target. You feel comfortable — not hungry, not stuffed. You could eat more, but you do not need to. If you stopped here, you would feel good for the next 3 to 4 hours.\n\nLevel 4 — Full: Your stomach feels stretched. You ate a bit more than you needed. This is common at restaurants or social meals. Not a problem occasionally, but consistently eating to a 4 means portions are too large.\n\nLevel 5 — Stuffed: Uncomfortably full. Your body is working overtime to digest. This usually happens when eating too fast, eating while distracted, or arriving at a meal at hunger level 4 or 5.\n\nThe key practice: pause halfway through your meal and check in. "Am I at a 3 yet?" If yes, stop — even if there is food left on the plate. This pause takes 10 seconds and is one of the highest-impact habits in this entire program.',

        hunger_medication: 'Understanding how your medication affects hunger hormones helps you prepare for what happens when the dose changes.\n\nGLP-1 medications work on several hunger pathways simultaneously. They reduce ghrelin production (making you less hungry), slow gastric emptying (keeping food in your stomach longer so you feel full), and act on brain receptors in the hypothalamus that regulate appetite. The combined effect is powerful — many people forget what hunger feels like.\n\nAs your dose decreases, these effects reverse gradually. Ghrelin levels rise, gastric emptying speeds up, and the brain\'s appetite center becomes more active. This does not happen overnight — it unfolds over weeks.\n\nThe most important thing to know: your hunger may temporarily overshoot. Research shows that ghrelin can rebound above its pre-medication baseline for several weeks during tapering. This means you may feel hungrier than you did even before starting medication. This is temporary and normalizes, but it can be alarming if you do not expect it.\n\nThis is exactly why building hunger awareness now matters. When appetite rebounds, you need the skill to distinguish "my ghrelin is overshooting" from "I genuinely need more food." The daily hunger check-in builds this skill. Every time you rate your hunger before eating, you strengthen the neural pathway between sensing hunger and making a conscious choice about how to respond.',

        emotional_hunger: 'Emotional hunger is one of the biggest challenges in the transition period, and understanding it deeply will serve you for years.\n\nPhysical hunger is a bottom-up signal — it starts in your gut and stomach and travels to your brain via the vagus nerve and hormones. It builds slowly, is not food-specific, and is satisfied by eating.\n\nEmotional hunger is a top-down signal — it starts in your brain\'s limbic system (emotion center) and manifests as a craving. It appears suddenly, is usually for specific comfort foods (sweet, salty, fatty), and eating does not fully satisfy it because the underlying need is emotional, not caloric.\n\nCommon triggers for emotional eating: stress, boredom, loneliness, anxiety, fatigue, celebration, and habit (like always snacking while watching TV). While on GLP-1 medication, emotional eating was suppressed along with physical hunger. As the medication changes, both types return — and if you have not built awareness, emotional hunger can drive significant overeating.\n\nThe HALT technique is a practical tool: when you feel a sudden craving, ask yourself — am I Hungry, Angry, Lonely, or Tired? If the answer is anything other than truly hungry, the craving is emotional. Address the root cause first: take a walk (anger/stress), call someone (lonely), or rest (tired). If you still want to eat after 15 minutes, eat mindfully and without guilt. The awareness itself changes the pattern over time.',

        satiety_skill: 'Satiety — the sustained feeling of fullness between meals — is not just a passive consequence of eating. It is an active skill that improves with practice, and it is arguably the single most important skill for long-term weight maintenance.\n\nThree levers control satiety: what you eat, how you eat, and when you eat. Optimizing all three creates a robust fullness system that works without medication.\n\nWhat you eat: Protein has the highest satiety value per calorie — it triggers cholecystokinin (CCK) and peptide YY (PYY), hormones that signal fullness. Fiber adds bulk that stretches the stomach and slows absorption. Fat provides lasting satisfaction but is calorie-dense, so moderate portions work best. The optimal satiety meal combines all three: protein + fiber + moderate fat.\n\nHow you eat: Eating speed is critical. Your gut-brain fullness signal takes about 20 minutes to register. If you finish a meal in 8 minutes, you will overshoot satiety every time. Slow down: put your fork down between bites, chew thoroughly, sip water during the meal. Eating from a plate (not a package) and without screens also improves satiety awareness.\n\nWhen you eat: Regular meal timing trains your body to expect food at predictable intervals, which regulates ghrelin release. Skipping meals creates ghrelin spikes that lead to overeating at the next meal. Even when you are not hungry (common on medication), eating at regular times builds the routine your body needs later.\n\nSatiety improves with practice. Each mindful meal strengthens the connection between eating and awareness. Over weeks and months, you will naturally calibrate portions, stop at the right point, and feel satisfied longer. This is the skill that replaces medication.',

        /* ===== NEW MODULES ===== */

        understanding_fullness: 'While on medication, it was easy to feel full on small amounts of food. Now that your medication is changing, your natural "I am full" and "I am hungry" signals are returning. Practicing noticing them is one of the most important skills you can build.\n\nFullness is a physical feeling — your stomach feels satisfied and comfortable after eating. Protein-rich foods and vegetables are especially good at creating this feeling because they take longer to digest.\n\nHunger is physical too, but it can be confused with boredom, stress, or tiredness. Real hunger builds slowly and can be satisfied by almost any food. Cravings for something specific — like chips or sweets — are usually more about emotions or habit.\n\nHere is a simple practice: before each meal, ask yourself "am I actually hungry, or is it just time to eat?" Both answers are fine. After eating, notice how full you feel on a scale of 1 to 5. This small habit of checking in builds awareness that will guide you when your appetite returns later.',

        gi_comfort: 'Your medication slows down how fast food moves through your stomach. That is part of why you feel full longer, but it can also cause some uncomfortable side effects like nausea, bloating, or constipation.\n\nThe good news: most of these improve over time, and there are simple things you can do to feel better. Eat smaller meals instead of big ones. Chew slowly and take your time. Avoid greasy or very fatty foods, which are harder to digest on top of the medication.\n\nIf you feel bloated, try a short walk after eating instead of lying down. If constipation is an issue, drink more water and add fiber gradually — but not too much at once, or it can make things worse.\n\nFoods that tend to sit well: lean meats, cooked vegetables, rice, toast, and soups. If nausea is a problem, try starting meals with a few plain crackers or ginger tea. If symptoms are severe or do not improve, let your doctor know. These side effects are manageable — they should not stop you from eating enough to stay nourished and energized.',

        weight_after_glp1: 'One of the most important things to know is that some weight regain when reducing or stopping your medication is biologically normal. Studies consistently show this happens to most people, and it is not a personal failure — it is how the body responds to the change.\n\nHere is what happens: your appetite-suppressing hormone effects start fading, so hunger gradually returns. Food moves through your stomach faster, so you feel hungry sooner after eating. And ghrelin (your hunger hormone) can temporarily overshoot its pre-medication level, making you feel hungrier than you did even before starting treatment. All of this is your body recalibrating.\n\nThe key reframe: your appetite signals return before your metabolism fully adjusts. A small amount of regain during this window is expected and does not mean you are doing something wrong. What matters is the trajectory — stabilizing is very different from accelerating.\n\nThis app tracks an acceptable regain range of 3 to 5 percent of your lowest weight. If you weighed 165 at your lowest, 170 to 173 is within the normal adjustment zone. The goal is to prevent accelerating regain — weight that keeps climbing week over week. If you stay within your band and your habits are consistent, you are succeeding. If the trend goes above the band, that is a signal to tighten habits, not to panic or crash diet.',

        hunger_vs_emotional: 'As your appetite returns, learning the difference between physical hunger and emotional hunger becomes a critical skill. When medication was suppressing appetite, this distinction did not matter much. Now it does.\n\nPhysical hunger builds gradually — it starts as a mild emptiness and slowly grows over 30 minutes to a few hours. It is not specific. You would be happy eating almost anything. It comes with cues like a growling stomach or difficulty concentrating, and it goes away once you eat a normal meal.\n\nEmotional hunger is different. It appears suddenly — you go from not thinking about food to urgently wanting something specific, usually comfort food that is sweet, salty, or fatty. Eating does not fully satisfy it because the real need is not fuel — it is stress relief, boredom, or comfort. Emotional hunger often leads to eating past fullness and feeling guilty afterward.\n\nNeither type is "bad." Occasional comfort eating is completely human. The issue is when it becomes your main coping tool, especially during the transition when appetite is higher and stress may be too. When you notice a sudden, specific craving, pause: am I physically hungry, or am I feeling something else? If it is emotional, try addressing the emotion first — a walk, a phone call, a breathing exercise. If you still want to eat after 15 minutes, eat mindfully. The awareness itself is the skill.',

        scale_during_transition: 'The scale can become a major source of anxiety during the GLP-1 transition. Understanding what it actually measures — and what it does not — helps you use it as data instead of a judgment.\n\nYour weight fluctuates by 2 to 4 pounds every single day from things that have nothing to do with fat: water retention, sodium, hormonal cycles, how recently you ate, and digestion. A single weigh-in tells you almost nothing meaningful. The trend over weeks is what matters.\n\nDuring transition, it is very common to see the scale go up. Some of this is the expected 3 to 5 percent regain. Some is water weight as your body adjusts. And some may be muscle gain if you have been training — muscle is denser than fat, so body composition can improve even as the number rises.\n\nTwo traps to avoid: reactive restriction (seeing a higher number and immediately slashing calories — this raises cortisol and backfires) and obsessive weighing (stepping on the scale multiple times a day amplifies normal fluctuations into emotional crises). Instead, weigh once per week at the same time — morning, after the bathroom, before eating. Track the 4-week trend. If it is stable or down, you are on track. If it is consistently rising above your maintenance band, recommit to your habits: protein, meal structure, walking, and sleep.',

        alcohol_maintenance: 'Alcohol warrants specific attention in maintenance because its metabolic effects intersect with virtually every system this program monitors: glycemic regulation, sleep architecture, appetite signaling, body composition, and executive function around food decisions. Understanding the pharmacology allows informed decision-making rather than arbitrary rule-following.\n\nAlcohol\'s glycemic effects are complex and biphasic. Acutely, ethanol suppresses hepatic gluconeogenesis, which can transiently lower blood glucose — this is why a glass of wine may produce a dip on your CGM. However, cocktails with juice or sugar mixers produce a rapid spike followed by a suppression-mediated drop. More consequentially, while the liver metabolizes ethanol (at a fixed rate of approximately one standard drink per hour), its capacity for glycemic regulation is impaired. This can elevate fasting glucose by 10 to 20 mg/dL the following morning and increase 24-hour glucose variability.\n\nAlcohol dose-dependently suppresses Stage N3 (deep sleep) and REM sleep. Even 1 to 2 standard drinks reduce deep sleep by 20 to 40 percent. Since N3 is where growth hormone secretion, muscle repair, and metabolic restoration occur, and REM is where emotional processing and memory consolidation happen, alcohol systematically degrades the sleep quality that supports every other maintenance behavior. The downstream effects — elevated ghrelin, suppressed leptin, increased cortisol — make the 24 to 48 hours post-drinking measurably harder for hunger management.\n\nAlcohol also reduces prefrontal cortex inhibition, impairing the executive function that supports meal structure and portion awareness. Late-night post-drinking snacking is one of the highest-frequency sources of surplus caloric intake in maintenance populations. Additionally, ethanol provides 7 kcal/gram with zero satiety value and preferentially promotes visceral adipogenesis — the most metabolically pathogenic fat depot.\n\nThe evidence-based recommendation is strategic moderation, not elimination. Limit to 1 to 2 standard drinks per occasion, maximum 2 to 3 occasions per week. Choose lower-glycemic options (dry wine, spirits with soda water or plain mixers) over sugar-laden cocktails and high-carb beers. Avoid drinking on an empty stomach. Use your CGM to empirically test how alcohol affects your personal glucose, sleep, and next-day hunger — the data will provide more compelling motivation than any guideline.',

        satiety_mastery: 'In maintenance without GLP-1 receptor agonist support, endogenous satiety management becomes your primary mechanism for energy balance. Your ability to feel appropriately satisfied after meals depends on the integration of mechanical, hormonal, and behavioral signals — and all three can be deliberately optimized.\n\nThe satiety hierarchy from Phases 1 and 2 — protein density, fiber volume, meal structure — remains the foundation. In maintenance, these tools can be refined with precision. Protein leveraging research demonstrates that front-loading protein intake into the first meal of the day (30+ grams at breakfast) reduces total 24-hour caloric intake more effectively than isocaloric protein distribution. The mechanism involves sustained cholecystokinin (CCK) and peptide YY (PYY) signaling from the duodenum, plus thermogenic cost — protein has the highest thermic effect of any macronutrient at 20 to 30 percent of calories consumed. If afternoons or evenings are your vulnerability window, a higher-protein breakfast creates a hormonal buffer.\n\nVolume eating becomes a sophisticated meal-engineering practice. Building meals where 50 percent or more of the plate consists of high-volume, low-energy-density foods — large salads with substantial toppings, vegetable-heavy stir-fries, broth-based soups, cauliflower rice blended with grain rice, spiralized vegetables mixed with pasta — leverages gastric mechanoreceptor signaling to produce satiety at a lower caloric cost. This is not restriction; it is strategic caloric dilution.\n\nMindful eating practices are supported by a growing evidence base. Distracted eating (screens, multitasking) increases intake by 10 to 25 percent in controlled studies. The physiological explanation: gut-brain satiety signaling via the vagus nerve requires approximately 20 minutes to fully register in the hypothalamus. Eating at a pace that allows this signaling to complete — putting the fork down between bites, chewing thoroughly — is not a willpower exercise. It is giving your satiety feedback loop time to function.\n\nThe advanced maintenance distinction is between "satiated" and "full." Satiation — the absence of hunger, a neutral comfort — is the appropriate meal-termination signal in maintenance. Fullness — physical stomach distension — represents overshoot. Training yourself to stop at satiation rather than fullness is the single most impactful long-term maintenance skill, and it can only develop through the repeated practice of mindful self-assessment at meals.',

        maintenance_band_education: 'Your maintenance weight range is one of the most important concepts to internalize. It defines the range of weight that is expected and acceptable as your medication changes. Accepting this band prevents the emotional spiral that leads people to abandon their habits.\n\nThe band is set at 3 to 5 percent of your goal or lowest stable weight. If your lowest was 160 pounds, your band is roughly 155 to 168. Fluctuations within this range are normal — they reflect daily water shifts, hormonal cycles, meal timing, and the biological adjustments that happen during transition.\n\nWhy a range instead of a number? Because weight is never a fixed point. Even people not on medication fluctuate by several pounds daily. Adding the GLP-1 transition on top of normal variability means movement within the band is expected. The goal is to stay within it, not to nail one exact number.\n\nThe action framework is simple. Within the band: continue your habits, do not react to daily fluctuations. Touching the upper edge: tighten habits for one to two weeks — recommit to protein, walking, sleep, and meal structure. Above the band for two or more consecutive weeks: activate the full reset protocol and consider a check-in with your clinician. This band will appear on your weight graph as a visual guide. It replaces anxiety with structure.',

        quick_reset_p3: 'Relapse prevention in maintenance is a systems-level challenge. Unlike the taper phase, where drift manifests over days to weeks, maintenance drift is slower and more insidious — developing over weeks to months as small behavioral deviations compound until habits have materially shifted without conscious awareness. The research on weight-maintenance relapse identifies this gradual erosion, rather than acute events, as the primary failure mode.\n\nYour first surveillance layer is periodic CGM monitoring. Wearing the sensor for 1 to 2 weeks every 4 to 8 weeks provides objective metabolic data independent of subjective self-assessment (which is reliably optimistic). Compare current metrics to your established taper-phase baseline: mean fasting glucose, postprandial peak amplitude, and glycemic variability (CV). Rising numbers are investigative signals, not emergencies.\n\nYour second surveillance layer is a structured behavioral audit on a 2-to-4-week cadence. Assess each habit domain: meal structure and protein adherence, resistance training frequency, post-meal walking consistency, sleep schedule fidelity, and stress management practice. The empirical pattern in maintenance relapse is cascade failure: one domain slips (usually sleep or exercise), which impairs a second (nutrition or stress management), which degrades a third. Early detection of the initial slip prevents the cascade.\n\nWhen drift is identified, deploy the graduated response protocol. Mild drift (fasting glucose up 5 to 10 mg/dL, one skipped training session): the 3-step reset is sufficient — protein anchor, walk, sleep check. Moderate drift (fasting glucose up 10+ mg/dL, multiple missed sessions, unstructured meals): commit to a 2-week recommitment block tightening all five habit domains simultaneously. Significant drift (sustained weight above maintenance band, consistently elevated glucose, most habits abandoned): structured restart with clinician support.\n\nThe most dangerous cognitive distortion in maintenance is temporal discounting — "I will get back on track tomorrow." Behavioral momentum research demonstrates that the single most predictive action is the next one: eat a protein-anchored meal now, walk for 10 minutes now, set a bedtime alarm now. Momentum builds from one action, not one perfect day. Your behavioral patterns exhibit a well-documented reconsolidation advantage — habits that have been previously established rebuild faster than novel ones. Use this to your advantage: you are not starting over, you are reactivating.'
      };

      var EDUCATION_SECTION_ORDER = ['glucose_cgm', 'nutrition', 'exercise', 'hunger', 'sleep', 'stress'];
      var EDUCATION_SECTIONS = {
        glucose_cgm: {
          title: 'Glucose & CGM',
          modules: [
            { id: 'cgm_basics', title: 'What is a CGM?', description: 'Your sensor reads blood sugar and shows it on your phone. Here is what the line means.', estimatedTime: '1 min', tier: 'foundation' },
            { id: 'glp1_basics', title: 'How your medication helps', description: 'Your medication reduces hunger and stabilizes blood sugar. Here are the basics.', estimatedTime: '1 min', tier: 'foundation' },
            { id: 'patterns_101', title: 'Spotting your first patterns', description: 'Which meals spike you? Which keep you flat? Start noticing.', estimatedTime: '1 min', tier: 'foundation' },
            { id: 'cgm_transition', title: 'CGM during dose changes', description: 'Spikes get bigger as medication tapers. Learn what is expected vs. what to act on.', estimatedTime: '2 min', tier: 'intermediate' },
            { id: 'pairing_glucose', title: 'Macro pairing for glucose', description: 'Combine carbs with protein, fat, and fiber to flatten your curve.', estimatedTime: '2 min', tier: 'intermediate' },
            { id: 'weight_after_glp1', title: 'Weight after GLP-1 changes', description: 'Some regain is biologically expected. Learn why, how much, and when to act.', estimatedTime: '2 min', tier: 'intermediate' },
            { id: 'scale_during_transition', title: 'Using the scale wisely', description: 'Daily weight fluctuates 2-4 lbs. How to use it as data, not stress.', estimatedTime: '2 min', tier: 'intermediate' },
            { id: 'maintenance_band_education', title: 'Your maintenance band', description: 'The 3-5% weight range that defines success.', estimatedTime: '2 min', tier: 'intermediate' },
            { id: 'drift_prevention', title: 'Drift detection & correction', description: 'Fasting glucose trends, variability, and catching metabolic drift early.', estimatedTime: '3 min', tier: 'advanced' },
            { id: 'cgm_maintenance', title: 'Long-term CGM strategy', description: 'Periodic wear protocol: when to monitor and escalation criteria.', estimatedTime: '3 min', tier: 'advanced' }
          ],
          games: []
        },
        exercise: {
          title: 'Exercise',
          modules: [
            { id: 'resistance_first', title: 'Why strength training matters', description: 'Keep your muscle while losing weight. Here is how to start.', estimatedTime: '1 min', tier: 'foundation' },
            { id: 'post_meal_move', title: 'The post-meal walk', description: 'Walk 10 minutes after eating. The easiest habit with the biggest payoff.', estimatedTime: '1 min', tier: 'foundation' },
            { id: 'post_meal_walk', title: 'Optimizing post-meal walks', description: 'Timing, pace, and duration for maximum glucose benefit.', estimatedTime: '2 min', tier: 'intermediate' },
            { id: 'strength_taper', title: 'Progressive overload', description: 'Make your workouts gradually harder. Introducing progressive overload.', estimatedTime: '2 min', tier: 'intermediate' },
            { id: 'protein_muscle', title: 'Protein + exercise = muscle', description: 'Protein is the building material, exercise is the blueprint.', estimatedTime: '2 min', tier: 'intermediate' },
            { id: 'long_term_strength', title: 'Periodization & progression', description: 'Linear periodization, deloads, and the science of long-term training.', estimatedTime: '3 min', tier: 'advanced' },
            { id: 'post_meal_maintenance', title: 'NEAT & energy expenditure', description: 'Why daily movement predicts maintenance better than gym sessions.', estimatedTime: '3 min', tier: 'advanced' }
          ],
          games: [
            { id: 'muscle_guess', title: 'Which muscle?', description: 'Guess the main muscle each exercise targets.', type: 'muscle_guess', estimatedTime: '3 min' },
            { id: 'build_workout', title: 'Build a workout', description: 'Pick exercises, get scored, learn rep schemes.', type: 'build_workout', estimatedTime: '5 min' },
            { id: 'form_quiz', title: 'Which has better form?', description: 'Compare exercise descriptions and pick proper form.', type: 'form_quiz', estimatedTime: '4 min' },
            { id: 'record_form', title: 'Record your form', description: 'Film 5 reps and get movement-specific feedback.', type: 'record_form', estimatedTime: '2 min' }
          ]
        },
        nutrition: {
          title: 'Nutrition',
          modules: [
            { id: 'meal_structure', title: 'Eat 3 meals a day', description: 'Regular meals protect muscles and build a lasting routine.', estimatedTime: '1 min', tier: 'foundation' },
            { id: 'protein_anchor_p1', title: 'Protein at every meal', description: 'Put protein on your plate every time you eat. Here is why.', estimatedTime: '1 min', tier: 'foundation' },
            { id: 'fiber_intro', title: 'Adding fiber', description: 'Fiber helps digestion, blood sugar, and fullness. Go slow.', estimatedTime: '1 min', tier: 'foundation' },
            { id: 'appetite_return', title: 'Managing appetite return', description: 'Hunger coming back is expected. Use your habits as a satiety toolkit.', estimatedTime: '2 min', tier: 'intermediate' },
            { id: 'carb_strategy', title: 'Carb pairing strategies', description: 'Be intentional, not restrictive. Pairing, portions, and timing.', estimatedTime: '2 min', tier: 'intermediate' },
            { id: 'satiety_playbook', title: 'Satiety playbook', description: 'Protein density, fiber volume, and meal construction for fullness.', estimatedTime: '2 min', tier: 'intermediate' },
            { id: 'maintenance_playbook', title: 'Flexible restraint (80/20)', description: 'Evidence-based maintenance nutrition and flexible structure.', estimatedTime: '3 min', tier: 'advanced' },
            { id: 'alcohol_maintenance', title: 'Alcohol & maintenance', description: 'Alcohol\'s effects on glucose, sleep, hunger, and body composition.', estimatedTime: '3 min', tier: 'advanced' },
            { id: 'holidays_travel', title: 'Travel, holidays & social eating', description: 'Navigate disruptions with flexible restraint.', estimatedTime: '3 min', tier: 'advanced' }
          ],
          games: [
            { id: 'protein_guess', title: 'Protein quiz', description: 'Which food has more protein?', type: 'protein_guess', estimatedTime: '2 min' },
            { id: 'fiber_guess', title: 'Fiber face-off', description: 'Which food has more fiber?', type: 'fiber_guess', estimatedTime: '2 min' },
            { id: 'build_meal', title: 'Build a balanced plate', description: 'Pick protein, carb, and veggie for a balanced meal.', type: 'build_meal', estimatedTime: '2 min' }
          ]
        },
        hunger: {
          title: 'Hunger & Satiety',
          modules: [
            { id: 'hunger_basics', title: 'What hunger actually is', description: 'Hunger is information, not an emergency. Understanding ghrelin, leptin, and your fuel gauge.', estimatedTime: '1 min', tier: 'foundation' },
            { id: 'hunger_signals', title: 'Reading your hunger levels', description: 'The 5 levels of hunger and why eating at a 3 is the sweet spot.', estimatedTime: '1 min', tier: 'foundation' },
            { id: 'fullness_signals', title: 'Reading your fullness levels', description: 'Learn to stop at "satisfied" instead of "stuffed." The halfway pause.', estimatedTime: '1 min', tier: 'foundation' },
            { id: 'understanding_fullness', title: 'Hunger vs. fullness after GLP-1', description: 'Your signals are returning. Practice noticing them as they come back.', estimatedTime: '1 min', tier: 'foundation' },
            { id: 'hunger_medication', title: 'How medication changes hunger', description: 'What GLP-1 does to ghrelin and gastric emptying — and what happens when it changes.', estimatedTime: '2 min', tier: 'intermediate' },
            { id: 'emotional_hunger', title: 'Emotional vs. physical hunger', description: 'Sudden cravings vs. slow-building hunger. The HALT technique.', estimatedTime: '2 min', tier: 'intermediate' },
            { id: 'hunger_vs_emotional', title: 'Navigating appetite return', description: 'When medication changes, hunger rebounds. How to tell recalibration from overeating.', estimatedTime: '2 min', tier: 'intermediate' },
            { id: 'satiety_skill', title: 'Satiety as a skill', description: 'What you eat, how you eat, and when you eat — three levers for lasting fullness.', estimatedTime: '3 min', tier: 'advanced' },
            { id: 'satiety_mastery', title: 'Advanced satiety strategies', description: 'Protein leveraging, volume eating, and the satiation-vs-fullness distinction.', estimatedTime: '3 min', tier: 'advanced' }
          ],
          games: []
        },
        sleep: {
          title: 'Sleep & Recovery',
          modules: [
            { id: 'sleep_consistency_p1', title: 'Sleep matters more than you think', description: 'Bad sleep = more hunger the next day. One habit: consistent bedtime.', estimatedTime: '1 min', tier: 'foundation' },
            { id: 'hydration_p1', title: 'Drink more water', description: 'Medication can hide thirst. Simple reminders to stay hydrated.', estimatedTime: '1 min', tier: 'foundation' },
            { id: 'gi_comfort', title: 'GI comfort on medication', description: 'Nausea, bloating, constipation? Simple fixes that work.', estimatedTime: '1 min', tier: 'foundation' },
            { id: 'sleep_taper', title: 'Sleep and hunger hormones', description: 'Poor sleep raises ghrelin and lowers leptin. How to protect yourself.', estimatedTime: '2 min', tier: 'intermediate' },
            { id: 'hydration_p2', title: 'Hydration as a strategic tool', description: 'Water before meals, steady sipping, and digestion support.', estimatedTime: '2 min', tier: 'intermediate' },
            { id: 'stress_sleep_glucose', title: 'Sleep architecture & metabolism', description: 'Deep sleep, glucose tolerance, and ghrelin/leptin without medication.', estimatedTime: '3 min', tier: 'advanced' }
          ],
          games: []
        },
        stress: {
          title: 'Stress & Resilience',
          modules: [
            { id: 'stress_glucose_p1', title: 'Stress raises blood sugar', description: 'Stressed days = higher numbers. Three simple tools to recover.', estimatedTime: '1 min', tier: 'foundation' },
            { id: 'recovery_p1', title: 'Rest days are part of the plan', description: 'Your body gets stronger during rest, not during workouts.', estimatedTime: '1 min', tier: 'foundation' },
            { id: 'stress_taper', title: 'Stress during transition', description: 'Cortisol raises blood sugar and cravings. Measurable metabolic impact.', estimatedTime: '2 min', tier: 'intermediate' },
            { id: 'quick_reset', title: 'The 3-step reset', description: 'Off track? Protein anchor, 15-min walk, sleep check.', estimatedTime: '2 min', tier: 'intermediate' },
            { id: 'stress_maintenance', title: 'Allostatic load & HPA axis', description: 'Cumulative stress physiology and evidence-based reduction.', estimatedTime: '3 min', tier: 'advanced' },
            { id: 'quick_reset_p3', title: 'Relapse prevention protocol', description: 'Surveillance layers, cascade failure detection, and graduated response.', estimatedTime: '3 min', tier: 'advanced' }
          ],
          games: [
            { id: 'guided_meditation', title: 'Guided breathing', description: '5-minute breathing exercise for calm and stress relief.', type: 'guided_meditation', estimatedTime: '5 min' }
          ]
        }
      };

      /* Single-program config — no phases */
      var TOOLKIT_MODULE_IDS = ['education', 'glucose_cgm', 'nutrition', 'exercise', 'sleep', 'stress', 'success_metrics'];
      var TOOLKIT_MODULES = {
        education: { id: 'education', title: 'Education overview', steps: [
          { type: 'reading', title: 'Your graduation at a glance', body: 'This toolkit guides your 16-week graduation. Education progresses from foundation to advanced. Build habits now so they carry you forward.' },
          { type: 'reading', title: 'Why it matters', body: 'Durable habits\u2014protein anchor, structured meals, resistance training, CGM awareness\u2014support stability with or without medication. Complete the modules below to build your foundation.' }
        ]},
        glucose_cgm: { id: 'glucose_cgm', title: 'Glucose & CGM', steps: [
          { type: 'reading', title: 'Observe and learn', body: 'CGM is feedback, not judgment. Focus on patterns over single readings. No spike alarms, no perfection pressure.' },
          { type: 'reading', title: 'Personal patterns', body: 'Identify what drives your spikes: meal composition, timing, activity. Use Insights to see your Glucose GPA and trends.' }
        ]},
        nutrition: { id: 'nutrition', title: 'Nutrition', steps: [
          { type: 'reading', title: 'Protein anchor', body: 'Aim for a daily minimum at each meal. Structured meals even without hunger help prevent under-eating and lean mass loss.' },
          { type: 'activity', activityId: 'protein_guess' },
          { type: 'reading', title: 'Fiber and satiety', body: 'Introduce fiber gradually. Pair carbs with protein and volume foods for better glucose and fullness.' }
        ]},
        exercise: { id: 'exercise', title: 'Exercise', steps: [
          { type: 'reading', title: 'Resistance first', body: 'Resistance training is required for lean mass protection. Moderate cardio is optional. Avoid aggressive volume increases.' },
          { type: 'activity', activityId: 'build_workout' },
          { type: 'reading', title: 'Post-meal movement', body: 'A 10\u201315 min walk after meals supports glucose disposal. Build this into your routine in Transition and Maintenance.' }
        ]},
        sleep: { id: 'sleep', title: 'Sleep', steps: [
          { type: 'reading', title: 'Sleep consistency', body: 'Consistent sleep supports appetite regulation (ghrelin/leptin) and glucose. Aim for similar bed and wake times.' },
          { type: 'reading', title: 'Hydration', body: 'GLP-1 can blunt thirst. Set reminders to drink water. Good hydration supports GI comfort and consistency.' }
        ]},
        stress: { id: 'stress', title: 'Stress', steps: [
          { type: 'reading', title: 'Stress and glucose', body: 'Stress and cortisol can affect appetite and glucose. Integrate stress management (e.g. breathing, movement, sleep) into your routine.' },
          { type: 'reading', title: 'Recovery', body: 'Recovery is part of the plan. Rest days and sleep matter as much as training and nutrition.' }
        ]},
        success_metrics: { id: 'success_metrics', title: 'Success metrics', steps: [
          { type: 'reading', title: 'What we track', body: 'Habit adoption rate, protein anchor adherence, resistance sessions per week, education completion, and glucose variability trend. Focus on consistency, not perfection.' },
          { type: 'reading', title: 'Your scores', body: 'Glucose GPA, Lifestyle GPA, Hunger/satiety ratings, and Consistency (macros, water, education completion, lifestyle, and glucose) feed your Transition Readiness score.' }
        ]}
      };
      var PROTEIN_GUESS_ITEMS = [
        { a: '1 cup Greek yogurt', b: '1 medium banana', more: 'a', aG: 20, bG: 1 },
        { a: '3 oz chicken breast', b: '1 cup white rice', more: 'a', aG: 26, bG: 4 },
        { a: '2 large eggs', b: '1 slice whole-wheat bread', more: 'a', aG: 12, bG: 4 },
        { a: '1 scoop whey protein', b: '1 apple', more: 'a', aG: 24, bG: 0 }
      ];
      var BUILD_WORKOUT_OPTIONS = ['Squats', 'Push-ups', 'Rows (band or dumbbell)', 'Lunges', 'Plank', 'Glute bridge'];
      var BUILD_BACK_OPTIONS = ['Bent-over row (dumbbell or band)', 'Seated row (cable or band)', 'Single-arm row', 'Face pulls', 'Reverse flyes', 'Superman hold', 'Lat pull-down (if available)', 'Deadlift (conventional or Romanian)'];
      var BUILD_LEGS_OPTIONS = ['Squats (goblet or bodyweight)', 'Lunges (forward or reverse)', 'Glute bridge', 'Romanian deadlift (RDL)', 'Step-ups', 'Calf raises', 'Leg curl (if available)', 'Leg press (if available)'];
      var MUSCLE_BUILDING_EDUCATION = 'Why muscle building matters: Preserving or building lean mass supports metabolism, strength, and long-term weight stability—especially on or after GLP-1. Rep scheme for muscle building: aim for 8–12 reps per set (hypertrophy range); 2–4 sets per exercise. Slow down the eccentric (lowering phase) of each movement—e.g. 2–3 seconds down on a squat or row—to increase time under tension and reduce injury risk. Choose 3–4 exercises per muscle group (back, then legs) for a balanced session. Consistency (2–3x per week per muscle group) beats one-off intensity.';
      var FORM_QUIZ_ITEMS = [
        { movement: 'Squat', question: 'Which option shows closer to proper squat form?', optionA: 'Knees caving inward, chest dropped, weight on toes.', optionB: 'Knees tracking over toes, chest up, weight in mid-foot.', correct: 'B' },
        { movement: 'Romanian deadlift (RDL)', question: 'Which option is closer to proper RDL form?', optionA: 'Rounding the lower back, knees locked straight.', optionB: 'Slight bend in knees, neutral spine, hinge at hips, slight stretch in hamstrings.', correct: 'B' },
        { movement: 'Push-up', question: 'Which describes better push-up form?', optionA: 'Sagging hips, head dropping, elbows flared out 90°.', optionB: 'Body in a straight line, core braced, elbows ~45° from body.', correct: 'B' },
        { movement: 'Dead bug', question: 'Which is better dead bug form?', optionA: 'Lower back lifting off floor, holding breath, moving too fast.', optionB: 'Lower back pressed to floor throughout, exhale as limb extends, slow and controlled.', correct: 'B' }
      ];
      var RECORD_FORM_MOVEMENTS = [
        { id: 'squat', name: 'Squat', tips: 'Record from the side. Do 5 reps in ~10 seconds. Keep chest up, knees over toes, weight in mid-foot.' },
        { id: 'rdl', name: 'Romanian deadlift (RDL)', tips: 'Record from the side. 5 reps, ~10 sec. Hinge at hips, soft knees, neutral spine.' },
        { id: 'pushup', name: 'Push-up', tips: 'Record from the side. 5 reps, ~10 sec. Straight line from head to heels, controlled tempo.' },
        { id: 'deadbug', name: 'Dead bug', tips: 'Record from the side. 5 reps, ~10 sec. Lower back stays on floor; extend opposite arm and leg slowly.' }
      ];
      var RECORD_FORM_CORRECTIONS = {
        squat: 'Form score: 7/10. Corrections: Keep chest up throughout the rep. Track knees over toes—avoid letting them cave in. Shift weight into mid-foot if you tend to rise onto toes.',
        rdl: 'Form score: 8/10. Corrections: Maintain a neutral spine; avoid rounding the lower back. Soft bend in the knees. Feel the stretch in your hamstrings as you hinge.',
        pushup: 'Form score: 7/10. Corrections: Keep a straight line from head to heels—don’t let hips sag or pike up. Brace your core. Elbows at about 45° from your body.',
        deadbug: 'Form score: 8/10. Corrections: Press lower back into the floor before moving. Exhale as you extend the arm and leg. Move slowly and with control.'
      };
      var FIBER_GUESS_ITEMS = [
        { a: '1 cup black beans', b: '1 cup white rice', more: 'a', aG: 15, bG: 0.6 },
        { a: '1 medium apple with skin', b: '1 cup apple juice', more: 'a', aG: 4, bG: 0 },
        { a: '1 cup broccoli', b: '1 cup iceberg lettuce', more: 'a', aG: 5, bG: 1 },
        { a: '1/2 cup oats', b: '1 slice white bread', more: 'a', aG: 4, bG: 0.8 },
        { a: '1 medium sweet potato', b: '1 medium potato', more: 'a', aG: 4, bG: 2 }
      ];
      var BUILD_MEAL_PROTEINS = ['Grilled chicken breast', 'Salmon', 'Greek yogurt', 'Eggs', 'Lentils', 'Tofu'];
      var BUILD_MEAL_CARBS = ['Brown rice', 'Quinoa', 'Sweet potato', 'Whole-wheat bread', 'Oats', 'Black beans'];
      var BUILD_MEAL_VEGGIES = ['Broccoli', 'Spinach', 'Bell peppers', 'Zucchini', 'Mixed greens', 'Roasted vegetables'];
      var MUSCLE_GUESS_ITEMS = [
        { exercise: 'Squats', options: ['Quadriceps', 'Hamstrings', 'Calves', 'Biceps'], correct: 0 },
        { exercise: 'Push-ups', options: ['Chest', 'Triceps', 'Shoulders', 'Back'], correct: 0 },
        { exercise: 'Rows (band or dumbbell)', options: ['Back', 'Biceps', 'Shoulders', 'Chest'], correct: 0 },
        { exercise: 'Lunges', options: ['Quadriceps', 'Glutes', 'Hamstrings', 'Calves'], correct: 1 },
        { exercise: 'Plank', options: ['Core', 'Shoulders', 'Glutes', 'Chest'], correct: 0 },
        { exercise: 'Glute bridge', options: ['Glutes', 'Hamstrings', 'Core', 'Quadriceps'], correct: 0 }
      ];
      var MEDITATION_SCRIPT = [
        { t: 0, text: 'Find a comfortable seat or lie down. Close your eyes if that feels good.' },
        { t: 30, text: 'Take a slow breath in through your nose... and out through your mouth.' },
        { t: 60, text: 'Let your shoulders drop. Relax your jaw. Notice your feet on the floor.' },
        { t: 90, text: 'Breathe in for 4 counts... hold for 2... breathe out for 6.' },
        { t: 120, text: 'If your mind wanders, gently bring it back to your breath.' },
        { t: 150, text: 'You\'re doing great. One more minute of calm breathing.' },
        { t: 240, text: 'When you\'re ready, wiggle your fingers and toes. Open your eyes slowly.' },
        { t: 300, text: 'Well done. Carry this calm with you.' }
      ];
      var INSIGHT_TYPES = ['pattern_insight', 'comparison_insight', 'recovery_insight', 'drift_alert', 'stability_tip', 'sleep_stress_correlation', 'hydration_consistency'];
      var INSIGHT_WEIGHT = { pattern_insight: 1, stability_tip: 0.9, drift_alert: 0.8, recovery_insight: 0.7, hydration_consistency: 0.6 };

      function getState() {
        try {
          var s = localStorage.getItem(STORAGE_KEY);
          return s ? JSON.parse(s) : {};
        } catch (e) { return {}; }
      }
      function saveState(s) {
        try { localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); } catch (e) {}
      }

      var state = getState();
      function migrateToProgramState(s) {
        if (!s.doseEvents && s.dose_change_events) {
          s.doseEvents = (s.dose_change_events || []).map(function(e) { return { type: e.type, occurredAt: e.occurredAt || e.date || new Date().toISOString().slice(0, 10), notes: e.notes }; });
        }
        if (s.phaseStartAt === undefined) s.phaseStartAt = s.glp1_phase_start_date || new Date().toISOString().slice(0, 10);
        if (!s.preferences) s.preferences = { showDailyWeight: false, showWeightAtAll: true, notificationsEnabled: true };
        if (s.maintenanceBandPct === undefined) s.maintenanceBandPct = s.maintenance_band_pct !== undefined ? s.maintenance_band_pct : 5;
        if (s.weightAnchor === undefined) s.weightAnchor = null;
        if (!s.dismissedBanners) s.dismissedBanners = {};
        if (!s.hungerEntries) s.hungerEntries = {};
        if (!s.bodyScanEntries) s.bodyScanEntries = {};
        if (!s.completedModules) s.completedModules = {};
        if (!s.completedGames) s.completedGames = {};
        if (!s.weeklyCheckIns) s.weeklyCheckIns = {};
        if (!s.weeklyScoreHistory) s.weeklyScoreHistory = [];
        if (!s.postWeek8CheckIn) s.postWeek8CheckIn = null;
        if (!s.week1CheckIn) s.week1CheckIn = null;
        if (!s.week5CheckIn) s.week5CheckIn = null;
        if (!s.focusAreas) s.focusAreas = [];
        if (!s.profile) s.profile = {};
        if (!s.coachSessions) s.coachSessions = [];
        if (!s.strategyLog) s.strategyLog = [];
        if (!s.weekOrder) s.weekOrder = null;
        return s;
      }
      state = migrateToProgramState(state);
      if (state.onboardingComplete === undefined) state.onboardingComplete = false;
      if (!state.phaseStartAt) state.phaseStartAt = state.glp1_phase_start_date || new Date().toISOString().slice(0, 10);
      if (!state.dose_change_events) state.dose_change_events = [];
      if (!state.doseEvents) state.doseEvents = [];
      if (state.maintenance_band_pct === undefined) state.maintenance_band_pct = 5;
      if (!state.program_enrolled_at) state.program_enrolled_at = state.onboardingComplete ? new Date().toISOString() : null;

      function analytics(eventName, props) {
        try { if (window.__glp1_analytics) window.__glp1_analytics(eventName, props); else console.log('[glp1]', eventName, props || {}); } catch (e) {}
      }
      function scoreToGPA(score) {
        if (score >= 90) return { letter: 'A', class: 'a' };
        if (score >= 80) return { letter: 'B', class: 'b' };
        if (score >= 70) return { letter: 'C', class: 'c' };
        if (score >= 60) return { letter: 'D', class: 'd' };
        return { letter: 'F', class: 'f' };
      }
      function score100To15(score100) {
        return Math.round((1 + (score100 / 100) * 4) * 10) / 10;
      }
      function getGlucoseGPA(state) {
        var metrics = [
          { title: 'Postprandial (post-meal) glucose avg', value: '130 mg/dL', pct: 65 },
          { title: 'Daily glucose average', value: '108 mg/dL', pct: 50 },
          { title: 'Overnight glucose average', value: '90 mg/dL', pct: 32 },
          { title: 'Glucose variability (CV)', value: '10%', pct: 42 },
          { title: 'Time in Range', value: '85%', pct: 72 },
          { title: 'Spikes per day', value: '1.0', pct: 30 },
          { title: 'Crashes per day', value: '1.0', pct: 35 }
        ];
        var score100 = 78;
        var score15 = score100To15(score100);
        return { score15: score15, score100: score100, gpa: scoreToGPA(score100), metrics: metrics };
      }
      function getLifestyleGPA(state) {
        var latestScan = null;
        if (state.bodyScanEntries) {
          var scanKeys = Object.keys(state.bodyScanEntries).sort().reverse();
          if (scanKeys.length > 0) latestScan = state.bodyScanEntries[scanKeys[0]];
        }
        var bodyFatVal = latestScan ? latestScan.bodyFat + '%' : '28%';
        var bodyFatPct = latestScan ? Math.max(10, Math.min(90, 100 - latestScan.bodyFat * 2)) : 58;
        var visceralVal = latestScan ? latestScan.visceralFat + '%' : '\u2014 No scan yet';
        var visceralPct = latestScan ? Math.max(10, Math.min(90, 100 - latestScan.visceralFat * 4)) : null;
        var scanBonus = latestScan ? latestScan.lifestyleBonus : 0;
        var factors = [
          { title: 'Weight', value: '165 lbs', pct: 45 },
          { title: 'Activity', value: 'Moderate', pct: 62 },
          { title: 'Sleep', value: '72%', pct: 38 },
          { title: 'Body fat %', value: bodyFatVal, pct: bodyFatPct },
          { title: 'Visceral fat %', value: visceralVal, pct: visceralPct },
          { title: 'HRV (Heart Rate Variability)', value: '\u2014 No data', pct: null }
        ];
        var score100 = Math.min(100, 74 + scanBonus);
        var score15 = score100To15(score100);
        return { score15: score15, score100: score100, gpa: scoreToGPA(score100), period: '3 months', factors: factors };
      }
      var GAUGE_COLORS = { from: '#7c3aed', to: '#a78bfa' };
      function buildGaugeSVG(score15, gradId) {
        var pct = Math.min(1, Math.max(0, (score15 - 1) / 4));
        var pathLen = 283;
        var dash = Math.round(pct * pathLen);
        var gc = GAUGE_COLORS;
        return '<svg class="gpa-gauge-svg" viewBox="0 0 200 100" preserveAspectRatio="xMidYMax meet"><defs><linearGradient id="' + gradId + '" x1="0" y1="0" x2="1" y2="0"><stop offset="0%" stop-color="' + gc.from + '"/><stop offset="100%" stop-color="' + gc.to + '"/></linearGradient></defs><path d="M 10 90 A 90 90 0 0 1 190 90" fill="none" stroke="#e2e8f0" stroke-width="12" stroke-linecap="round"/><path d="M 10 90 A 90 90 0 0 1 190 90" fill="none" stroke="url(#' + gradId + ')" stroke-width="12" stroke-linecap="round" stroke-dasharray="' + dash + ' ' + pathLen + '"/></svg>';
      }
      function buildGlucoseGPAHtml(g) {
        var rows = g.metrics.map(function(m) {
          var thumbStyle = m.pct != null ? 'left:' + m.pct + '%' : 'display:none';
          return '<div class="gpa-metric-row"><div class="metric-info"><div class="metric-title">' + m.title + '</div><div class="metric-value">' + m.value + '</div></div><div class="metric-slider-wrap"><span class="metric-slider-thumb" style="' + thumbStyle + '"></span></div><span class="metric-chevron">&#8250;</span></div>';
        }).join('');
        return '<div class="gpa-section-card" data-gpa-type="glucose"><div class="gpa-gauge-wrap"><div class="gpa-gauge-title">Glucose GPA</div>' + buildGaugeSVG(g.score15, 'gaugeGlucose') + '<div class="gpa-gauge-score">' + g.score15 + '</div><div class="gpa-gauge-scale"><span>1</span><span>5</span></div></div>' + rows + '</div>';
      }
      function buildLifestyleGPAHtml(l) {
        var rows = l.factors.map(function(f) {
          var thumbStyle = f.pct != null ? 'left:' + f.pct + '%' : 'display:none';
          return '<div class="gpa-metric-row"><div class="metric-info"><div class="metric-title">' + f.title + '</div><div class="metric-value">' + f.value + '</div></div><div class="metric-slider-wrap"><span class="metric-slider-thumb" style="' + thumbStyle + '"></span></div><span class="metric-chevron">&#8250;</span></div>';
        }).join('');
        return '<div class="gpa-section-card" data-gpa-type="lifestyle"><div class="gpa-gauge-wrap"><div class="gpa-gauge-title">Lifestyle score &#8226; ' + (l.period || '3 months') + '</div>' + buildGaugeSVG(l.score15, 'gaugeLifestyle') + '<div class="gpa-gauge-score">' + l.score15 + '</div><div class="gpa-gauge-scale"><span>1</span><span>5</span></div></div>' + rows + '</div>';
      }
      function buildTransitionReadinessInsightHtml(readiness, glucoseScore15, lifestyleScore15, consistencyScore100, hungerAvg) {
        var readiness15 = score100To15(readiness);
        var consistency15 = score100To15(consistencyScore100);
        var hungerLabel = hungerAvg >= 2.5 && hungerAvg <= 3.5 ? 'On track' : (hungerAvg < 2.5 ? 'Low' : 'Higher');
        return '<div class="gpa-section-card" data-gpa-type="readiness"><div class="gpa-gauge-wrap"><div class="gpa-gauge-title">Transition Readiness</div>' + buildGaugeSVG(readiness15, 'gaugeReadiness') + '<div class="gpa-gauge-score">' + readiness15 + ' <span class="gpa-out-of">/ 5</span></div><div class="gpa-gauge-scale"><span>1</span><span>5</span></div></div>' +
          '<div class="readiness-components"><div class="m-title">Components</div>' +
          '<div class="readiness-component-row"><span>Glucose GPA</span><span>' + glucoseScore15 + '</span></div>' +
          '<div class="readiness-component-row"><span>Lifestyle GPA</span><span>' + lifestyleScore15 + '</span></div>' +
          '<div class="readiness-component-row"><span>Hunger/satiety ratings</span><span>' + hungerLabel + '</span></div>' +
          '<div class="readiness-component-row"><span>Consistency rating</span><span>' + consistency15 + '</span></div></div>' +
          '<p class="readiness-toolkit-note">Based on macros, water, education completion, lifestyle score, and glucose score consistency. Full score &amp; plan in Transition Toolkit.</p></div>';
      }
      var GPA_EXPLANATIONS = {
        glucose: {
          title: 'Glucose GPA',
          description: 'A composite score (1\u20135) based on how well your glucose stays in a healthy range. Combines post-meal response, daily average, overnight levels, variability, time in range, spikes, and crashes.',
          components: {
            'Postprandial (post-meal) glucose avg': {
              desc: 'How high your glucose rises within 2 hours after meals. Lower averages mean better blood sugar control after eating.',
              ideal: 'Under 140 mg/dL',
              tips: [
                'Eat protein and fat before carbs \u2014 food order flattens the curve by up to 30%.',
                'Take a 10\u201315 min walk within 30 minutes of finishing a meal.',
                'Never eat carbs alone \u2014 always pair with protein, fat, or fiber.',
                'Try apple cider vinegar (1 tbsp in water) before a carb-heavy meal.',
                'Slow down your eating pace \u2014 meals under 10 minutes spike glucose more.'
              ]
            },
            'Daily glucose average': {
              desc: 'Your mean glucose reading across the entire day. Closer to 90\u2013110 mg/dL is ideal for most people.',
              ideal: '90\u2013110 mg/dL',
              tips: [
                'Anchor every meal with 25\u201330g protein to keep average glucose lower.',
                'Spread meals evenly through the day \u2014 avoid skipping then overeating.',
                'Reduce refined carbs (white bread, pasta, sugary drinks) in favor of whole foods.',
                'Stay hydrated \u2014 dehydration raises blood glucose concentration.',
                'Get 7\u20139 hours of sleep \u2014 short sleep raises next-day glucose average.'
              ]
            },
            'Overnight glucose average': {
              desc: 'Your glucose level while sleeping. Stable, lower overnight glucose suggests good metabolic health.',
              ideal: '70\u201390 mg/dL',
              tips: [
                'Avoid large meals within 2\u20133 hours of bedtime.',
                'If you snack at night, choose protein + fat (e.g., nuts, cheese) over carbs.',
                'Keep a consistent bedtime \u2014 irregular sleep disrupts overnight glucose.',
                'Manage evening stress \u2014 cortisol raises fasting glucose.',
                'Limit alcohol \u2014 it disrupts liver glucose regulation overnight.'
              ]
            },
            'Glucose variability (CV)': {
              desc: 'Coefficient of variation \u2014 how much your glucose swings throughout the day. Lower CV means more stable glucose.',
              ideal: 'Under 20%',
              tips: [
                'Keep consistent meal timing day-to-day \u2014 variability thrives on irregularity.',
                'Balance every meal: protein + carb + fat + fiber.',
                'Avoid sugar-sweetened beverages \u2014 the single biggest variability driver.',
                'Move after meals consistently, not just occasionally.',
                'Manage stress \u2014 cortisol spikes create glucose spikes even without food.'
              ]
            },
            'Time in Range': {
              desc: 'Percentage of time your glucose stays within the target range (typically 70\u2013140 mg/dL). Higher is better.',
              ideal: 'Above 85%',
              tips: [
                'Increase fiber at every meal \u2014 veggies, beans, and whole grains slow absorption.',
                'Eliminate liquid sugar (juice, soda, sweetened coffee) \u2014 fastest TIR improvement.',
                'Post-meal movement: even 5 minutes of walking helps keep glucose in range.',
                'Consistent meal timing improves TIR more than perfect meal composition.',
                'Prioritize sleep quality \u2014 poor sleep drops TIR significantly the next day.'
              ]
            },
            'Spikes per day': {
              desc: 'Number of times glucose rises above 140 mg/dL per day. Fewer spikes indicate better meal pairing and timing.',
              ideal: 'Less than 1 per day',
              tips: [
                'Pair every carb source with protein and fat \u2014 the #1 spike reducer.',
                'Walk after your largest meal of the day \u2014 biggest bang for your buck.',
                'Add a salad or veggie side to meals \u2014 fiber physically slows glucose absorption.',
                'Watch portion sizes on high-GI foods (rice, potatoes, bread).',
                'Try eating in this order: veggies \u2192 protein \u2192 carbs to blunt the spike.'
              ]
            },
            'Crashes per day': {
              desc: 'Number of times glucose drops below 70 mg/dL per day. Fewer crashes mean more stable energy levels.',
              ideal: 'Less than 0.5 per day',
              tips: [
                'Don\u2019t skip meals \u2014 long gaps between eating cause reactive drops.',
                'Avoid high-sugar meals without protein \u2014 the spike-crash cycle.',
                'Keep a small protein snack available for when you feel shaky or foggy.',
                'Moderate caffeine \u2014 excess coffee on an empty stomach can trigger crashes.',
                'Eat a balanced breakfast with protein to set a stable glucose foundation.'
              ]
            }
          }
        },
        lifestyle: {
          title: 'Lifestyle Score',
          description: 'A composite score (1\u20135) reflecting your overall health behaviors. Combines weight, activity, sleep, body composition, and heart rate variability over the past 3 months.',
          components: {
            'Weight': {
              desc: 'Your current weight tracked over time. The score reflects trend direction (stable, losing, or gaining) relative to your goal.',
              ideal: 'Stable or trending toward goal',
              tips: [
                'Focus on the 7-day trend, not daily fluctuations \u2014 water weight varies 2\u20134 lbs.',
                'Weigh yourself at the same time each day (morning, after bathroom) for consistency.',
                'Prioritize protein intake \u2014 it preserves lean mass during weight loss.',
                'Resistance training prevents muscle loss that makes weight regain easier.',
                'If weight trends up, check sleep and stress before cutting calories.'
              ]
            },
            'Activity': {
              desc: 'Your overall movement level including workouts, steps, and daily activity (NEAT). Higher and more consistent activity scores better.',
              ideal: '3+ workouts/week, 7k+ steps/day',
              tips: [
                'Aim for 2\u20133 resistance training sessions per week \u2014 non-negotiable for GLP-1 users.',
                'Hit 7,000+ steps daily \u2014 NEAT burns more calories than most workouts.',
                'Take movement breaks every hour if you sit for work.',
                'Post-meal walks count toward your step goal AND improve glucose \u2014 double win.',
                'Consistency matters more than intensity \u2014 4 moderate sessions beat 1 intense one.'
              ]
            },
            'Sleep': {
              desc: 'Your sleep consistency and duration. Hitting 7\u20139 hours consistently with similar bed/wake times scores highest.',
              ideal: '7\u20139 hours, consistent timing',
              tips: [
                'Set a consistent bedtime and wake time \u2014 even on weekends.',
                'Stop screens 30\u201360 minutes before bed \u2014 blue light suppresses melatonin.',
                'Keep your bedroom cool (65\u201368\u00b0F) and dark.',
                'Avoid caffeine after 2 PM \u2014 it has a 6-hour half-life.',
                'Morning sunlight within 30 minutes of waking helps set your circadian rhythm.'
              ]
            },
            'Body fat %': {
              desc: 'Your estimated body fat percentage from body scans. Lower body fat (within healthy range) indicates better body composition.',
              ideal: 'Men: 15\u201325%, Women: 20\u201332%',
              tips: [
                'Resistance training is the most effective way to improve body composition.',
                'Protein intake (0.7\u20131g per lb bodyweight) preserves muscle while losing fat.',
                'Scan weekly at the same time for consistent readings.',
                'Focus on the trend over 4+ weeks \u2014 single scans have measurement noise.',
                'Sleep quality directly affects fat loss \u2014 poor sleep shifts weight loss toward muscle.'
              ]
            },
            'Visceral fat %': {
              desc: 'Fat stored around your organs. Lower visceral fat is strongly linked to metabolic health and disease prevention.',
              ideal: 'Below 10%',
              tips: [
                'Aerobic exercise (walking, cycling) is especially effective at reducing visceral fat.',
                'Reduce alcohol \u2014 it\u2019s strongly linked to visceral fat accumulation.',
                'Manage stress \u2014 cortisol drives fat storage preferentially around organs.',
                'Soluble fiber (oats, beans, berries) specifically targets visceral fat reduction.',
                'Sleep 7+ hours \u2014 short sleep increases visceral fat independent of diet.'
              ]
            },
            'HRV (Heart Rate Variability)': {
              desc: 'A measure of your nervous system recovery. Higher HRV generally indicates better fitness and lower stress.',
              ideal: 'Higher is better (varies by age)',
              tips: [
                'Consistent aerobic exercise is the #1 way to increase HRV over time.',
                'Practice slow breathing (4 seconds in, 6 seconds out) for 5 minutes daily.',
                'Avoid alcohol \u2014 even 1\u20132 drinks significantly lowers HRV for 24\u201348 hours.',
                'Prioritize sleep \u2014 HRV drops sharply with less than 7 hours.',
                'Manage training load \u2014 overtraining drops HRV. Include rest days.'
              ]
            }
          }
        },
        readiness: {
          title: 'Transition Readiness',
          description: 'A composite score (1\u20135) that estimates how prepared you are to reduce or stop GLP-1 medication. It weighs four components: Glucose GPA (30%), Lifestyle Score (30%), Hunger/Satiety adaptation (20%), and Consistency (20%) \u2014 which includes education completion, workout regularity, nutrition, and hydration.',
          components: {
            'Glucose GPA (30%)': {
              desc: 'How well you manage glucose through food pairing, movement, and timing \u2014 independent of medication support.',
              ideal: '4.0+ / 5',
              tips: [
                'Pair every meal: protein + carb + fat + fiber \u2014 this is the foundation.',
                'Walk after meals consistently \u2014 movement replaces some of what GLP-1 does for glucose.',
                'Learn your personal spike triggers in CGM data and build around them.',
                'Keep consistent meal timing so your body anticipates and regulates glucose better.',
                'Reduce reliance on medication-driven appetite suppression by building meal structure habits.'
              ]
            },
            'Lifestyle GPA (30%)': {
              desc: 'Your overall health habits: activity, sleep, body composition. Stronger lifestyle habits sustain results off medication.',
              ideal: '4.0+ / 5',
              tips: [
                'Resistance train 2\u20133x/week \u2014 lean mass is the #1 predictor of maintenance success.',
                'Hit step goals daily \u2014 NEAT compensates for metabolic adaptation after GLP-1.',
                'Prioritize sleep consistency \u2014 it supports hunger hormones, glucose, and recovery.',
                'Use the body scanner to ensure you\u2019re maintaining lean mass, not just losing weight.',
                'Build habits that don\u2019t require willpower \u2014 automate meals, workouts, and sleep.'
              ]
            },
            'Hunger/Satiety (20%)': {
              desc: 'How well you recognize and respond to hunger and fullness cues. Scores closest to neutral (3/5) indicate best adaptation.',
              ideal: 'Neutral (2.5\u20133.5)',
              tips: [
                'Complete the daily hunger check-in \u2014 awareness is the first step to control.',
                'Eat slowly and mindfully \u2014 it takes 20 minutes for satiety signals to reach your brain.',
                'Learn the difference between physical hunger and emotional/habitual eating.',
                'Use the protein + fiber + volume formula to feel full without medication support.',
                'Expect appetite to increase during taper \u2014 this is normal, not a sign of failure.'
              ]
            },
            'Consistency (20%)': {
              desc: 'Day-to-day stability of your macros, water, lifestyle score, glucose score, and education completion. Less deviation and more learning means habits are automatic and knowledge-driven.',
              ideal: '4.0+ / 5',
              tips: [
                'Complete your weekly education modules \u2014 knowledge reinforces the habits you\u2019re building.',
                'Meal prep or plan meals in advance \u2014 decision fatigue kills consistency.',
                'Set daily reminders for water, protein, and movement.',
                'Track your habits daily, not weekly \u2014 daily tracking catches drift early.',
                'Don\u2019t try to make up for bad days with restriction \u2014 just return to routine.',
                'Build a \u201cminimum viable day\u201d: the simplest version of your habits you do even on hard days.'
              ]
            }
          }
        }
      };

      function getGPAHistory(state) {
        if (!state.gpaHistory) state.gpaHistory = {};
        var today = getTodayKey();
        var glucose = getGlucoseGPA(state);
        var lifestyle = getLifestyleGPA(state);
        var readinessVal = computeReadiness(state);
        state.gpaHistory[today] = {
          glucose: glucose.score15,
          lifestyle: lifestyle.score15,
          readiness: score100To15(readinessVal)
        };
        saveState(state);
        var keys = Object.keys(state.gpaHistory).sort().reverse().slice(0, 30);
        return { keys: keys, data: state.gpaHistory };
      }

      function getWeekScores(state, type) {
        var hist = getGPAHistory(state);
        var days = [];
        var dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        for (var i = 6; i >= 0; i--) {
          var d = new Date();
          d.setDate(d.getDate() - i);
          var key = d.toISOString().slice(0, 10);
          var entry = hist.data[key];
          var score = entry ? entry[type] : null;
          if (score === null || score === undefined) {
            score = type === 'glucose' ? +(3.5 + Math.random() * 1.0).toFixed(1) :
                    type === 'lifestyle' ? +(3.2 + Math.random() * 1.0).toFixed(1) :
                    +(3.0 + Math.random() * 1.2).toFixed(1);
          }
          days.push({ label: dayNames[d.getDay()], score: parseFloat(score) });
        }
        return days;
      }

      function getBestWorst(weekScores, allTimeData, type) {
        var weekMax = 0, weekMin = 5;
        weekScores.forEach(function(d) { if (d.score > weekMax) weekMax = d.score; if (d.score < weekMin) weekMin = d.score; });
        var allMax = weekMax, allMin = weekMin;
        var keys = Object.keys(allTimeData);
        keys.forEach(function(k) {
          var entry = allTimeData[k];
          if (entry && entry[type] != null) {
            if (entry[type] > allMax) allMax = entry[type];
            if (entry[type] < allMin) allMin = entry[type];
          }
        });
        return { best: Math.max(allMax, weekMax), worst: Math.min(allMin, weekMin) };
      }

      function showGPAModal(type) {
        var existing = document.querySelector('.gpa-modal-overlay');
        if (existing) existing.remove();
        var info = GPA_EXPLANATIONS[type];
        if (!info) return;
        var currentScore;
        if (type === 'glucose') currentScore = getGlucoseGPA(state).score15;
        else if (type === 'lifestyle') currentScore = getLifestyleGPA(state).score15;
        else currentScore = score100To15(computeReadiness(state));

        var weekScores = getWeekScores(state, type);
        var hist = getGPAHistory(state);
        var bw = getBestWorst(weekScores, hist.data, type);

        var barsHtml = weekScores.map(function(d) {
          var h = Math.max(8, Math.round((d.score / 5) * 60));
          return '<div class="gpa-modal-week-day"><div class="day-score">' + d.score + '</div><div class="day-bar" style="height:' + h + 'px"></div><div class="day-label">' + d.label + '</div></div>';
        }).join('');

        var compItems = [];
        if (type === 'glucose') {
          getGlucoseGPA(state).metrics.forEach(function(m) {
            var c = info.components[m.title];
            if (c) compItems.push({ name: m.title, value: m.value, data: c });
          });
        } else if (type === 'lifestyle') {
          getLifestyleGPA(state).factors.forEach(function(f) {
            var c = info.components[f.title];
            if (c) compItems.push({ name: f.title, value: f.value, data: c });
          });
        } else {
          Object.keys(info.components).forEach(function(name) {
            var c = info.components[name];
            compItems.push({ name: name, value: '', data: c });
          });
        }

        var componentsHtml = compItems.map(function(item, idx) {
          return '<div class="gpa-modal-component" data-comp-idx="' + idx + '"><div class="comp-header"><span class="comp-name">' + item.name + '</span>' + (item.value ? '<span class="comp-value">' + item.value + '</span>' : '') + '<span class="comp-chevron">\u203A</span></div><div class="comp-desc">' + item.data.desc + '</div></div>';
        }).join('');

        var overlay = document.createElement('div');
        overlay.className = 'gpa-modal-overlay';
        overlay.innerHTML = '<div class="gpa-modal"><div class="gpa-modal-handle"></div>' +
          '<div class="gpa-modal-header"><h2>' + info.title + '</h2><button type="button" class="gpa-modal-close">\u00D7</button></div>' +
          '<div id="gpa-modal-body">' +
          '<div class="gpa-modal-score-hero"><div class="hero-score">' + currentScore + ' <span style="font-size:0.4em;font-weight:500;-webkit-text-fill-color:var(--text-muted)">/ 5</span></div><div class="hero-label">Current score</div></div>' +
          '<div class="gpa-modal-section"><h3>What this measures</h3><p style="font-size:0.875rem;color:var(--text);margin:0;line-height:1.5">' + info.description + '</p></div>' +
          '<div class="gpa-modal-section"><h3>Components &mdash; tap for advice</h3>' + componentsHtml + '</div>' +
          '<div class="gpa-modal-section"><h3>Past 7 days</h3><div class="gpa-modal-week-row">' + barsHtml + '</div></div>' +
          '<div class="gpa-modal-section"><h3>Best &amp; worst to date</h3><div class="gpa-modal-best-worst"><div class="bw-card best"><div class="bw-value">' + bw.best + '</div><div class="bw-label">Best score</div></div><div class="bw-card worst"><div class="bw-value">' + bw.worst + '</div><div class="bw-label">Worst score</div></div></div></div>' +
          '</div></div>';

        overlay.querySelector('.gpa-modal-close').onclick = function() { overlay.remove(); };
        overlay.onclick = function(e) { if (e.target === overlay) overlay.remove(); };

        overlay.querySelectorAll('.gpa-modal-component').forEach(function(row) {
          row.onclick = function() {
            var idx = parseInt(row.getAttribute('data-comp-idx'), 10);
            var item = compItems[idx];
            if (!item) return;
            showComponentDetail(overlay, item, info.title);
          };
        });

        document.body.appendChild(overlay);
      }

      function showComponentDetail(overlay, item, parentTitle) {
        var body = overlay.querySelector('#gpa-modal-body');
        if (!body) return;
        var header = overlay.querySelector('.gpa-modal-header h2');
        if (header) header.textContent = item.name;

        var tipsHtml = (item.data.tips || []).map(function(tip, i) {
          return '<li><span class="tip-num">' + (i + 1) + '</span><span class="tip-content">' + tip + '</span></li>';
        }).join('');

        body.innerHTML = '<div class="gpa-modal-detail">' +
          '<div class="gpa-modal-section" style="border-top:none;padding-top:8px">' +
          '<button type="button" class="gpa-modal-detail-back" id="comp-detail-back">\u2190 Back to ' + parentTitle + '</button>' +
          '<div class="comp-detail-hero"><div class="cdh-left"><div class="cdh-name">' + item.name + '</div>' + (item.value ? '<div class="cdh-value">' + item.value + '</div>' : '') + '</div><div class="cdh-ideal">Ideal<strong>' + (item.data.ideal || '\u2014') + '</strong></div></div>' +
          '<div class="comp-detail-desc">' + item.data.desc + '</div>' +
          '<h3 style="font-size:0.75rem;text-transform:uppercase;letter-spacing:0.05em;color:var(--accent);font-weight:700;margin:0 0 10px">How to improve</h3>' +
          '<ul class="comp-detail-tips">' + tipsHtml + '</ul>' +
          '</div></div>';

        var backBtn = body.querySelector('#comp-detail-back');
        if (backBtn) {
          backBtn.onclick = function() {
            overlay.remove();
            showGPAModal(parentTitle === 'Glucose GPA' ? 'glucose' : parentTitle === 'Lifestyle Score' ? 'lifestyle' : 'readiness');
          };
        }
      }

      function buildToolkitEducationHtml() {
        var edu = TOOLKIT_EDUCATION_SINGLE;
        var sectionsHtml = '';
        var keys = ['risks', 'nutrition', 'exercise', 'cgm', 'sleepStress', 'successMetrics'];
        keys.forEach(function(k) {
          var sec = edu[k];
          if (!sec) return;
          if (sec.bullets && sec.bullets.length) {
            sectionsHtml += '<div class="toolkit-edu-section"><h4>' + sec.title + '</h4><ul>' + sec.bullets.map(function(b) { return '<li>' + b + '</li>'; }).join('') + '</ul></div>';
          }
        });
        return '<div class="toolkit-edu">' + sectionsHtml + '</div>';
      }
      function getConsistencyMetrics(state) {
        var workoutConsistency = 78;
        var macroConsistencyDay = 72;
        var macroConsistencyWeek = 75;
        var waterConsistencyDay = 80;
        var waterConsistencyWeek = 78;
        var eduProgress = getPhaseEducationProgress(state);
        var educationConsistency = eduProgress.total > 0 ? Math.round((eduProgress.done / eduProgress.total) * 100) : 0;
        return { workoutConsistency: workoutConsistency, macroConsistencyDay: macroConsistencyDay, macroConsistencyWeek: macroConsistencyWeek, waterConsistencyDay: waterConsistencyDay, waterConsistencyWeek: waterConsistencyWeek, educationConsistency: educationConsistency };
      }
      function getConsistencyScore(state) {
        var c = getConsistencyMetrics(state);
        return Math.round((c.workoutConsistency + c.macroConsistencyWeek + c.waterConsistencyWeek + c.educationConsistency) / 4);
      }
      function computeReadiness(state) {
        var glucose = getGlucoseGPA(state).score100;
        var lifestyle = getLifestyleGPA(state).score100;
        var consistency = getConsistencyMetrics(state);
        var hungerAvg = getHungerAvgLast7(state);
        if (hungerAvg == null) hungerAvg = 3.2;
        var consistencyScore = Math.round((consistency.workoutConsistency + consistency.macroConsistencyWeek + consistency.waterConsistencyWeek + consistency.educationConsistency) / 4);
        var score = Math.round(glucose * 0.3 + lifestyle * 0.3 + (100 - Math.abs(hungerAvg - 3) * 15) * 0.2 + consistencyScore * 0.2);
        return Math.min(100, Math.max(0, score));
      }
      function getProgramMetrics(state) {
        var habit = 72, glucose = 68, maintenance = 70;
        return { habit_score: habit, glucose_stability_score: glucose, maintenance_score: maintenance };
      }
      function getModuleBody(moduleId) {
        if (MODULE_BODIES[moduleId]) return MODULE_BODIES[moduleId];
        var m = EDUCATION_MODULES.filter(function(x) { return x.module_id === moduleId; })[0];
        if (m && m.body) return m.body;
        return 'Content for this module.';
      }
      function getModuleTitle(moduleId) {
        var m = EDUCATION_MODULES.filter(function(x) { return x.module_id === moduleId; })[0];
        if (m && m.title) return m.title;
        return moduleId.replace(/_/g, ' ');
      }
      function getRecommendedModules(state) {
        return EDUCATION_MODULES;
      }
      function getTodayKey() { return new Date().toISOString().slice(0, 10); }
      function getWeekKey() {
        var d = new Date(); var day = d.getDay(); var diff = d.getDate() - day + (day === 0 ? -6 : 1);
        var monday = new Date(d.setDate(diff)); return monday.toISOString().slice(0, 10);
      }
      function markModuleCompleted(s, moduleId) {
        if (!s.completedModules) s.completedModules = {};
        if (!s.completedModules[moduleId]) s.completedModules[moduleId] = new Date().toISOString();
        saveState(s);
      }
      function markGameCompleted(s, gameType) {
        if (!s.completedGames) s.completedGames = {};
        var key = gameType + '_' + getTodayKey();
        if (!s.completedGames[key]) s.completedGames[key] = new Date().toISOString();
        saveState(s);
      }
      function isModuleCompleted(s, moduleId) { return !!(s.completedModules && s.completedModules[moduleId]); }
      function isGameCompleted(s, gameType) { return !!(s.completedGames && s.completedGames[gameType + '_' + getTodayKey()]); }
      function getPhaseEducationProgress(s) {
        var totalModules = 0, completedModules = 0, totalGames = 0, completedGames = 0;
        var secOrder = EDUCATION_SECTION_ORDER;
        var sections = {};
        secOrder.forEach(function(secId) {
          var sec = EDUCATION_SECTIONS[secId];
          if (!sec) return;
          var sMods = 0, sCDone = 0, sGames = 0, sGDone = 0;
          (sec.modules || []).forEach(function(m) { sMods++; totalModules++; if (isModuleCompleted(s, m.id)) { sCDone++; completedModules++; } });
          (sec.games || []).forEach(function(g) { sGames++; totalGames++; if (isGameCompleted(s, g.type)) { sGDone++; completedGames++; } });
          sections[secId] = { total: sMods + sGames, done: sCDone + sGDone };
        });
        return { totalModules: totalModules, completedModules: completedModules, totalGames: totalGames, completedGames: completedGames, total: totalModules + totalGames, done: completedModules + completedGames, sections: sections };
      }
      function shouldShowWeeklyCheckin(s) {
        var wk = getWeekKey();
        if (s.weeklyCheckIns && s.weeklyCheckIns[wk]) return false;
        if (!s.program_enrolled_at) return false;
        var enrolled = new Date(s.program_enrolled_at);
        var now = new Date();
        if ((now - enrolled) < 3 * 24 * 60 * 60 * 1000) return false;
        return true;
      }
      function getGraduationWeek(s) {
        var start = new Date(s.phaseStartAt || s.glp1_phase_start_date || new Date().toISOString().slice(0, 10));
        var now = new Date();
        var diff = Math.floor((now - start) / (1000 * 60 * 60 * 24));
        return Math.min(16, Math.max(1, Math.floor(diff / 7) + 1));
      }
      function getGraduationBlock(s) { return weekToBlock(getGraduationWeek(s)); }
      function seedWeeklyScoreHistory(s) {
        if (!s.weeklyScoreHistory) s.weeklyScoreHistory = [];
        var currentWeek = getGraduationWeek(s);
        var existing = {};
        s.weeklyScoreHistory.forEach(function(e) { existing[e.weekNumber] = true; });
        var baseG = 3.2, baseL = 2.8, baseT = 2.5;
        for (var w = 1; w <= currentWeek; w++) {
          if (existing[w]) continue;
          var progress = (w - 1) / 15;
          var noise = function() { return (Math.random() - 0.5) * 0.3; };
          var g = Math.min(5, Math.max(1, baseG + progress * 1.4 + noise()));
          var l = Math.min(5, Math.max(1, baseL + progress * 1.6 + noise()));
          var t = Math.min(5, Math.max(1, baseT + progress * 1.8 + noise()));
          g = Math.round(g * 10) / 10;
          l = Math.round(l * 10) / 10;
          t = Math.round(t * 10) / 10;
          var weekDate = new Date(s.phaseStartAt || s.glp1_phase_start_date);
          weekDate.setDate(weekDate.getDate() + (w - 1) * 7);
          s.weeklyScoreHistory.push({ week: weekDate.toISOString().slice(0, 10), weekNumber: w, glucose: g, lifestyle: l, transition: t });
        }
        saveState(s);
      }
      function recordCurrentWeekScore(s) {
        var wk = getGraduationWeek(s);
        var exists = s.weeklyScoreHistory.some(function(e) { return e.weekNumber === wk; });
        if (exists) return;
        s.weeklyScoreHistory.push({
          week: getWeekKey(),
          weekNumber: wk,
          glucose: getGlucoseGPA(s).score15,
          lifestyle: getLifestyleGPA(s).score15,
          transition: score100To15(computeReadiness(s))
        });
        saveState(s);
      }
      function buildGraduationTimeline(s, clickable) {
        var currentWeek = getGraduationWeek(s);
        var currentBlock = weekToBlock(currentWeek);
        var milestone = pBlockMilestone(currentBlock);
        var gradCheck = checkGraduationCriteria(s);
        var metCount = gradCheck.criteria.filter(function(c) { return c.met; }).length;
        var p2unlocked = isPhase2Unlocked(s);
        var html = '<div class="grad-timeline-wrap"><div class="grad-timeline-title">16-Week Graduation</div>' +
          '<div class="grad-timeline-sub">Block ' + currentBlock + ' (Weeks ' + blockToWeeks(currentBlock).join('\u2013') + ') \u2014 ' + milestone + (currentBlock >= 8 && gradCheck.allMet ? ' \ud83c\udf93' : '') + '</div><div class="grad-timeline">';
        for (var w = 1; w <= TOTAL_WEEKS; w++) {
          var blk = weekToBlock(w);
          var isFirstInBlock = w % 2 === 1;
          var isLastInBlock = w % 2 === 0;
          var isLocked = blk >= 5 && !p2unlocked;
          var hasCgm = isCGMBlock(blk);
          if (isFirstInBlock) {
            var blockBg = hasCgm ? 'background:rgba(37,99,235,0.06);border:1.5px solid #93c5fd;' : 'background:rgba(0,0,0,0.02);border:1.5px solid #e2e8f0;';
            html += '<div style="display:flex;align-items:center;gap:0;position:relative;border-radius:20px;padding:2px 4px;flex-shrink:0;' + blockBg + '">';
            if (hasCgm) html += '<div style="position:absolute;top:-8px;left:50%;transform:translateX(-50%);font-size:0.5rem;background:#2563eb;color:#fff;border-radius:3px;padding:0 4px;line-height:1.4;white-space:nowrap">CGM</div>';
          }
          var cls = 'grad-week';
          if (w < currentWeek) cls += ' done';
          else if (w === currentWeek) cls += ' current';
          if (w === TOTAL_WEEKS) cls += ' graduation';
          if (isLocked) cls += ' locked';
          if (clickable) cls += ' clickable';
          var dotContent = w < currentWeek ? '&#10003;' : isLocked ? '&#128274;' : w === TOTAL_WEEKS ? '&#9733;' : w;
          html += '<div class="' + cls + '" title="' + pBlockMilestone(blk) + '"' + (clickable ? ' data-week="' + w + '"' : '') + ' style="position:relative"><div class="grad-week-dot">' + dotContent + '</div><div class="grad-week-label">' + (w === TOTAL_WEEKS ? 'Grad' : 'W' + w) + '</div></div>';
          if (isFirstInBlock) {
            html += '<div class="grad-week-line' + (w < currentWeek ? ' done' : '') + (isLocked ? ' locked' : '') + '" style="width:6px;min-width:6px"></div>';
          }
          if (isLastInBlock) {
            html += '</div>';
            if (w < TOTAL_WEEKS) html += '<div class="grad-week-line' + (w < currentWeek ? ' done' : '') + (isLocked ? ' locked' : '') + '"></div>';
          }
        }
        html += '</div>';
        html += '<div style="display:flex;justify-content:center;gap:14px;padding:4px 0 6px;font-size:0.625rem;color:var(--text-muted)">' +
          '<span style="display:flex;align-items:center;gap:3px"><span style="display:inline-block;width:16px;height:8px;border-radius:4px;border:1.5px solid #93c5fd;background:rgba(37,99,235,0.06)"></span> CGM block</span>' +
          '<span style="display:flex;align-items:center;gap:3px"><span style="display:inline-block;width:16px;height:8px;border-radius:4px;border:1.5px solid #e2e8f0;background:rgba(0,0,0,0.02)"></span> Habit block</span></div>';
        if (clickable) html += '<div style="text-align:center;padding:2px 0 8px;font-size:0.6875rem;color:var(--text-muted)">Scroll &amp; tap any week to see goals &amp; education &#8594;</div>';
        html += '<div style="padding:0 16px 14px"><div style="font-size:0.8125rem;font-weight:600;color:var(--text);margin-bottom:6px">Graduation Criteria (' + metCount + '/' + gradCheck.criteria.length + ')</div>';
        gradCheck.criteria.forEach(function(c) {
          html += '<div style="display:flex;align-items:center;gap:6px;margin-bottom:3px;font-size:0.75rem;color:' + (c.met ? '#16a34a' : 'var(--text-muted)') + '"><span>' + (c.met ? '&#10003;' : '&#9711;') + '</span> ' + c.label + '</div>';
        });
        html += '</div></div>';
        return html;
      }
      function buildGraduationTrendSVG(history) {
        if (!history || history.length === 0) return '';
        var sorted = history.slice().sort(function(a, b) { return a.weekNumber - b.weekNumber; });
        var w = 320, h = 160, padL = 30, padR = 16, padT = 12, padB = 28;
        var plotW = w - padL - padR, plotH = h - padT - padB;
        var minY = 1, maxY = 5;
        function x(wk) { return padL + ((wk - 1) / 15) * plotW; }
        function y(val) { return padT + plotH - ((val - minY) / (maxY - minY)) * plotH; }
        var svg = '<svg viewBox="0 0 ' + w + ' ' + h + '" preserveAspectRatio="xMidYMid meet" style="width:100%;height:auto">';
        CGM_PERIODS.forEach(function(p) {
          var x1 = x(p.weeks[0]) - ((plotW / 15) * 0.4);
          var x2 = x(p.weeks[1]) + ((plotW / 15) * 0.4);
          svg += '<rect x="' + x1 + '" y="' + padT + '" width="' + (x2 - x1) + '" height="' + plotH + '" fill="#2563eb" fill-opacity="0.06" rx="3"/>';
        });
        for (var v = 1; v <= 5; v++) {
          svg += '<line x1="' + padL + '" y1="' + y(v) + '" x2="' + (w - padR) + '" y2="' + y(v) + '" stroke="#f1f5f9" stroke-width="1"/>';
          svg += '<text x="' + (padL - 6) + '" y="' + (y(v) + 3) + '" font-size="9" fill="#94a3b8" text-anchor="end">' + v + '.0</text>';
        }
        for (var wk = 1; wk <= TOTAL_WEEKS; wk += 2) {
          svg += '<text x="' + x(wk) + '" y="' + (h - 4) + '" font-size="7" fill="' + (isCGMWeek(wk) ? '#2563eb' : '#94a3b8') + '" text-anchor="middle">' + (isCGMWeek(wk) ? '\u25CF' : '') + 'W' + wk + '</text>';
        }
        var colors = { glucose: '#2563eb', lifestyle: '#ec4899', transition: '#7c3aed' };
        ['glucose', 'lifestyle', 'transition'].forEach(function(key) {
          var pts = sorted.filter(function(d) { return typeof d[key] === 'number'; });
          if (pts.length < 2) return;
          var pathD = pts.map(function(d, i) { return (i === 0 ? 'M' : 'L') + ' ' + x(d.weekNumber) + ' ' + y(d[key]); }).join(' ');
          svg += '<path d="' + pathD + '" fill="none" stroke="' + colors[key] + '" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>';
          pts.forEach(function(d) { svg += '<circle cx="' + x(d.weekNumber) + '" cy="' + y(d[key]) + '" r="3.5" fill="' + colors[key] + '" stroke="#fff" stroke-width="1.5"/>'; });
        });
        svg += '</svg>';
        return '<div class="grad-trend-card"><div class="grad-trend-title">Graduation Trend</div><div class="grad-trend-sub">Your weekly GPA scores across the 16-week program</div>' + svg +
          '<div class="grad-trend-legend"><div class="grad-trend-legend-item"><div class="grad-trend-legend-dot" style="background:#2563eb"></div>Glucose</div><div class="grad-trend-legend-item"><div class="grad-trend-legend-dot" style="background:#ec4899"></div>Lifestyle</div><div class="grad-trend-legend-item"><div class="grad-trend-legend-dot" style="background:#7c3aed"></div>Transition</div></div></div>';
      }
      function getHungerCompletedToday(state) {
        var key = getTodayKey();
        return !!(state.hungerEntries && state.hungerEntries[key] && state.hungerEntries[key].completedAt);
      }
      function getHungerAvgLast7(state) {
        if (!state.hungerEntries) return null;
        var keys = [];
        for (var i = 0; i < 7; i++) { var d = new Date(); d.setDate(d.getDate() - i); keys.push(d.toISOString().slice(0, 10)); }
        var sum = 0, n = 0;
        keys.forEach(function(k) {
          var e = state.hungerEntries[k];
          if (e && typeof e.overallHunger === 'number') { sum += e.overallHunger; n++; }
        });
        return n > 0 ? Math.round((sum / n) * 10) / 10 : null;
      }
      function getHungerMasteryScore(s) {
        if (!s.hungerEntries) return { score: 0, streak: 0, daysLogged: 0, avgHunger: null, avgFullness: null, level: 'Beginner' };
        var entries = [];
        for (var i = 0; i < 14; i++) { var d = new Date(); d.setDate(d.getDate() - i); var k = d.toISOString().slice(0, 10); if (s.hungerEntries[k] && s.hungerEntries[k].completedAt) entries.push(s.hungerEntries[k]); }
        var daysLogged = entries.length;
        var streak = 0;
        for (var j = 0; j < 14; j++) { var dd = new Date(); dd.setDate(dd.getDate() - j); var kk = dd.toISOString().slice(0, 10); if (s.hungerEntries[kk] && s.hungerEntries[kk].completedAt) streak++; else break; }
        var sumH = 0, sumF = 0, nH = 0, nF = 0;
        entries.forEach(function(e) {
          if (typeof e.overallHunger === 'number') { sumH += e.overallHunger; nH++; }
          if (typeof e.postMealFullness === 'number') { sumF += e.postMealFullness; nF++; }
        });
        var avgH = nH > 0 ? sumH / nH : null;
        var avgF = nF > 0 ? sumF / nF : null;
        var score = 0;
        score += Math.min(40, daysLogged * (40 / 10));
        if (avgH !== null) { var idealDist = Math.abs(avgH - 3); score += Math.max(0, 30 - idealDist * 15); }
        if (avgF !== null) { var idealDistF = Math.abs(avgF - 3.5); score += Math.max(0, 30 - idealDistF * 15); }
        score = Math.min(100, Math.round(score));
        var level = score >= 80 ? 'Advanced' : score >= 50 ? 'Developing' : score >= 20 ? 'Learning' : 'Beginner';
        return { score: score, streak: streak, daysLogged: daysLogged, avgHunger: avgH ? Math.round(avgH * 10) / 10 : null, avgFullness: avgF ? Math.round(avgF * 10) / 10 : null, level: level };
      }
      function checkGraduationCriteria(s) {
        var hist = (s.weeklyScoreHistory || []).slice().sort(function(a, b) { return b.weekNumber - a.weekNumber; });
        var eduProg = getPhaseEducationProgress(s);
        var eduPct = eduProg.total > 0 ? Math.round((eduProg.done / eduProg.total) * 100) : 0;
        var results = [];
        GRADUATION_CRITERIA.forEach(function(c) {
          if (c.key === 'education') { results.push({ label: c.label, met: eduPct >= c.threshold }); return; }
          if (c.key === 'weight') {
            var anchor = s.weightAnchor || 165; var bandPct = (s.maintenance_band_pct || 5) / 100; var upper = anchor * (1 + bandPct);
            var currentW = s.weightHistory ? (function() { var ks = Object.keys(s.weightHistory).sort().reverse(); return ks.length > 0 ? s.weightHistory[ks[0]] : anchor; })() : anchor;
            results.push({ label: c.label, met: currentW <= upper }); return;
          }
          var consecutive = 0;
          for (var i = 0; i < hist.length && i < 5; i++) { if (hist[i][c.key] >= c.threshold) consecutive++; else break; }
          results.push({ label: c.label, met: consecutive >= c.weeksNeeded });
        });
        var allMet = results.every(function(r) { return r.met; });
        return { criteria: results, allMet: allMet };
      }
      function getDoseEvents(state) {
        var ev = state.doseEvents && state.doseEvents.length ? state.doseEvents : (state.dose_change_events || []).map(function(e) { return { type: e.type, occurredAt: e.occurredAt || e.date, notes: e.notes }; });
        return ev;
      }
      function daysSinceLastDoseDecrease(state) {
        var events = getDoseEvents(state);
        for (var i = events.length - 1; i >= 0; i--) {
          if (events[i].type === DOSE_EVENT_TYPE.DECREASED_DOSE || events[i].type === DOSE_EVENT_TYPE.SWITCHED_FORMULATION) {
            var d = new Date(events[i].occurredAt || events[i].date); var n = new Date(); return Math.floor((n - d) / (24 * 60 * 60 * 1000));
          }
        }
        return 999;
      }
      function daysSinceStopped(state) {
        var events = getDoseEvents(state);
        for (var i = events.length - 1; i >= 0; i--) {
          if (events[i].type === DOSE_EVENT_TYPE.STOPPED) {
            var d = new Date(events[i].occurredAt || events[i].date); var n = new Date(); return Math.floor((n - d) / (24 * 60 * 60 * 1000));
          }
        }
        return 999;
      }
      function getProgramContext(state) {
        var metrics = getProgramMetrics(state);
        var readiness = computeReadiness(state);
        state.readinessScore = readiness;
        var currentWeek = getGraduationWeek(state);
        var currentBlock = weekToBlock(currentWeek);
        var weeklyGoal = pBlockGoal(currentBlock);
        return { metrics: metrics, readiness: readiness, currentWeek: currentWeek, currentBlock: currentBlock, weeklyGoal: weeklyGoal, dismissedBanners: state.dismissedBanners || {} };
      }

      var currentScreen = state.onboardingComplete ? 'home' : 'onboarding';
      var currentNav = 'home';
      var navHistory = [];
      var cgmOverride = null;
      function navigateTo(screen, nav) {
        navHistory.push({ screen: currentScreen, nav: currentNav });
        if (navHistory.length > 20) navHistory.shift();
        currentScreen = screen;
        if (nav !== undefined) currentNav = nav;
        render();
      }
      function navigateBack(fallbackScreen, fallbackNav) {
        if (navHistory.length > 0) {
          var prev = navHistory.pop();
          currentScreen = prev.screen;
          currentNav = prev.nav;
        } else {
          currentScreen = fallbackScreen || 'home';
          currentNav = fallbackNav || 'home';
        }
        render();
      }
      var insightsSegment = 'lifestyle';
      var showStoppedModal = false;
      var showWeeklyCheckin = false;
      var weeklyCheckinTimer = null;
      var weeklyCheckinDismissedThisSession = false;
      var openModuleId = null;
      var openToolkitModuleId = null;
      var openWeekNumber = null;
      var openEducationModuleId = null;
      var openEducationGameType = null;
      var openEducationGameTitle = null;
      var eduGameIndex = 0;
      var eduGameAnswered = false;
      var eduBuildMealSelected = { protein: null, carb: null, veggie: null };
      var eduBuildWorkoutStep = 0;
      var eduBuildBackSelected = [];
      var eduBuildLegsSelected = [];
      var eduFormQuizIndex = 0;
      var eduFormQuizAnswered = false;
      var eduRecordFormMovementId = null;
      var eduRecordFormPhase = 'pick';
      var eduMeditationStartTime = null;
      var eduMeditationInterval = null;
      var toolkitModuleStep = 0;
      var proteinGuessIndex = 0;
      var proteinGuessAnswered = false;
      var buildWorkoutSelected = [];

      function render() {
        var app = document.getElementById('app');
        app.innerHTML = '';

        if (currentScreen === 'onboarding') {
          renderOnboarding(app);
          return;
        }

        var nav = document.createElement('nav');
        nav.className = 'bottom-nav';
        var tabs = [
          { key: 'home', label: 'Home', icon: '\u2302' },
          { key: 'dailies', label: 'Toolkit', icon: '\u2713' },
          { key: 'log', label: 'Log', isLog: true },
          { key: 'insights', label: 'Insights', icon: '\u2584' },
          { key: 'settings', label: 'Settings', icon: '\u2699' }
        ];
        tabs.forEach(function(t) {
          var btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'nav-btn' + (currentNav === t.key ? ' active' : '');
          if (t.isLog) {
            btn.innerHTML = '<span class="big">+</span>' + t.label;
            btn.onclick = function() { navHistory = []; currentNav = 'log'; currentScreen = 'log'; render(); };
          } else {
            btn.innerHTML = '<span class="icon-wrap">' + t.icon + '</span>' + t.label;
            btn.onclick = function() { navHistory = []; currentNav = t.key; currentScreen = t.key; render(); };
          }
          nav.appendChild(btn);
        });

        if (currentScreen === 'home') renderHome(app);
        else if (currentScreen === 'dailies') renderTransitionToolkit(app);
        else if (currentScreen === 'log') renderLog(app);
        else if (currentScreen === 'insights') renderInsights(app);
        else if (currentScreen === 'settings') renderSettings(app);
        else if (currentScreen === 'program') renderProgram(app);
        else if (currentScreen === 'toolkit_module') renderToolkitModule(app);
        else if (currentScreen === 'education_module') renderEducationModuleDetail(app);
        else if (currentScreen === 'education_game') renderEducationGame(app);
        else if (currentScreen === 'hunger_questionnaire') renderHungerQuestionnaire(app);
        else if (currentScreen === 'hunger_coach') renderHungerCoach(app);
        else if (currentScreen === 'body_scanner') renderBodyScanner(app);
        else if (currentScreen === 'week_detail') renderWeekDetail(app);
        else if (currentScreen === 'post8_checkin') renderPost8CheckIn(app);

        app.appendChild(nav);
        if (showStoppedModal) renderStoppedModal(app);
        if (showWeeklyCheckin) renderWeeklyCheckin(app);
        if (currentScreen === 'home' && !showWeeklyCheckin && !weeklyCheckinDismissedThisSession && shouldShowWeeklyCheckin(state)) {
          if (weeklyCheckinTimer) clearTimeout(weeklyCheckinTimer);
          weeklyCheckinTimer = setTimeout(function() { showWeeklyCheckin = true; render(); }, 4000);
        }
      }

      var onboardStep = 0;
      var onboardAnswers = {};
      var onboardProfile = {};
      var OB_TOTAL_STEPS = 18;

      function obProgressBar(step) {
        var pct = Math.round((step / (OB_TOTAL_STEPS - 1)) * 100);
        return '<div style="padding:0 20px 12px"><div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="font-size:0.625rem;color:var(--text-muted)">Step ' + (step + 1) + ' of ' + OB_TOTAL_STEPS + '</span><span style="font-size:0.625rem;color:var(--phase-accent);font-weight:600">' + pct + '%</span></div><div style="height:4px;background:#e2e8f0;border-radius:2px;overflow:hidden"><div style="height:100%;width:' + pct + '%;background:var(--phase-accent);border-radius:2px;transition:width 0.3s"></div></div></div>';
      }

      function obMultiSelect(items, selectedArr, dataAttr, cssClass) {
        return items.map(function(item) {
          var sel = selectedArr.indexOf(item.id) >= 0;
          return '<button type="button" class="' + cssClass + '" data-' + dataAttr + '="' + item.id + '" style="display:flex;align-items:center;gap:10px;padding:12px 14px;border-radius:12px;border:2px solid ' + (sel ? 'var(--phase-accent)' : '#e2e8f0') + ';background:' + (sel ? 'var(--phase-accent-light)' : '#fff') + ';text-align:left;cursor:pointer;transition:all 0.15s;width:100%">' +
            '<span style="font-size:1.25rem;flex-shrink:0">' + item.icon + '</span>' +
            '<div style="flex:1"><div style="font-size:0.8125rem;font-weight:' + (sel ? '700' : '600') + ';color:' + (sel ? 'var(--phase-accent)' : 'var(--text)') + '">' + item.label + '</div>' + (item.desc ? '<div style="font-size:0.6875rem;color:var(--text-muted);margin-top:2px">' + item.desc + '</div>' : '') + '</div>' +
            '<div style="width:22px;height:22px;border-radius:50%;border:2px solid ' + (sel ? 'var(--phase-accent)' : '#cbd5e1') + ';display:flex;align-items:center;justify-content:center;flex-shrink:0;background:' + (sel ? 'var(--phase-accent)' : '#fff') + ';color:#fff;font-size:0.6875rem">' + (sel ? '&#10003;' : '') + '</div></button>';
        }).join('');
      }
      function obBindMultiSelect(div, cssClass, dataAttr, profileKey) {
        div.querySelectorAll('.' + cssClass).forEach(function(btn) {
          btn.onclick = function() {
            var id = btn.getAttribute('data-' + dataAttr);
            var arr = onboardProfile[profileKey] || [];
            var idx = arr.indexOf(id);
            if (idx >= 0) arr.splice(idx, 1); else arr.push(id);
            onboardProfile[profileKey] = arr;
            render();
          };
        });
      }

      function renderOnboarding(container) {
        var div = document.createElement('div');
        div.className = 'screen active onboarding';
        var p = onboardProfile;

        if (onboardStep === 0) {
          div.innerHTML = '<div style="padding:28px 20px;text-align:center">' +
            '<div style="font-size:3rem;margin-bottom:16px">\ud83c\udf93</div>' +
            '<h1 style="font-size:1.5rem;margin:0 0 8px">GLP-1 Graduation</h1>' +
            '<p style="font-size:0.9375rem;color:var(--text-muted);margin:0 0 24px;line-height:1.5">A 16-week program to build the habits and confidence you need to thrive after GLP-1.</p>' +
            '<div style="text-align:left;background:var(--phase-accent-light);border-radius:14px;padding:16px;margin:0 0 24px">' +
            '<p style="margin:0 0 8px;font-size:0.875rem;font-weight:700;color:var(--phase-accent)">What to expect</p>' +
            '<ul style="margin:0;padding:0 0 0 18px;font-size:0.8125rem;color:var(--text);line-height:1.6">' +
            '<li>Weeks 1\u20134: Build your foundation</li>' +
            '<li>Weeks 5\u20138: Develop skills</li>' +
            '<li>Weeks 9\u201316: Personalized to what works best for YOU</li>' +
            '</ul></div>' +
            '<button type="button" class="btn btn-primary" id="onboard-next" style="font-size:1.0625rem;padding:14px 20px;width:100%">Get started \u2192</button>' +
            '<p style="font-size:0.75rem;color:var(--text-muted);margin:16px 0 0">We do not provide medication advice. Work with your clinician for dosing decisions.</p>' +
            '</div>';
          div.querySelector('#onboard-next').onclick = function() { onboardStep = 1; render(); };

        } else if (onboardStep === 1) {
          div.innerHTML = obProgressBar(1) +
            '<div style="padding:0 20px">' +
            '<h2 style="margin:0 0 6px;font-size:1.25rem">Let\u2019s get to know you</h2>' +
            '<p style="font-size:0.8125rem;color:var(--text-muted);margin:0 0 20px;line-height:1.5">This helps us personalize your experience.</p>' +
            '<div class="card" style="padding:16px">' +
            '<label style="display:block;margin-bottom:14px"><span style="font-size:0.8125rem;font-weight:600;color:var(--text);display:block;margin-bottom:4px">First name</span><input type="text" id="ob-name" value="' + (p.name || '') + '" placeholder="Your first name" style="width:100%;padding:10px 12px;border:2px solid #e2e8f0;border-radius:10px;font-size:0.9375rem;box-sizing:border-box" /></label>' +
            '<label style="display:block;margin-bottom:14px"><span style="font-size:0.8125rem;font-weight:600;color:var(--text);display:block;margin-bottom:4px">Age</span><input type="number" id="ob-age" value="' + (p.age || '') + '" placeholder="e.g. 34" min="18" max="100" style="width:100%;padding:10px 12px;border:2px solid #e2e8f0;border-radius:10px;font-size:0.9375rem;box-sizing:border-box" /></label>' +
            '<div><span style="font-size:0.8125rem;font-weight:600;color:var(--text);display:block;margin-bottom:6px">Sex</span><div style="display:flex;gap:8px">' +
            ['Female', 'Male', 'Other'].map(function(s) {
              var sel = p.sex === s;
              return '<button type="button" class="ob-sex-btn" data-sex="' + s + '" style="flex:1;padding:10px 4px;border-radius:10px;border:2px solid ' + (sel ? 'var(--phase-accent)' : '#e2e8f0') + ';background:' + (sel ? 'var(--phase-accent-light)' : '#fff') + ';font-size:0.8125rem;font-weight:' + (sel ? '700' : '400') + ';color:' + (sel ? 'var(--phase-accent)' : 'var(--text-muted)') + ';cursor:pointer">' + s + '</button>';
            }).join('') +
            '</div></div></div>' +
            '<button type="button" class="btn btn-primary" id="ob-next1" style="width:100%;margin-top:16px;' + (p.name ? '' : 'opacity:0.5') + '">Continue \u2192</button></div>';
          div.querySelectorAll('.ob-sex-btn').forEach(function(btn) { btn.onclick = function() { onboardProfile.sex = btn.getAttribute('data-sex'); render(); }; });
          div.querySelector('#ob-name').oninput = function() { onboardProfile.name = this.value.trim(); div.querySelector('#ob-next1').style.opacity = this.value.trim() ? '1' : '0.5'; };
          div.querySelector('#ob-age').oninput = function() { onboardProfile.age = parseInt(this.value) || ''; };
          div.querySelector('#ob-next1').onclick = function() { if (!onboardProfile.name) return; onboardStep = 2; render(); };

        } else if (onboardStep === 2) {
          var meds = ['Semaglutide (Ozempic/Wegovy)', 'Tirzepatide (Mounjaro/Zepbound)', 'Liraglutide (Saxenda)', 'Other GLP-1'];
          var durations = ['Less than 3 months', '3\u20136 months', '6\u201312 months', '1\u20132 years', '2+ years'];
          var statuses = ['Currently tapering', 'Planning to taper soon', 'Recently stopped (< 1 month)', 'Stopped 1\u20133 months ago', 'Stopped 3+ months ago'];
          div.innerHTML = obProgressBar(2) +
            '<div style="padding:0 20px">' +
            '<h2 style="margin:0 0 6px;font-size:1.25rem">Your medication</h2>' +
            '<p style="font-size:0.8125rem;color:var(--text-muted);margin:0 0 16px;line-height:1.5">This helps us tailor content to your medication journey.</p>' +
            '<div class="card" style="padding:16px"><span style="font-size:0.8125rem;font-weight:600;color:var(--text);display:block;margin-bottom:8px">Current or most recent GLP-1 medication</span><div style="display:flex;flex-direction:column;gap:6px">' +
            meds.map(function(m) { var sel = p.medication === m; return '<button type="button" class="ob-med-btn" data-med="' + m + '" style="padding:10px 12px;border-radius:10px;border:2px solid ' + (sel ? 'var(--phase-accent)' : '#e2e8f0') + ';background:' + (sel ? 'var(--phase-accent-light)' : '#fff') + ';text-align:left;font-size:0.8125rem;color:' + (sel ? 'var(--phase-accent)' : 'var(--text)') + ';font-weight:' + (sel ? '700' : '400') + ';cursor:pointer">' + m + '</button>'; }).join('') +
            '</div></div>' +
            '<div class="card" style="padding:16px"><span style="font-size:0.8125rem;font-weight:600;color:var(--text);display:block;margin-bottom:8px">How long were you on GLP-1 medication?</span><div style="display:flex;flex-direction:column;gap:6px">' +
            durations.map(function(d) { var sel = p.duration === d; return '<button type="button" class="ob-dur-btn" data-dur="' + d + '" style="padding:10px 12px;border-radius:10px;border:2px solid ' + (sel ? 'var(--phase-accent)' : '#e2e8f0') + ';background:' + (sel ? 'var(--phase-accent-light)' : '#fff') + ';text-align:left;font-size:0.8125rem;color:' + (sel ? 'var(--phase-accent)' : 'var(--text)') + ';font-weight:' + (sel ? '700' : '400') + ';cursor:pointer">' + d + '</button>'; }).join('') +
            '</div></div>' +
            '<div class="card" style="padding:16px"><span style="font-size:0.8125rem;font-weight:600;color:var(--text);display:block;margin-bottom:8px">Medication status</span><div style="display:flex;flex-direction:column;gap:6px">' +
            statuses.map(function(s) { var sel = p.medStatus === s; return '<button type="button" class="ob-stat-btn" data-stat="' + s + '" style="padding:10px 12px;border-radius:10px;border:2px solid ' + (sel ? 'var(--phase-accent)' : '#e2e8f0') + ';background:' + (sel ? 'var(--phase-accent-light)' : '#fff') + ';text-align:left;font-size:0.8125rem;color:' + (sel ? 'var(--phase-accent)' : 'var(--text)') + ';font-weight:' + (sel ? '700' : '400') + ';cursor:pointer">' + s + '</button>'; }).join('') +
            '</div></div>' +
            '<button type="button" class="btn btn-primary" id="ob-next2" style="width:100%;margin-top:12px;' + (p.medication && p.duration && p.medStatus ? '' : 'opacity:0.5') + '">Continue \u2192</button></div>';
          div.querySelectorAll('.ob-med-btn').forEach(function(btn) { btn.onclick = function() { onboardProfile.medication = btn.getAttribute('data-med'); render(); }; });
          div.querySelectorAll('.ob-dur-btn').forEach(function(btn) { btn.onclick = function() { onboardProfile.duration = btn.getAttribute('data-dur'); render(); }; });
          div.querySelectorAll('.ob-stat-btn').forEach(function(btn) { btn.onclick = function() { onboardProfile.medStatus = btn.getAttribute('data-stat'); render(); }; });
          div.querySelector('#ob-next2').onclick = function() { if (!p.medication || !p.duration || !p.medStatus) return; onboardStep = 3; render(); };

        } else if (onboardStep === 3) {
          var selected = p.reasonOffGlp1 || [];
          div.innerHTML = obProgressBar(3) +
            '<div style="padding:0 20px">' +
            '<h2 style="margin:0 0 6px;font-size:1.25rem">Why did you stop or start tapering GLP-1?</h2>' +
            '<p style="font-size:0.8125rem;color:var(--text-muted);margin:0 0 16px;line-height:1.5">Select all that apply. No judgment \u2014 this helps us understand your situation.</p>' +
            '<div style="display:flex;flex-direction:column;gap:8px">' +
            obMultiSelect(REASON_OFF_GLP1, selected, 'reason', 'ob-reason-btn') +
            '</div>' +
            '<button type="button" class="btn btn-primary" id="ob-next3" style="width:100%;margin-top:16px;' + (selected.length > 0 ? '' : 'opacity:0.5') + '">Continue \u2192</button></div>';
          obBindMultiSelect(div, 'ob-reason-btn', 'reason', 'reasonOffGlp1');
          div.querySelector('#ob-next3').onclick = function() { if (!(p.reasonOffGlp1 && p.reasonOffGlp1.length > 0)) return; onboardStep = 4; render(); };

        } else if (onboardStep === 4) {
          div.innerHTML = obProgressBar(4) +
            '<div style="padding:0 20px">' +
            '<h2 style="margin:0 0 6px;font-size:1.25rem">About your body</h2>' +
            '<p style="font-size:0.8125rem;color:var(--text-muted);margin:0 0 16px;line-height:1.5">We use this to set your maintenance weight and personalize targets.</p>' +
            '<div class="card" style="padding:16px">' +
            '<div style="display:flex;gap:12px;margin-bottom:14px">' +
            '<label style="flex:1"><span style="font-size:0.8125rem;font-weight:600;color:var(--text);display:block;margin-bottom:4px">Current weight (lbs)</span><input type="number" id="ob-weight" value="' + (p.weight || '') + '" placeholder="e.g. 185" min="80" max="500" style="width:100%;padding:10px 12px;border:2px solid #e2e8f0;border-radius:10px;font-size:0.9375rem;box-sizing:border-box" /></label>' +
            '<label style="flex:1"><span style="font-size:0.8125rem;font-weight:600;color:var(--text);display:block;margin-bottom:4px">Goal weight (lbs)</span><input type="number" id="ob-goal-wt" value="' + (p.goalWeight || '') + '" placeholder="e.g. 165" min="80" max="500" style="width:100%;padding:10px 12px;border:2px solid #e2e8f0;border-radius:10px;font-size:0.9375rem;box-sizing:border-box" /></label>' +
            '</div>' +
            '<div style="display:flex;gap:12px;margin-bottom:14px">' +
            '<label style="flex:1"><span style="font-size:0.8125rem;font-weight:600;color:var(--text);display:block;margin-bottom:4px">Height (ft)</span><input type="number" id="ob-ht-ft" value="' + (p.heightFt || '') + '" placeholder="5" min="3" max="8" style="width:100%;padding:10px 12px;border:2px solid #e2e8f0;border-radius:10px;font-size:0.9375rem;box-sizing:border-box" /></label>' +
            '<label style="flex:1"><span style="font-size:0.8125rem;font-weight:600;color:var(--text);display:block;margin-bottom:4px">Height (in)</span><input type="number" id="ob-ht-in" value="' + (p.heightIn || '') + '" placeholder="7" min="0" max="11" style="width:100%;padding:10px 12px;border:2px solid #e2e8f0;border-radius:10px;font-size:0.9375rem;box-sizing:border-box" /></label>' +
            '</div>' +
            '<span style="font-size:0.8125rem;font-weight:600;color:var(--text);display:block;margin-bottom:8px">Activity level</span>' +
            '<div style="display:flex;flex-direction:column;gap:6px">' +
            [{ id: 'sedentary', label: 'Sedentary', desc: 'Little to no exercise' }, { id: 'light', label: 'Lightly active', desc: '1\u20132 days/week' }, { id: 'moderate', label: 'Moderately active', desc: '3\u20134 days/week' }, { id: 'very', label: 'Very active', desc: '5+ days/week' }].map(function(a) {
              var sel = p.activityLevel === a.id;
              return '<button type="button" class="ob-act-btn" data-act="' + a.id + '" style="padding:10px 12px;border-radius:10px;border:2px solid ' + (sel ? 'var(--phase-accent)' : '#e2e8f0') + ';background:' + (sel ? 'var(--phase-accent-light)' : '#fff') + ';text-align:left;font-size:0.8125rem;color:' + (sel ? 'var(--phase-accent)' : 'var(--text)') + ';font-weight:' + (sel ? '700' : '400') + ';cursor:pointer"><strong>' + a.label + '</strong> <span style="color:var(--text-muted);font-weight:400">\u2014 ' + a.desc + '</span></button>';
            }).join('') +
            '</div></div>' +
            '<button type="button" class="btn btn-primary" id="ob-next4" style="width:100%;margin-top:12px;' + (p.weight && p.activityLevel ? '' : 'opacity:0.5') + '">Continue \u2192</button></div>';
          div.querySelector('#ob-weight').oninput = function() { onboardProfile.weight = parseInt(this.value) || ''; };
          div.querySelector('#ob-goal-wt').oninput = function() { onboardProfile.goalWeight = parseInt(this.value) || ''; };
          div.querySelector('#ob-ht-ft').oninput = function() { onboardProfile.heightFt = parseInt(this.value) || ''; };
          div.querySelector('#ob-ht-in').oninput = function() { onboardProfile.heightIn = parseInt(this.value) || ''; };
          div.querySelectorAll('.ob-act-btn').forEach(function(btn) { btn.onclick = function() { onboardProfile.activityLevel = btn.getAttribute('data-act'); render(); }; });
          div.querySelector('#ob-next4').onclick = function() { if (!p.weight || !p.activityLevel) return; onboardStep = 5; render(); };

        } else if (onboardStep === 5) {
          var goals = [
            { id: 'maintain', icon: '&#9878;', label: 'Maintain my weight loss', desc: 'Keep the progress I\u2019ve made on medication' },
            { id: 'habits', icon: '&#127793;', label: 'Build lasting habits', desc: 'Develop routines that stick without medication' },
            { id: 'glucose', icon: '&#128200;', label: 'Stabilize my glucose', desc: 'Reduce spikes and improve metabolic health' },
            { id: 'taper', icon: '&#128137;', label: 'Successfully taper off', desc: 'Reduce or stop medication confidently' },
            { id: 'fitness', icon: '&#128170;', label: 'Improve fitness & strength', desc: 'Build muscle and increase daily movement' },
            { id: 'hunger', icon: '&#129368;', label: 'Manage hunger naturally', desc: 'Learn to eat well without medication-suppressed appetite' }
          ];
          var selected = p.goals || [];
          div.innerHTML = obProgressBar(5) +
            '<div style="padding:0 20px">' +
            '<h2 style="margin:0 0 6px;font-size:1.25rem">What are your goals?</h2>' +
            '<p style="font-size:0.8125rem;color:var(--text-muted);margin:0 0 16px;line-height:1.5">Select all that apply. This helps us prioritize your education and weekly focus.</p>' +
            '<div style="display:flex;flex-direction:column;gap:8px">' + obMultiSelect(goals, selected, 'goal', 'ob-goal-btn') + '</div>' +
            '<button type="button" class="btn btn-primary" id="ob-next5" style="width:100%;margin-top:16px;' + (selected.length > 0 ? '' : 'opacity:0.5') + '">Continue \u2192</button></div>';
          obBindMultiSelect(div, 'ob-goal-btn', 'goal', 'goals');
          div.querySelector('#ob-next5').onclick = function() { if (!(p.goals && p.goals.length > 0)) return; onboardStep = 6; render(); };

        } else if (onboardStep === 6) {
          var selected = p.preGlp1Struggles || [];
          div.innerHTML = obProgressBar(6) +
            '<div style="padding:0 20px">' +
            '<h2 style="margin:0 0 6px;font-size:1.25rem">Before GLP-1</h2>' +
            '<p style="font-size:0.8125rem;color:var(--text-muted);margin:0 0 16px;line-height:1.5">What did you struggle with <strong>before</strong> starting GLP-1 medication? Select all that apply.</p>' +
            '<div style="display:flex;flex-direction:column;gap:8px">' + obMultiSelect(STRUGGLE_OPTIONS, selected, 'str', 'ob-prestr-btn') + '</div>' +
            '<button type="button" class="btn btn-primary" id="ob-next6" style="width:100%;margin-top:16px;' + (selected.length > 0 ? '' : 'opacity:0.5') + '">Continue \u2192</button></div>';
          obBindMultiSelect(div, 'ob-prestr-btn', 'str', 'preGlp1Struggles');
          div.querySelector('#ob-next6').onclick = function() { if (!(p.preGlp1Struggles && p.preGlp1Struggles.length > 0)) return; onboardStep = 7; render(); };

        } else if (onboardStep === 7) {
          var selected = p.currentStruggles || [];
          div.innerHTML = obProgressBar(7) +
            '<div style="padding:0 20px">' +
            '<h2 style="margin:0 0 6px;font-size:1.25rem">Right now</h2>' +
            '<p style="font-size:0.8125rem;color:var(--text-muted);margin:0 0 6px;line-height:1.5">What do you struggle with <strong>most right now</strong>? This directly shapes the order of your 16-week program.</p>' +
            '<p style="font-size:0.75rem;color:var(--phase-accent);margin:0 0 16px;font-weight:600">Rank by selecting your biggest struggle first.</p>' +
            '<div style="display:flex;flex-direction:column;gap:8px">' + obMultiSelect(STRUGGLE_OPTIONS, selected, 'str', 'ob-curstr-btn') + '</div>' +
            '<button type="button" class="btn btn-primary" id="ob-next7" style="width:100%;margin-top:16px;' + (selected.length > 0 ? '' : 'opacity:0.5') + '">Continue \u2192</button></div>';
          obBindMultiSelect(div, 'ob-curstr-btn', 'str', 'currentStruggles');
          div.querySelector('#ob-next7').onclick = function() { if (!(p.currentStruggles && p.currentStruggles.length > 0)) return; onboardStep = 8; render(); };

        } else if (onboardStep === 8) {
          var stOptions = [
            { id: 'never', icon: '&#10060;', label: 'Never tried it', desc: 'I haven\u2019t done any strength or resistance training' },
            { id: 'tried', icon: '&#129300;', label: 'I\u2019ve tried but don\u2019t stick with it', desc: 'I\u2019ve done it before but can\u2019t stay consistent' },
            { id: 'beginner', icon: '&#128170;', label: 'Just getting started', desc: 'I\u2019ve recently begun and I\u2019m still learning' },
            { id: 'light', icon: '&#127947;', label: '1\u20132 times per week', desc: 'I train occasionally but want to do more' },
            { id: 'regular', icon: '&#127941;', label: '3+ times per week', desc: 'I train regularly and feel comfortable with it' },
            { id: 'lost', icon: '&#128694;', label: 'I don\u2019t know where to start', desc: 'Interested but overwhelmed by the options' }
          ];
          div.innerHTML = obProgressBar(8) +
            '<div style="padding:0 20px">' +
            '<h2 style="margin:0 0 6px;font-size:1.25rem">Strength & resistance training</h2>' +
            '<p style="font-size:0.8125rem;color:var(--text-muted);margin:0 0 16px;line-height:1.5">Resistance training is one of the most important tools for maintaining weight loss off GLP-1. Where are you right now?</p>' +
            '<div style="display:flex;flex-direction:column;gap:8px">' +
            stOptions.map(function(o) {
              var sel = p.strengthTraining === o.id;
              return '<button type="button" class="ob-st-btn" data-st="' + o.id + '" style="padding:12px 14px;border-radius:12px;border:2px solid ' + (sel ? 'var(--phase-accent)' : '#e2e8f0') + ';background:' + (sel ? 'var(--phase-accent-light)' : '#fff') + ';text-align:left;cursor:pointer;display:flex;align-items:center;gap:10px;transition:all 0.15s">' +
                '<span style="font-size:1.25rem;flex-shrink:0">' + o.icon + '</span>' +
                '<div><div style="font-size:0.875rem;font-weight:' + (sel ? '700' : '600') + ';color:' + (sel ? 'var(--phase-accent)' : 'var(--text)') + '">' + o.label + '</div><div style="font-size:0.75rem;color:var(--text-muted);margin-top:2px">' + o.desc + '</div></div></button>';
            }).join('') +
            '</div>' +
            '<button type="button" class="btn btn-primary" id="ob-next8" style="width:100%;margin-top:16px;' + (p.strengthTraining ? '' : 'opacity:0.5') + '">Continue to baseline assessment \u2192</button></div>';
          div.querySelectorAll('.ob-st-btn').forEach(function(btn) { btn.onclick = function() { onboardProfile.strengthTraining = btn.getAttribute('data-st'); render(); }; });
          div.querySelector('#ob-next8').onclick = function() { if (!p.strengthTraining) return; onboardStep = 9; render(); };

        } else if (onboardStep >= 9 && onboardStep <= 16) {
          var qIdx = onboardStep - 9;
          var q = POST8_QUESTIONS[qIdx];
          var val = onboardAnswers[q.id] || 0;
          var labels = ['Not at all', 'A little', 'Sometimes', 'Usually', 'Always'];
          var html = obProgressBar(onboardStep) +
            '<div style="padding:0 20px">' +
            '<p style="font-size:0.6875rem;font-weight:600;color:var(--phase-accent);text-transform:uppercase;letter-spacing:0.04em;margin:0 0 16px">Question ' + (qIdx + 1) + ' of 8</p>' +
            '<div style="text-align:center;margin-bottom:20px"><span style="font-size:2.5rem">' + q.icon + '</span></div>' +
            '<h2 style="margin:0 0 24px;font-size:1.125rem;text-align:center;line-height:1.4">' + q.text + '</h2>' +
            '<div style="display:flex;flex-direction:column;gap:10px;margin-bottom:24px">';
          for (var r = 1; r <= 5; r++) {
            var sel = val === r;
            html += '<button type="button" class="ob-q-rating" data-val="' + r + '" style="padding:14px 16px;border-radius:12px;border:2px solid ' + (sel ? 'var(--phase-accent)' : '#e2e8f0') + ';background:' + (sel ? 'var(--phase-accent-light)' : '#fff') + ';text-align:left;cursor:pointer;display:flex;align-items:center;gap:12px;transition:all 0.15s">' +
              '<div style="width:36px;height:36px;border-radius:50%;background:' + (sel ? 'var(--phase-accent)' : '#f1f5f9') + ';color:' + (sel ? '#fff' : 'var(--text-muted)') + ';display:flex;align-items:center;justify-content:center;font-size:1rem;font-weight:700;flex-shrink:0">' + r + '</div>' +
              '<span style="font-size:0.9375rem;font-weight:' + (sel ? '700' : '400') + ';color:' + (sel ? 'var(--phase-accent)' : 'var(--text)') + '">' + labels[r - 1] + '</span></button>';
          }
          html += '</div>';
          if (val > 0) {
            html += '<button type="button" class="btn btn-primary" id="ob-q-next" style="width:100%">' + (qIdx < 7 ? 'Next question \u2192' : 'See your results \u2192') + '</button>';
          }
          html += '</div>';
          div.innerHTML = html;
          div.querySelectorAll('.ob-q-rating').forEach(function(btn) {
            btn.onclick = function() {
              onboardAnswers[q.id] = parseInt(btn.getAttribute('data-val'));
              render();
            };
          });
          if (div.querySelector('#ob-q-next')) {
            div.querySelector('#ob-q-next').onclick = function() {
              if (qIdx < 7) { onboardStep++; render(); }
              else {
                var areaScores = {};
                POST8_QUESTIONS.forEach(function(qq) {
                  if (!areaScores[qq.area]) areaScores[qq.area] = { sum: 0, count: 0 };
                  areaScores[qq.area].sum += (onboardAnswers[qq.id] || 3);
                  areaScores[qq.area].count++;
                });
                var ranked = Object.keys(areaScores).map(function(k) { return { area: k, avg: areaScores[k].sum / areaScores[k].count }; });
                ranked.sort(function(a, b) { return a.avg - b.avg; });
                onboardAnswers._ranked = ranked;
                onboardStep = 17;
                render();
              }
            };
          }

        } else if (onboardStep === 17) {
          var ranked = onboardAnswers._ranked || [];
          var personalizedOrder = buildPersonalizedWeekOrder(onboardProfile.currentStruggles || []);
          var html = obProgressBar(17) +
            '<div style="padding:0 20px">' +
            '<div style="text-align:center;margin-bottom:16px"><div style="font-size:2rem;margin-bottom:4px">&#128202;</div><h2 style="margin:0 0 6px;font-size:1.125rem">Your Personalized Program</h2><p style="font-size:0.8125rem;color:var(--text-muted);margin:0">Built from your struggles, goals, and baseline assessment.</p></div>';

          html += '<div class="card" style="border-left:4px solid var(--phase-accent);padding:16px;margin-bottom:12px"><h3 style="margin:0 0 10px;font-size:0.9375rem;font-weight:700;color:var(--phase-accent)">Your 16-week roadmap</h3>';
          for (var wi = 0; wi < 8; wi++) {
            var topicId = personalizedOrder[wi];
            var topic = WEEK_TOPICS[topicId];
            if (!topic) continue;
            var isHighlight = wi <= 2;
            html += '<div style="display:flex;align-items:center;gap:10px;padding:6px 0;' + (wi < 7 ? 'border-bottom:1px solid #f1f5f9;' : '') + '">' +
              '<div style="width:28px;height:28px;border-radius:50%;background:' + (isHighlight ? 'var(--phase-accent)' : '#f1f5f9') + ';color:' + (isHighlight ? '#fff' : 'var(--text-muted)') + ';display:flex;align-items:center;justify-content:center;font-size:0.75rem;font-weight:700;flex-shrink:0">' + (wi + 1) + '</div>' +
              '<div style="flex:1"><div style="font-size:0.8125rem;font-weight:' + (isHighlight ? '700' : '400') + ';color:' + (isHighlight ? 'var(--phase-accent)' : 'var(--text)') + '">' + topic.milestone + '</div></div>' +
              (isHighlight ? '<span style="font-size:0.5625rem;background:var(--phase-accent-light);color:var(--phase-accent);padding:2px 6px;border-radius:4px;font-weight:700">Priority</span>' : '') +
              '</div>';
          }
          html += '<div style="display:flex;align-items:center;gap:10px;padding:6px 0;border-top:2px dashed #e2e8f0;margin-top:4px"><div style="width:28px;height:28px;border-radius:50%;background:#f1f5f9;color:var(--text-muted);display:flex;align-items:center;justify-content:center;font-size:0.6875rem;font-weight:700;flex-shrink:0">9\u201312</div><div style="font-size:0.8125rem;color:var(--text-muted)">Personalized deep-dive (unlocked at week 9)</div></div>';
          html += '</div>';

          POST8_QUESTIONS.forEach(function(q) {
            var val = onboardAnswers[q.id] || 3;
            var fb = val <= 2 ? q.feedback.low : val <= 3 ? q.feedback.mid : q.feedback.high;
            var barColor = val <= 2 ? '#ef4444' : val <= 3 ? '#eab308' : '#22c55e';
            var ratingLabel = ['', 'Not at all', 'A little', 'Sometimes', 'Usually', 'Always'][val];
            html += '<div class="card" style="padding:14px 16px;margin-bottom:10px">' +
              '<div style="display:flex;align-items:center;gap:6px;margin-bottom:6px"><span style="font-size:1rem">' + q.icon + '</span><span style="font-size:0.8125rem;font-weight:700;color:var(--text)">' + q.text + '</span></div>' +
              '<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px"><div style="flex:1;height:6px;background:#e2e8f0;border-radius:3px;overflow:hidden"><div style="height:100%;width:' + (val * 20) + '%;background:' + barColor + ';border-radius:3px"></div></div><span style="font-size:0.6875rem;font-weight:600;color:' + barColor + '">' + val + '/5 \u2014 ' + ratingLabel + '</span></div>' +
              '<p style="font-size:0.8125rem;color:var(--text);margin:0;line-height:1.55;background:#f8fafc;border-radius:8px;padding:10px 12px">' + fb + '</p></div>';
          });

          html += '<button type="button" class="btn btn-primary" id="onboard-finish" style="width:100%;margin:16px 0 24px;font-size:1.0625rem;padding:14px 20px">Start your graduation \ud83c\udf93</button></div>';
          div.innerHTML = html;
          div.querySelector('#onboard-finish').onclick = function() {
            var personalizedOrder = buildPersonalizedWeekOrder(onboardProfile.currentStruggles || []);
            state.onboardingComplete = true;
            state.program_enrolled_at = new Date().toISOString();
            state.phaseStartAt = new Date().toISOString().slice(0, 10);
            state.profile = JSON.parse(JSON.stringify(onboardProfile));
            state.week1CheckIn = { completedAt: new Date().toISOString(), answers: JSON.parse(JSON.stringify(onboardAnswers)) };
            state.weekOrder = personalizedOrder;
            if (onboardProfile.weight) state.weightAnchor = onboardProfile.weight;
            saveState(state);
            analytics('glp1_program_enrolled', { goals: onboardProfile.goals, struggles: onboardProfile.currentStruggles, weekOrder: personalizedOrder });
            onboardStep = 0; onboardAnswers = {}; onboardProfile = {};
            currentScreen = 'home'; currentNav = 'home'; render();
          };
        }

        container.appendChild(div);
      }

      function renderHome(container) {
        var ctx = getProgramContext(state);
        var gw = ctx.currentWeek;
        var gb = ctx.currentBlock;
        var weeklyGoal = ctx.weeklyGoal;
        var homeCGMActive = cgmOverride !== null ? cgmOverride : isCGMWeek(gw);
        var div = document.createElement('div');
        div.className = 'screen active';
        var todayDoneHunger = getHungerCompletedToday(state);
        var mastery = getHungerMasteryScore(state);
        var masteryPct = mastery.score;
        var todayEntry = (state.hungerEntries && state.hungerEntries[getTodayKey()]) || null;
        var tipIdx = Math.floor((new Date().getDate() + new Date().getMonth()) % HUNGER_MICRO_TIPS.length);
        var dailyTip = HUNGER_MICRO_TIPS[tipIdx];
        var hungerReminderHtml = '<div class="card" style="border-left:4px solid var(--phase-accent);padding:16px">' +
          '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px"><div style="display:flex;align-items:center;gap:8px"><span style="font-size:1.25rem">&#129368;</span><span style="font-size:0.9375rem;font-weight:700;color:var(--text)">Hunger Coach</span></div>' +
          '<div style="display:flex;align-items:center;gap:4px"><span style="font-size:0.6875rem;font-weight:600;color:var(--phase-accent)">' + mastery.level + '</span></div></div>' +
          '<div style="display:flex;gap:8px;margin-bottom:12px">' +
          '<div style="flex:1;background:#f8fafc;border-radius:10px;padding:8px 10px;text-align:center"><div style="font-size:1.125rem;font-weight:800;color:var(--phase-accent)">' + mastery.streak + '</div><div style="font-size:0.5625rem;color:var(--text-muted)">Day streak</div></div>' +
          '<div style="flex:1;background:#f8fafc;border-radius:10px;padding:8px 10px;text-align:center"><div style="font-size:1.125rem;font-weight:800;color:var(--phase-accent)">' + (mastery.avgHunger !== null ? mastery.avgHunger : '\u2014') + '</div><div style="font-size:0.5625rem;color:var(--text-muted)">Avg hunger</div></div>' +
          '<div style="flex:1;background:#f8fafc;border-radius:10px;padding:8px 10px;text-align:center"><div style="font-size:1.125rem;font-weight:800;color:var(--phase-accent)">' + (mastery.avgFullness !== null ? mastery.avgFullness : '\u2014') + '</div><div style="font-size:0.5625rem;color:var(--text-muted)">Avg fullness</div></div>' +
          '</div>' +
          '<div style="margin-bottom:10px"><div style="display:flex;justify-content:space-between;margin-bottom:3px"><span style="font-size:0.6875rem;font-weight:600;color:var(--text)">Satiety skill</span><span style="font-size:0.6875rem;font-weight:600;color:var(--phase-accent)">' + masteryPct + '/100</span></div><div style="height:6px;background:#e2e8f0;border-radius:3px;overflow:hidden"><div style="height:100%;width:' + masteryPct + '%;background:var(--phase-accent);border-radius:3px;transition:width 0.3s"></div></div></div>' +
          '<div style="background:var(--phase-accent-light);border-radius:8px;padding:8px 10px;margin-bottom:12px"><p style="margin:0 0 2px;font-size:0.625rem;font-weight:700;color:var(--phase-accent);text-transform:uppercase;letter-spacing:0.04em">Today\u2019s tip</p><p style="margin:0;font-size:0.8125rem;color:var(--text);line-height:1.4">' + dailyTip + '</p></div>' +
          (!homeCGMActive ?
            '<div style="background:#eff6ff;border-radius:8px;padding:8px 10px;margin-bottom:12px;display:flex;align-items:center;gap:8px"><span style="font-size:1rem">&#128161;</span><div><p style="margin:0;font-size:0.6875rem;font-weight:600;color:#2563eb">No sensor? Your hunger IS the signal.</p><p style="margin:2px 0 0;font-size:0.6875rem;color:#3b82f6;line-height:1.3">Notice patterns: are you most satisfied on days with protein, fiber, or a walk? Your next CGM will confirm what your gut already knows.</p></div></div>' : '') +
          (todayDoneHunger ?
            '<div id="home-hunger-cta" style="display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px 12px;background:#f0fdf4;border-radius:8px;cursor:pointer"><div style="display:flex;align-items:center;gap:8px"><span style="color:#16a34a;font-size:1rem">&#10003;</span><div><span style="font-size:0.8125rem;font-weight:600;color:#16a34a">Checked in today</span>' + (todayEntry ? '<span style="font-size:0.75rem;color:var(--text-muted);margin-left:8px">Hunger: ' + todayEntry.overallHunger + '/5 &middot; Fullness: ' + todayEntry.postMealFullness + '/5</span>' : '') + '</div></div><span style="color:#16a34a;font-size:0.875rem">&#8250;</span></div>' :
            '<button type="button" class="btn btn-primary" id="home-hunger-cta" style="width:100%;font-size:0.875rem">Check in now \u2014 30 seconds</button>') +
          '<button type="button" class="btn btn-outline" id="home-coach-cta" style="width:100%;margin-top:8px;font-size:0.8125rem;display:flex;align-items:center;justify-content:center;gap:6px"><span>&#129368;</span> I\u2019m feeling hungry \u2014 help me</button>' +
          '</div>';
        var glucoseGPA = getGlucoseGPA(state);
        var lifestyleGPA = getLifestyleGPA(state);
        var consistencyScore = getConsistencyScore(state);
        var glucose15 = glucoseGPA.score15;
        var lifestyle15 = lifestyleGPA.score15;
        var consistency15 = score100To15(consistencyScore);
        var homeGpaStrip = '<div class="home-gpa-strip-wrap" id="home-gpa-strip"><div class="home-gpa-strip">' +
          '<div class="home-gpa-pill"><div class="home-gpa-value">' + glucose15 + '</div><div class="home-gpa-label">Glucose GPA</div></div>' +
          '<div class="home-gpa-pill"><div class="home-gpa-value">' + lifestyle15 + '</div><div class="home-gpa-label">Lifestyle GPA</div></div>' +
          '<div class="home-gpa-pill"><div class="home-gpa-value">' + consistency15 + '</div><div class="home-gpa-label">Consistency GPA</div></div>' +
          '</div><p class="home-gpa-strip-hint">View in Insights <span class="hint-chevron">&#8250;</span></p></div>';
        var gb = weekToBlock(gw);
        var ms = pBlockMilestone(gb);
        var gc = checkGraduationCriteria(state); var met = gc.criteria.filter(function(c) { return c.met; }).length;
        var pct = Math.round((gw / 16) * 100);
        var homeNextCgmBlk = getNextCGMBlock(gb);
        var homeNextCgmWk = homeNextCgmBlk ? blockToWeeks(homeNextCgmBlk)[0] : null;
        var homeNextDays = homeNextCgmWk ? Math.max(0, (homeNextCgmWk - gw) * 7) : 0;
        var nextSensorLine = (!homeCGMActive && homeNextCgmWk) ? '<div style="font-size:0.6875rem;color:#2563eb;margin-top:4px;display:flex;align-items:center;gap:4px"><span>&#128201;</span> Next sensor in <strong>' + homeNextDays + ' days</strong> (Block ' + homeNextCgmBlk + ')</div>' : '';
        div.innerHTML = '<header class="page-header"><span style="width:36px"></span><span class="header-title">Home</span><button type="button" class="header-btn" id="go-settings" title="Settings">&#128100;</button></header>' +
          '<div class="phase-badge"><span class="phase-badge-dot"></span>' + PROGRAM_NAME + ' \u2014 Block ' + gb + ' (Wk ' + blockToWeeks(gb).join('\u2013') + ')</div>' +
          '<div class="card" id="home-grad-card" style="cursor:pointer;padding:14px 16px;border-left:4px solid var(--phase-accent)"><div style="display:flex;justify-content:space-between;align-items:center"><div><div style="font-size:0.9375rem;font-weight:700;color:var(--phase-accent)">' + ms + '</div><div style="font-size:0.75rem;color:var(--text-muted);margin-top:2px">Block ' + gb + ' of 8 \u00b7 Weeks ' + blockToWeeks(gb).join('\u2013') + '</div>' + nextSensorLine + '</div><div style="text-align:right"><div style="font-size:1.25rem;font-weight:800;color:var(--phase-accent)">' + pct + '%</div><div style="font-size:0.625rem;color:var(--text-muted)">' + met + '/' + gc.criteria.length + ' criteria</div></div></div><div style="height:4px;background:#e2e8f0;border-radius:2px;margin-top:8px;overflow:hidden"><div style="height:100%;width:' + pct + '%;background:var(--phase-accent);border-radius:2px"></div></div><div style="font-size:0.6875rem;color:var(--text-muted);margin-top:6px;text-align:right">Tap to view full timeline &#8250;</div></div>' +
          (homeCGMActive ?
          '<div class="card" id="cgm-status-card" style="cursor:pointer;border:2px solid #2563eb;background:#fafcff"><div class="glucose-section"><p class="glucose-label">Current glucose <span style="font-size:0.6875rem;background:#2563eb;color:#fff;padding:3px 10px;border-radius:12px;margin-left:6px;vertical-align:middle;cursor:pointer">&#128994; LIVE &mdash; tap to toggle</span></p><p class="glucose-value">110<span class="glucose-unit">mg/dL</span> <span style="color:var(--text-muted);font-size:1rem">&#8594;</span></p><div class="metrics-row"><span class="metric-pill tir">TIR 85%</span><span class="metric-pill spd">SPD 5</span><span class="metric-pill lst">LST 5:30p<span class="info-dot">i</span></span></div></div></div>' +
          '<div class="card glucose-graph-card"><div class="glucose-graph-wrap">' +
          '<svg viewBox="0 0 340 200" preserveAspectRatio="xMidYMid meet">' +
          '<line class="graph-hline" x1="44" y1="24" x2="320" y2="24"/>' +
          '<line class="graph-hline" x1="44" y1="156" x2="320" y2="156"/>' +
          '<path fill="#2563eb" fill-opacity="0.4" d="M 44 136 L 71 134 L 71 156 L 44 156 Z"/><path fill="none" stroke="#2563eb" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" d="M 44 136 L 71 134"/>' +
          '<path fill="#eab308" fill-opacity="0.4" d="M 71 134 L 99 81 L 108 99 L 108 156 L 71 156 Z"/><path fill="none" stroke="#eab308" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" d="M 71 134 L 99 81 L 108 99"/>' +
          '<path fill="#2563eb" fill-opacity="0.4" d="M 108 99 L 112 138 L 136 136 L 136 156 L 108 156 Z"/><path fill="none" stroke="#2563eb" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" d="M 108 99 L 112 138 L 136 136"/>' +
          '<path fill="#ec4899" fill-opacity="0.45" d="M 136 136 L 154 24 L 166 53 L 166 156 L 136 156 Z"/><path fill="none" stroke="#ec4899" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" d="M 136 136 L 154 24 L 166 53"/>' +
          '<path fill="#2563eb" fill-opacity="0.4" d="M 166 53 L 191 140 L 191 156 L 166 156 Z"/><path fill="none" stroke="#2563eb" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" d="M 166 53 L 191 140"/>' +
          '<path fill="#eab308" fill-opacity="0.4" d="M 191 140 L 210 82 L 228 111 L 228 156 L 191 156 Z"/><path fill="none" stroke="#eab308" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" d="M 191 140 L 210 82 L 228 111"/>' +
          '<path fill="#2563eb" fill-opacity="0.4" d="M 228 111 L 264 124 L 320 127 L 320 156 L 228 156 Z"/><path fill="none" stroke="#7c3aed" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" d="M 228 111 L 264 124 L 320 127"/>' +
          '<line class="graph-ref-line" x1="44" y1="127" x2="320" y2="127"/>' +
          '<line class="graph-lst-line" x1="283" y1="24" x2="283" y2="127"/>' +
          '<circle class="graph-current-dot-outer2" cx="320" cy="127" r="14"/>' +
          '<circle class="graph-current-dot-outer" cx="320" cy="127" r="10"/>' +
          '<circle class="graph-current-dot" cx="320" cy="127" r="5"/>' +
          '<text class="graph-peak-label" x="99" y="76">+62</text><text class="graph-peak-label" x="154" y="18">+244</text>' +
          '<text class="graph-axis-y" x="324" y="27" text-anchor="start">250</text><text class="graph-axis-y" x="324" y="130" text-anchor="start">110</text><text class="graph-axis-y" x="324" y="159" text-anchor="start">70</text>' +
          '<text class="graph-axis-x" x="44" y="172">3:45p</text><text class="graph-axis-x" x="99" y="172">4:30p</text><text class="graph-axis-x" x="154" y="172">5:15p</text><text class="graph-axis-x" x="210" y="172">6:00p</text><text class="graph-axis-x" x="265" y="172">6:45p</text><text class="graph-axis-x" x="308" y="172">7:30p</text>' +
          '<text class="graph-axis-x" x="278" y="20" font-size="9" fill="#64748b">LST cutoff</text>' +
          '</svg></div>' +
          '<div class="graph-timeline"><div class="graph-timeline-row"><button type="button" class="graph-timeline-arrow" aria-label="Previous">&#9664;</button><div class="graph-timeline-icons"><span class="graph-timeline-icon meal" title="Meals">&#127860;</span><span class="graph-timeline-meal-badge">2</span><span class="graph-timeline-icon unknown">?</span><span class="graph-timeline-icon run" title="Activity">&#128694;</span></div><button type="button" class="graph-timeline-arrow" aria-label="Next">&#9654;</button><span class="graph-timeline-spacer"></span><button type="button" class="graph-add-btn" aria-label="Add">+</button></div><div class="graph-updated-wrap"><span class="graph-updated">Glucose by Stelo updated just now</span></div></div></div>'
          : (function() {
            var lastPeriod = getLastCGMPeriod(gw);
            var summaryGPA = glucose15;
            var avgPts = [
              {t:'6a',g:92},{t:'7a',g:95},{t:'8a',g:132},{t:'9a',g:118},{t:'10a',g:104},
              {t:'11a',g:99},{t:'12p',g:97},{t:'1p',g:141},{t:'2p',g:126},{t:'3p',g:108},
              {t:'4p',g:101},{t:'5p',g:98},{t:'6p',g:138},{t:'7p',g:124},{t:'8p',g:110},
              {t:'9p',g:103},{t:'10p',g:96}
            ];
            var svgW = 320, svgH = 120, pL = 32, pR = 10, pT = 14, pB = 22;
            var plotW = svgW - pL - pR, plotH = svgH - pT - pB;
            var gMin = 70, gMax = 180;
            function gx(i) { return pL + (i / (avgPts.length - 1)) * plotW; }
            function gy(v) { return pT + plotH - ((v - gMin) / (gMax - gMin)) * plotH; }
            var pathD = avgPts.map(function(p, i) { return (i === 0 ? 'M' : 'L') + ' ' + gx(i).toFixed(1) + ' ' + gy(p.g).toFixed(1); }).join(' ');
            var areaD = pathD + ' L ' + gx(avgPts.length - 1).toFixed(1) + ' ' + (pT + plotH) + ' L ' + gx(0).toFixed(1) + ' ' + (pT + plotH) + ' Z';
            var peakIdx = 0; avgPts.forEach(function(p, i) { if (p.g > avgPts[peakIdx].g) peakIdx = i; });
            var avgGlucose = Math.round(avgPts.reduce(function(s, p) { return s + p.g; }, 0) / avgPts.length);
            var avgSvg = '<svg viewBox="0 0 ' + svgW + ' ' + svgH + '" preserveAspectRatio="xMidYMid meet" style="width:100%;height:auto">' +
              '<rect x="' + pL + '" y="' + gy(140) + '" width="' + plotW + '" height="' + (gy(70) - gy(140)) + '" fill="#fef3c7" fill-opacity="0.3" rx="2"/>' +
              '<line x1="' + pL + '" y1="' + gy(140) + '" x2="' + (svgW - pR) + '" y2="' + gy(140) + '" stroke="#d97706" stroke-width="0.5" stroke-dasharray="3,3"/>' +
              '<text x="' + (svgW - pR - 2) + '" y="' + (gy(140) - 2) + '" font-size="7" fill="#d97706" text-anchor="end">140</text>' +
              '<line x1="' + pL + '" y1="' + gy(100) + '" x2="' + (svgW - pR) + '" y2="' + gy(100) + '" stroke="#e2e8f0" stroke-width="0.5" stroke-dasharray="3,3"/>' +
              '<text x="' + (pL - 3) + '" y="' + (gy(100) + 3) + '" font-size="7" fill="#94a3b8" text-anchor="end">100</text>' +
              '<path d="' + areaD + '" fill="#f59e0b" fill-opacity="0.12"/>' +
              '<path d="' + pathD + '" fill="none" stroke="#d97706" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="6,3"/>' +
              '<circle cx="' + gx(peakIdx).toFixed(1) + '" cy="' + gy(avgPts[peakIdx].g).toFixed(1) + '" r="3.5" fill="#d97706" stroke="#fff" stroke-width="1.5"/>' +
              '<text x="' + gx(peakIdx).toFixed(1) + '" y="' + (gy(avgPts[peakIdx].g) - 5) + '" font-size="7" fill="#92400e" text-anchor="middle">' + avgPts[peakIdx].g + '</text>';
            for (var ti = 0; ti < avgPts.length; ti += 4) {
              avgSvg += '<text x="' + gx(ti).toFixed(1) + '" y="' + (svgH - 4) + '" font-size="7" fill="#94a3b8" text-anchor="middle">' + avgPts[ti].t + '</text>';
            }
            avgSvg += '</svg>';

            return '<div class="card" id="cgm-off-toggle" style="padding:14px 16px;cursor:pointer;border:2px solid #d97706;background:#fffbeb">' +
              '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px"><div style="display:flex;align-items:center;gap:6px"><span style="font-size:1rem">&#128200;</span><span style="font-size:0.875rem;font-weight:700;color:var(--text)">Your Average Day</span><span style="font-size:0.5625rem;color:#92400e;background:#fef3c7;padding:1px 5px;border-radius:4px;font-weight:600">' + (lastPeriod ? lastPeriod.label : 'Last Sensor') + '</span></div><span style="font-size:0.6875rem;background:#d97706;color:#fff;padding:3px 10px;border-radius:12px;cursor:pointer">&#128308; OFF &mdash; tap to toggle</span></div>' +
              '<p style="font-size:0.6875rem;color:var(--text-muted);margin:0 0 6px;line-height:1.3">This is what your typical day looked like on your last sensor. Your habits are working to improve this curve.</p>' +
              avgSvg +
              '<div style="display:flex;gap:8px;margin-top:8px">' +
              '<div style="flex:1;background:#fef9c3;border-radius:8px;padding:6px 8px;text-align:center"><div style="font-size:1rem;font-weight:800;color:#92400e">' + avgGlucose + '</div><div style="font-size:0.5625rem;color:#a16207">Avg mg/dL</div></div>' +
              '<div style="flex:1;background:#fef9c3;border-radius:8px;padding:6px 8px;text-align:center"><div style="font-size:1rem;font-weight:800;color:#92400e">' + summaryGPA + '</div><div style="font-size:0.5625rem;color:#a16207">Glucose GPA</div></div>' +
              '<div style="flex:1;background:#fef9c3;border-radius:8px;padding:6px 8px;text-align:center"><div style="font-size:1rem;font-weight:800;color:#92400e">85%</div><div style="font-size:0.5625rem;color:#a16207">Time in Range</div></div></div>' +
              '<div style="margin-top:8px;padding:6px 8px;background:#fff7ed;border-radius:6px;font-size:0.6875rem;color:#92400e;line-height:1.4"><strong>Post-lunch spike</strong> was your highest daily average. Protein + walk after lunch can flatten this.</div>' +
              '</div>';
          })()) +
          (!homeCGMActive ?
            '<div style="margin:4px 0"><div style="margin:0 16px 0;padding:6px 12px;background:var(--phase-accent);color:#fff;border-radius:10px 10px 0 0;font-size:0.6875rem;font-weight:700;text-transform:uppercase;letter-spacing:0.05em;display:flex;align-items:center;gap:4px">&#11088; Your primary signal this week</div><div style="margin:0 16px 12px;border:2px solid var(--phase-accent);border-top:none;border-radius:0 0 12px 12px;box-shadow:0 2px 12px rgba(124,58,237,0.10);overflow:hidden">' +
            hungerReminderHtml +
            '</div></div>' :
            hungerReminderHtml) +
          homeGpaStrip +
          buildWeightBandGraph(state) +
          (gb >= 5 && !isPhase2Unlocked(state) ?
            '<div class="card focus-card" data-widget="weekly_goal" style="border:2px dashed #cbd5e1"><h3 style="color:#94a3b8">&#128274; Blocks 5\u20138 Locked</h3><p style="font-size:0.875rem;color:var(--text-muted);margin:0 0 8px">Complete blocks 1\u20134 and the post-block-4 check-in to unlock your personalized final blocks.</p><button type="button" class="btn btn-outline" style="margin-top:0" id="focus-cta">Open Toolkit</button></div>' :
            '<div class="card focus-card" data-widget="weekly_goal"><h3>Block ' + gb + ' Focus: ' + weeklyGoal.title + '</h3><p style="font-size:0.875rem;color:var(--text-muted);margin:0 0 8px">' + weeklyGoal.desc + '</p><p style="font-size:0.8125rem;font-weight:600;color:var(--phase-accent);margin:0 0 12px">Target: ' + weeklyGoal.metric + '</p><button type="button" class="btn btn-outline" style="margin-top:0" id="focus-cta">Open Toolkit</button></div>') +
          '<div class="card today-card"><div class="card-head"><h3>Today</h3><span class="completed">0/3 Completed</span></div><p class="focus-line">Focus on LST this week</p><p class="pinned">&#128204; PINNED</p>' +
          '<div class="habit-item"><span class="habit-icon">&#127860;</span><span class="habit-label">Log 30g of protein today</span><span class="habit-progress"><span class="fill"></span></span><span class="habit-frac">1/2</span><button type="button" class="habit-more" aria-label="More">&#8942;</button></div>' +
          '<div class="habit-item"><span class="habit-icon">&#128166;</span><span class="habit-label">Drink 8 oz of water with 2 meals</span><span class="habit-progress"><span class="fill"></span></span><span class="habit-frac">1/2</span><button type="button" class="habit-more" aria-label="More">&#8942;</button></div>' +
          '<div class="habit-item"><span class="habit-icon">&#128694;</span><span class="habit-label">Walk 7,000 steps today</span><span class="habit-progress"><span class="fill"></span></span><span class="habit-frac">1/2</span><button type="button" class="habit-more" aria-label="More">&#8942;</button></div>' +
          '<p class="habits-refresh">Habits refresh in 13 hr, 3 min</p><button type="button" class="see-all" id="see-dailies">See all habits</button></div>' +
          '';
        div.querySelector('#go-settings').onclick = function() { navigateTo('settings', 'settings'); };
        div.querySelector('#see-dailies').onclick = function() { navigateTo('dailies', 'dailies'); };
        if (div.querySelector('#home-grad-card')) div.querySelector('#home-grad-card').onclick = function() { navigateTo('dailies', 'dailies'); };
        if (div.querySelector('#home-hunger-cta')) div.querySelector('#home-hunger-cta').onclick = function() { navigateTo('hunger_questionnaire'); };
        if (div.querySelector('#home-coach-cta')) div.querySelector('#home-coach-cta').onclick = function() { resetCoachState(); navigateTo('hunger_coach'); };
        if (div.querySelector('#home-gpa-strip')) div.querySelector('#home-gpa-strip').onclick = function() { navigateTo('insights', 'insights'); };
        if (div.querySelector('#focus-cta')) div.querySelector('#focus-cta').onclick = function() { navigateTo('dailies', 'dailies'); };
        var cgmCard = div.querySelector('#cgm-status-card');
        if (cgmCard) cgmCard.onclick = function(e) {
          if (e.target.closest('.graph-add-btn') || e.target.closest('.graph-timeline-arrow')) return;
          cgmOverride = false;
          render();
        };
        var cgmOffToggle = div.querySelector('#cgm-off-toggle');
        if (cgmOffToggle) cgmOffToggle.onclick = function() {
          cgmOverride = true;
          render();
        };
        container.appendChild(div);
      }

      function renderTransitionToolkit(container) {
        var gw = getGraduationWeek(state);
        var gb = weekToBlock(gw);
        var weeklyGoal = pBlockGoal(gb);
        var readiness = computeReadiness(state);
        var readiness15 = score100To15(readiness);
        var readinessGPA = scoreToGPA(readiness);
        var planBullets = [
          'Keep logging workouts 3x/week \u2014 consistency beats make-up days',
          'Complete weekly education modules \u2014 knowledge drives lasting habits',
          'Stabilize macros day-to-day and week-to-week',
          'Hit water goals daily for better consistency score',
          'Use hunger check-ins to spot patterns'
        ];
        var div = document.createElement('div');
        div.className = 'screen active';
        var cgmCard = '<div class="card" style="padding:12px 14px;border:1px solid #bfdbfe;background:#fafcff"><div style="display:flex;align-items:center;gap:6px;margin-bottom:8px"><span style="font-size:1rem">&#128201;</span><div style="font-size:0.875rem;font-weight:700;color:#2563eb">CGM Sensor Schedule</div></div>' +
          '<div style="display:grid;grid-template-columns:1fr 1fr;gap:6px">' +
          CGM_PERIODS.map(function(p) {
            var isActive = p.weeks.indexOf(gw) >= 0;
            var isDone = gw > p.weeks[1];
            return '<div style="padding:8px 10px;border-radius:8px;background:' + (isActive ? '#dbeafe' : isDone ? '#f0fdf4' : '#f8fafc') + ';border:1px solid ' + (isActive ? '#2563eb' : isDone ? '#bbf7d0' : '#e2e8f0') + '">' +
              '<div style="font-size:0.75rem;font-weight:700;color:' + (isActive ? '#2563eb' : isDone ? '#16a34a' : 'var(--text)') + '">Block ' + p.block + ' (Wk ' + p.weeks[0] + '\u2013' + p.weeks[1] + ')' + (isActive ? ' \u25C0 NOW' : isDone ? ' \u2714' : '') + '</div>' +
              '<div style="font-size:0.625rem;color:var(--text-muted);margin-top:2px">' + p.purpose + '</div></div>';
          }).join('') +
          '</div></div>';
        div.innerHTML = '<header class="page-header"><span style="width:36px"></span><span class="header-title">Toolkit</span><span style="width:36px"></span></header>' +
          buildGraduationTimeline(state, true) +
          cgmCard +
          '<div class="card" style="background:var(--phase-accent-light);border-left:4px solid var(--phase-accent)"><h3 style="margin:0 0 8px;font-size:0.9375rem;font-weight:700;color:var(--phase-accent)">Core Principles</h3><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">' +
          CORE_PRINCIPLES.map(function(p, i) { return '<div style="font-size:0.8125rem;color:var(--text);line-height:1.4;padding:6px 8px;background:rgba(255,255,255,0.7);border-radius:8px"><strong style="color:var(--phase-accent)">' + (i + 1) + '.</strong> ' + p + '</div>'; }).join('') +
          '</div></div>' +
          '<div class="card focus-card" data-widget="weekly_goal"><h3>Block ' + gb + ' Focus: ' + weeklyGoal.title + '</h3><p style="font-size:0.875rem;color:var(--text-muted);margin:0 0 8px">' + weeklyGoal.desc + '</p><p style="font-size:0.8125rem;font-weight:600;color:var(--phase-accent);margin:0">Target: ' + weeklyGoal.metric + '</p></div>' +
          '<div class="card readiness-plan-card"><h3 style="margin:0 0 8px;font-size:1rem">Graduation Readiness Score</h3><p style="font-size:0.8125rem;color:var(--text-muted);margin:0 0 10px">Based on Glucose GPA, Lifestyle GPA, hunger/satiety ratings, education completion, and consistency.</p><div style="display:flex;align-items:center;gap:12px;margin:12px 0"><div class="gpa-circle ' + readinessGPA.class + '" style="width:52px;height:52px;font-size:1.375rem">' + readinessGPA.letter + '</div><span style="font-size:1.125rem;font-weight:600">' + readiness15 + ' / 5</span></div><div class="m-title" style="margin:8px 0 4px">Components</div><div class="consistency-row"><span>Glucose GPA</span><span>' + getGlucoseGPA(state).score15 + '</span></div><div class="consistency-row"><span>Lifestyle GPA</span><span>' + getLifestyleGPA(state).score15 + '</span></div><div class="consistency-row"><span>Hunger/satiety ratings</span><span>On track</span></div><div class="consistency-row"><span>Consistency rating</span><span>' + score100To15(getConsistencyScore(state)) + '</span></div><div class="m-title" style="margin:10px 0 4px">Your plan</div><ul class="plan-list">' + planBullets.map(function(b) { return '<li>' + b + '</li>'; }).join('') + '</ul></div>' +
          (function() {
          var secOrder = EDUCATION_SECTION_ORDER;
          var eduProg = getPhaseEducationProgress(state);
          var pct = eduProg.total > 0 ? Math.round((eduProg.done / eduProg.total) * 100) : 0;
          var pBE = pBlockEdu(gb);
          var weekEduMods = gb >= 5 ? getPersonalizedWeekModules(state, gw) : (pBE ? pBE.modules : []);
          var weekEduTotal = weekEduMods.length;
          var weekEduDone = weekEduMods.filter(function(mid) { return isModuleCompleted(state, mid); }).length;
          var weekPct = weekEduTotal > 0 ? Math.round((weekEduDone / weekEduTotal) * 100) : 0;
          var weekGoalMet = weekPct >= 80;
          var html = '<div class="card"><h3 class="edu-section-title">Education</h3>' +
            '<p class="edu-section-subtitle">' + eduProg.done + ' of ' + eduProg.total + ' completed (' + pct + '%)</p><div class="edu-progress-bar"><div class="edu-progress-fill" style="width:' + pct + '%"></div></div>' +
            '<div style="margin-top:10px;padding:10px 12px;border-radius:10px;background:' + (weekGoalMet ? '#f0fdf4' : '#fefce8') + ';border:1px solid ' + (weekGoalMet ? '#bbf7d0' : '#fef08a') + ';display:flex;align-items:center;gap:8px">' +
            '<div style="font-size:1.25rem">' + (weekGoalMet ? '&#10003;' : '&#9201;') + '</div><div><div style="font-size:0.8125rem;font-weight:600;color:' + (weekGoalMet ? '#16a34a' : '#a16207') + '">Block ' + gb + ' Education: ' + weekEduDone + '/' + weekEduTotal + (weekGoalMet ? ' \u2014 Goal met!' : '') + '</div><div style="font-size:0.75rem;color:var(--text-muted)">Goal: complete 80% (' + Math.ceil(weekEduTotal * 0.8) + '+ modules) this block</div></div></div>' +
            '<p style="font-size:0.75rem;color:var(--text-muted);margin:10px 0 4px">Tap a section to see all modules in that category.</p>';
          secOrder.forEach(function(secId) {
            var sec = EDUCATION_SECTIONS[secId];
            if (!sec || (!sec.modules.length && !(sec.games && sec.games.length))) return;
            var sp = eduProg.sections[secId] || { total: 0, done: 0 };
            var secPct = sp.total > 0 ? Math.round((sp.done / sp.total) * 100) : 0;
            var secIcons = { glucose_cgm: '&#128200;', nutrition: '&#127860;', exercise: '&#127939;', hunger: '&#129368;', sleep: '&#128164;', stress: '&#129504;' };
            html += '<div class="edu-section-block ' + secId + ' collapsed" data-sec-id="' + secId + '"><div class="edu-section-header" data-sec-toggle="' + secId + '" style="display:flex;align-items:center;justify-content:space-between;cursor:pointer;padding:10px 0;border-bottom:1px solid #f1f5f9"><div style="display:flex;align-items:center;gap:8px"><span style="font-size:1.125rem">' + (secIcons[secId] || '') + '</span><div><h4 class="edu-section-head" style="margin:0;font-size:0.9375rem">' + (sec.title || secId).replace(/</g, '&lt;') + '</h4><p style="margin:2px 0 0;font-size:0.6875rem;color:var(--text-muted)">' + sp.done + '/' + sp.total + ' completed</p></div></div><div style="display:flex;align-items:center;gap:6px"><div style="width:40px;height:4px;background:#e2e8f0;border-radius:2px;overflow:hidden"><div style="height:100%;width:' + secPct + '%;background:var(--phase-accent);border-radius:2px"></div></div><span class="edu-section-chevron" style="font-size:0.875rem;color:var(--text-muted);transition:transform 0.2s">&#9654;</span></div></div>' +
              '<div class="edu-section-content" style="display:none">';
            (sec.modules || []).forEach(function(m) {
              var done = isModuleCompleted(state, m.id);
              var tierLabel = m.tier === 'foundation' ? '\ud83d\udfe2' : m.tier === 'intermediate' ? '\ud83d\udfe1' : '\ud83d\udfe3';
              var isThisWeek = weekEduMods.indexOf(m.id) >= 0;
              html += '<div class="edu-module-card' + (done ? ' completed' : '') + (isThisWeek ? ' this-week' : '') + '">' + (isThisWeek ? '<div style="font-size:0.625rem;font-weight:700;color:var(--phase-accent);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px">Block ' + gb + ' module</div>' : '') + '<div class="edu-module-title">' + tierLabel + ' ' + (m.title || '').replace(/</g, '&lt;') + '</div><div class="edu-module-desc">' + (m.description || '').replace(/</g, '&lt;') + '</div><div class="edu-module-meta"><span class="edu-module-time">' + (done ? 'Completed' : (m.estimatedTime || '')) + '</span><button type="button" class="btn btn-primary edu-module-start" data-module-id="' + (m.id || '').replace(/"/g, '&quot;') + '">' + (done ? 'Review' : 'Start') + '</button></div></div>';
            });
            (sec.games || []).forEach(function(g) {
              var gDone = isGameCompleted(state, g.type);
              html += '<div class="edu-module-card edu-game-card' + (gDone ? ' completed' : '') + '"><div class="edu-module-title">' + (g.title || g.type || '').replace(/</g, '&lt;') + '</div><div class="edu-module-desc">' + (g.description || '').replace(/</g, '&lt;') + '</div><div class="edu-module-meta"><span class="edu-module-time">' + (gDone ? 'Completed today' : (g.estimatedTime || '')) + '</span><button type="button" class="btn btn-outline edu-game-play" data-game-type="' + (g.type || '').replace(/"/g, '&quot;') + '" data-game-title="' + (g.title || g.type || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;') + '">' + (gDone ? 'Play again' : 'Play') + '</button></div></div>';
            });
            html += '</div></div>';
          });
          return html + '</div>';
        })() +
          '';
        div.querySelectorAll('[data-sec-toggle]').forEach(function(hdr) {
          hdr.onclick = function() {
            var secBlock = hdr.closest('.edu-section-block');
            var content = secBlock.querySelector('.edu-section-content');
            var chevron = hdr.querySelector('.edu-section-chevron');
            if (secBlock.classList.contains('collapsed')) {
              secBlock.classList.remove('collapsed');
              content.style.display = 'block';
              chevron.style.transform = 'rotate(90deg)';
            } else {
              secBlock.classList.add('collapsed');
              content.style.display = 'none';
              chevron.style.transform = 'rotate(0deg)';
            }
          };
        });
        div.querySelectorAll('[data-week]').forEach(function(weekDot) {
          weekDot.onclick = function() {
            openWeekNumber = parseInt(weekDot.getAttribute('data-week'));
            navigateTo('week_detail');
          };
        });
        var currentDot = div.querySelector('.grad-week.current');
        if (currentDot) {
          setTimeout(function() {
            var timeline = currentDot.closest('.grad-timeline');
            if (timeline) {
              var dotLeft = currentDot.offsetLeft - timeline.offsetLeft;
              timeline.scrollLeft = Math.max(0, dotLeft - timeline.clientWidth / 2 + currentDot.offsetWidth / 2);
            }
          }, 50);
        }
        div.querySelectorAll('.edu-module-start').forEach(function(btn) {
          btn.onclick = function() {
            openEducationModuleId = btn.getAttribute('data-module-id');
            navigateTo('education_module');
          };
        });
        div.querySelectorAll('.edu-game-play').forEach(function(btn) {
          btn.onclick = function() {
            openEducationGameType = btn.getAttribute('data-game-type');
            openEducationGameTitle = btn.getAttribute('data-game-title') || openEducationGameType;
            eduGameIndex = 0;
            eduGameAnswered = false;
            eduBuildMealSelected = { protein: null, carb: null, veggie: null };
            eduBuildWorkoutStep = 0;
            eduBuildBackSelected = [];
            eduBuildLegsSelected = [];
            eduFormQuizIndex = 0;
            eduFormQuizAnswered = false;
            eduRecordFormMovementId = null;
            eduRecordFormPhase = 'pick';
            navigateTo('education_game');
          };
        });
        container.appendChild(div);
      }

      function isPhase2Unlocked(s) {
        if (s.postWeek8CheckIn && s.focusAreas && s.focusAreas.length > 0) return true;
        return false;
      }
      function getWeek1to8EduCompletion(s) {
        var total = 0, done = 0, seen = {};
        for (var b = 1; b <= 4; b++) {
          var be = pBlockEdu(b);
          if (!be) continue;
          be.modules.forEach(function(mid) { if (seen[mid]) return; seen[mid] = true; total++; if (isModuleCompleted(s, mid)) done++; });
        }
        return { total: total, done: done, pct: total > 0 ? Math.round((done / total) * 100) : 0 };
      }
      function getSignosInsights(s) {
        var insights = [];
        var gGPA = getGlucoseGPA(s);
        var lGPA = getLifestyleGPA(s);
        if (gGPA.score15 < 3.5) insights.push({ area: 'glucose', label: 'Glucose stability', detail: 'Your Glucose GPA is ' + gGPA.score15 + '/5. Glucose management could use more attention.' });
        if (lGPA.score15 < 3.0) insights.push({ area: 'exercise', label: 'Activity & lifestyle', detail: 'Your Lifestyle GPA is ' + lGPA.score15 + '/5. More movement and activity tracking may help.' });
        var hungerEntries = s.hungerEntries || {};
        var hungerDays = Object.keys(hungerEntries).length;
        var totalDays = Math.max(1, Math.round((new Date() - new Date(s.phaseStartAt || new Date())) / (86400000)));
        var hungerRate = totalDays > 0 ? hungerDays / totalDays : 0;
        if (hungerRate < 0.5) insights.push({ area: 'hunger', label: 'Hunger awareness', detail: 'You completed hunger check-ins ' + Math.round(hungerRate * 100) + '% of days. Building this habit helps with satiety long-term.' });
        var consistency = getConsistencyScore(s);
        if (consistency < 60) insights.push({ area: 'nutrition', label: 'Nutrition consistency', detail: 'Your consistency score is ' + Math.round(consistency) + '/100. Meal structure and protein may need more attention.' });
        if (insights.length === 0) insights.push({ area: 'nutrition', label: 'Keep building', detail: 'Your scores look solid. Deep-diving into nutrition or hunger mastery can take you further.' });
        return insights;
      }
      function getPersonalizedWeekModules(s, weekNum) {
        var blk = weekToBlock(weekNum);
        if (blk < 5 || !s.focusAreas || s.focusAreas.length === 0) return [];
        var mods = [];
        s.focusAreas.forEach(function(areaKey) {
          var area = FOCUS_AREA_OPTIONS[areaKey];
          if (area && area.modules) mods = mods.concat(area.modules);
        });
        var unique = [];
        var seen = {};
        mods.forEach(function(m) { if (!seen[m]) { unique.push(m); seen[m] = true; } });
        var perBlock = Math.ceil(unique.length / 4);
        var blockOffset = blk - 5;
        return unique.slice(blockOffset * perBlock, (blockOffset + 1) * perBlock);
      }
      function getWeekModulesBySection(weekNum) {
        var moduleIds;
        if (weekNum >= 9) {
          moduleIds = getPersonalizedWeekModules(state, weekNum);
        } else {
          var weekEdu = pWeekEdu(weekNum);
          moduleIds = weekEdu ? weekEdu.modules : [];
        }
        var bySec = {};
        EDUCATION_SECTION_ORDER.forEach(function(secId) {
          var sec = EDUCATION_SECTIONS[secId];
          if (!sec) return;
          var matched = (sec.modules || []).filter(function(m) { return moduleIds.indexOf(m.id) >= 0; });
          if (matched.length > 0) bySec[secId] = matched;
        });
        return bySec;
      }

      function renderWeekDetail(container) {
        var wk = openWeekNumber || 1;
        var blk = weekToBlock(wk);
        var goal = pBlockGoal(blk);
        var milestone = pBlockMilestone(blk);
        var currentWeek = getGraduationWeek(state);
        var currentBlock = weekToBlock(currentWeek);
        var isPast = blk < currentBlock;
        var isCurrent = blk === currentBlock;
        var isPersonalized = blk >= 5;
        var phase2Unlocked = isPhase2Unlocked(state);
        var div = document.createElement('div');
        div.className = 'screen active';
        var statusColor = isCurrent ? 'var(--phase-accent)' : isPast ? '#16a34a' : 'var(--text-muted)';
        var statusLabel = isCurrent ? 'Current block' : isPast ? 'Completed' : 'Upcoming';
        var blockHasCGM = isCGMBlock(blk);
        var cgmPeriod = getCGMPeriod(blockToWeeks(blk)[0]);
        var bwks = blockToWeeks(blk);
        var secIcons = { glucose_cgm: '&#128200;', nutrition: '&#127860;', exercise: '&#127939;', hunger: '&#129368;', sleep: '&#128164;', stress: '&#129504;' };
        var html = '<header class="page-header"><button type="button" class="header-btn back-btn" id="week-back" aria-label="Back">&#8249;</button><span class="header-title">Block ' + blk + ' (Wk ' + bwks.join('\u2013') + ')</span><span style="width:36px"></span></header>' +
          '<div style="padding:0 16px">' +
          '<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px"><div style="width:44px;height:44px;border-radius:50%;background:' + (isCurrent ? 'var(--phase-accent)' : isPast ? '#16a34a' : (isPersonalized && !phase2Unlocked) ? '#94a3b8' : '#e2e8f0') + ';color:#fff;display:flex;align-items:center;justify-content:center;font-size:1.125rem;font-weight:700">' + (isPast ? '&#10003;' : (isPersonalized && !phase2Unlocked) ? '&#128274;' : blk) + '</div><div><div style="font-size:1.0625rem;font-weight:700;color:var(--text)">' + milestone + '</div><div style="font-size:0.75rem;color:' + statusColor + ';font-weight:600">' + statusLabel + ' \u00b7 Weeks ' + bwks.join('\u2013') + '</div></div></div>' +
          (blockHasCGM ?
            '<div style="display:flex;align-items:center;gap:6px;margin-bottom:16px;padding:8px 12px;background:#eff6ff;border-radius:8px;border:1px solid #bfdbfe"><span style="font-size:1rem">&#128201;</span><div><div style="font-size:0.8125rem;font-weight:700;color:#2563eb">CGM Active' + (cgmPeriod ? ' \u2014 ' + cgmPeriod.label : '') + '</div><div style="font-size:0.6875rem;color:#3b82f6">' + (cgmPeriod ? cgmPeriod.purpose : 'Wear your sensor this block') + '</div></div></div>' :
            '<div style="display:flex;align-items:center;gap:6px;margin-bottom:16px;padding:8px 12px;background:#f8fafc;border-radius:8px;border:1px solid #e2e8f0"><span style="font-size:1rem">&#128170;</span><div><div style="font-size:0.8125rem;font-weight:600;color:var(--text)">Habit Mode \u2014 No CGM</div><div style="font-size:0.6875rem;color:var(--text-muted)">Focus on building habits using what you learned from your last sensor</div></div></div>');

        html += '<div class="card" style="border-left:4px solid ' + (isPersonalized && !phase2Unlocked ? '#94a3b8' : 'var(--phase-accent)') + '"><h3 style="margin:0 0 6px;font-size:1rem;color:' + (isPersonalized && !phase2Unlocked ? '#94a3b8' : 'var(--phase-accent)') + '">Block ' + blk + ' Goal: ' + goal.title + '</h3><p style="font-size:0.875rem;color:var(--text-muted);margin:0 0 8px;line-height:1.5">' + goal.desc + '</p><div style="display:inline-block;font-size:0.8125rem;font-weight:600;color:' + (isPersonalized && !phase2Unlocked ? '#94a3b8' : 'var(--phase-accent)') + ';background:' + (isPersonalized && !phase2Unlocked ? '#f1f5f9' : 'var(--phase-accent-light)') + ';padding:4px 10px;border-radius:6px">Target: ' + goal.metric + '</div></div>';

        if (isPersonalized && !phase2Unlocked) {
          var w18prog = getWeek1to8EduCompletion(state);
          html += '<div class="card" style="background:#f8fafc;border:2px dashed #cbd5e1;text-align:center;padding:24px 16px">' +
            '<div style="font-size:2.5rem;margin-bottom:12px">&#128274;</div>' +
            '<h3 style="margin:0 0 8px;font-size:1.0625rem;color:var(--text)">Blocks 5\u20138 are locked</h3>' +
            '<p style="font-size:0.875rem;color:var(--text-muted);margin:0 0 16px;line-height:1.5">Complete blocks 1\u20134 and the post-block-4 check-in to unlock your personalized final blocks.</p>' +
            '<div style="text-align:left;background:#fff;border-radius:10px;padding:12px;margin-bottom:12px">' +
            '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><span style="font-size:0.8125rem;font-weight:600">Education progress (Blocks 1\u20134)</span><span style="font-size:0.8125rem;font-weight:600;color:' + (w18prog.pct >= 80 ? '#16a34a' : 'var(--phase-accent)') + '">' + w18prog.pct + '%</span></div>' +
            '<div style="height:6px;background:#e2e8f0;border-radius:3px;overflow:hidden"><div style="height:100%;width:' + w18prog.pct + '%;background:' + (w18prog.pct >= 80 ? '#16a34a' : 'var(--phase-accent)') + ';border-radius:3px"></div></div>' +
            '<div style="font-size:0.6875rem;color:var(--text-muted);margin-top:4px">' + w18prog.done + ' of ' + w18prog.total + ' modules completed</div></div>' +
            '<div style="text-align:left;background:#fff;border-radius:10px;padding:12px">' +
            '<div style="display:flex;align-items:center;gap:6px"><span style="font-size:0.9375rem">' + (state.postWeek8CheckIn ? '&#10003;' : '&#9711;') + '</span><span style="font-size:0.8125rem;color:' + (state.postWeek8CheckIn ? '#16a34a' : 'var(--text-muted)') + '">Post-block-4 check-in</span></div></div>';
          html += '<button type="button" class="btn btn-primary" id="start-checkin" style="margin-top:16px;width:100%">Start your check-in</button>';
          html += '</div>';

        } else if (isPersonalized && phase2Unlocked) {
          var focusLabels = (state.focusAreas || []).map(function(k) {
            var fa = FOCUS_AREA_OPTIONS[k];
            return fa ? fa.title : k;
          }).join(' & ');
          html += '<div class="card" style="background:var(--phase-accent-light);border:1px solid var(--phase-accent)">' +
            '<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px"><span style="font-size:1.25rem">&#127919;</span><h3 style="margin:0;font-size:0.9375rem;font-weight:700;color:var(--phase-accent)">Your Focus: ' + focusLabels + '</h3></div>' +
            '<p style="font-size:0.8125rem;color:var(--text);margin:0;line-height:1.5">These modules are personalized based on your post-block-4 check-in. Keep all your block 1\u20134 habits running \u2014 they are your foundation. These blocks go deeper on your chosen area.</p></div>';
          var weekModIds = getPersonalizedWeekModules(state, wk);
          var weekDone = weekModIds.filter(function(mid) { return isModuleCompleted(state, mid); }).length;
          var weekTotal = weekModIds.length;
          var weekPct = weekTotal > 0 ? Math.round((weekDone / weekTotal) * 100) : 0;
          var goalMet = weekPct >= 80;
          html += '<div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><h3 style="margin:0;font-size:0.9375rem">Education this block</h3><span style="font-size:0.8125rem;font-weight:600;color:' + (goalMet ? '#16a34a' : 'var(--phase-accent)') + '">' + weekDone + '/' + weekTotal + '</span></div>' +
            '<div style="height:6px;background:#e2e8f0;border-radius:3px;overflow:hidden;margin-bottom:4px"><div style="height:100%;width:' + weekPct + '%;background:' + (goalMet ? '#16a34a' : 'var(--phase-accent)') + ';border-radius:3px;transition:width 0.3s"></div></div>' +
            '<div style="display:flex;justify-content:space-between;font-size:0.6875rem;color:var(--text-muted);margin-bottom:12px"><span>' + weekPct + '% complete</span><span>Goal: 80%' + (goalMet ? ' &#10003;' : '') + '</span></div>';
          var bySec = getWeekModulesBySection(wk);
          var secKeys = Object.keys(bySec);
          secKeys.forEach(function(secId) {
            var sec = EDUCATION_SECTIONS[secId];
            var mods = bySec[secId];
            var secDone = mods.filter(function(m) { return isModuleCompleted(state, m.id); }).length;
            html += '<div style="margin-bottom:12px"><div style="display:flex;align-items:center;gap:6px;margin-bottom:6px"><span style="font-size:0.9375rem">' + (secIcons[secId] || '') + '</span><span style="font-size:0.8125rem;font-weight:600;color:var(--text)">' + (sec ? sec.title : secId) + '</span><span style="font-size:0.6875rem;color:var(--text-muted);margin-left:auto">' + secDone + '/' + mods.length + '</span></div>';
            mods.forEach(function(m) {
              var done = isModuleCompleted(state, m.id);
              var tierLabel = m.tier === 'foundation' ? '\ud83d\udfe2' : m.tier === 'intermediate' ? '\ud83d\udfe1' : '\ud83d\udfe3';
              html += '<div class="edu-module-card' + (done ? ' completed' : '') + '" style="margin-left:0"><div class="edu-module-title">' + tierLabel + ' ' + (m.title || '') + '</div><div class="edu-module-desc">' + (m.description || '') + '</div><div class="edu-module-meta"><span class="edu-module-time">' + (done ? 'Completed' : (m.estimatedTime || '')) + '</span><button type="button" class="btn btn-primary edu-module-start" data-module-id="' + (m.id || '') + '">' + (done ? 'Review' : 'Start') + '</button></div></div>';
            });
            html += '</div>';
          });
          html += '</div>';

        } else {
          if (blk === 1) {
            var ciDoneW1 = !!state.week1CheckIn;
            html += '<div class="card" style="border-left:4px solid ' + (ciDoneW1 ? '#16a34a' : 'var(--phase-accent)') + ';padding:16px">' +
              '<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px"><span style="font-size:1.25rem">&#128640;</span><h3 style="margin:0;font-size:0.9375rem;font-weight:700;color:' + (ciDoneW1 ? '#16a34a' : 'var(--phase-accent)') + '">Baseline Assessment</h3></div>' +
              '<p style="font-size:0.8125rem;color:var(--text-muted);margin:0 0 12px;line-height:1.5">You completed your baseline assessment during onboarding. This is used to track your growth throughout the program.</p>' +
              '<div style="display:flex;align-items:center;gap:8px"><span style="color:#16a34a;font-size:1rem">&#10003;</span><span style="font-size:0.8125rem;font-weight:600;color:#16a34a">Completed during onboarding</span>' +
              '<button type="button" class="btn btn-outline start-week-checkin" data-ci-week="1" style="margin-left:auto;font-size:0.75rem;padding:6px 12px">Review</button></div></div>';
          }
          if (blk === 3) {
            var ciState = state.week5CheckIn;
            var ciDone = !!ciState;
            var ciLabel = 'Mid-Program Check-In';
            var ciDesc = 'You\u2019re halfway through the foundation blocks! Assess how you\u2019ve progressed since your baseline and see where to adjust.';
            var ciIcon = '&#128200;';
            html += '<div class="card" style="border-left:4px solid ' + (ciDone ? '#16a34a' : 'var(--phase-accent)') + ';padding:16px">' +
              '<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px"><span style="font-size:1.25rem">' + ciIcon + '</span><h3 style="margin:0;font-size:0.9375rem;font-weight:700;color:' + (ciDone ? '#16a34a' : 'var(--phase-accent)') + '">' + ciLabel + '</h3></div>' +
              '<p style="font-size:0.8125rem;color:var(--text-muted);margin:0 0 12px;line-height:1.5">' + ciDesc + '</p>' +
              (ciDone
                ? '<div style="display:flex;align-items:center;gap:8px"><span style="color:#16a34a;font-size:1rem">&#10003;</span><span style="font-size:0.8125rem;font-weight:600;color:#16a34a">Completed</span><button type="button" class="btn btn-outline start-week-checkin" data-ci-week="5" style="margin-left:auto;font-size:0.75rem;padding:6px 12px">Review</button></div>'
                : '<button type="button" class="btn btn-primary start-week-checkin" data-ci-week="5" style="width:100%">Start check-in</button>') +
              '</div>';
          }
          var weekEdu = pBlockEdu(blk);
          var weekModIds2 = weekEdu ? weekEdu.modules : [];
          var weekDone2 = weekModIds2.filter(function(mid) { return isModuleCompleted(state, mid); }).length;
          var weekTotal2 = weekModIds2.length;
          var weekPct2 = weekTotal2 > 0 ? Math.round((weekDone2 / weekTotal2) * 100) : 0;
          var goalMet2 = weekPct2 >= 80;
          var bySec2 = getWeekModulesBySection(wk);
          html += '<div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><h3 style="margin:0;font-size:0.9375rem">Education this block</h3><span style="font-size:0.8125rem;font-weight:600;color:' + (goalMet2 ? '#16a34a' : 'var(--phase-accent)') + '">' + weekDone2 + '/' + weekTotal2 + '</span></div>' +
            '<div style="height:6px;background:#e2e8f0;border-radius:3px;overflow:hidden;margin-bottom:4px"><div style="height:100%;width:' + weekPct2 + '%;background:' + (goalMet2 ? '#16a34a' : 'var(--phase-accent)') + ';border-radius:3px;transition:width 0.3s"></div></div>' +
            '<div style="display:flex;justify-content:space-between;font-size:0.6875rem;color:var(--text-muted);margin-bottom:12px"><span>' + weekPct2 + '% complete</span><span>Goal: 80%' + (goalMet2 ? ' &#10003;' : '') + '</span></div>';
          var secKeys2 = Object.keys(bySec2);
          secKeys2.forEach(function(secId) {
            var sec = EDUCATION_SECTIONS[secId];
            var mods = bySec2[secId];
            var secDone = mods.filter(function(m) { return isModuleCompleted(state, m.id); }).length;
            html += '<div style="margin-bottom:12px"><div style="display:flex;align-items:center;gap:6px;margin-bottom:6px"><span style="font-size:0.9375rem">' + (secIcons[secId] || '') + '</span><span style="font-size:0.8125rem;font-weight:600;color:var(--text)">' + (sec ? sec.title : secId) + '</span><span style="font-size:0.6875rem;color:var(--text-muted);margin-left:auto">' + secDone + '/' + mods.length + '</span></div>';
            mods.forEach(function(m) {
              var done = isModuleCompleted(state, m.id);
              var tierLabel = m.tier === 'foundation' ? '\ud83d\udfe2' : m.tier === 'intermediate' ? '\ud83d\udfe1' : '\ud83d\udfe3';
              html += '<div class="edu-module-card' + (done ? ' completed' : '') + '" style="margin-left:0"><div class="edu-module-title">' + tierLabel + ' ' + (m.title || '') + '</div><div class="edu-module-desc">' + (m.description || '') + '</div><div class="edu-module-meta"><span class="edu-module-time">' + (done ? 'Completed' : (m.estimatedTime || '')) + '</span><button type="button" class="btn btn-primary edu-module-start" data-module-id="' + (m.id || '') + '">' + (done ? 'Review' : 'Start') + '</button></div></div>';
            });
            html += '</div>';
          });
          html += '</div>';
        }

        var prevBlk = blk > 1 ? blockToWeeks(blk - 1)[0] : null;
        var nextBlk = blk < TOTAL_BLOCKS ? blockToWeeks(blk + 1)[0] : null;
        html += '<div style="display:flex;gap:8px;padding:0 0 24px">' +
          (prevBlk ? '<button type="button" class="btn btn-outline" id="wk-prev" style="flex:1">&laquo; Block ' + (blk - 1) + '</button>' : '<div style="flex:1"></div>') +
          (nextBlk ? '<button type="button" class="btn btn-outline" id="wk-next" style="flex:1">Block ' + (blk + 1) + ' &raquo;</button>' : '<div style="flex:1"></div>') +
          '</div></div>';
        div.innerHTML = html;
        div.querySelector('#week-back').onclick = function() { navigateBack(); };
        if (div.querySelector('#wk-prev')) div.querySelector('#wk-prev').onclick = function() { openWeekNumber = prevBlk; render(); };
        if (div.querySelector('#wk-next')) div.querySelector('#wk-next').onclick = function() { openWeekNumber = nextBlk; render(); };
        if (div.querySelector('#start-checkin')) div.querySelector('#start-checkin').onclick = function() { checkinWeek = 9; post8Step = 0; post8Answers = {}; navigateTo('post8_checkin'); };
        div.querySelectorAll('.start-week-checkin').forEach(function(btn) {
          btn.onclick = function() {
            var ciW = parseInt(btn.getAttribute('data-ci-week'));
            checkinWeek = ciW;
            post8Step = 0;
            var prev = ciW === 1 ? state.week1CheckIn : ciW === 5 ? state.week5CheckIn : state.postWeek8CheckIn;
            post8Answers = (prev && prev.answers) ? JSON.parse(JSON.stringify(prev.answers)) : {};
            navigateTo('post8_checkin');
          };
        });
        div.querySelectorAll('.edu-module-start').forEach(function(btn) {
          btn.onclick = function() {
            openEducationModuleId = btn.getAttribute('data-module-id');
            navigateTo('education_module');
          };
        });
        container.appendChild(div);
      }

      var post8Step = 0;
      var post8Answers = {};
      var checkinWeek = 9;
      var POST8_QUESTIONS = [
        { id: 'q_protein', text: 'I consistently eat protein at every meal.', area: 'nutrition', icon: '&#127860;',
          feedback: {
            low: 'You\'re still building the protein habit. That\'s okay \u2014 it takes time. Your data shows your meals averaged about 18g protein, which is below the 25g target. Focus on "protein first" at your next meal: eat the protein on your plate before anything else. Even small increases make a real difference for muscle preservation and fullness.',
            mid: 'You\'re getting protein most meals but not consistently. Your average was around 22g/meal \u2014 close! The meals where you hit 25g+ correlated with 40% better satiety scores and more stable glucose in the 2 hours after eating. Try prepping protein sources on Sundays so they\'re always ready.',
            high: 'Strong work. You\'ve anchored protein at nearly every meal, averaging 28g per meal. Your Lifestyle GPA component for nutrition improved 0.6 points since week 2. This habit is locked in \u2014 keep it as your non-negotiable foundation.'
          }},
        { id: 'q_walking', text: 'I walk after meals most days.', area: 'exercise', icon: '&#127939;',
          feedback: {
            low: 'Post-meal walking hasn\'t clicked yet. Your step data shows an average of 4,200 steps/day, and most walking happened in the morning rather than after meals. Even a 5-minute walk after dinner makes a measurable difference \u2014 your CGM data shows meals followed by walking had 25% lower glucose peaks. Start with just one meal per day.',
            mid: 'You\'re walking after some meals. Your data shows about 3-4 post-meal walks per week, with an average of 6,100 steps/day. On days you walked after dinner, your overnight glucose was 12 mg/dL lower on average. Try setting a "shoes on" reminder right after your biggest meal.',
            high: 'Excellent. Post-meal walking is a clear habit for you. Your average daily steps are 8,400, and most of them come at the right times. Your post-meal glucose peaks are consistently 20-30% lower than expected. This is one of your strongest habits.'
          }},
        { id: 'q_hunger', text: 'I can tell the difference between physical hunger and emotional hunger.', area: 'hunger', icon: '&#129368;',
          feedback: {
            low: 'Distinguishing hunger types is one of the harder skills, especially on medication when signals are muted. You completed hunger check-ins about 35% of days. The check-ins you did complete showed most ratings at 1-2 (low hunger), which suggests you may be eating on schedule rather than in response to signals. That\'s fine for now \u2014 as medication changes, this awareness becomes critical.',
            mid: 'You\'re developing hunger awareness. Your check-ins show you can identify a level 3 ("ready to eat") most of the time. Your data suggests evening snacking patterns that may be more emotional than physical \u2014 glucose stays flat during these episodes, meaning your body wasn\'t actually needing fuel. The HALT technique (Hungry, Angry, Lonely, Tired?) can help.',
            high: 'Strong hunger awareness. Your check-in data shows consistent ability to eat at level 2-3 and stop at level 3 fullness. Your hunger-to-eating patterns align well with physical cues, and your satiety scores improved steadily over the 8 weeks.'
          }},
        { id: 'q_sleep', text: 'I go to bed at a consistent time most nights.', area: 'sleep_stress', icon: '&#128164;',
          feedback: {
            low: 'Sleep consistency needs attention. Your bedtime varied by more than 90 minutes across the week. Research shows that inconsistent sleep raises ghrelin (hunger hormone) by 15-20% and increases next-day glucose by 10-15 mg/dL. Even setting a "wind down" alarm 30 minutes before target bedtime helps. This is high-leverage \u2014 fixing sleep improves everything else.',
            mid: 'You\'re mostly consistent but weekends are throwing you off. Your weekday bedtime varies by about 30 minutes (good), but weekends shift by 90+ minutes. This "social jet lag" disrupts your circadian rhythm and hunger hormones for 1-2 days afterward. Try keeping weekend bedtime within 45 minutes of your weekday schedule.',
            high: 'Excellent sleep consistency. Your bedtime varies by less than 25 minutes most nights. This stability supports your hunger hormones, glucose regulation, and recovery. On your most consistent sleep weeks, your Glucose GPA was 0.4 points higher on average.'
          }},
        { id: 'q_glucose', text: 'I understand what makes my glucose spike and how to manage it.', area: 'glucose', icon: '&#128200;',
          feedback: {
            low: 'Your Glucose GPA has been around 2.8/5 with high variability. Your CGM data shows frequent spikes above 160 mg/dL, especially after lunch and dinner. The good news: there\'s a clear pattern. Meals with protein + fiber had 40% lower spikes than carb-heavy meals. This is learnable \u2014 the CGM is showing you exactly what to change.',
            mid: 'You\'re learning your patterns. Your Glucose GPA improved from 2.9 to 3.4 over 8 weeks \u2014 real progress. Your biggest remaining spikes happen with refined carbs eaten alone (afternoon snacks, quick breakfasts). Pairing these with protein or fat would bring your GPA above 3.5 consistently.',
            high: 'You have strong glucose awareness. Your GPA is 3.8+ and improving. You\'ve learned your trigger foods and consistently pair carbs with protein. Your post-meal spikes rarely exceed 140 mg/dL and recover quickly. Your CGM knowledge is one of your biggest assets.'
          }},
        { id: 'q_stress', text: 'I have at least one stress management tool I use regularly.', area: 'sleep_stress', icon: '&#129504;',
          feedback: {
            low: 'Stress management is a gap. Your data shows glucose variability increases by 30% on high-stress days (identified by higher fasting glucose and wider intraday swings). Without a regular stress tool, cortisol stays elevated and makes every other habit harder. Even 2 minutes of deep breathing after a stressful moment can reduce cortisol by 15%. Pick one tool and practice it this week.',
            mid: 'You have a stress tool but use it inconsistently. On days when your glucose variability was highest, you didn\'t log any stress management activity. Building it into a daily routine (e.g., 5 minutes of breathing before bed) makes it automatic rather than something you have to remember during a stressful moment.',
            high: 'You\'ve integrated stress management well. Your glucose variability on high-stress days is only 10% higher than baseline, compared to 30%+ for most users. Whatever you\'re doing \u2014 keep doing it. This resilience will be even more valuable post-medication.'
          }},
        { id: 'q_satiety', text: 'I usually stop eating when satisfied, not stuffed.', area: 'hunger', icon: '&#127860;',
          feedback: {
            low: 'Stopping at "satisfied" is tough, especially when hunger signals are muted by medication. Your fullness check-ins averaged 4.2/5 \u2014 consistently past the ideal of 3. This matters because habitually eating to fullness now creates a pattern that\'s harder to break when appetite returns. Try the halfway pause: stop eating halfway through your meal and wait 2 minutes. Ask yourself "am I at a 3?"',
            mid: 'You\'re getting better at finding the "satisfied" point. Your fullness ratings moved from an average of 4.1 to 3.6 over 8 weeks \u2014 progress in the right direction. Eating speed is likely a factor: meals eaten in under 10 minutes correlated with higher fullness ratings. Slow down, and you\'ll hit the target more consistently.',
            high: 'You\'ve developed strong satiety awareness. Your average fullness rating is 3.1 \u2014 right at the "satisfied, not stuffed" sweet spot. This skill is rare and incredibly valuable for long-term maintenance. You naturally calibrate portions without needing to count or measure.'
          }},
        { id: 'q_weight', text: 'I understand what maintenance weight is and I\u2019m not afraid of normal fluctuations.', area: 'weight', icon: '&#9878;',
          feedback: {
            low: 'The scale still causes anxiety. That\'s common and understandable. Your weight data shows normal daily fluctuations of 2-3 lbs, which is entirely water, food timing, and digestion \u2014 not fat. Your maintenance band is set at \u00b15% of your anchor weight, and you\'re currently well within it. Try shifting to weekly weigh-ins instead of daily to reduce noise.',
            mid: 'You understand the maintenance band concept but still react to daily changes. Your data shows check-in patterns that spike on days after the scale goes up. Remember: a 2 lb increase overnight is almost never fat \u2014 it takes a 7,000 calorie surplus to gain 2 lbs of actual body mass. Focus on the 4-week trend line.',
            high: 'You have a healthy relationship with the scale. Your weigh-in patterns are consistent without being obsessive, and your emotional responses to fluctuations seem stable. You understand that maintenance is a range, not a number. This mindset is one of the strongest predictors of long-term success.'
          }}
      ];
      function renderPost8CheckIn(container) {
        var div = document.createElement('div');
        div.className = 'screen active';
        var insights = getSignosInsights(state);
        var focusKeys = Object.keys(FOCUS_AREA_OPTIONS);

        var ciTitle = checkinWeek === 1 ? 'Baseline Check-In' : checkinWeek === 5 ? 'Mid-Program Check-In' : 'Post-Block 4 Check-In';
        var ciEmoji = checkinWeek === 1 ? '&#128640;' : checkinWeek === 5 ? '&#128200;' : '&#127881;';
        var ciHeading = checkinWeek === 1 ? 'Your Starting Point' : checkinWeek === 5 ? 'Your Mid-Program Report' : 'Your Foundation Progress Report';
        var ciSubhead = checkinWeek === 1 ? 'Let\u2019s establish your baseline. This snapshot captures where you are today so we can measure your progress.' : checkinWeek === 5 ? 'You\u2019re halfway through the foundation. Here\u2019s what the data shows so far \u2014 and where to adjust.' : 'Here\u2019s what we\u2019ve learned about your body and habits over the first 4 blocks.';
        var ciAssessHead = checkinWeek === 1 ? 'How confident do you feel about each area right now?' : checkinWeek === 5 ? 'How are you progressing in each area?' : 'How do you feel about each area?';
        var ciAssessSub = checkinWeek === 1 ? 'Be honest \u2014 there are no wrong answers. This sets your baseline.' : checkinWeek === 5 ? 'Compare to how you felt at block 1. This helps guide the rest of your foundation.' : 'Be honest \u2014 this personalizes your final 4 blocks.';
        var ciFbHeading = checkinWeek === 1 ? 'Your Baseline Profile' : checkinWeek === 5 ? 'Mid-Program Feedback' : 'Personalized Feedback';
        var ciFbSub = checkinWeek === 1 ? 'Here\u2019s where you\u2019re starting from. We\u2019ll use this to track your growth.' : checkinWeek === 5 ? 'Here\u2019s how you\u2019ve progressed since block 1 \u2014 and where to focus next.' : 'Here\u2019s how you did on each area \u2014 and what to focus on next.';
        var ciNextLabel = checkinWeek === 1 ? 'See your baseline profile \u2192' : checkinWeek === 5 ? 'See your mid-program feedback \u2192' : 'See your personalized feedback \u2192';
        var ciFinishLabel = checkinWeek === 1 ? 'Save baseline & continue' : checkinWeek === 5 ? 'Save progress & continue' : 'Choose your focus \u2192';
        var ciNumbersTitle = checkinWeek === 1 ? 'Your Starting Numbers' : checkinWeek === 5 ? 'Your Numbers So Far' : 'Your Numbers';
        var ciNoticeTitle = checkinWeek === 1 ? 'What we\u2019ll be tracking' : checkinWeek === 5 ? 'What Signos noticed (so far)' : 'What Signos noticed';
        var ciNoticeDesc = checkinWeek === 1 ? 'Here\u2019s what we\u2019ll monitor over your 16-week program:' : checkinWeek === 5 ? 'Based on your scores and data from blocks 1\u20132:' : 'Based on your scores and data from blocks 1\u20134:';

        if (post8Step === 0) {
          var glucoseGPA = getGlucoseGPA(state);
          var lifestyleGPA = getLifestyleGPA(state);
          var consistency = getConsistencyScore(state);
          var hungerEntries = state.hungerEntries || {};
          var hungerDays = Object.keys(hungerEntries).length;
          var mockData = {
            avgSteps: 5800 + Math.round(Math.random() * 3000),
            avgProtein: 19 + Math.round(Math.random() * 12),
            postMealWalks: 2 + Math.round(Math.random() * 4),
            avgSleep: (6.2 + Math.random() * 1.5).toFixed(1),
            mealsWith3Components: Math.round(40 + Math.random() * 45),
            glucoseDaysInRange: Math.round(55 + Math.random() * 35),
            hungerCheckinRate: Math.round(30 + Math.random() * 60),
            avgPostMealSpike: Math.round(125 + Math.random() * 45)
          };
          var html = '<header class="page-header"><button type="button" class="header-btn back-btn" id="p8-back" aria-label="Back">&#8249;</button><span class="header-title">' + ciTitle + '</span><span style="width:36px"></span></header>' +
            '<div style="padding:0 16px">' +
            '<div style="text-align:center;margin-bottom:20px"><div style="font-size:3rem;margin-bottom:8px">' + ciEmoji + '</div><h2 style="margin:0 0 8px;font-size:1.25rem">' + ciHeading + '</h2><p style="font-size:0.875rem;color:var(--text-muted);margin:0;line-height:1.5">' + ciSubhead + '</p></div>' +
            '<div class="card" style="padding:14px 16px"><h3 style="margin:0 0 12px;font-size:0.9375rem;color:var(--phase-accent)">' + ciNumbersTitle + '</h3>' +
            '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">' +
            '<div style="background:#f8fafc;border-radius:10px;padding:10px;text-align:center"><div style="font-size:1.375rem;font-weight:800;color:var(--phase-accent)">' + glucoseGPA.score15 + '</div><div style="font-size:0.6875rem;color:var(--text-muted)">Glucose GPA</div></div>' +
            '<div style="background:#f8fafc;border-radius:10px;padding:10px;text-align:center"><div style="font-size:1.375rem;font-weight:800;color:var(--phase-accent)">' + lifestyleGPA.score15 + '</div><div style="font-size:0.6875rem;color:var(--text-muted)">Lifestyle GPA</div></div>' +
            '<div style="background:#f8fafc;border-radius:10px;padding:10px;text-align:center"><div style="font-size:1.375rem;font-weight:800;color:var(--phase-accent)">' + mockData.avgSteps.toLocaleString() + '</div><div style="font-size:0.6875rem;color:var(--text-muted)">Avg daily steps</div></div>' +
            '<div style="background:#f8fafc;border-radius:10px;padding:10px;text-align:center"><div style="font-size:1.375rem;font-weight:800;color:var(--phase-accent)">' + mockData.avgProtein + 'g</div><div style="font-size:0.6875rem;color:var(--text-muted)">Avg protein/meal</div></div>' +
            '<div style="background:#f8fafc;border-radius:10px;padding:10px;text-align:center"><div style="font-size:1.375rem;font-weight:800;color:var(--phase-accent)">' + mockData.avgSleep + 'h</div><div style="font-size:0.6875rem;color:var(--text-muted)">Avg sleep</div></div>' +
            '<div style="background:#f8fafc;border-radius:10px;padding:10px;text-align:center"><div style="font-size:1.375rem;font-weight:800;color:var(--phase-accent)">' + mockData.hungerCheckinRate + '%</div><div style="font-size:0.6875rem;color:var(--text-muted)">Hunger check-in rate</div></div>' +
            '</div></div>' +
            '<div class="card" style="border-left:4px solid var(--phase-accent)"><h3 style="margin:0 0 10px;font-size:0.9375rem;color:var(--phase-accent)">' + ciNoticeTitle + '</h3><p style="font-size:0.8125rem;color:var(--text-muted);margin:0 0 12px">' + ciNoticeDesc + '</p>';
          var mockInsights;
          if (checkinWeek === 1) {
            mockInsights = [
              { icon: '&#128200;', label: 'Glucose patterns', detail: 'We\u2019ll track your post-meal spikes, time in range, and variability. Your starting Glucose GPA is ' + glucoseGPA.score15 + '/5. Over the next few weeks, you\u2019ll learn what spikes your glucose and how to manage it.' },
              { icon: '&#127860;', label: 'Nutrition habits', detail: 'We\u2019ll monitor meal composition, protein intake, and fiber. Right now, we\u2019re establishing your eating patterns to build on in week 2.' },
              { icon: '&#127939;', label: 'Activity & movement', detail: 'We\u2019re tracking daily steps and post-meal walks. Your current average is ' + mockData.avgSteps.toLocaleString() + ' steps/day. Week 3 will focus on building a walking habit.' },
              { icon: '&#129368;', label: 'Hunger & satiety', detail: 'Your hunger check-ins will be key. As your medication changes, understanding your body\u2019s signals becomes critical. This is your baseline awareness.' },
              { icon: '&#128164;', label: 'Sleep & recovery', detail: 'We\u2019ll monitor sleep duration and consistency. Your current average is ' + mockData.avgSleep + ' hours. Week 8 will deep-dive on sleep optimization.' },
              { icon: '&#129504;', label: 'Stress & recovery', detail: 'Stress impacts glucose, hunger, and recovery. We\u2019ll track patterns between stressful days and glucose variability over the program.' }
            ];
          } else if (checkinWeek === 5) {
            mockInsights = [
              { icon: '&#128200;', label: 'Glucose patterns', detail: 'Your post-meal spikes averaged ' + mockData.avgPostMealSpike + ' mg/dL. Since baseline, your Glucose GPA moved from ' + (glucoseGPA.score15 - 0.3).toFixed(1) + ' to ' + glucoseGPA.score15 + '. Meals with protein + fiber spiked 35% less than carb-only meals.' },
              { icon: '&#127860;', label: 'Nutrition progress', detail: mockData.mealsWith3Components + '% of meals had all 3 components. Your protein intake averaged ' + mockData.avgProtein + 'g/meal. ' + (mockData.avgProtein >= 25 ? 'You\u2019re hitting the target \u2014 great work.' : 'You\u2019re close but not yet consistent \u2014 the next 3 weeks can solidify this.') },
              { icon: '&#127939;', label: 'Activity & movement', detail: 'You averaged ' + mockData.avgSteps.toLocaleString() + ' daily steps and ' + mockData.postMealWalks + ' post-meal walks per week. ' + (mockData.avgSteps >= 7000 ? 'Strong activity level.' : 'Adding post-meal walks is the highest-leverage change right now.') },
              { icon: '&#129368;', label: 'Hunger & satiety', detail: 'You logged hunger check-ins ' + mockData.hungerCheckinRate + '% of days. Your hunger awareness is ' + (mockData.hungerCheckinRate >= 60 ? 'building well.' : 'still developing \u2014 more frequent check-ins will accelerate this.') },
              { icon: '&#128164;', label: 'Sleep impact', detail: 'You averaged ' + mockData.avgSleep + ' hours of sleep. ' + (parseFloat(mockData.avgSleep) >= 7 ? 'Your sleep is solid \u2014 this supports everything else.' : 'On nights under 6.5 hours, your next-day glucose variability increased by 22%.') },
              { icon: '&#129504;', label: 'Stress & recovery', detail: 'Consistency score: ' + Math.round(consistency) + '/100. ' + (consistency >= 70 ? 'You\u2019re building reliable habits.' : 'Day-to-day consistency is where the biggest gains are. Focus on doing the basics every day, not perfectly.') }
            ];
          } else {
            mockInsights = [
              { icon: '&#128200;', label: 'Glucose patterns', detail: 'Your post-meal spikes averaged ' + mockData.avgPostMealSpike + ' mg/dL. Meals paired with protein + fiber spiked 35\u201340% less than carb-only meals. Your best glucose days were when you walked after eating.' },
              { icon: '&#127860;', label: 'Nutrition consistency', detail: mockData.mealsWith3Components + '% of your meals had all 3 components (protein + fiber + carb). Meals that hit all 3 kept you satisfied 1.5 hours longer on average.' },
              { icon: '&#127939;', label: 'Activity & movement', detail: 'You averaged ' + mockData.avgSteps.toLocaleString() + ' daily steps and ' + mockData.postMealWalks + ' post-meal walks per week. On your most active days, overnight glucose was 8\u201312 mg/dL lower.' },
              { icon: '&#129368;', label: 'Hunger & satiety', detail: 'You logged hunger check-ins ' + mockData.hungerCheckinRate + '% of days. Your average hunger rating was 2.4/5 (slightly hungry) and average fullness was 3.6/5 (just past satisfied).' },
              { icon: '&#128164;', label: 'Sleep impact', detail: 'You averaged ' + mockData.avgSleep + ' hours of sleep. On nights under 6.5 hours, your next-day glucose variability increased by 22% and hunger ratings jumped 0.8 points.' },
              { icon: '&#129504;', label: 'Stress & recovery', detail: 'Your highest-glucose days correlated with poor sleep and no logged stress management. Consistency score: ' + Math.round(consistency) + '/100 \u2014 ' + (consistency >= 70 ? 'solid and improving.' : consistency >= 50 ? 'room to improve day-to-day consistency.' : 'this is an area with significant opportunity.') }
            ];
          }
          mockInsights.forEach(function(ins) {
            html += '<div style="display:flex;align-items:flex-start;gap:8px;margin-bottom:10px;padding:10px;background:#f8fafc;border-radius:8px"><span style="font-size:1.125rem;flex-shrink:0">' + ins.icon + '</span><div><div style="font-size:0.8125rem;font-weight:600;color:var(--text)">' + ins.label + '</div><div style="font-size:0.75rem;color:var(--text-muted);margin-top:3px;line-height:1.5">' + ins.detail + '</div></div></div>';
          });
          html += '</div>' +
            '<button type="button" class="btn btn-primary" id="p8-next" style="width:100%;margin-bottom:24px">Next: Self-assessment \u2192</button></div>';
          div.innerHTML = html;
          div.querySelector('#p8-back').onclick = function() { navigateBack(); };
          div.querySelector('#p8-next').onclick = function() { post8Step = 1; render(); };

        } else if (post8Step === 1) {
          var html = '<header class="page-header"><button type="button" class="header-btn back-btn" id="p8-back" aria-label="Back">&#8249;</button><span class="header-title">Self-Assessment</span><span style="width:36px"></span></header>' +
            '<div style="padding:0 16px">' +
            '<div style="display:flex;align-items:center;gap:8px;margin-bottom:16px"><div style="font-size:1.5rem">&#128221;</div><div><p style="margin:0;font-size:0.9375rem;font-weight:600;color:var(--text)">' + ciAssessHead + '</p><p style="font-size:0.75rem;color:var(--text-muted);margin:2px 0 0">' + ciAssessSub + '</p></div></div>';
          POST8_QUESTIONS.forEach(function(q) {
            var val = post8Answers[q.id] || 0;
            html += '<div class="card" style="padding:12px 14px;margin-bottom:8px"><div style="display:flex;align-items:center;gap:6px;margin-bottom:8px"><span style="font-size:0.9375rem">' + q.icon + '</span><p style="margin:0;font-size:0.8125rem;font-weight:600;color:var(--text)">' + q.text + '</p></div>' +
              '<div style="display:flex;justify-content:space-between;gap:4px">';
            var labels = ['Not at all', 'A little', 'Sometimes', 'Usually', 'Always'];
            for (var r = 1; r <= 5; r++) {
              html += '<button type="button" class="p8-rating" data-qid="' + q.id + '" data-val="' + r + '" style="flex:1;padding:8px 2px;border-radius:8px;border:2px solid ' + (val === r ? 'var(--phase-accent)' : '#e2e8f0') + ';background:' + (val === r ? 'var(--phase-accent-light)' : '#fff') + ';font-size:0.625rem;color:' + (val === r ? 'var(--phase-accent)' : 'var(--text-muted)') + ';cursor:pointer;font-weight:' + (val === r ? '700' : '400') + '">' + r + '<br>' + labels[r - 1] + '</button>';
            }
            html += '</div></div>';
          });
          var allAnswered = POST8_QUESTIONS.every(function(q) { return post8Answers[q.id] && post8Answers[q.id] > 0; });
          html += '<button type="button" class="btn btn-primary" id="p8-next2" style="width:100%;margin:8px 0 24px;' + (allAnswered ? '' : 'opacity:0.5') + '">' + ciNextLabel + '</button></div>';
          div.innerHTML = html;
          div.querySelector('#p8-back').onclick = function() { post8Step = 0; render(); };
          div.querySelectorAll('.p8-rating').forEach(function(btn) {
            btn.onclick = function() {
              post8Answers[btn.getAttribute('data-qid')] = parseInt(btn.getAttribute('data-val'));
              render();
            };
          });
          div.querySelector('#p8-next2').onclick = function() {
            if (!allAnswered) return;
            var areaScores = {};
            POST8_QUESTIONS.forEach(function(q) {
              if (!areaScores[q.area]) areaScores[q.area] = { sum: 0, count: 0 };
              areaScores[q.area].sum += (post8Answers[q.id] || 3);
              areaScores[q.area].count++;
            });
            var ranked = Object.keys(areaScores).map(function(k) { return { area: k, avg: areaScores[k].sum / areaScores[k].count }; });
            ranked.sort(function(a, b) { return a.avg - b.avg; });
            post8Answers._ranked = ranked;
            post8Step = 2;
            render();
          };

        } else if (post8Step === 2) {
          var html = '<header class="page-header"><button type="button" class="header-btn back-btn" id="p8-back" aria-label="Back">&#8249;</button><span class="header-title">Your Feedback</span><span style="width:36px"></span></header>' +
            '<div style="padding:0 16px">' +
            '<div style="text-align:center;margin-bottom:16px"><div style="font-size:2rem;margin-bottom:4px">&#128202;</div><h2 style="margin:0 0 6px;font-size:1.125rem">' + ciFbHeading + '</h2><p style="font-size:0.8125rem;color:var(--text-muted);margin:0">' + ciFbSub + '</p></div>';
          POST8_QUESTIONS.forEach(function(q) {
            var val = post8Answers[q.id] || 3;
            var fb = val <= 2 ? q.feedback.low : val <= 3 ? q.feedback.mid : q.feedback.high;
            var barColor = val <= 2 ? '#ef4444' : val <= 3 ? '#eab308' : '#22c55e';
            var ratingLabel = ['', 'Not at all', 'A little', 'Sometimes', 'Usually', 'Always'][val];
            html += '<div class="card" style="padding:14px 16px;margin-bottom:10px">' +
              '<div style="display:flex;align-items:center;gap:6px;margin-bottom:6px"><span style="font-size:1rem">' + q.icon + '</span><span style="font-size:0.8125rem;font-weight:700;color:var(--text)">' + q.text + '</span></div>' +
              '<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px"><div style="flex:1;height:6px;background:#e2e8f0;border-radius:3px;overflow:hidden"><div style="height:100%;width:' + (val * 20) + '%;background:' + barColor + ';border-radius:3px"></div></div><span style="font-size:0.6875rem;font-weight:600;color:' + barColor + '">' + val + '/5 \u2014 ' + ratingLabel + '</span></div>' +
              '<p style="font-size:0.8125rem;color:var(--text);margin:0;line-height:1.55;background:#f8fafc;border-radius:8px;padding:10px 12px">' + fb + '</p></div>';
          });
          var ranked = post8Answers._ranked || [];
          if (ranked.length > 0) {
            html += '<div class="card" style="background:var(--phase-accent-light);border:1px solid var(--phase-accent);margin-top:4px"><h3 style="margin:0 0 8px;font-size:0.9375rem;color:var(--phase-accent)">Summary</h3>';
            html += '<div style="margin-bottom:8px">';
            ranked.forEach(function(r) {
              var fa = FOCUS_AREA_OPTIONS[r.area];
              var label = fa ? fa.title : r.area;
              var pct = Math.round((r.avg / 5) * 100);
              var col = r.avg <= 2.5 ? '#ef4444' : r.avg <= 3.5 ? '#eab308' : '#22c55e';
              html += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px"><span style="font-size:0.75rem;width:100px;flex-shrink:0;color:var(--text)">' + label + '</span><div style="flex:1;height:6px;background:#e2e8f0;border-radius:3px;overflow:hidden"><div style="height:100%;width:' + pct + '%;background:' + col + ';border-radius:3px"></div></div><span style="font-size:0.6875rem;font-weight:600;color:' + col + ';width:28px;text-align:right">' + r.avg.toFixed(1) + '</span></div>';
            });
            html += '</div>';
            var weakAreas = ranked.slice(0, 2).map(function(r) { var fa = FOCUS_AREA_OPTIONS[r.area]; return fa ? fa.title : r.area; }).join('</strong> and <strong>');
            var summaryText = checkinWeek === 1
              ? 'Your starting gaps are <strong>' + weakAreas + '</strong>. These are areas the program will help you build over the coming weeks.'
              : checkinWeek === 5
              ? 'Your biggest opportunities are still <strong>' + weakAreas + '</strong>. Focus your effort here for the next 3 weeks.'
              : 'Your weakest areas are <strong>' + weakAreas + '</strong>. We recommend focusing your final 4 blocks here.';
            html += '<p style="font-size:0.8125rem;color:var(--text);margin:0">' + summaryText + '</p></div>';
          }
          html += '<button type="button" class="btn btn-primary" id="p8-next3" style="width:100%;margin:12px 0 24px">' + ciFinishLabel + '</button></div>';
          div.innerHTML = html;
          div.querySelector('#p8-back').onclick = function() { post8Step = 1; render(); };
          div.querySelector('#p8-next3').onclick = function() {
            if (checkinWeek === 1) {
              state.week1CheckIn = { completedAt: new Date().toISOString(), answers: JSON.parse(JSON.stringify(post8Answers)) };
              saveState(state);
              post8Step = 0; post8Answers = {};
              navigateBack();
            } else if (checkinWeek === 5) {
              state.week5CheckIn = { completedAt: new Date().toISOString(), answers: JSON.parse(JSON.stringify(post8Answers)) };
              saveState(state);
              post8Step = 0; post8Answers = {};
              navigateBack();
            } else {
              post8Step = 3; render();
            }
          };

        } else if (post8Step === 3) {
          var ranked = post8Answers._ranked || [];
          var suggested = ranked.length > 0 ? ranked.slice(0, 2).map(function(r) { return r.area; }) : ['nutrition'];
          var selectedAreas = state.focusAreas && state.focusAreas.length > 0 ? state.focusAreas.slice() : [];
          var html = '<header class="page-header"><button type="button" class="header-btn back-btn" id="p8-back" aria-label="Back">&#8249;</button><span class="header-title">Choose Your Focus</span><span style="width:36px"></span></header>' +
            '<div style="padding:0 16px">' +
            '<p style="font-size:0.875rem;color:var(--text-muted);margin:0 0 8px;line-height:1.5">Choose <strong>1 or 2 topics</strong> to deep-dive on for your final 4 blocks. You\u2019ll keep all habits from blocks 1\u20134 as your foundation.</p>';
          if (ranked.length > 0) {
            html += '<div class="card" style="background:#fefce8;border:1px solid #fef08a;margin-bottom:12px"><div style="display:flex;align-items:center;gap:6px"><span style="font-size:1rem">&#128161;</span><div><div style="font-size:0.8125rem;font-weight:600;color:#a16207">Signos recommends</div><p style="font-size:0.75rem;color:var(--text-muted);margin:2px 0 0">Your lowest scores were in <strong>' + ranked.slice(0, 2).map(function(r) { var fa = FOCUS_AREA_OPTIONS[r.area]; return fa ? fa.title : r.area; }).join('</strong> and <strong>') + '</strong>. Focusing here will have the biggest impact on your graduation readiness.</p></div></div></div>';
          }
          focusKeys.forEach(function(key) {
            var fa = FOCUS_AREA_OPTIONS[key];
            var isSelected = selectedAreas.indexOf(key) >= 0;
            var isSuggested = suggested.indexOf(key) >= 0;
            html += '<div class="card focus-option" data-focus="' + key + '" style="padding:12px 14px;margin-bottom:8px;cursor:pointer;border:2px solid ' + (isSelected ? 'var(--phase-accent)' : isSuggested ? '#fbbf24' : '#e2e8f0') + ';background:' + (isSelected ? 'var(--phase-accent-light)' : '#fff') + ';transition:all 0.15s">' +
              '<div style="display:flex;align-items:center;gap:8px"><span style="font-size:1.25rem">' + fa.icon + '</span><div style="flex:1"><div style="font-size:0.875rem;font-weight:700;color:var(--text)">' + fa.title + (isSuggested ? ' <span style="font-size:0.625rem;background:#fef08a;color:#a16207;padding:2px 6px;border-radius:4px;font-weight:600">Recommended</span>' : '') + '</div><div style="font-size:0.75rem;color:var(--text-muted);margin-top:2px">' + fa.desc + '</div><div style="font-size:0.6875rem;color:var(--text-muted);margin-top:4px">' + fa.modules.length + ' advanced modules</div></div>' +
              '<div style="width:26px;height:26px;border-radius:50%;border:2px solid ' + (isSelected ? 'var(--phase-accent)' : '#cbd5e1') + ';display:flex;align-items:center;justify-content:center;flex-shrink:0;background:' + (isSelected ? 'var(--phase-accent)' : '#fff') + ';color:#fff;font-size:0.75rem;transition:all 0.15s">' + (isSelected ? '&#10003;' : '') + '</div></div></div>';
          });
          html += '<p style="font-size:0.75rem;color:var(--text-muted);text-align:center;margin:4px 0 8px">' + selectedAreas.length + ' of 2 selected</p>' +
            '<button type="button" class="btn btn-primary" id="p8-finish" style="width:100%;margin-bottom:24px;' + (selectedAreas.length === 0 ? 'opacity:0.5' : '') + '">Unlock weeks 9\u201316</button></div>';
          div.innerHTML = html;
          div.querySelector('#p8-back').onclick = function() { post8Step = 2; render(); };
          div.querySelectorAll('.focus-option').forEach(function(opt) {
            opt.onclick = function() {
              var key = opt.getAttribute('data-focus');
              var idx = selectedAreas.indexOf(key);
              if (idx >= 0) { selectedAreas.splice(idx, 1); }
              else if (selectedAreas.length < 2) { selectedAreas.push(key); }
              state.focusAreas = selectedAreas;
              render();
            };
          });
          var finishBtn = div.querySelector('#p8-finish');
          if (finishBtn && selectedAreas.length > 0) {
            finishBtn.onclick = function() {
              state.postWeek8CheckIn = { completedAt: new Date().toISOString(), answers: post8Answers, focusAreas: selectedAreas.slice() };
              state.focusAreas = selectedAreas.slice();
              saveState(state);
              post8Step = 0;
              post8Answers = {};
              openWeekNumber = 9;
              navigateTo('week_detail');
            };
          }
        }
        container.appendChild(div);
      }

      function renderToolkitModule(container) {
        var mod = TOOLKIT_MODULES[openToolkitModuleId];
        if (!mod) { navigateBack('dailies', 'dailies'); return; }
        var step = mod.steps[toolkitModuleStep];
        var totalSteps = mod.steps.length;
        var isLast = toolkitModuleStep === totalSteps - 1;
        var div = document.createElement('div');
        div.className = 'screen active';
        var stepContent = '';
        if (step.type === 'reading') {
          stepContent = '<div class="module-step-reading"><h4 class="module-step-title">' + step.title + '</h4><p class="module-step-body">' + step.body + '</p></div>';
        } else if (step.type === 'activity' && step.activityId === 'protein_guess') {
          var item = PROTEIN_GUESS_ITEMS[proteinGuessIndex] || PROTEIN_GUESS_ITEMS[0];
          if (!proteinGuessAnswered) {
            stepContent = '<div class="module-step-activity"><h4 class="module-step-title">Which has more protein?</h4><p class="module-step-body" style="margin-bottom:12px">Tap the option with more protein per typical serving.</p><div class="protein-guess-options"><button type="button" class="btn btn-outline protein-option" data-which="a">' + item.a + '</button><button type="button" class="btn btn-outline protein-option" data-which="b">' + item.b + '</button></div></div>';
          } else {
            var correct = item.more === 'a' ? item.a : item.b;
            stepContent = '<div class="module-step-activity"><h4 class="module-step-title">Which has more protein?</h4><p class="module-step-body">' + item.a + ' has ~' + item.aG + 'g protein. ' + item.b + ' has ~' + item.bG + 'g. Higher: <strong>' + correct + '</strong>.</p></div>';
          }
        } else if (step.type === 'activity' && step.activityId === 'build_workout') {
          stepContent = '<div class="module-step-activity"><h4 class="module-step-title">Build a resistance workout</h4><p class="module-step-body" style="margin-bottom:12px">Select 3\u20134 exercises for a full-body session.</p><div class="build-workout-list">' + BUILD_WORKOUT_OPTIONS.map(function(ex, i) {
            var checked = buildWorkoutSelected.indexOf(ex) >= 0;
            return '<label class="build-workout-item"><input type="checkbox" data-exercise="' + ex + '" ' + (checked ? 'checked' : '') + ' /> ' + ex + '</label>';
          }).join('') + '</div></div>';
        } else if (step.type === 'video') {
          stepContent = '<div class="module-step-reading"><h4 class="module-step-title">' + (step.title || 'Video') + '</h4><p class="module-step-body">' + (step.body || 'Video content placeholder. In a full app, embed or link to video here.') + '</p></div>';
        }
        div.innerHTML = '<header class="page-header"><button type="button" class="header-btn" id="module-back">&larr;</button><span class="header-title">' + mod.title + '</span><span style="width:36px"></span></header>' +
          '<div class="card"><div class="module-progress">Step ' + (toolkitModuleStep + 1) + ' of ' + totalSteps + '</div>' + stepContent +
          '<div class="module-step-actions"><button type="button" class="btn btn-outline" id="module-prev" ' + (toolkitModuleStep === 0 ? 'disabled' : '') + '>Back</button><button type="button" class="btn btn-primary" id="module-next">' + (isLast ? 'Complete' : 'Next') + '</button></div></div>';
        div.querySelector('#module-back').onclick = function() {
          if (toolkitModuleStep === 0) { openToolkitModuleId = null; navigateBack('dailies', 'dailies'); } else { toolkitModuleStep--; proteinGuessAnswered = false; render(); }
        };
        div.querySelector('#module-prev').onclick = function() { toolkitModuleStep--; proteinGuessAnswered = false; render(); };
        div.querySelector('#module-next').onclick = function() {
          if (step.type === 'activity' && step.activityId === 'protein_guess' && !proteinGuessAnswered) return;
          if (isLast) { openToolkitModuleId = null; navigateBack('dailies', 'dailies'); return; } else { toolkitModuleStep++; proteinGuessAnswered = false; }
          render();
        };
        div.querySelectorAll('.protein-option').forEach(function(btn) {
          btn.onclick = function() { proteinGuessAnswered = true; render(); };
        });
        div.querySelectorAll('.build-workout-list input[type="checkbox"]').forEach(function(cb) {
          cb.onchange = function() {
            var ex = cb.getAttribute('data-exercise');
            if (cb.checked) { if (buildWorkoutSelected.indexOf(ex) < 0) buildWorkoutSelected.push(ex); } else buildWorkoutSelected = buildWorkoutSelected.filter(function(e) { return e !== ex; });
            };
          });
        container.appendChild(div);
      }

      function renderEducationGame(container) {
        if (!openEducationGameType) { navigateBack('dailies', 'dailies'); return; }
        var div = document.createElement('div');
        div.className = 'screen active';
        var title = openEducationGameTitle || openEducationGameType;
        var back = function() { openEducationGameType = null; openEducationGameTitle = null; if (eduMeditationInterval) clearInterval(eduMeditationInterval); navigateBack('dailies', 'dailies'); };
        var content = '';
        if (openEducationGameType === 'protein_guess') {
          var pitems = PROTEIN_GUESS_ITEMS;
          var pi = Math.min(eduGameIndex, pitems.length - 1);
          var item = pitems[pi];
          if (!item) { back(); return; }
          if (!eduGameAnswered) {
            content = '<div class="card"><h4 class="module-step-title">Which has more protein?</h4><p class="module-step-body" style="margin-bottom:12px">Tap the option with more protein per typical serving.</p><div class="protein-guess-options"><button type="button" class="btn btn-outline protein-option" data-which="a">' + item.a + '</button><button type="button" class="btn btn-outline protein-option" data-which="b">' + item.b + '</button></div><p style="font-size:0.75rem;color:var(--text-muted);margin-top:12px">' + (pi + 1) + ' of ' + pitems.length + '</p></div>';
          } else {
            var correct = item.more === 'a' ? item.a : item.b;
            content = '<div class="card"><h4 class="module-step-title">Which has more protein?</h4><p class="module-step-body">' + item.a + ' has ~' + item.aG + 'g protein. ' + item.b + ' has ~' + item.bG + 'g. Higher: <strong>' + correct + '</strong>.</p><button type="button" class="btn btn-primary" id="edu-game-next">' + (pi < pitems.length - 1 ? 'Next' : 'Done') + '</button></div>';
          }
        } else if (openEducationGameType === 'fiber_guess') {
          var fitems = FIBER_GUESS_ITEMS;
          var fi = Math.min(eduGameIndex, fitems.length - 1);
          var fitem = fitems[fi];
          if (!fitem) { back(); return; }
          if (!eduGameAnswered) {
            content = '<div class="card"><h4 class="module-step-title">Which has more fiber?</h4><p class="module-step-body" style="margin-bottom:12px">Tap the option with more fiber per typical serving.</p><div class="protein-guess-options"><button type="button" class="btn btn-outline fiber-option" data-which="a">' + fitem.a + '</button><button type="button" class="btn btn-outline fiber-option" data-which="b">' + fitem.b + '</button></div><p style="font-size:0.75rem;color:var(--text-muted);margin-top:12px">' + (fi + 1) + ' of ' + fitems.length + '</p></div>';
          } else {
            var fcorrect = fitem.more === 'a' ? fitem.a : fitem.b;
            content = '<div class="card"><h4 class="module-step-title">Which has more fiber?</h4><p class="module-step-body">' + fitem.a + ' has ~' + fitem.aG + 'g fiber. ' + fitem.b + ' has ~' + fitem.bG + 'g. Higher: <strong>' + fcorrect + '</strong>.</p><button type="button" class="btn btn-primary" id="edu-game-next">' + (fi < fitems.length - 1 ? 'Next' : 'Done') + '</button></div>';
          }
        } else if (openEducationGameType === 'build_meal') {
          var sel = eduBuildMealSelected;
          var hasAll = sel.protein && sel.carb && sel.veggie;
          content = '<div class="card"><h4 class="module-step-title">Build a meal</h4><p class="module-step-body" style="margin-bottom:12px">Pick one protein, one carb, and one veggie for a balanced plate.</p><div class="edu-build-meal"><div class="edu-meal-group"><div class="edu-meal-label">Protein</div>' + BUILD_MEAL_PROTEINS.map(function(p) { return '<button type="button" class="btn btn-outline edu-meal-opt' + (sel.protein === p ? ' selected' : '') + '" data-cat="protein" data-val="' + p.replace(/"/g, '&quot;') + '">' + p + '</button>'; }).join('') + '</div><div class="edu-meal-group"><div class="edu-meal-label">Carb</div>' + BUILD_MEAL_CARBS.map(function(c) { return '<button type="button" class="btn btn-outline edu-meal-opt' + (sel.carb === c ? ' selected' : '') + '" data-cat="carb" data-val="' + c.replace(/"/g, '&quot;') + '">' + c + '</button>'; }).join('') + '</div><div class="edu-meal-group"><div class="edu-meal-label">Veggie</div>' + BUILD_MEAL_VEGGIES.map(function(v) { return '<button type="button" class="btn btn-outline edu-meal-opt' + (sel.veggie === v ? ' selected' : '') + '" data-cat="veggie" data-val="' + v.replace(/"/g, '&quot;') + '">' + v + '</button>'; }).join('') + '</div></div>' + (hasAll ? '<p class="module-step-body" style="margin-top:12px">Your plate: <strong>' + sel.protein + '</strong> + <strong>' + sel.carb + '</strong> + <strong>' + sel.veggie + '</strong>. Nice balance!</p><button type="button" class="btn btn-primary" id="edu-game-done">Done</button>' : '') + '</div>';
        } else if (openEducationGameType === 'muscle_guess') {
          var mitems = MUSCLE_GUESS_ITEMS;
          var mi = Math.min(eduGameIndex, mitems.length - 1);
          var mitem = mitems[mi];
          if (!mitem) { back(); return; }
          if (!eduGameAnswered) {
            content = '<div class="card"><h4 class="module-step-title">Which muscle does this exercise target most?</h4><p class="module-step-body" style="margin-bottom:12px"><strong>' + mitem.exercise + '</strong></p><div class="edu-muscle-options">' + mitem.options.map(function(opt, idx) { return '<button type="button" class="btn btn-outline muscle-option" data-idx="' + idx + '">' + opt + '</button>'; }).join('') + '</div><p style="font-size:0.75rem;color:var(--text-muted);margin-top:12px">' + (mi + 1) + ' of ' + mitems.length + '</p></div>';
          } else {
            var correctMuscle = mitem.options[mitem.correct];
            content = '<div class="card"><h4 class="module-step-title">Which muscle?</h4><p class="module-step-body">' + mitem.exercise + ' primarily targets <strong>' + correctMuscle + '</strong>.</p><button type="button" class="btn btn-primary" id="edu-game-next">' + (mi < mitems.length - 1 ? 'Next' : 'Done') + '</button></div>';
          }
        } else if (openEducationGameType === 'guided_meditation') {
          var elapsed = eduMeditationStartTime ? Math.floor((Date.now() - eduMeditationStartTime) / 1000) : 0;
          var script = MEDITATION_SCRIPT;
          var currentPrompt = script[0].text;
          for (var i = script.length - 1; i >= 0; i--) { if (elapsed >= script[i].t) { currentPrompt = script[i].text; break; } }
          var mins = Math.floor(elapsed / 60);
          var secs = elapsed % 60;
          var timerStr = (mins < 10 ? '0' : '') + mins + ':' + (secs < 10 ? '0' : '') + secs;
          if (!eduMeditationStartTime) {
            content = '<div class="card edu-meditation-card"><h4 class="module-step-title">Guided meditation</h4><p class="module-step-body">5 minutes of breathing and calm. Find a quiet spot, then tap Start.</p><button type="button" class="btn btn-primary" id="edu-meditation-start">Start</button></div>';
          } else {
            content = '<div class="card edu-meditation-card"><div class="edu-meditation-timer">' + timerStr + '</div><p class="module-step-body edu-meditation-prompt">' + currentPrompt.replace(/</g, '&lt;') + '</p>' + (elapsed >= 300 ? '<button type="button" class="btn btn-primary" id="edu-game-done">Done</button>' : '') + '</div>';
          }
        } else if (openEducationGameType === 'build_workout') {
          if (eduBuildWorkoutStep === 0) {
            content = '<div class="card"><div class="module-progress">Step 1 of 3: Back</div><h4 class="module-step-title">Build your back workout</h4><p class="module-step-body" style="margin-bottom:14px">Select 3–4 exercises for your back. We\'ll score your workout and explain rep schemes next.</p><div class="build-workout-list" data-step="back">' + BUILD_BACK_OPTIONS.map(function(ex) { var checked = eduBuildBackSelected.indexOf(ex) >= 0; return '<label class="build-workout-item"><input type="checkbox" data-exercise="' + ex.replace(/"/g, '&quot;') + '" data-step="back" ' + (checked ? 'checked' : '') + ' /> ' + ex + '</label>'; }).join('') + '</div><button type="button" class="btn btn-primary" id="edu-build-next" style="margin-top:14px">Next: Legs</button></div>';
          } else if (eduBuildWorkoutStep === 1) {
            content = '<div class="card"><div class="module-progress">Step 2 of 3: Legs</div><h4 class="module-step-title">Build your legs workout</h4><p class="module-step-body" style="margin-bottom:14px">Select 3–4 exercises for your legs.</p><div class="build-workout-list" data-step="legs">' + BUILD_LEGS_OPTIONS.map(function(ex) { var checked = eduBuildLegsSelected.indexOf(ex) >= 0; return '<label class="build-workout-item"><input type="checkbox" data-exercise="' + ex.replace(/"/g, '&quot;') + '" data-step="legs" ' + (checked ? 'checked' : '') + ' /> ' + ex + '</label>'; }).join('') + '</div><button type="button" class="btn btn-primary" id="edu-build-next" style="margin-top:14px">See score &amp; learn</button></div>';
          } else {
            var backCount = eduBuildBackSelected.length;
            var legsCount = eduBuildLegsSelected.length;
            var score = Math.min(100, Math.round((backCount >= 3 && legsCount >= 3 ? 100 : (backCount + legsCount) * 12)));
            content = '<div class="card edu-reading-card"><div class="module-progress">Step 3 of 3</div><h4 class="module-step-title">Your workout score: ' + score + '/100</h4><p class="module-step-body" style="margin-bottom:12px"><strong>Back:</strong> ' + (eduBuildBackSelected.length ? eduBuildBackSelected.join(', ') : 'None selected') + '</p><p class="module-step-body" style="margin-bottom:14px"><strong>Legs:</strong> ' + (eduBuildLegsSelected.length ? eduBuildLegsSelected.join(', ') : 'None selected') + '</p><p class="module-step-body">' + MUSCLE_BUILDING_EDUCATION.replace(/</g, '&lt;') + '</p><button type="button" class="btn btn-primary" id="edu-game-done" style="margin-top:16px">Done</button></div>';
          }
        } else if (openEducationGameType === 'form_quiz') {
          var fq = FORM_QUIZ_ITEMS[eduFormQuizIndex];
          if (!fq) { back(); return; }
          if (!eduFormQuizAnswered) {
            content = '<div class="card"><h4 class="module-step-title">' + fq.movement + '</h4><p class="module-step-body" style="margin-bottom:14px">' + fq.question.replace(/</g, '&lt;') + '</p><div class="edu-muscle-options"><button type="button" class="btn btn-outline form-quiz-opt" data-pick="A">A: ' + (fq.optionA || '').replace(/</g, '&lt;') + '</button><button type="button" class="btn btn-outline form-quiz-opt" data-pick="B">B: ' + (fq.optionB || '').replace(/</g, '&lt;') + '</button></div><p style="font-size:0.75rem;color:var(--text-muted);margin-top:12px">' + (eduFormQuizIndex + 1) + ' of ' + FORM_QUIZ_ITEMS.length + '</p></div>';
          } else {
            content = '<div class="card"><h4 class="module-step-title">' + fq.movement + '</h4><p class="module-step-body">Correct answer: <strong>' + fq.correct + '</strong>. ' + (fq.correct === 'A' ? fq.optionA : fq.optionB).replace(/</g, '&lt;') + '</p><button type="button" class="btn btn-primary" id="edu-game-next">' + (eduFormQuizIndex < FORM_QUIZ_ITEMS.length - 1 ? 'Next' : 'Done') + '</button></div>';
          }
        } else if (openEducationGameType === 'record_form') {
          if (eduRecordFormPhase === 'pick') {
            content = '<div class="card"><h4 class="module-step-title">Record your form</h4><p class="module-step-body" style="margin-bottom:14px">Choose a movement. You\'ll record 5 reps from the side (~10 seconds); we\'ll analyze and give corrections.</p><div class="edu-muscle-options">' + RECORD_FORM_MOVEMENTS.map(function(m) { return '<button type="button" class="btn btn-outline record-form-pick" data-movement="' + m.id + '">' + m.name + '</button>'; }).join('') + '</div></div>';
          } else if (eduRecordFormPhase === 'record') {
            var mov = RECORD_FORM_MOVEMENTS.filter(function(m) { return m.id === eduRecordFormMovementId; })[0];
            content = '<div class="card"><h4 class="module-step-title">' + (mov ? mov.name : '') + '</h4><p class="module-step-body" style="margin-bottom:14px">' + (mov ? mov.tips : '').replace(/</g, '&lt;') + '</p><p style="font-size:0.875rem;color:var(--text-muted);margin-bottom:12px">Position your phone to record from the side. When ready, tap Start and perform 5 reps in about 10 seconds.</p><button type="button" class="btn btn-primary" id="edu-record-start">Start recording</button><button type="button" class="btn btn-outline" id="edu-record-back" style="margin-top:10px;width:100%">Back to movements</button></div>';
          } else if (eduRecordFormPhase === 'analyzing') {
            content = '<div class="card"><h4 class="module-step-title">Analyzing your form</h4><p class="module-step-body">Reviewing your movement…</p><div style="margin-top:16px;font-size:0.875rem;color:var(--text-muted)">In a full app, video would be analyzed here. Below is sample feedback.</div></div>';
          } else {
            var correction = RECORD_FORM_CORRECTIONS[eduRecordFormMovementId] || 'Form feedback for this movement.';
            content = '<div class="card"><h4 class="module-step-title">Form feedback</h4><p class="module-step-body">' + (correction || '').replace(/</g, '&lt;') + '</p><button type="button" class="btn btn-primary" id="edu-game-done">Done</button></div>';
          }
        } else {
          back(); return;
        }
        div.innerHTML = '<header class="page-header"><button type="button" class="header-btn" id="edu-game-back">&larr;</button><span class="header-title">' + (title || 'Game').replace(/</g, '&lt;') + '</span><span style="width:36px"></span></header>' + content;
        div.querySelector('#edu-game-back').onclick = back;
        if (div.querySelector('#edu-game-next')) {
          var nextBtn = div.querySelector('#edu-game-next');
          nextBtn.onclick = openEducationGameType === 'form_quiz' ? function() {
            if (eduFormQuizIndex >= FORM_QUIZ_ITEMS.length - 1) { markGameCompleted(state, openEducationGameType); back(); } else { eduFormQuizIndex++; eduFormQuizAnswered = false; render(); }
          } : function() {
            var items = openEducationGameType === 'protein_guess' ? PROTEIN_GUESS_ITEMS : openEducationGameType === 'fiber_guess' ? FIBER_GUESS_ITEMS : openEducationGameType === 'muscle_guess' ? MUSCLE_GUESS_ITEMS : [];
            if (eduGameIndex >= items.length - 1) { markGameCompleted(state, openEducationGameType); back(); } else { eduGameIndex++; eduGameAnswered = false; render(); }
          };
        }
        if (div.querySelector('#edu-game-done')) div.querySelector('#edu-game-done').onclick = function() { markGameCompleted(state, openEducationGameType); back(); };
        if (div.querySelector('#edu-build-next')) div.querySelector('#edu-build-next').onclick = function() { eduBuildWorkoutStep++; render(); };
        div.querySelectorAll('.form-quiz-opt').forEach(function(btn) { btn.onclick = function() { eduFormQuizAnswered = true; render(); }; });
        div.querySelectorAll('.record-form-pick').forEach(function(btn) {
          btn.onclick = function() { eduRecordFormMovementId = btn.getAttribute('data-movement'); eduRecordFormPhase = 'record'; render(); };
        });
        if (div.querySelector('#edu-record-start')) div.querySelector('#edu-record-start').onclick = function() { eduRecordFormPhase = 'analyzing'; render(); setTimeout(function() { eduRecordFormPhase = 'result'; render(); }, 2200); };
        if (div.querySelector('#edu-record-back')) div.querySelector('#edu-record-back').onclick = function() { eduRecordFormPhase = 'pick'; eduRecordFormMovementId = null; render(); };
        if (div.querySelector('#edu-meditation-start')) {
          div.querySelector('#edu-meditation-start').onclick = function() {
            eduMeditationStartTime = Date.now();
            if (eduMeditationInterval) clearInterval(eduMeditationInterval);
            eduMeditationInterval = setInterval(function() { render(); }, 1000);
            render();
          };
        }
        div.querySelectorAll('.protein-option').forEach(function(btn) { btn.onclick = function() { eduGameAnswered = true; render(); }; });
        div.querySelectorAll('.fiber-option').forEach(function(btn) { btn.onclick = function() { eduGameAnswered = true; render(); }; });
        div.querySelectorAll('.muscle-option').forEach(function(btn) {
          btn.onclick = function() { eduGameAnswered = true; render(); };
        });
        div.querySelectorAll('.edu-meal-opt').forEach(function(btn) {
          btn.onclick = function() {
            var cat = btn.getAttribute('data-cat');
            var val = btn.getAttribute('data-val');
            if (cat === 'protein') eduBuildMealSelected.protein = val;
            else if (cat === 'carb') eduBuildMealSelected.carb = val;
            else if (cat === 'veggie') eduBuildMealSelected.veggie = val;
            render();
          };
        });
        div.querySelectorAll('.build-workout-list input[type="checkbox"]').forEach(function(cb) {
          cb.onchange = function() {
            var ex = cb.getAttribute('data-exercise');
            var step = cb.getAttribute('data-step');
            if (step === 'back') {
              if (cb.checked) { if (eduBuildBackSelected.indexOf(ex) < 0) eduBuildBackSelected.push(ex); } else eduBuildBackSelected = eduBuildBackSelected.filter(function(e) { return e !== ex; });
            } else if (step === 'legs') {
              if (cb.checked) { if (eduBuildLegsSelected.indexOf(ex) < 0) eduBuildLegsSelected.push(ex); } else eduBuildLegsSelected = eduBuildLegsSelected.filter(function(e) { return e !== ex; });
            } else {
              if (cb.checked) { if (buildWorkoutSelected.indexOf(ex) < 0) buildWorkoutSelected.push(ex); } else buildWorkoutSelected = buildWorkoutSelected.filter(function(e) { return e !== ex; });
            }
            render();
          };
        });
        container.appendChild(div);
      }

      function renderEducationModuleDetail(container) {
        if (!openEducationModuleId) { navigateBack('dailies', 'dailies'); return; }
        var div = document.createElement('div');
        div.className = 'screen active';
        var title = getModuleTitle(openEducationModuleId);
        var body = getModuleBody(openEducationModuleId);
        var bodyHtml = (body || '').split('\n\n').map(function(para) { return '<p class="module-step-body">' + para.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</p>'; }).join('');
        div.innerHTML = '<header class="page-header"><button type="button" class="header-btn" id="edu-module-back">&larr;</button><span class="header-title">' + (title || 'Module').replace(/</g, '&lt;') + '</span><span style="width:36px"></span></header>' +
          '<div class="card edu-reading-card"><div class="module-step-reading">' + bodyHtml + '</div><button type="button" class="btn btn-primary" id="edu-module-done" style="margin-top:16px">Done</button></div>';
        div.querySelector('#edu-module-back').onclick = function() { openEducationModuleId = null; navigateBack('dailies', 'dailies'); };
        div.querySelector('#edu-module-done').onclick = function() { markModuleCompleted(state, openEducationModuleId); openEducationModuleId = null; navigateBack('dailies', 'dailies'); };
        container.appendChild(div);
      }

      function renderLog(container) {
        var div = document.createElement('div');
        div.className = 'screen active';
        var todayDone = getHungerCompletedToday(state);
        var scanDone = state.bodyScanEntries && state.bodyScanEntries[getTodayKey()];
        div.innerHTML = '<header class="page-header"><span style="width:36px"></span><span class="header-title">Log</span><span style="width:36px"></span></header>' +
          (todayDone ? '' : '<div class="card" style="margin:12px 16px 4px;background:var(--phase-accent-light);border-left:4px solid var(--phase-accent);padding:14px 16px;cursor:pointer" id="hunger-checkin-banner"><p style="margin:0;font-weight:600;font-size:0.9375rem;color:var(--phase-accent)">Hunger check-in</p><p style="margin:4px 0 0;font-size:0.8125rem;color:var(--text-muted)">Build your satiety skill \u2014 takes 30 seconds.</p></div>') +
          '<div class="log-grid">' +
          '<button type="button" class="log-item" id="log-exercise"><span class="log-icon exercise">&#127939;</span><span><span class="log-label">Exercise</span><br><span class="log-hint">Workouts, steps</span></span></button>' +
          '<button type="button" class="log-item" id="log-sleep"><span class="log-icon sleep">&#128164;</span><span><span class="log-label">Sleep</span><br><span class="log-hint">Duration, quality</span></span></button>' +
          '<button type="button" class="log-item" id="log-food"><span class="log-icon food">&#127860;</span><span><span class="log-label">Food</span><br><span class="log-hint">Meals, macros</span></span></button>' +
          '<button type="button" class="log-item" id="log-water"><span class="log-icon water">&#128166;</span><span><span class="log-label">Water</span><br><span class="log-hint">Hydration</span></span></button>' +
          '<button type="button" class="log-item" id="log-weight"><span class="log-icon weight">&#128297;</span><span><span class="log-label">Weight</span><br><span class="log-hint">Body measurements</span></span></button>' +
          '<button type="button" class="log-item' + (scanDone ? ' log-item-done' : '') + '" id="log-bodyscan"><span class="log-icon bodyscan">&#128247;</span><span><span class="log-label">Body scanner</span><br><span class="log-hint">' + (scanDone ? 'Scanned today — ' + scanDone.bodyFat + '% body fat' : 'Body fat %, visceral fat %') + '</span></span></button>' +
          '<button type="button" class="log-item' + (todayDone ? ' log-item-done' : '') + '" id="log-hunger"><span class="log-icon hunger">&#128268;</span><span><span class="log-label">Hunger check-in</span><br><span class="log-hint">' + (todayDone ? 'Completed today' : 'Complete once per day') + '</span></span></button>' +
          '</div>';
        ['exercise', 'sleep', 'food', 'water', 'weight'].forEach(function(k) {
          var btn = div.querySelector('#log-' + k);
          if (btn) btn.onclick = function() { render(); };
        });
        var hungerBtn = div.querySelector('#log-hunger');
        if (hungerBtn) hungerBtn.onclick = function() { navigateTo('hunger_questionnaire'); };
        var hungerBanner = div.querySelector('#hunger-checkin-banner');
        if (hungerBanner) hungerBanner.onclick = function() { navigateTo('hunger_questionnaire'); };
        var scanBtn = div.querySelector('#log-bodyscan');
        if (scanBtn) scanBtn.onclick = function() { navigateTo('body_scanner'); };
        container.appendChild(div);
      }

      function renderHungerQuestionnaire(container) {
        var div = document.createElement('div');
        div.className = 'screen active';
        var todayKey = getTodayKey();
        var hungerFrame = HUNGER_FRAME;
        var mastery = getHungerMasteryScore(state);
        var existing = (state.hungerEntries && state.hungerEntries[todayKey]) || {};
        var overall = typeof existing.overallHunger === 'number' ? existing.overallHunger : 3;
        var fullness = typeof existing.postMealFullness === 'number' ? existing.postMealFullness : 3;
        var hLabels = HUNGER_SCALE_LABELS.hunger;
        var fLabels = HUNGER_SCALE_LABELS.fullness;
        var hungerLabelsHtml = '<div class="hunger-scale-labels">' + hLabels.map(function(l) { return '<div class="hunger-scale-label' + (l.val === overall ? ' active' : '') + '" data-hval="' + l.val + '">' + l.short + '</div>'; }).join('') + '</div>';
        var fullnessLabelsHtml = '<div class="hunger-scale-labels">' + fLabels.map(function(l) { return '<div class="hunger-scale-label' + (l.val === fullness ? ' active' : '') + '" data-fval="' + l.val + '">' + l.short + '</div>'; }).join('') + '</div>';
        var masteryPct = mastery.score;
        var masteryColor = masteryPct >= 70 ? '#16a34a' : masteryPct >= 40 ? '#d97706' : '#94a3b8';
        div.innerHTML = '<header class="page-header"><button type="button" class="header-btn" id="hunger-q-back">&larr;</button><span class="header-title">Hunger Check-in</span><span style="width:36px"></span></header>' +
          '<div class="hunger-mastery-card" style="margin:12px 16px"><div style="display:flex;justify-content:space-between;align-items:flex-start"><div><div class="hunger-mastery-title">Satiety Skill</div><div class="hunger-mastery-sub">' + mastery.level + ' \u00b7 ' + mastery.streak + '-day streak</div></div><div class="hunger-mastery-score" style="color:' + masteryColor + '">' + masteryPct + '</div></div><div class="hunger-mastery-bar"><div class="hunger-mastery-fill" style="width:' + masteryPct + '%;background:' + masteryColor + '"></div></div><p style="font-size:0.75rem;color:var(--text-muted);margin:0">Score improves with consistent logging, eating at hunger level 3, and landing fullness at 3\u20134.</p></div>' +
          '<div class="card" style="background:var(--phase-accent-light);border-left:3px solid var(--phase-accent)"><p style="margin:0 0 2px;font-size:0.8125rem;font-weight:700;color:var(--phase-accent)">' + hungerFrame.label + '</p><p style="margin:0;font-size:0.8125rem;color:var(--text);line-height:1.45">' + hungerFrame.tip + '</p></div>' +
          '<div class="card"><p style="font-size:0.9375rem;font-weight:600;margin:0 0 4px">How hungry are you right now?</p><p style="font-size:0.75rem;color:var(--text-muted);margin:0 0 10px">Hunger is a signal to respond to, not resist.</p>' +
          hungerLabelsHtml +
          '<input type="range" min="1" max="5" value="' + overall + '" id="hunger-overall" style="width:100%;margin:0 0 4px" />' +
          '<p style="font-size:0.75rem;color:var(--phase-accent);margin:0 0 18px;text-align:center;font-weight:600" id="hunger-desc-val">' + (hLabels[overall - 1] ? hLabels[overall - 1].desc : '') + '</p>' +
          '<p style="font-size:0.9375rem;font-weight:600;margin:0 0 4px">How full were you after your last meal?</p><p style="font-size:0.75rem;color:var(--text-muted);margin:0 0 10px">Aim for "Satisfied" \u2014 comfortable but not stuffed.</p>' +
          fullnessLabelsHtml +
          '<input type="range" min="1" max="5" value="' + fullness + '" id="hunger-fullness" style="width:100%;margin:0 0 4px" />' +
          '<p style="font-size:0.75rem;color:var(--phase-accent);margin:0 0 18px;text-align:center;font-weight:600" id="fullness-desc-val">' + (fLabels[fullness - 1] ? fLabels[fullness - 1].desc : '') + '</p>' +
          '<button type="button" class="btn btn-primary" id="hunger-q-submit" style="width:100%">Submit check-in</button></div>';
        div.querySelector('#hunger-q-back').onclick = function() { navigateBack('log', 'log'); };
        function updateLabels() {
          var o = parseInt(div.querySelector('#hunger-overall').value, 10);
          var f = parseInt(div.querySelector('#hunger-fullness').value, 10);
          div.querySelectorAll('.hunger-scale-label[data-hval]').forEach(function(el) { el.classList.toggle('active', parseInt(el.getAttribute('data-hval'), 10) === o); });
          div.querySelectorAll('.hunger-scale-label[data-fval]').forEach(function(el) { el.classList.toggle('active', parseInt(el.getAttribute('data-fval'), 10) === f); });
          var hDesc = div.querySelector('#hunger-desc-val');
          var fDesc = div.querySelector('#fullness-desc-val');
          if (hDesc) hDesc.textContent = HUNGER_SCALE_LABELS.hunger[o - 1] ? HUNGER_SCALE_LABELS.hunger[o - 1].desc : '';
          if (fDesc) fDesc.textContent = HUNGER_SCALE_LABELS.fullness[f - 1] ? HUNGER_SCALE_LABELS.fullness[f - 1].desc : '';
        }
        div.querySelector('#hunger-overall').oninput = updateLabels;
        div.querySelector('#hunger-fullness').oninput = updateLabels;
        div.querySelector('#hunger-q-submit').onclick = function() {
          if (!state.hungerEntries) state.hungerEntries = {};
          var hungerVal = parseInt(div.querySelector('#hunger-overall').value, 10);
          var fullnessVal = parseInt(div.querySelector('#hunger-fullness').value, 10);
          state.hungerEntries[todayKey] = { overallHunger: hungerVal, postMealFullness: fullnessVal, completedAt: new Date().toISOString() };
          saveState(state);
          var feedbackTitle = '';
          var feedbackBody = '';
          if (hungerVal >= 4) {
            feedbackTitle = 'Higher hunger \u2014 your body is talking';
            feedbackBody = 'This is a signal to respond to, not resist. Try a protein-first meal next, and check if sleep was short last night \u2014 poor sleep amplifies hunger hormones by ~15\u201320%. Volume foods (large salad, broth-based soup) can help bridge the gap.';
          } else if (hungerVal <= 2) {
            feedbackTitle = 'Low hunger today';
            feedbackBody = 'Your hunger is quiet today. Keep eating by structure even when not hungry \u2014 undereating slows metabolism and costs muscle. Structured meals protect lean mass.';
          } else {
            feedbackTitle = 'Comfortably hungry \u2014 sweet spot';
            feedbackBody = 'A hunger level of 3 means your body is communicating well and you\u2019re responding at the right time. This is the ideal window to eat. Your satiety habits are working.';
          }
          if (fullnessVal <= 2) {
            feedbackBody += ' Your post-meal fullness is low \u2014 try eating more slowly (20+ minutes), starting with protein before carbs, and adding fiber-rich foods to extend your fullness window.';
          } else if (fullnessVal >= 5) {
            feedbackBody += ' You felt overly full \u2014 next time, try pausing halfway through the meal for 2 minutes. It takes ~20 minutes for fullness signals to reach your brain.';
          }
          var gInsight = getGlucoseHungerInsight(hungerVal, fullnessVal);
          var tipIndex = Math.floor(Math.random() * HUNGER_MICRO_TIPS.length);
          var microTip = HUNGER_MICRO_TIPS[tipIndex];
          var newMastery = getHungerMasteryScore(state);
          var submitBtn = div.querySelector('#hunger-q-submit');
          var card = submitBtn.closest('.card');
          card.innerHTML = '<div style="text-align:center;padding:8px 0"><div style="font-size:2rem;margin-bottom:8px">\u2713</div><h3 style="margin:0 0 8px;font-size:1.0625rem;font-weight:700">' + feedbackTitle + '</h3><p style="font-size:0.875rem;color:var(--text-muted);line-height:1.5;margin:0 0 14px">' + feedbackBody + '</p>' +
            '<div style="background:' + (gInsight.color === '#ef4444' ? '#fef2f2' : gInsight.color === '#f59e0b' ? '#fffbeb' : '#f0fdf4') + ';border-radius:10px;padding:10px 12px;margin-bottom:14px;text-align:left;border-left:3px solid ' + gInsight.color + '"><div style="display:flex;align-items:center;gap:6px;margin-bottom:4px"><span style="font-size:0.875rem">' + gInsight.icon + '</span><p style="margin:0;font-size:0.6875rem;font-weight:700;color:' + gInsight.color + ';text-transform:uppercase;letter-spacing:0.04em">' + gInsight.title + '</p></div><p style="margin:0;font-size:0.8125rem;color:var(--text);line-height:1.4">' + gInsight.body + '</p></div>' +
            '<div style="background:#f8fafc;border-radius:10px;padding:10px 12px;margin-bottom:14px;text-align:left"><p style="margin:0 0 2px;font-size:0.6875rem;font-weight:700;color:var(--phase-accent);text-transform:uppercase;letter-spacing:0.04em">Did you know?</p><p style="margin:0;font-size:0.8125rem;color:var(--text);line-height:1.4">' + microTip + '</p></div>' +
            '<div style="background:var(--phase-accent-light);border-radius:10px;padding:10px 12px;margin-bottom:14px;text-align:left"><p style="margin:0 0 2px;font-size:0.6875rem;font-weight:700;color:var(--phase-accent)">Satiety Skill: ' + newMastery.score + '/100</p><div class="hunger-mastery-bar"><div class="hunger-mastery-fill" style="width:' + newMastery.score + '%;background:var(--phase-accent)"></div></div><p style="margin:4px 0 0;font-size:0.75rem;color:var(--text-muted)">' + newMastery.level + ' \u00b7 ' + newMastery.streak + '-day streak</p></div>' +
            (hungerVal >= 4 || fullnessVal >= 5 || fullnessVal <= 1 ? '<button type="button" class="btn btn-outline" id="hunger-open-coach" style="width:100%;margin-bottom:8px;display:flex;align-items:center;justify-content:center;gap:6px"><span>&#129368;</span> Need help with this? Talk to your coach</button>' : '') +
            '<button type="button" class="btn btn-primary" id="hunger-done" style="width:100%">Done</button></div>';
          if (card.querySelector('#hunger-open-coach')) card.querySelector('#hunger-open-coach').onclick = function() { resetCoachState(); navigateTo('hunger_coach'); };
          card.querySelector('#hunger-done').onclick = function() { navigateBack('log', 'log'); };
        };
        container.appendChild(div);
      }

      var coachState = { scenario: null, branch: null, step: 0, path: [], haltSelected: null, scanStep: -1, followUpShown: false, timerActive: false, timerSeconds: 0, timerInterval: null, viewingLesson: null, mealTimerActive: false, mealTimerSeconds: 0, mealTimerInterval: null, strategyTracked: false };
      function resetCoachState() { coachState = { scenario: null, branch: null, step: 0, path: [], haltSelected: null, scanStep: -1, followUpShown: false, timerActive: false, timerSeconds: 0, timerInterval: null, viewingLesson: null, mealTimerActive: false, mealTimerSeconds: 0, mealTimerInterval: null, strategyTracked: false }; }

      function renderHungerCoach(container) {
        var div = document.createElement('div');
        div.className = 'screen active';
        var cs = coachState;
        var html = '<header class="page-header"><button type="button" class="header-btn back-btn" id="coach-back" aria-label="Back">&#8249;</button><span class="header-title">Hunger Coach</span><span style="width:36px"></span></header>';

        if (cs.viewingLesson) {
          var lesson = HUNGER_LESSONS.filter(function(l) { return l.id === cs.viewingLesson; })[0];
          if (lesson) {
            html += '<div style="padding:0 16px">' +
              '<div style="text-align:center;margin-bottom:16px"><span style="font-size:2.5rem">' + lesson.icon + '</span></div>' +
              '<h2 style="margin:0 0 14px;font-size:1.125rem;text-align:center">' + lesson.title + '</h2>' +
              '<div class="card" style="padding:16px">' + lesson.body + '</div>' +
              '<div style="background:var(--phase-accent-light);border-radius:12px;padding:14px 16px;margin-top:12px"><p style="margin:0 0 4px;font-size:0.6875rem;font-weight:700;color:var(--phase-accent);text-transform:uppercase;letter-spacing:0.04em">Key takeaway</p><p style="margin:0;font-size:0.875rem;color:var(--text);line-height:1.55;font-weight:500">' + lesson.takeaway + '</p></div>' +
              '<button type="button" class="btn btn-outline" id="lesson-back" style="width:100%;margin-top:16px">&#8592; Back to coach</button></div>';
            div.innerHTML = html;
            div.querySelector('#coach-back').onclick = function() { resetCoachState(); navigateBack(); };
            div.querySelector('#lesson-back').onclick = function() { cs.viewingLesson = null; render(); };
          }

        } else if (!cs.scenario) {
          var sessions = state.coachSessions || [];
          var recentCount = sessions.filter(function(s) { var d = new Date(s.timestamp); var now = new Date(); return (now - d) < 7 * 24 * 60 * 60 * 1000; }).length;
          var mastery = getHungerMasteryScore(state);
          var gw = getGraduationWeek(state);
          var weekMilestone = pWeekMilestone(gw);
          var topPattern = '';
          var bestStrategy = '';
          if (sessions.length >= 3) {
            var scenCounts = {};
            sessions.slice(-20).forEach(function(s) { scenCounts[s.scenario] = (scenCounts[s.scenario] || 0) + 1; });
            var topKey = Object.keys(scenCounts).sort(function(a, b) { return scenCounts[b] - scenCounts[a]; })[0];
            var topSc = COACH_SCENARIOS.filter(function(s) { return s.id === topKey; })[0];
            if (topSc) topPattern = topSc.label;
          }
          if (state.strategyLog && state.strategyLog.length >= 2) {
            var helpedCounts = {};
            state.strategyLog.filter(function(s) { return s.helped; }).forEach(function(s) { helpedCounts[s.strategy] = (helpedCounts[s.strategy] || 0) + 1; });
            var bestKey = Object.keys(helpedCounts).sort(function(a, b) { return helpedCounts[b] - helpedCounts[a]; })[0];
            if (bestKey) bestStrategy = bestKey;
          }

          var profileName = (state.profile && state.profile.name) ? state.profile.name.split(' ')[0] : '';
          var greeting = profileName ? ('Hi ' + profileName + '! ') : '';
          var contextMsg = '';
          if (mastery.avgHunger !== null && mastery.daysLogged >= 3) {
            var sweetSpotDays = 0;
            for (var hi = 0; hi < 7; hi++) { var hd = new Date(); hd.setDate(hd.getDate() - hi); var hk = hd.toISOString().slice(0, 10); if (state.hungerEntries && state.hungerEntries[hk] && state.hungerEntries[hk].overallHunger === 3) sweetSpotDays++; }
            if (sweetSpotDays >= 4) contextMsg = 'You\u2019ve been eating at the sweet spot ' + sweetSpotDays + ' out of 7 days. That\u2019s great awareness.';
            else if (mastery.avgHunger > 3.5) contextMsg = 'Your hunger has been running a bit high this week (avg ' + mastery.avgHunger + '). Let\u2019s look at why.';
            else if (mastery.avgHunger < 2.5) contextMsg = 'Your hunger has been very low this week (avg ' + mastery.avgHunger + '). Make sure you\u2019re eating enough.';
            else contextMsg = 'You\u2019re building solid hunger awareness. Keep checking in \u2014 every entry helps.';
          } else {
            contextMsg = 'I\u2019m here to help you understand your hunger \u2014 not fight it. What\u2019s going on?';
          }

          html += '<div style="padding:0 16px">' +
            '<div style="display:flex;align-items:center;gap:10px;margin-bottom:12px"><div class="coach-avatar">&#129368;</div><div><h2 style="margin:0;font-size:1.125rem">' + greeting + 'Your Hunger Coach</h2><p style="font-size:0.8125rem;color:var(--text-muted);margin:2px 0 0">' + contextMsg + '</p></div></div>';

          var statsHtml = '';
          if (mastery.daysLogged > 0) statsHtml += '<div style="text-align:center;flex:1"><div style="font-size:1.125rem;font-weight:800;color:var(--phase-accent)">' + mastery.streak + '</div><div style="font-size:0.5625rem;color:var(--text-muted)">Day streak</div></div>';
          if (mastery.avgHunger !== null) statsHtml += '<div style="text-align:center;flex:1"><div style="font-size:1.125rem;font-weight:800;color:' + (Math.abs(mastery.avgHunger - 3) <= 0.5 ? '#16a34a' : '#d97706') + '">' + mastery.avgHunger + '</div><div style="font-size:0.5625rem;color:var(--text-muted)">Avg hunger</div></div>';
          if (mastery.avgFullness !== null) statsHtml += '<div style="text-align:center;flex:1"><div style="font-size:1.125rem;font-weight:800;color:' + (mastery.avgFullness >= 2.5 && mastery.avgFullness <= 4 ? '#16a34a' : '#d97706') + '">' + mastery.avgFullness + '</div><div style="font-size:0.5625rem;color:var(--text-muted)">Avg fullness</div></div>';
          if (recentCount > 0) statsHtml += '<div style="text-align:center;flex:1"><div style="font-size:1.125rem;font-weight:800;color:var(--phase-accent)">' + recentCount + '</div><div style="font-size:0.5625rem;color:var(--text-muted)">Coach chats</div></div>';
          if (statsHtml) html += '<div style="background:#f8fafc;border-radius:10px;padding:10px 12px;margin-bottom:14px;display:flex;gap:8px">' + statsHtml + '</div>';

          var gCtxLanding = getGlucoseContext();
          var gLandBg = gCtxLanding.type === 'crash' ? '#fef2f2' : gCtxLanding.type === 'below_baseline' ? '#fffbeb' : '#f0fdf4';
          var gLandBorder = gCtxLanding.color;
          var gLandNote = '';
          if (gCtxLanding.type === 'crash') {
            gLandNote = mastery.avgHunger !== null && mastery.avgHunger > 3.2 ? 'Your higher hunger this week may be linked to glucose crashes after meals. Try eating protein first to flatten the curve.' : 'A glucose crash can trigger hunger even if you just ate. Check your CGM after meals to spot the pattern.';
          } else if (gCtxLanding.type === 'below_baseline') {
            gLandNote = 'Below-baseline glucose drives carb cravings. If you\u2019re feeling pulled toward bread or sweets right now, this is why.';
          } else if (gCtxLanding.type === 'stable' && mastery.avgHunger !== null && Math.abs(mastery.avgHunger - 3) <= 0.5) {
            gLandNote = 'Glucose is stable and your hunger has been well-managed this week. Your current meal patterns are working.';
          } else {
            gLandNote = 'Glucose is ' + gCtxLanding.current + ' mg/dL. ' + (gCtxLanding.type === 'post_meal' ? 'Watch for a dip in 45\u201360 min \u2014 if hunger returns, it may be a glucose crash.' : 'Stable glucose means your hunger signals are trustworthy right now.');
          }
          html += '<div style="background:' + gLandBg + ';border-radius:10px;padding:10px 12px;margin-bottom:14px;border-left:3px solid ' + gLandBorder + '">' +
            '<div style="display:flex;align-items:center;gap:6px;margin-bottom:4px"><span style="font-size:0.875rem">' + gCtxLanding.icon + '</span><span style="font-size:0.6875rem;font-weight:700;color:' + gLandBorder + '">Glucose: ' + gCtxLanding.current + ' mg/dL \u2014 ' + gCtxLanding.trend + '</span></div>' +
            '<p style="margin:0;font-size:0.75rem;color:var(--text);line-height:1.45">' + gLandNote + '</p></div>';

          if (bestStrategy) {
            html += '<div style="background:#f0fdf4;border-radius:10px;padding:10px 12px;margin-bottom:14px;border-left:3px solid #16a34a"><p style="margin:0;font-size:0.75rem"><span style="font-weight:700;color:#16a34a">Your best strategy:</span> <span style="color:var(--text)">' + bestStrategy + '</span></p></div>';
          }
          if (topPattern && sessions.length >= 5) {
            html += '<div style="background:var(--phase-accent-light);border-radius:10px;padding:10px 12px;margin-bottom:14px;border-left:3px solid var(--phase-accent)"><p style="margin:0;font-size:0.75rem"><span style="font-weight:700;color:var(--phase-accent)">Pattern noticed:</span> <span style="color:var(--text)">"' + topPattern + '" comes up most often. Explore the "Learn" section for deeper strategies.</span></p></div>';
          }

          html += '<p style="font-size:0.6875rem;font-weight:700;color:var(--phase-accent);text-transform:uppercase;letter-spacing:0.06em;margin:0 0 8px">Practice a skill</p>';
          COACH_SCENARIOS.filter(function(sc) { return sc.category === 'proactive'; }).forEach(function(sc) {
            html += '<button type="button" class="coach-option coach-scenario-btn" data-scenario="' + sc.id + '"><div style="display:flex;align-items:center;gap:10px"><span class="coach-opt-icon">' + sc.icon + '</span><div><div class="coach-opt-label">' + sc.label + '</div><div class="coach-opt-desc">' + sc.desc + '</div></div></div></button>';
          });
          html += '<p style="font-size:0.6875rem;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.06em;margin:16px 0 8px">I\u2019m feeling something</p>';
          COACH_SCENARIOS.filter(function(sc) { return sc.category === 'reactive'; }).forEach(function(sc) {
            html += '<button type="button" class="coach-option coach-scenario-btn" data-scenario="' + sc.id + '"><div style="display:flex;align-items:center;gap:10px"><span class="coach-opt-icon">' + sc.icon + '</span><div><div class="coach-opt-label">' + sc.label + '</div><div class="coach-opt-desc">' + sc.desc + '</div></div></div></button>';
          });
          html += '<p style="font-size:0.6875rem;font-weight:700;color:#16a34a;text-transform:uppercase;letter-spacing:0.06em;margin:16px 0 8px">Learn &amp; explore</p>';
          COACH_SCENARIOS.filter(function(sc) { return sc.category === 'learn'; }).forEach(function(sc) {
            html += '<button type="button" class="coach-option coach-scenario-btn" data-scenario="' + sc.id + '"><div style="display:flex;align-items:center;gap:10px"><span class="coach-opt-icon">' + sc.icon + '</span><div><div class="coach-opt-label">' + sc.label + '</div><div class="coach-opt-desc">' + sc.desc + '</div></div></div></button>';
          });
          html += '<div style="margin-top:16px;margin-bottom:6px"><p style="font-size:0.6875rem;font-weight:700;color:#16a34a;text-transform:uppercase;letter-spacing:0.06em;margin:0 0 8px">Mini-lessons</p>';
          HUNGER_LESSONS.forEach(function(lesson) {
            html += '<button type="button" class="coach-option coach-lesson-btn" data-lesson="' + lesson.id + '" style="padding:10px 12px"><div style="display:flex;align-items:center;gap:10px"><span style="font-size:1.25rem">' + lesson.icon + '</span><div><div style="font-size:0.8125rem;font-weight:600;color:var(--text)">' + lesson.title + '</div></div><span style="color:var(--text-muted);font-size:0.875rem;margin-left:auto">&#8250;</span></div></button>';
          });
          html += '</div></div>';

          div.innerHTML = html;
          div.querySelector('#coach-back').onclick = function() { resetCoachState(); navigateBack(); };
          div.querySelectorAll('.coach-scenario-btn').forEach(function(btn) {
            btn.onclick = function() {
              var scId = btn.getAttribute('data-scenario');
              if (scId === 'learn_hunger') {
                cs.viewingLesson = HUNGER_LESSONS[0].id;
                render();
              } else {
                cs.scenario = scId;
                cs.path.push(cs.scenario);
                render();
              }
            };
          });
          div.querySelectorAll('.coach-lesson-btn').forEach(function(btn) {
            btn.onclick = function() {
              cs.viewingLesson = btn.getAttribute('data-lesson');
              render();
            };
          });

        } else {
          var branchData = COACH_BRANCHES[cs.branch || cs.scenario];
          if (!branchData) { resetCoachState(); render(); return; }

          var resp = cs.step > 0 ? cs.currentResponse : null;

          if (!resp) {
            if (branchData.isBodyScan) {
              if (cs.scanStep < 0) {
                html += '<div style="padding:0 16px">' +
                  '<div class="coach-bubble"><div style="display:flex;align-items:center;gap:8px;margin-bottom:8px"><div class="coach-avatar" style="width:28px;height:28px;font-size:0.875rem">&#129368;</div><span style="font-size:0.75rem;font-weight:600;color:var(--phase-accent)">Coach</span></div>' + branchData.question + '</div>';
                html += '<div style="text-align:center;margin-bottom:16px"><p style="font-size:0.875rem;color:var(--text-muted);margin:0 0 16px">I\u2019ll guide you through a quick body scan. Ready?</p>' +
                  '<button type="button" class="btn btn-primary" id="coach-start-scan" style="width:100%">Start body scan</button></div></div>';
                div.innerHTML = html;
                div.querySelector('#coach-back').onclick = function() { resetCoachState(); navigateBack(); };
                div.querySelector('#coach-start-scan').onclick = function() { cs.scanStep = 0; render(); };
              } else if (cs.scanStep < branchData.steps.length) {
                var scanItem = branchData.steps[cs.scanStep];
                html += '<div style="padding:0 16px">' +
                  '<div class="coach-bubble"><div style="display:flex;align-items:center;gap:8px;margin-bottom:8px"><div class="coach-avatar" style="width:28px;height:28px;font-size:0.875rem">&#129368;</div><span style="font-size:0.75rem;font-weight:600;color:var(--phase-accent)">Coach</span></div>' + scanItem.prompt + '</div>' +
                  '<div style="text-align:center;margin:16px 0">' +
                  '<div class="coach-timer-ring active"><span class="coach-timer-text" id="scan-countdown">' + scanItem.duration + '</span></div>' +
                  '<p style="font-size:0.75rem;color:var(--text-muted);margin:8px 0 0">Step ' + (cs.scanStep + 1) + ' of ' + branchData.steps.length + '</p></div>' +
                  '<button type="button" class="btn btn-outline" id="coach-scan-next" style="width:100%;margin-top:8px">' + (cs.scanStep < branchData.steps.length - 1 ? 'Next step' : 'Done \u2014 how do I feel?') + '</button></div>';
                div.innerHTML = html;
                div.querySelector('#coach-back').onclick = function() { resetCoachState(); navigateBack(); };
                var countEl = div.querySelector('#scan-countdown');
                var remaining = scanItem.duration;
                var scanTimer = setInterval(function() {
                  remaining--;
                  if (countEl) countEl.textContent = remaining > 0 ? remaining : '\u2713';
                  if (remaining <= 0) clearInterval(scanTimer);
                }, 1000);
                div.querySelector('#coach-scan-next').onclick = function() {
                  clearInterval(scanTimer);
                  cs.scanStep++;
                  render();
                };
              } else {
                html += '<div style="padding:0 16px">' +
                  '<div class="coach-bubble"><div style="display:flex;align-items:center;gap:8px;margin-bottom:8px"><div class="coach-avatar" style="width:28px;height:28px;font-size:0.875rem">&#129368;</div><span style="font-size:0.75rem;font-weight:600;color:var(--phase-accent)">Coach</span></div>Great. Based on what you felt, which best describes you right now?</div>';
                branchData.afterScan.forEach(function(opt) {
                  html += '<button type="button" class="coach-option coach-response-btn" data-resp="' + opt.id + '"><span class="coach-opt-icon">' + opt.icon + '</span> ' + opt.label + '</button>';
                });
                html += '</div>';
                div.innerHTML = html;
                div.querySelector('#coach-back').onclick = function() { resetCoachState(); navigateBack(); };
                div.querySelectorAll('.coach-response-btn').forEach(function(btn) {
                  btn.onclick = function() {
                    var respId = btn.getAttribute('data-resp');
                    cs.path.push(respId);
                    cs.currentResponse = branchData.responses[respId];
                    cs.step = 1;
                    render();
                  };
                });
              }
            } else if (branchData.isHalt) {
              html += '<div style="padding:0 16px">' +
                '<div class="coach-bubble"><div style="display:flex;align-items:center;gap:8px;margin-bottom:8px"><div class="coach-avatar" style="width:28px;height:28px;font-size:0.875rem">&#129368;</div><span style="font-size:0.75rem;font-weight:600;color:var(--phase-accent)">Coach</span></div>' + branchData.question + '</div>';
              if (branchData.subtitle) html += '<p style="font-size:0.8125rem;color:var(--text-muted);margin:0 0 12px;line-height:1.5">' + branchData.subtitle + '</p>';
              html += '<div class="halt-grid">';
              branchData.options.forEach(function(opt) {
                html += '<button type="button" class="halt-btn coach-halt-btn" data-halt="' + opt.id + '"><span class="halt-letter">' + opt.letter + '</span><span class="halt-label">' + opt.label + '</span><span style="font-size:0.6875rem;color:var(--text-muted);display:block;margin-top:2px">' + opt.desc + '</span></button>';
              });
              html += '</div></div>';
              div.innerHTML = html;
              div.querySelector('#coach-back').onclick = function() { resetCoachState(); navigateBack(); };
              div.querySelectorAll('.coach-halt-btn').forEach(function(btn) {
                btn.onclick = function() {
                  var haltId = btn.getAttribute('data-halt');
                  cs.haltSelected = haltId;
                  cs.path.push('halt_' + haltId);
                  cs.currentResponse = branchData.responses[haltId];
                  cs.step = 1;
                  render();
                };
              });
            } else {
              html += '<div style="padding:0 16px">' +
                '<div class="coach-bubble"><div style="display:flex;align-items:center;gap:8px;margin-bottom:8px"><div class="coach-avatar" style="width:28px;height:28px;font-size:0.875rem">&#129368;</div><span style="font-size:0.75rem;font-weight:600;color:var(--phase-accent)">Coach</span></div>' + branchData.question + '</div>';
              branchData.options.forEach(function(opt) {
                html += '<button type="button" class="coach-option coach-branch-btn" data-opt="' + opt.id + '"><div class="coach-opt-label">' + opt.label + '</div>' + (opt.desc ? '<div class="coach-opt-desc">' + opt.desc + '</div>' : '') + '</button>';
              });
              html += '</div>';
              div.innerHTML = html;
              div.querySelector('#coach-back').onclick = function() { resetCoachState(); navigateBack(); };
              div.querySelectorAll('.coach-branch-btn').forEach(function(btn) {
                btn.onclick = function() {
                  var optId = btn.getAttribute('data-opt');
                  cs.path.push(optId);
                  var optResp = branchData.responses[optId];
                  if (optResp && optResp.followUp) {
                    cs.branch = optResp.followUp;
                    render();
                  } else if (optResp) {
                    cs.currentResponse = optResp;
                    cs.step = 1;
                    render();
                  }
                };
              });
            }
          } else {
            html += '<div style="padding:0 16px">';
            html += '<div class="coach-bubble"><div style="display:flex;align-items:center;gap:8px;margin-bottom:8px"><div class="coach-avatar" style="width:28px;height:28px;font-size:0.875rem">&#129368;</div><span style="font-size:0.75rem;font-weight:600;color:var(--phase-accent)">Coach</span></div><strong style="font-size:0.9375rem;display:block;margin-bottom:6px">' + resp.title + '</strong>' + resp.body + '</div>';

            var glucoseCtx = getGlucoseContext();
            var glucoseRelevant = cs.scenario === 'ate_still_hungry' || cs.scenario === 'starving' || cs.scenario === 'craving' || cs.scenario === 'not_hungry_want_eat' || cs.scenario === 'unsure' || cs.scenario === 'post_meal' || cs.scenario === 'about_to_eat' || cs.scenario === 'hunger_changing';
            if (glucoseRelevant) {
              var gBorder = glucoseCtx.color;
              var gBg = glucoseCtx.type === 'crash' ? '#fef2f2' : glucoseCtx.type === 'below_baseline' ? '#fffbeb' : glucoseCtx.type === 'stable' ? '#f0fdf4' : '#f8fafc';
              var gNote = '';
              if (glucoseCtx.type === 'crash' && (cs.scenario === 'ate_still_hungry' || cs.scenario === 'craving')) {
                gNote = 'This crash is likely driving your hunger right now. Eating protein \u2014 not carbs \u2014 breaks the cycle.';
              } else if (glucoseCtx.type === 'below_baseline' && cs.scenario === 'craving') {
                gNote = 'Your brain is requesting fast carbs to restore fuel. Satisfy it with protein + a small carb to avoid re-spiking.';
              } else if (glucoseCtx.type === 'stable' && cs.scenario === 'not_hungry_want_eat') {
                gNote = 'Stable glucose confirms this urge isn\u2019t physical hunger. It\u2019s emotional or habitual.';
              } else if (glucoseCtx.type === 'stable' && cs.scenario === 'about_to_eat') {
                gNote = 'Glucose is steady. You\u2019re in a good position to eat a well-paced, balanced meal.';
              } else if (glucoseCtx.type === 'crash' && cs.scenario === 'post_meal') {
                gNote = 'A rapid glucose drop like this can make you feel unsatisfied even after eating enough. Next meal: eat protein and veggies first.';
              } else {
                gNote = glucoseCtx.type === 'crash' ? 'A glucose crash can amplify hunger and cravings regardless of how much you ate.' : glucoseCtx.type === 'below_baseline' ? 'Below-baseline glucose drives carb-seeking behavior. This is your biology, not a character flaw.' : 'Stable glucose means your hunger signals are reliable right now.';
              }
              html += '<div style="background:' + gBg + ';border-left:3px solid ' + gBorder + ';border-radius:10px;padding:12px 14px;margin-bottom:14px">' +
                '<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px"><span style="font-size:1rem">' + glucoseCtx.icon + '</span><span style="font-size:0.75rem;font-weight:700;color:' + gBorder + '">Your glucose right now: ' + glucoseCtx.current + ' mg/dL</span><span style="font-size:0.625rem;color:var(--text-muted);margin-left:auto">' + glucoseCtx.trend + '</span></div>' +
                '<p style="margin:0;font-size:0.8125rem;color:var(--text);line-height:1.5">' + gNote + '</p></div>';
            }

            if (resp.actions && resp.actions.length > 0) {
              html += '<div style="margin-bottom:12px"><p style="font-size:0.75rem;font-weight:700;color:var(--phase-accent);text-transform:uppercase;letter-spacing:0.04em;margin:0 0 8px">What to do right now</p>';
              resp.actions.forEach(function(a, i) {
                html += '<div class="coach-action-card"><div class="coach-action-body"><span style="font-weight:700;color:var(--phase-accent);margin-right:4px">' + (i + 1) + '.</span> ' + a + '</div></div>';
              });
              html += '</div>';
            }

            if (resp.why) {
              html += '<div style="background:#f8fafc;border-radius:10px;padding:12px 14px;margin-bottom:14px"><p style="margin:0 0 4px;font-size:0.6875rem;font-weight:700;color:var(--phase-accent);text-transform:uppercase;letter-spacing:0.04em">Why this works</p><p style="margin:0;font-size:0.8125rem;color:var(--text);line-height:1.5">' + resp.why + '</p></div>';
            }

            if (resp.showTimer && !cs.followUpShown) {
              html += '<div style="text-align:center;margin-bottom:16px">';
              if (!cs.timerActive) {
                html += '<button type="button" class="btn btn-outline" id="coach-start-timer" style="width:100%">&#9202; Start 10-minute timer</button>';
              } else {
                var mins = Math.floor(cs.timerSeconds / 60);
                var secs = cs.timerSeconds % 60;
                html += '<div class="coach-timer-ring' + (cs.timerSeconds > 0 ? ' active' : '') + '"><span class="coach-timer-text" id="coach-timer-display">' + mins + ':' + (secs < 10 ? '0' : '') + secs + '</span></div>';
                if (cs.timerSeconds <= 0) {
                  html += '<p style="font-size:0.875rem;font-weight:600;color:var(--phase-accent);margin:8px 0 0">Time\u2019s up! How do you feel?</p>';
                }
              }
              html += '</div>';
            }

            if (resp.showMealTimer && !cs.followUpShown) {
              html += '<div style="text-align:center;margin-bottom:16px">';
              if (!cs.mealTimerActive) {
                html += '<button type="button" class="btn btn-outline" id="coach-meal-timer" style="width:100%">&#127793; Start 20-minute meal timer</button>';
              } else {
                var mMins = Math.floor(cs.mealTimerSeconds / 60);
                var mSecs = cs.mealTimerSeconds % 60;
                html += '<div class="coach-timer-ring' + (cs.mealTimerSeconds > 0 ? ' active' : '') + '"><span class="coach-timer-text" id="coach-meal-display">' + mMins + ':' + (mSecs < 10 ? '0' : '') + mSecs + '</span></div>';
                if (cs.mealTimerSeconds <= 0) html += '<p style="font-size:0.875rem;font-weight:600;color:var(--phase-accent);margin:8px 0 0">Time\u2019s up! How did the meal go?</p>';
              }
              html += '</div>';
            }

            if (resp.trackStrategy && !cs.strategyTracked && !cs.followUpShown) {
              html += '<div style="background:#f8fafc;border-radius:12px;padding:14px 16px;margin-bottom:14px">' +
                '<p style="margin:0 0 8px;font-size:0.8125rem;font-weight:700;color:var(--text)">Will you try one of these strategies?</p>' +
                '<div style="display:flex;flex-direction:column;gap:6px">';
              if (resp.actions) {
                resp.actions.slice(0, 3).forEach(function(a, idx) {
                  var shortLabel = a.length > 50 ? a.substring(0, 50) + '\u2026' : a;
                  html += '<button type="button" class="coach-option coach-try-strategy" data-strat="' + idx + '" style="padding:8px 10px;font-size:0.8125rem"><span class="coach-opt-icon">&#9989;</span> <span class="coach-opt-label">' + shortLabel + '</span></button>';
                });
              }
              html += '</div></div>';
            }

            if (!cs.followUpShown) {
              html += '<div style="margin-bottom:16px"><p style="font-size:0.8125rem;font-weight:600;color:var(--text);margin:0 0 8px">What happened?</p>' +
                '<div style="display:flex;flex-direction:column;gap:6px">' +
                '<button type="button" class="coach-option coach-followup-btn" data-followup="paused" style="padding:10px 12px"><span class="coach-opt-icon">&#128154;</span> <span class="coach-opt-label">I paused and the feeling passed</span></button>' +
                '<button type="button" class="coach-option coach-followup-btn" data-followup="ate_intentional" style="padding:10px 12px"><span class="coach-opt-icon">&#127793;</span> <span class="coach-opt-label">I ate something intentionally</span></button>' +
                '<button type="button" class="coach-option coach-followup-btn" data-followup="satisfied" style="padding:10px 12px"><span class="coach-opt-icon">&#127860;</span> <span class="coach-opt-label">I ate and I feel satisfied</span></button>' +
                '<button type="button" class="coach-option coach-followup-btn" data-followup="learn_more" style="padding:10px 12px"><span class="coach-opt-icon">&#128218;</span> <span class="coach-opt-label">I want to learn more about this</span></button>' +
                '</div></div>';
            } else {
              var fuMsg = '';
              if (cs.followUpResult === 'paused') {
                fuMsg = '<div class="coach-bubble" style="background:#f0fdf4;border-left:3px solid #16a34a"><strong style="color:#16a34a">Awareness win.</strong> You recognized the signal, paused, and let it pass on its own. That\u2019s not willpower \u2014 it\u2019s a skill. Every time you do this, you strengthen the neural pathways for hunger literacy. It gets easier with practice.</div>';
              } else if (cs.followUpResult === 'ate_intentional') {
                fuMsg = '<div class="coach-bubble" style="background:#f0fdf4;border-left:3px solid #16a34a"><strong style="color:#16a34a">That\u2019s a great outcome.</strong> You checked in, made a conscious decision, and chose to eat intentionally. That\u2019s the opposite of reactive eating. The skill isn\u2019t about avoiding food \u2014 it\u2019s about making deliberate choices. You did that.</div>';
              } else if (cs.followUpResult === 'satisfied') {
                fuMsg = '<div class="coach-bubble" style="background:#f0fdf4;border-left:3px solid #16a34a"><strong style="color:#16a34a">Perfect landing.</strong> You read your body\u2019s signal, responded to it, and ended up satisfied. That\u2019s the entire skill in one interaction. Note what you ate and how \u2014 this is your reference point for a successful hunger-response cycle.</div>';
              } else if (cs.followUpResult === 'learn_more') {
                fuMsg = '<div class="coach-bubble" style="background:var(--phase-accent-light);border-left:3px solid var(--phase-accent)"><strong style="color:var(--phase-accent)">Curiosity is progress.</strong> Wanting to understand your hunger better is the most valuable instinct you can develop. Check out the mini-lessons below for a deeper dive.</div>' +
                  '<div style="display:flex;flex-direction:column;gap:6px;margin-bottom:12px">';
                HUNGER_LESSONS.forEach(function(lesson) {
                  fuMsg += '<button type="button" class="coach-option coach-endlesson-btn" data-lesson="' + lesson.id + '" style="padding:8px 10px"><span style="font-size:1rem">' + lesson.icon + '</span> <span style="font-size:0.8125rem;font-weight:600">' + lesson.title + '</span></button>';
                });
                fuMsg += '</div>';
              } else {
                fuMsg = '<div class="coach-bubble" style="background:#f0fdf4;border-left:3px solid #16a34a"><strong style="color:#16a34a">Nice work checking in.</strong> Every interaction with this coach builds your hunger awareness, regardless of the outcome. Come back anytime.</div>';
              }
              html += fuMsg;
              html += '<button type="button" class="btn btn-primary" id="coach-done" style="width:100%;margin-bottom:24px">Done</button>';
            }
            html += '</div>';

            div.innerHTML = html;
            div.querySelector('#coach-back').onclick = function() { resetCoachState(); navigateBack(); };

            if (div.querySelector('#coach-start-timer')) {
              div.querySelector('#coach-start-timer').onclick = function() {
                cs.timerActive = true;
                cs.timerSeconds = 600;
                render();
                cs.timerInterval = setInterval(function() {
                  cs.timerSeconds--;
                  var el = document.querySelector('#coach-timer-display');
                  if (el) {
                    var m = Math.floor(cs.timerSeconds / 60);
                    var s = cs.timerSeconds % 60;
                    el.textContent = m + ':' + (s < 10 ? '0' : '') + s;
                  }
                  if (cs.timerSeconds <= 0) {
                    clearInterval(cs.timerInterval);
                    render();
                  }
                }, 1000);
              };
            }

            if (div.querySelector('#coach-meal-timer')) {
              div.querySelector('#coach-meal-timer').onclick = function() {
                cs.mealTimerActive = true;
                cs.mealTimerSeconds = 1200;
                render();
                cs.mealTimerInterval = setInterval(function() {
                  cs.mealTimerSeconds--;
                  var el = document.querySelector('#coach-meal-display');
                  if (el) {
                    var m = Math.floor(cs.mealTimerSeconds / 60);
                    var s = cs.mealTimerSeconds % 60;
                    el.textContent = m + ':' + (s < 10 ? '0' : '') + s;
                  }
                  if (cs.mealTimerSeconds <= 0) {
                    clearInterval(cs.mealTimerInterval);
                    render();
                  }
                }, 1000);
              };
            }

            div.querySelectorAll('.coach-try-strategy').forEach(function(btn) {
              btn.onclick = function() {
                var stratIdx = parseInt(btn.getAttribute('data-strat'));
                var resp2 = cs.currentResponse;
                var stratText = resp2 && resp2.actions && resp2.actions[stratIdx] ? resp2.actions[stratIdx] : '';
                if (stratText) {
                  if (!state.strategyLog) state.strategyLog = [];
                  state.strategyLog.push({ timestamp: new Date().toISOString(), scenario: cs.scenario, strategy: stratText.substring(0, 60), helped: null });
                  if (state.strategyLog.length > 200) state.strategyLog = state.strategyLog.slice(-100);
                  saveState(state);
                }
                cs.strategyTracked = true;
                render();
              };
            });

            div.querySelectorAll('.coach-followup-btn').forEach(function(btn) {
              btn.onclick = function() {
                if (cs.timerInterval) clearInterval(cs.timerInterval);
                if (cs.mealTimerInterval) clearInterval(cs.mealTimerInterval);
                cs.followUpShown = true;
                cs.followUpResult = btn.getAttribute('data-followup');
                cs.path.push('followup_' + cs.followUpResult);
                if (!state.coachSessions) state.coachSessions = [];
                state.coachSessions.push({
                  timestamp: new Date().toISOString(),
                  scenario: cs.scenario,
                  path: cs.path.slice(),
                  followUp: cs.followUpResult
                });
                if (state.coachSessions.length > 100) state.coachSessions = state.coachSessions.slice(-50);
                if (state.strategyLog && state.strategyLog.length > 0) {
                  var lastStrat = state.strategyLog[state.strategyLog.length - 1];
                  if (lastStrat.helped === null) {
                    lastStrat.helped = cs.followUpResult === 'paused' || cs.followUpResult === 'satisfied' || cs.followUpResult === 'ate_intentional';
                  }
                }
                saveState(state);
                render();
              };
            });

            div.querySelectorAll('.coach-endlesson-btn').forEach(function(btn) {
              btn.onclick = function() {
                cs.viewingLesson = btn.getAttribute('data-lesson');
                cs.followUpShown = false;
                cs.scenario = null;
                cs.branch = null;
                cs.step = 0;
                render();
              };
            });

            if (div.querySelector('#coach-done')) {
              div.querySelector('#coach-done').onclick = function() {
                resetCoachState();
                navigateBack();
              };
            }
          }
        }

        container.appendChild(div);
      }

      function renderBodyScanner(container) {
        var div = document.createElement('div');
        div.className = 'screen active';
        var todayKey = getTodayKey();
        var existing = state.bodyScanEntries && state.bodyScanEntries[todayKey];
        var scanStep = existing ? 'results' : 'capture';
        if (scanStep === 'results') {
          div.innerHTML = '<header class="page-header"><button type="button" class="header-btn" id="scan-back">&larr;</button><span class="header-title">Body scan results</span><span style="width:36px"></span></header>' +
            '<div style="padding:0 16px">' +
            '<p style="font-size:0.875rem;color:var(--text-muted);margin:0 0 16px">Scan completed today at ' + new Date(existing.scannedAt).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) + '</p>' +
            '<div class="scan-results-grid">' +
            '<div class="scan-result-card"><div class="scan-result-value">' + existing.bodyFat + '%</div><div class="scan-result-label">Body fat</div></div>' +
            '<div class="scan-result-card"><div class="scan-result-value">' + existing.visceralFat + '%</div><div class="scan-result-label">Visceral fat</div></div>' +
            '<div class="scan-result-card lifestyle"><div class="scan-result-value">+' + existing.lifestyleBonus + ' pts</div><div class="scan-result-label">Added to your Lifestyle Score</div></div>' +
            '</div>' +
            '<div class="card" style="margin-top:12px"><p style="margin:0;font-size:0.875rem;color:var(--text-muted)">Scan weekly for the most accurate trend data. Body composition changes slowly — focus on the trend over 4+ weeks, not any single scan.</p></div>' +
            '</div>';
          div.querySelector('#scan-back').onclick = function() { navigateBack('log', 'log'); };
        } else {
          div.innerHTML = '<header class="page-header"><button type="button" class="header-btn" id="scan-back">&larr;</button><span class="header-title">Body scanner</span><span style="width:36px"></span></header>' +
            '<div style="padding:0 16px">' +
            '<p style="font-size:0.875rem;color:var(--text-muted);margin:0 0 12px">Stand 4–6 feet from your phone. Align your body with the silhouette and hold still for 5 seconds.</p>' +
            '<div class="body-scan-preview" id="scan-preview">' +
            '<div class="body-scan-overlay"><div class="body-scan-silhouette"></div><div class="body-scan-hint" id="scan-status-text">Tap Start to begin</div></div>' +
            '</div>' +
            '<button type="button" class="btn btn-primary" id="scan-start-btn" style="width:100%;margin-bottom:12px">Start scan</button>' +
            '<p style="font-size:0.75rem;color:var(--text-muted);text-align:center;margin:0">Uses your camera to estimate body composition. No images are stored.</p>' +
            '</div>';
          div.querySelector('#scan-back').onclick = function() { navigateBack('log', 'log'); };
          var startBtn = div.querySelector('#scan-start-btn');
          startBtn.onclick = function() {
            startBtn.disabled = true;
            startBtn.textContent = 'Scanning...';
            var statusText = div.querySelector('#scan-status-text');
            if (statusText) statusText.textContent = 'Hold still...';
            var scanPreview = div.querySelector('#scan-preview');
            if (scanPreview) scanPreview.style.background = 'linear-gradient(180deg, #1a1a2e, #16213e)';
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
              navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } }).then(function(stream) {
                var video = document.createElement('video');
                video.srcObject = stream;
                video.autoplay = true;
                video.playsInline = true;
                video.style.cssText = 'width:100%;height:100%;object-fit:cover;';
                scanPreview.insertBefore(video, scanPreview.firstChild);
                setTimeout(function() {
                  stream.getTracks().forEach(function(t) { t.stop(); });
                  finishScan(div);
                }, 5000);
              }).catch(function() {
                setTimeout(function() { finishScan(div); }, 3000);
              });
            } else {
              setTimeout(function() { finishScan(div); }, 3000);
            }
          };
        }
        function finishScan(d) {
          var bodyFat = (22 + Math.random() * 12).toFixed(1);
          var visceralFat = (6 + Math.random() * 8).toFixed(1);
          var lifestyleBonus = Math.round(3 + Math.random() * 4);
          if (!state.bodyScanEntries) state.bodyScanEntries = {};
          state.bodyScanEntries[todayKey] = {
            bodyFat: parseFloat(bodyFat),
            visceralFat: parseFloat(visceralFat),
            lifestyleBonus: lifestyleBonus,
            scannedAt: new Date().toISOString()
          };
          saveState(state);
          currentScreen = 'body_scanner';
          render();
        }
        container.appendChild(div);
      }

      function buildWeightBandGraph(state) {
        var anchor = state.weightAnchor || 165;
        var bandPct = (state.maintenance_band_pct || 5) / 100;
        var upper = Math.round(anchor * (1 + bandPct));
        var lower = Math.round(anchor * (1 - bandPct));
        var weeks = [];
        var dayLabels = [];
        for (var i = 11; i >= 0; i--) {
          var d = new Date();
          d.setDate(d.getDate() - i * 7);
          var key = d.toISOString().slice(0, 10);
          dayLabels.push(d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
          if (state.weightHistory && state.weightHistory[key]) {
            weeks.push(state.weightHistory[key]);
          } else {
            var drift = Math.min(i < 4 ? 0 : (i - 3) * 0.4, bandPct * anchor * 0.8);
            weeks.push(+(anchor + drift + (Math.random() - 0.3) * 2).toFixed(1));
          }
        }
        var allVals = weeks.concat([upper, lower]);
        var minW = Math.min.apply(null, allVals) - 2;
        var maxW = Math.max.apply(null, allVals) + 2;
        var range = maxW - minW || 1;
        var w = 340, h = 160, padL = 40, padR = 10, padT = 10, padB = 24;
        var plotW = w - padL - padR, plotH = h - padT - padB;
        function x(i) { return padL + (i / (weeks.length - 1)) * plotW; }
        function y(v) { return padT + plotH - ((v - minW) / range) * plotH; }
        var bandY1 = y(upper), bandY2 = y(lower);
        var anchorY = y(anchor);
        var svg = '<svg viewBox="0 0 ' + w + ' ' + h + '" style="width:100%;height:auto">';
        svg += '<rect x="' + padL + '" y="' + bandY1 + '" width="' + plotW + '" height="' + (bandY2 - bandY1) + '" fill="#dcfce7" rx="4"/>';
        svg += '<line x1="' + padL + '" y1="' + anchorY + '" x2="' + (w - padR) + '" y2="' + anchorY + '" stroke="#16a34a" stroke-width="1" stroke-dasharray="4 3"/>';
        svg += '<line x1="' + padL + '" y1="' + bandY1 + '" x2="' + (w - padR) + '" y2="' + bandY1 + '" stroke="#bbf7d0" stroke-width="1"/>';
        svg += '<line x1="' + padL + '" y1="' + bandY2 + '" x2="' + (w - padR) + '" y2="' + bandY2 + '" stroke="#bbf7d0" stroke-width="1"/>';
        svg += '<text x="' + (padL - 4) + '" y="' + (anchorY + 3) + '" text-anchor="end" font-size="9" fill="#16a34a">' + anchor + '</text>';
        svg += '<text x="' + (padL - 4) + '" y="' + (bandY1 + 3) + '" text-anchor="end" font-size="8" fill="#94a3b8">+' + (state.maintenance_band_pct || 5) + '%</text>';
        svg += '<text x="' + (padL - 4) + '" y="' + (bandY2 + 3) + '" text-anchor="end" font-size="8" fill="#94a3b8">-' + (state.maintenance_band_pct || 5) + '%</text>';
        var path = '';
        weeks.forEach(function(v, i) {
          path += (i === 0 ? 'M' : 'L') + x(i).toFixed(1) + ',' + y(v).toFixed(1);
        });
        svg += '<path d="' + path + '" fill="none" stroke="var(--accent)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>';
        weeks.forEach(function(v, i) {
          var isAbove = v > upper;
          var dotColor = isAbove ? '#dc2626' : 'var(--accent)';
          svg += '<circle cx="' + x(i).toFixed(1) + '" cy="' + y(v).toFixed(1) + '" r="3.5" fill="' + dotColor + '" stroke="#fff" stroke-width="1.5"/>';
        });
        [0, Math.floor(weeks.length / 2), weeks.length - 1].forEach(function(i) {
          svg += '<text x="' + x(i).toFixed(1) + '" y="' + (h - 2) + '" text-anchor="middle" font-size="8" fill="#94a3b8">' + dayLabels[i] + '</text>';
        });
        svg += '</svg>';
        var currentWeight = weeks[weeks.length - 1];
        var withinBand = currentWeight >= lower && currentWeight <= upper;
        var statusColor = withinBand ? '#16a34a' : '#dc2626';
        var statusText = withinBand ? 'Within maintenance band' : 'Above maintenance band';
        var statusIcon = withinBand ? '\u2713' : '\u26a0';
        var statusAdvice = '';
        if (!withinBand) {
          statusAdvice = '<p style="font-size:0.8125rem;color:var(--text-muted);margin:10px 0 0;line-height:1.4">Your weight is above the expected range. This is a signal to tighten habits \u2014 not a reason to panic. Recommit to protein anchoring, post-meal walks, and structured meals. Gradual correction over 2\u20133 weeks is the goal, not a sudden crash diet.</p>';
        }
        return '<div class="card" style="padding:16px"><h3 style="margin:0 0 4px;font-size:1rem;font-weight:700">Weight After GLP-1</h3>' +
          '<p style="font-size:0.8125rem;color:var(--text-muted);margin:0 0 4px">Some weight regain is biologically expected \u2014 it\u2019s your body recalibrating, not a failure.</p>' +
          '<p style="font-size:0.8125rem;color:var(--text-muted);margin:0 0 12px">A 3\u20135% regain is <strong>maintenance</strong>. What matters is staying within your band and stabilizing \u2014 not hitting a perfect number.</p>' +
          '<div style="overflow:hidden;border-radius:8px;background:#f8fafc;padding:8px">' + svg + '</div>' +
          '<div style="display:flex;align-items:center;gap:8px;margin-top:12px;padding:10px 12px;border-radius:10px;background:' + (withinBand ? '#f0fdf4' : '#fef2f2') + '">' +
          '<span style="font-size:1.125rem">' + statusIcon + '</span>' +
          '<div><div style="font-size:0.875rem;font-weight:600;color:' + statusColor + '">' + statusText + '</div>' +
          '<div style="font-size:0.8125rem;color:var(--text-muted)">Current: ' + currentWeight + ' lbs \u00b7 Anchor: ' + anchor + ' lbs \u00b7 Band: ' + lower + '\u2013' + upper + ' lbs</div></div></div>' +
          statusAdvice + '</div>';
      }

      function buildSensorComparisonSVG() {
        var sensors = [
          { label: 'CGM 1 (Blk 1)', weeks: '1\u20132', color: '#94a3b8', avgGlucose: 118, tir: 72, spikes: 6.2, avgPost: 158, fasting: 96, variability: 24 },
          { label: 'CGM 2 (Blk 3)', weeks: '5\u20136', color: '#2563eb', avgGlucose: 108, tir: 81, spikes: 4.5, avgPost: 142, fasting: 92, variability: 19 },
          { label: 'CGM 3 (Blk 6)', weeks: '11\u201312', color: '#7c3aed', avgGlucose: 102, tir: 87, spikes: 3.1, avgPost: 131, fasting: 89, variability: 15 },
          { label: 'CGM 4 (Blk 8)', weeks: '15\u201316', color: '#16a34a', avgGlucose: 98, tir: 91, spikes: 2.4, avgPost: 124, fasting: 87, variability: 12 }
        ];
        var gw = getGraduationWeek(state);
        var activeSensors = sensors.filter(function(s, i) { return CGM_PERIODS[i].weeks[0] <= gw; });
        if (activeSensors.length === 0) activeSensors = [sensors[0]];

        var svgW = 320, svgH = 140, pL = 32, pR = 10, pT = 16, pB = 30;
        var plotW = svgW - pL - pR, plotH = svgH - pT - pB;
        var hours = ['6a','8a','10a','12p','2p','4p','6p','8p','10p'];
        var baseCurves = [
          [94,134,116,100,144,104,140,112,98],
          [90,124,108,96,136,100,130,106,94],
          [88,118,104,94,128,98,124,102,90],
          [86,112,100,92,122,96,118,98,88]
        ];
        function gx(i) { return pL + (i / (hours.length - 1)) * plotW; }
        function gy(v) { return pT + plotH - ((v - 70) / (110)) * plotH; }

        var svg = '<svg viewBox="0 0 ' + svgW + ' ' + svgH + '" preserveAspectRatio="xMidYMid meet" style="width:100%;height:auto">';
        svg += '<rect x="' + pL + '" y="' + gy(140) + '" width="' + plotW + '" height="' + (gy(70) - gy(140)) + '" fill="#fef9c3" fill-opacity="0.15" rx="2"/>';
        svg += '<line x1="' + pL + '" y1="' + gy(140) + '" x2="' + (svgW - pR) + '" y2="' + gy(140) + '" stroke="#fbbf24" stroke-width="0.5" stroke-dasharray="3,3"/>';
        svg += '<line x1="' + pL + '" y1="' + gy(100) + '" x2="' + (svgW - pR) + '" y2="' + gy(100) + '" stroke="#e2e8f0" stroke-width="0.5" stroke-dasharray="3,3"/>';
        for (var v = 80; v <= 160; v += 40) {
          svg += '<text x="' + (pL - 4) + '" y="' + (gy(v) + 3) + '" font-size="7" fill="#94a3b8" text-anchor="end">' + v + '</text>';
        }
        hours.forEach(function(h, i) {
          svg += '<text x="' + gx(i) + '" y="' + (svgH - 6) + '" font-size="7" fill="#94a3b8" text-anchor="middle">' + h + '</text>';
        });

        activeSensors.forEach(function(s, si) {
          var curve = baseCurves[si];
          var pathD = curve.map(function(g, i) { return (i === 0 ? 'M' : 'L') + ' ' + gx(i).toFixed(1) + ' ' + gy(g).toFixed(1); }).join(' ');
          var opacity = si === activeSensors.length - 1 ? '1' : '0.4';
          var width = si === activeSensors.length - 1 ? '2.5' : '1.5';
          svg += '<path d="' + pathD + '" fill="none" stroke="' + s.color + '" stroke-width="' + width + '" stroke-linecap="round" stroke-linejoin="round" opacity="' + opacity + '"/>';
        });
        svg += '</svg>';

        var legend = '<div style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-top:4px">';
        activeSensors.forEach(function(s) {
          legend += '<div style="display:flex;align-items:center;gap:3px;font-size:0.625rem;color:var(--text-muted)"><div style="width:8px;height:3px;border-radius:2px;background:' + s.color + '"></div>' + s.label + ' (Wk ' + s.weeks + ')</div>';
        });
        legend += '</div>';

        var metricsGrid = '<div style="display:grid;grid-template-columns:repeat(' + activeSensors.length + ', 1fr);gap:4px;margin-top:10px">';
        metricsGrid += '<div></div>'.repeat(0);
        var metricRows = [
          { label: 'Avg Glucose', key: 'avgGlucose', unit: 'mg/dL', lower: true },
          { label: 'Time in Range', key: 'tir', unit: '%', lower: false },
          { label: 'Avg Spikes/Day', key: 'spikes', unit: '', lower: true },
          { label: 'Post-meal Avg', key: 'avgPost', unit: 'mg/dL', lower: true },
          { label: 'Fasting Avg', key: 'fasting', unit: 'mg/dL', lower: true },
          { label: 'Variability', key: 'variability', unit: '%', lower: true }
        ];

        var tableHtml = '<div style="margin-top:12px">';
        tableHtml += '<div style="display:grid;grid-template-columns:auto repeat(' + activeSensors.length + ', 1fr);gap:0;border:1px solid #e2e8f0;border-radius:8px;overflow:hidden;font-size:0.6875rem">';
        tableHtml += '<div style="padding:6px 8px;background:#f8fafc;font-weight:700;border-bottom:1px solid #e2e8f0"></div>';
        activeSensors.forEach(function(s) {
          tableHtml += '<div style="padding:6px 4px;background:#f8fafc;font-weight:700;text-align:center;color:' + s.color + ';border-bottom:1px solid #e2e8f0;border-left:1px solid #e2e8f0">' + s.label + '</div>';
        });
        metricRows.forEach(function(row, ri) {
          var isLast = ri === metricRows.length - 1;
          var bb = isLast ? '' : 'border-bottom:1px solid #e2e8f0;';
          tableHtml += '<div style="padding:5px 8px;' + bb + 'font-weight:600;color:var(--text)">' + row.label + '</div>';
          var vals = activeSensors.map(function(s) { return s[row.key]; });
          var best = row.lower ? Math.min.apply(null, vals) : Math.max.apply(null, vals);
          activeSensors.forEach(function(s, si) {
            var val = s[row.key];
            var isBest = val === best && activeSensors.length > 1;
            var change = si > 0 ? val - activeSensors[si - 1][row.key] : 0;
            var improved = row.lower ? change < 0 : change > 0;
            var changeStr = si > 0 ? (improved ? '&#9650;' : '&#9660;') : '';
            tableHtml += '<div style="padding:5px 4px;text-align:center;' + bb + 'border-left:1px solid #e2e8f0;' + (isBest ? 'background:#f0fdf4;font-weight:700;color:#16a34a' : 'color:var(--text)') + '">' + (typeof val === 'number' && val % 1 !== 0 ? val.toFixed(1) : val) + (row.unit ? '<span style="font-size:0.5rem;color:var(--text-muted)"> ' + row.unit + '</span>' : '') + (changeStr ? ' <span style="font-size:0.5rem;color:' + (improved ? '#16a34a' : '#ef4444') + '">' + changeStr + '</span>' : '') + '</div>';
          });
        });
        tableHtml += '</div></div>';

        return '<div class="card" style="padding:14px 16px"><h3 style="margin:0 0 4px;font-size:1rem;font-weight:700">Sensor-by-Sensor Comparison</h3>' +
          '<p style="font-size:0.75rem;color:var(--text-muted);margin:0 0 8px">Average daily glucose curve for each CGM wear period</p>' +
          svg + legend + tableHtml + '</div>';
      }

      function renderInsights(container) {
        var div = document.createElement('div');
        div.className = 'screen active';
        var glucoseGPA = getGlucoseGPA(state);
        var lifestyleGPA = getLifestyleGPA(state);
        var consistencyScore = getConsistencyScore(state);
        var readiness = computeReadiness(state);
        var hungerAvg = getHungerAvgLast7(state);
        if (hungerAvg == null) hungerAvg = 3.2;
        var seg = insightsSegment;
        div.innerHTML = '<header class="page-header"><span style="width:36px"></span><span class="header-title">Insights</span><span style="width:36px"></span></header>' +
          '<div class="segment-bar"><button type="button" class="segment' + (seg === 'lifestyle' ? ' active' : '') + '" data-seg="lifestyle">Lifestyle</button><button type="button" class="segment' + (seg === 'glucose' ? ' active' : '') + '" data-seg="glucose">Glucose</button><button type="button" class="segment' + (seg === 'graduation' ? ' active' : '') + '" data-seg="graduation">Graduation</button></div>' +

          (seg === 'lifestyle' ? (function() {
            return buildLifestyleGPAHtml(lifestyleGPA) +
              buildTransitionReadinessInsightHtml(readiness, glucoseGPA.score15, lifestyleGPA.score15, consistencyScore, hungerAvg) +
              '<div class="metric-card"><div class="m-title">Hunger &amp; Lifestyle Correlations</div><p style="font-size:0.75rem;color:var(--text-muted);margin:0 0 10px">How your daily habits affect hunger and satiety.</p>' +
              '<div class="hunger-correlate"><span class="correlate-icon">&#128164;</span><div class="correlate-text"><span class="correlate-label">Sleep</span><br>Hunger tends to be <strong>higher</strong> on nights with less than 6 hours of sleep. Poor sleep raises ghrelin and lowers leptin.</div></div>' +
              '<div class="hunger-correlate"><span class="correlate-icon">&#127939;</span><div class="correlate-text"><span class="correlate-label">Activity</span><br>Hunger tends to be <strong>higher</strong> on low-activity days. Regular movement stabilizes appetite hormones.</div></div>' +
              '<div class="hunger-correlate"><span class="correlate-icon">&#128166;</span><div class="correlate-text"><span class="correlate-label">Water</span><br>Hunger tends to be <strong>lower</strong> with consistent hydration. Dehydration mimics hunger signals.</div></div>' +
              '<div class="hunger-correlate"><span class="correlate-icon">&#129504;</span><div class="correlate-text"><span class="correlate-label">Stress</span><br>Hunger tends to be <strong>higher</strong> on high-stress days. Cortisol drives cravings for quick-energy foods.</div></div>' +
              '<div class="hunger-correlate"><span class="correlate-icon">&#128170;</span><div class="correlate-text"><span class="correlate-label">Strength training</span><br>Hunger is <strong>slightly elevated</strong> post-workout, but fullness lasts <strong>longer</strong> on training days.</div></div></div>' +
              '<div class="metric-card insight-card" data-insight-id="drift_alert"><div class="m-title">3-step stabilization</div><p style="font-size:0.9375rem;margin:0">If trend drifts: 1) Protein-first meal 2) 10\u201315 min post-meal walk 3) Structured timing for 3 days.</p><button type="button" class="insight-cta" data-action-id="start_reset">Start 3-day Reset</button></div>';
          })() : '') +

          (seg === 'glucose' ? (function() {
            var gw = getGraduationWeek(state);
            var cgmActive = isCGMWeek(gw);
            var nextBlkCgm = getNextCGMBlock(weekToBlock(gw));
            var cgmNote = !cgmActive ? '<div style="display:flex;align-items:center;gap:6px;padding:8px 12px;background:#fffbeb;border-radius:8px;border:1px solid #fde68a;margin:0 16px 8px"><span style="font-size:0.875rem">&#128201;</span><div style="font-size:0.75rem;color:#92400e;line-height:1.3"><strong>CGM Off</strong> \u2014 Glucose data is from your last sensor period. Next CGM: Block ' + (nextBlkCgm || 'N/A') + '</div></div>' : '';
            return cgmNote +
              buildGlucoseGPAHtml(glucoseGPA) +
              buildSensorComparisonSVG() +
              '<div class="metric-card"><div class="m-title">Hunger &amp; Glucose Correlations</div><p style="font-size:0.75rem;color:var(--text-muted);margin:0 0 10px">How glucose patterns influence your hunger and cravings.</p>' +
              '<div class="hunger-correlate"><span class="correlate-icon">&#128200;</span><div class="correlate-text"><span class="correlate-label">Post-meal spikes</span><br>Hunger tends to <strong>return faster</strong> after large glucose spikes (&gt;40 mg/dL). The crash that follows triggers appetite.</div></div>' +
              '<div class="hunger-correlate"><span class="correlate-icon">&#128201;</span><div class="correlate-text"><span class="correlate-label">Glucose crashes</span><br>Rapid glucose drops below baseline trigger <strong>carb cravings</strong> and a feeling of needing to eat immediately.</div></div>' +
              '<div class="hunger-correlate"><span class="correlate-icon">&#129381;</span><div class="correlate-text"><span class="correlate-label">Fiber pairing</span><br>Meals with fiber show <strong>smaller spikes</strong> and hunger stays <strong>lower</strong> for 2\u20133 hours longer.</div></div>' +
              '<div class="hunger-correlate"><span class="correlate-icon">&#129380;</span><div class="correlate-text"><span class="correlate-label">Protein first</span><br>Eating protein before carbs <strong>reduces post-meal spike by ~30%</strong> and extends satisfaction.</div></div>' +
              '<div class="hunger-correlate"><span class="correlate-icon">&#127860;</span><div class="correlate-text"><span class="correlate-label">Meal timing</span><br>Hunger tends to be <strong>lower</strong> on days with consistent meal spacing (3\u20134 hour gaps).</div></div>' +
              '<div class="hunger-correlate"><span class="correlate-icon">&#128694;</span><div class="correlate-text"><span class="correlate-label">Post-meal walk</span><br>A 10\u201315 min walk after eating <strong>reduces spike by 20\u201330 mg/dL</strong> and keeps hunger more stable.</div></div></div>';
          })() : '') +

          (seg === 'graduation' ? (function() {
            seedWeeklyScoreHistory(state);
            return buildGraduationTrendSVG(state.weeklyScoreHistory) +
              '<div class="card" style="margin-top:4px"><h3 style="margin:0 0 6px;font-size:0.875rem;font-weight:700">Score Summary</h3>' +
              (function() {
                var hist = (state.weeklyScoreHistory || []).slice().sort(function(a, b) { return a.weekNumber - b.weekNumber; });
                if (hist.length === 0) return '<p style="font-size:0.8125rem;color:var(--text-muted);margin:0">No data yet.</p>';
                var latest = hist[hist.length - 1];
                var first = hist[0];
                function delta(curr, prev) { var d = curr - prev; return d >= 0 ? '+' + d.toFixed(1) : d.toFixed(1); }
                return '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px">' +
                  '<div style="text-align:center"><div style="font-size:1.25rem;font-weight:700;color:#2563eb">' + latest.glucose.toFixed(1) + '</div><div style="font-size:0.6875rem;color:var(--text-muted)">Glucose</div><div style="font-size:0.6875rem;color:' + (latest.glucose >= first.glucose ? '#22c55e' : '#ef4444') + '">' + delta(latest.glucose, first.glucose) + '</div></div>' +
                  '<div style="text-align:center"><div style="font-size:1.25rem;font-weight:700;color:#ec4899">' + latest.lifestyle.toFixed(1) + '</div><div style="font-size:0.6875rem;color:var(--text-muted)">Lifestyle</div><div style="font-size:0.6875rem;color:' + (latest.lifestyle >= first.lifestyle ? '#22c55e' : '#ef4444') + '">' + delta(latest.lifestyle, first.lifestyle) + '</div></div>' +
                  '<div style="text-align:center"><div style="font-size:1.25rem;font-weight:700;color:#7c3aed">' + latest.transition.toFixed(1) + '</div><div style="font-size:0.6875rem;color:var(--text-muted)">Readiness</div><div style="font-size:0.6875rem;color:' + (latest.transition >= first.transition ? '#22c55e' : '#ef4444') + '">' + delta(latest.transition, first.transition) + '</div></div></div>';
              })() + '</div>' +
              '<div class="metric-card"><div class="m-title">Hunger &amp; Program Progress</div><p style="font-size:0.75rem;color:var(--text-muted);margin:0 0 10px">How your hunger patterns are changing across the program.</p>' +
              '<div class="hunger-correlate"><span class="correlate-icon">&#127860;</span><div class="correlate-text"><span class="correlate-label">Yogurt &amp; berries</span><br>Hunger tends to be <strong>lower</strong> on days when yogurt and berries are logged.</div></div>' +
              '<div class="hunger-correlate"><span class="correlate-icon">&#129380;</span><div class="correlate-text"><span class="correlate-label">Diet coke</span><br>Hunger tends to be <strong>lower</strong> when diet coke is logged.</div></div>' +
              '<div class="hunger-correlate"><span class="correlate-icon">&#128200;</span><div class="correlate-text"><span class="correlate-label">Satiety skill</span><br>Your ability to identify true hunger vs. cravings has <strong>improved 40%</strong> since week 1.</div></div>' +
              '<div class="hunger-correlate"><span class="correlate-icon">&#129368;</span><div class="correlate-text"><span class="correlate-label">Hunger sweet spot</span><br>You spend <strong>more days in the 2\u20134 hunger range</strong> now vs. early weeks. This means your system is calibrating.</div></div>' +
              '<div class="hunger-correlate"><span class="correlate-icon">&#128170;</span><div class="correlate-text"><span class="correlate-label">Consistency</span><br>Weeks with <strong>5+ hunger check-ins</strong> show 15% better readiness scores than weeks with fewer.</div></div></div>';
          })() : '');

        div.querySelectorAll('.segment').forEach(function(btn) {
          btn.onclick = function() { insightsSegment = btn.getAttribute('data-seg'); render(); };
        });
        div.querySelectorAll('.insight-card').forEach(function(card) {
          var id = card.getAttribute('data-insight-id');
          analytics('glp1_insight_viewed', { insight_id: id });
          var cta = card.querySelector('.insight-cta');
          if (cta) cta.onclick = function() {
            analytics('glp1_insight_action_clicked', { action_id: cta.getAttribute('data-action-id') });
            navigateTo('program');
          };
        });
        div.querySelectorAll('.gpa-section-card[data-gpa-type]').forEach(function(card) {
          card.onclick = function(e) {
            if (e.target.closest('.edit-factors') || e.target.closest('.insight-cta')) return;
            showGPAModal(card.getAttribute('data-gpa-type'));
          };
        });
        container.appendChild(div);
      }

      function renderSettings(container) {
        var t = PROGRAM_TABLE;
        var gw = getGraduationWeek(state);
        var div = document.createElement('div');
        div.className = 'screen active';
        div.innerHTML = '<header class="page-header"><button type="button" class="header-btn" id="settings-back">&larr;</button><span class="header-title">Settings</span><span style="width:36px"></span></header>' +
          '<div class="card" style="cursor:pointer" id="go-program"><h2 style="margin:0 0 4px;font-size:1rem;font-weight:700">GLP-1 Graduation Program</h2><p style="font-size:0.875rem;color:var(--text-muted);margin:0">Week ' + gw + ' of 16 \u2014 dose history, readiness, metrics</p></div>' +
          '<div class="card"><h2 style="margin:0 0 8px;font-size:1rem;font-weight:700">Program Details</h2>' +
          '<h4>Primary goal</h4><p><strong>' + t.goal + '</strong></p>' +
          '<h4>Do</h4><p>' + t.do + '</p>' +
          '<h4>Don\'t</h4><p>' + t.dont + '</p>' +
          '<h4>CGM role</h4><p>' + t.cgm + '</p>' +
          '<h4>Focus</h4><p>' + t.optimize + '</p></div>' +
          '<div class="card"><h2 style="margin:0 0 8px;font-size:1rem;font-weight:700">Maintenance band</h2><p style="font-size:0.8125rem;color:var(--text-muted);margin:0 0 8px">Weight within \u00b1<span id="band-pct">' + (state.maintenance_band_pct || 5) + '</span>% of goal.</p><input type="number" id="maintenance-band" min="1" max="20" value="' + (state.maintenance_band_pct || 5) + '" style="width:80px;padding:8px" /></div>' +
          (state.profile && state.profile.name ? '<div class="card"><h2 style="margin:0 0 8px;font-size:1rem;font-weight:700">Your profile</h2>' +
            '<div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:0.8125rem">' +
            '<div style="background:#f8fafc;border-radius:8px;padding:8px 10px"><span style="color:var(--text-muted);display:block;font-size:0.6875rem">Name</span><strong>' + (state.profile.name || '\u2014') + '</strong></div>' +
            '<div style="background:#f8fafc;border-radius:8px;padding:8px 10px"><span style="color:var(--text-muted);display:block;font-size:0.6875rem">Age</span><strong>' + (state.profile.age || '\u2014') + '</strong></div>' +
            '<div style="background:#f8fafc;border-radius:8px;padding:8px 10px"><span style="color:var(--text-muted);display:block;font-size:0.6875rem">Medication</span><strong>' + (state.profile.medication || '\u2014') + '</strong></div>' +
            '<div style="background:#f8fafc;border-radius:8px;padding:8px 10px"><span style="color:var(--text-muted);display:block;font-size:0.6875rem">Status</span><strong>' + (state.profile.medStatus || '\u2014') + '</strong></div>' +
            '<div style="background:#f8fafc;border-radius:8px;padding:8px 10px"><span style="color:var(--text-muted);display:block;font-size:0.6875rem">Weight</span><strong>' + (state.profile.weight ? state.profile.weight + ' lbs' : '\u2014') + '</strong></div>' +
            '<div style="background:#f8fafc;border-radius:8px;padding:8px 10px"><span style="color:var(--text-muted);display:block;font-size:0.6875rem">Activity</span><strong>' + (state.profile.activityLevel || '\u2014') + '</strong></div>' +
            '<div style="background:#f8fafc;border-radius:8px;padding:8px 10px;grid-column:span 2"><span style="color:var(--text-muted);display:block;font-size:0.6875rem">Strength training</span><strong>' + ({never:'Never tried',tried:'Tried but inconsistent',beginner:'Just getting started',light:'1\u20132x/week',regular:'3+x/week',lost:'Needs guidance'}[state.profile.strengthTraining] || '\u2014') + '</strong></div>' +
            '</div></div>' : '') +
          '<div class="card" style="border:2px solid #ef4444"><h2 style="margin:0 0 8px;font-size:1rem;font-weight:700;color:#ef4444">Reset program</h2><p style="font-size:0.8125rem;color:var(--text-muted);margin:0 0 12px">This will erase all your progress and return you to the onboarding screen. This action cannot be undone.</p><button type="button" class="btn" id="reset-program" style="background:#ef4444;color:#fff;border:none;width:100%">Reset &amp; restart</button></div>';
        div.querySelector('#settings-back').onclick = function() { navigateBack('home', 'home'); };
        div.querySelector('#go-program').onclick = function() { navigateTo('program'); };
        var bandInput = div.querySelector('#maintenance-band');
        if (bandInput) {
          bandInput.onchange = function() { var v = parseInt(bandInput.value, 10) || 5; state.maintenance_band_pct = v; state.maintenanceBandPct = v; saveState(state); div.querySelector('#band-pct').textContent = v; };
        }
        div.querySelector('#reset-program').onclick = function() {
          var overlay = document.createElement('div');
          overlay.className = 'modal-overlay';
          overlay.innerHTML = '<div class="modal"><h3 style="margin:0 0 8px">Reset everything?</h3><p style="font-size:0.875rem;color:var(--text-muted);margin:0 0 16px">All data, progress, check-ins, and education completion will be permanently erased. You\u2019ll go through onboarding again.</p><div class="modal-actions"><button type="button" class="btn btn-outline" id="reset-cancel">Cancel</button><button type="button" class="btn" id="reset-confirm" style="background:#ef4444;color:#fff;border:none">Reset</button></div></div>';
          overlay.querySelector('#reset-cancel').onclick = function() { overlay.remove(); };
          overlay.querySelector('#reset-confirm').onclick = function() {
            localStorage.removeItem('signos-glp1');
            state = migrateToProgramState({ onboardingComplete: false });
            onboardStep = 0; onboardAnswers = {}; onboardProfile = {};
            navHistory = [];
            currentScreen = 'onboarding'; currentNav = 'home';
            overlay.remove();
            render();
          };
          container.appendChild(overlay);
        };
        container.appendChild(div);
      }

      function renderProgram(container) {
        var metrics = getProgramMetrics(state);
        var readiness = computeReadiness(state);
        var readiness15 = score100To15(readiness);
        var readinessBarPct = Math.round(((readiness15 - 1) / 4) * 100);
        var gw = getGraduationWeek(state);
        var div = document.createElement('div');
        div.className = 'screen active';
        div.innerHTML = '<header class="page-header"><button type="button" class="header-btn" id="program-back">&larr;</button><span class="header-title">GLP-1 Graduation</span><span style="width:36px"></span></header>' +
          '<div class="card"><h2 style="margin:0 0 8px;font-size:1rem;font-weight:700">GLP-1 Graduation \u2014 Week ' + gw + ' of 16</h2><div class="toolkit-edu-goal" style="margin-bottom:12px"><div class="goal-label">Primary goal</div><p class="goal-text">' + PROGRAM_PRIMARY_GOAL + '</p></div></div>' +
          '<div class="card"><h2 style="margin:0 0 8px;font-size:1rem;font-weight:700">Dose history</h2><p style="font-size:0.8125rem;color:var(--text-muted);margin:0 0 10px">Log when you decrease dose, switch formulation, or stop.</p><div id="dose-events-list"></div><button type="button" class="btn btn-outline" id="log-dose-change" style="margin-top:8px"><span class="plus-circle">+</span> Log a dose change</button></div>' +
          '<div class="card"><h2 style="margin:0 0 8px;font-size:1rem;font-weight:700">Program metrics</h2><div class="program-metric"><span class="label">Habit score (14d)</span><span class="value">' + metrics.habit_score + '/100</span></div><div class="program-metric"><span class="label">Glucose stability</span><span class="value">' + metrics.glucose_stability_score + '/100</span></div><div class="program-metric"><span class="label">Maintenance score</span><span class="value">' + metrics.maintenance_score + '/100</span></div></div>' +
          '<div class="card"><button type="button" class="btn btn-outline" id="weekly-checkin" style="width:100%">Complete weekly check-in</button></div>' +
          '<div class="card"><h2 style="margin:0 0 8px;font-size:1rem;font-weight:700">Graduation readiness</h2><p style="font-size:0.875rem;margin:0">Your data suggests routines are ' + (readiness >= 70 ? 'consistent' : 'improving') + '.</p><div class="readiness-bar" style="margin-top:10px"><span class="fill" style="width:' + readinessBarPct + '%"></span></div><p style="font-size:0.75rem;color:var(--text-muted);margin:6px 0 0">' + readiness15 + ' / 5</p></div>' +
          '<div class="card sub-section"><h2 style="margin:0 0 8px;font-size:1rem;font-weight:700">Recommended education</h2><p style="font-size:0.8125rem;color:var(--text-muted);margin:0 0 10px">Modules across the graduation program.</p><div id="program-modules"></div></div>';
        var eventsList = div.querySelector('#dose-events-list');
        var evs = getDoseEvents(state);
        evs.slice().reverse().forEach(function(ev) {
          var label = ev.type === 'DECREASED_DOSE' ? 'Decreased dose' : ev.type === 'SWITCHED_FORMULATION' ? 'Switched formulation' : 'Stopped';
          var d = (ev.occurredAt || ev.date) ? new Date(ev.occurredAt || ev.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : '';
          var el = document.createElement('div'); el.className = 'dose-event'; el.innerHTML = '<span class="type">' + label + '</span><span class="date">' + d + '</span>' + (ev.notes ? '<br><span style="font-size:0.8125rem;color:var(--text-muted)">' + ev.notes + '</span>' : ''); eventsList.appendChild(el);
        });
        div.querySelector('#program-back').onclick = function() { navigateBack('settings', 'settings'); };
        div.querySelector('#log-dose-change').onclick = function() { showDoseLogModal(container); };
        div.querySelector('#weekly-checkin').onclick = function() {
          analytics('weekly_checkin_completed', {});
          var overlay = document.createElement('div');
          overlay.className = 'modal-overlay';
          overlay.innerHTML = '<div class="modal"><h3>Check-in recorded</h3><p>Thanks. We\'ll use this to keep your readiness and focus up to date.</p><div class="modal-actions"><button type="button" class="btn btn-primary" id="checkin-ok">OK</button></div></div>';
          overlay.querySelector('#checkin-ok').onclick = function() { overlay.remove(); };
          container.appendChild(overlay);
        };
        var lastEv = evs.length ? evs[evs.length - 1] : null;
        var mods = getRecommendedModules(state);
        mods.slice(0, 6).forEach(function(m) {
          var row = document.createElement('button');
          row.type = 'button';
          row.className = 'program-metric';
          row.setAttribute('data-module-id', m.module_id);
          row.style.cssText = 'width:100%;text-align:left;border:none;background:none;cursor:pointer;padding:10px 0;border-bottom:1px solid #f1f5f9';
          row.innerHTML = '<span class="label">' + m.title + '</span><span class="value" style="font-size:0.8125rem;color:var(--text-muted)">' + m.estimated_time + ' min</span>';
          row.onclick = function() {
            analytics('glp1_education_started', { module_id: m.module_id });
            var overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            var modBody = getModuleBody(m.module_id);
            overlay.innerHTML = '<div class="modal"><h3>' + m.title + '</h3><p style="white-space:pre-wrap">' + (modBody || '') + '</p><div class="modal-actions"><button type="button" class="btn btn-primary" id="mod-done">Done</button></div></div>';
            overlay.querySelector('#mod-done').onclick = function() {
              analytics('glp1_education_completed', { module_id: m.module_id });
              overlay.remove();
            };
            container.appendChild(overlay);
          };
          div.querySelector('#program-modules').appendChild(row);
        });
        container.appendChild(div);
        if (openModuleId) {
          var m = mods.filter(function(x) { return x.module_id === openModuleId; })[0] || EDUCATION_MODULES.filter(function(x) { return x.module_id === openModuleId; })[0];
          if (m) {
            analytics('glp1_education_started', { module_id: m.module_id });
            var overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            var modBody2 = getModuleBody(m.module_id);
            overlay.innerHTML = '<div class="modal"><h3>' + m.title + '</h3><p style="white-space:pre-wrap">' + (modBody2 || '') + '</p><div class="modal-actions"><button type="button" class="btn btn-primary" id="mod-done">Done</button></div></div>';
            overlay.querySelector('#mod-done').onclick = function() { analytics('glp1_education_completed', { module_id: m.module_id }); overlay.remove(); };
            container.appendChild(overlay);
          }
          openModuleId = null;
        }
      }

      function showDoseLogModal(container) {
        var overlay = document.createElement('div');
        overlay.className = 'modal-overlay';
        var today = new Date().toISOString().slice(0, 10);
        overlay.innerHTML = '<div class="modal"><h3>Log dose change</h3><p style="margin:0 0 12px;font-size:0.875rem">Type</p><select id="dose-type" style="width:100%;padding:10px;margin-bottom:12px;border-radius:8px;border:1px solid #e2e8f0">' +
          '<option value="DECREASED_DOSE">Decreased dose</option><option value="SWITCHED_FORMULATION">Switched formulation</option><option value="STOPPED">Stopped</option></select>' +
          '<p style="margin:0 0 12px;font-size:0.875rem">Date</p><input type="date" id="dose-date" value="' + today + '" style="width:100%;padding:10px;margin-bottom:12px;border-radius:8px;border:1px solid #e2e8f0" />' +
          '<p style="margin:0 0 12px;font-size:0.875rem">Notes (optional)</p><input type="text" id="dose-notes" placeholder="e.g. Half dose" style="width:100%;padding:10px;margin-bottom:16px;border-radius:8px;border:1px solid #e2e8f0" />' +
          '<div class="modal-actions"><button type="button" class="btn btn-outline" id="dose-cancel">Cancel</button><button type="button" class="btn btn-primary" id="dose-save">Save</button></div></div>';
        overlay.querySelector('#dose-cancel').onclick = function() { overlay.remove(); };
        overlay.querySelector('#dose-save').onclick = function() {
          var type = overlay.querySelector('#dose-type').value;
          var date = overlay.querySelector('#dose-date').value;
          var notes = overlay.querySelector('#dose-notes').value.trim() || undefined;
          var occurredAt = date ? date + 'T12:00:00.000Z' : new Date().toISOString();
          if (!state.dose_change_events) state.dose_change_events = [];
          if (!state.doseEvents) state.doseEvents = [];
          state.dose_change_events.push({ type: type, date: date, notes: notes });
          state.doseEvents.push({ type: type, occurredAt: occurredAt, notes: notes });
          analytics('glp1_dose_event_logged', { type: type });
          if (state.weightAnchor == null) state.weightAnchor = 180;
          saveState(state);
          overlay.remove();
          render();
        };
        container.appendChild(overlay);
      }

      function renderWeeklyCheckin(container) {
        var overlay = document.createElement('div');
        overlay.className = 'weekly-checkin-overlay';
        var eduProg = getPhaseEducationProgress(state);
        var pct = eduProg.total > 0 ? Math.round((eduProg.done / eduProg.total) * 100) : 0;
        overlay.innerHTML = '<div class="weekly-checkin-modal">' +
          '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px"><h3 style="margin:0;font-size:1.125rem;font-weight:700">Weekly check-in</h3><button type="button" id="weekly-close" style="background:none;border:none;font-size:1.5rem;color:var(--text-muted);cursor:pointer;padding:0;line-height:1">&times;</button></div>' +
          '<p class="weekly-q-label">How are you feeling this week?</p>' +
          '<div class="weekly-emoji-row">' +
            '<button type="button" class="weekly-emoji-btn" data-mood="1">&#128542;<span>Rough</span></button>' +
            '<button type="button" class="weekly-emoji-btn" data-mood="2">&#128533;<span>Meh</span></button>' +
            '<button type="button" class="weekly-emoji-btn" data-mood="3">&#128528;<span>OK</span></button>' +
            '<button type="button" class="weekly-emoji-btn" data-mood="4">&#128578;<span>Good</span></button>' +
            '<button type="button" class="weekly-emoji-btn" data-mood="5">&#128513;<span>Great</span></button>' +
          '</div>' +
          '<p class="weekly-q-label">Confidence in your transition</p><p class="weekly-q-sub">How confident do you feel about managing without (or with less) medication?</p>' +
          '<div class="weekly-emoji-row">' +
            '<button type="button" class="weekly-emoji-btn" data-conf="1">1<span>Low</span></button>' +
            '<button type="button" class="weekly-emoji-btn" data-conf="2">2<span></span></button>' +
            '<button type="button" class="weekly-emoji-btn" data-conf="3">3<span>Mid</span></button>' +
            '<button type="button" class="weekly-emoji-btn" data-conf="4">4<span></span></button>' +
            '<button type="button" class="weekly-emoji-btn" data-conf="5">5<span>High</span></button>' +
          '</div>' +
          '<p class="weekly-q-label">Biggest challenge this week?</p>' +
          '<textarea class="weekly-textarea" id="weekly-challenge" placeholder="e.g. Appetite returning, cravings, energy levels..."></textarea>' +
          '<div style="background:#f8fafc;border-radius:12px;padding:12px 14px;margin-bottom:18px">' +
            '<p style="margin:0 0 4px;font-size:0.8125rem;font-weight:600;color:var(--accent)">Education progress</p>' +
            '<p style="margin:0;font-size:0.8125rem;color:var(--text-muted)">' + eduProg.done + ' of ' + eduProg.total + ' modules completed (' + pct + '%)</p>' +
            '<div class="edu-progress-bar" style="margin-top:6px"><div class="edu-progress-fill" style="width:' + pct + '%"></div></div>' +
          '</div>' +
          '<button type="button" class="btn btn-primary" id="weekly-submit" style="width:100%" disabled>Submit check-in</button>' +
        '</div>';
        var selectedMood = null;
        var selectedConf = null;
        overlay.querySelectorAll('.weekly-emoji-btn[data-mood]').forEach(function(btn) {
          btn.onclick = function() {
            selectedMood = parseInt(btn.getAttribute('data-mood'));
            overlay.querySelectorAll('.weekly-emoji-btn[data-mood]').forEach(function(b) { b.classList.remove('selected'); });
            btn.classList.add('selected');
            if (selectedMood && selectedConf) overlay.querySelector('#weekly-submit').disabled = false;
          };
        });
        overlay.querySelectorAll('.weekly-emoji-btn[data-conf]').forEach(function(btn) {
          btn.onclick = function() {
            selectedConf = parseInt(btn.getAttribute('data-conf'));
            overlay.querySelectorAll('.weekly-emoji-btn[data-conf]').forEach(function(b) { b.classList.remove('selected'); });
            btn.classList.add('selected');
            if (selectedMood && selectedConf) overlay.querySelector('#weekly-submit').disabled = false;
          };
        });
        overlay.querySelector('#weekly-close').onclick = function() {
          showWeeklyCheckin = false; weeklyCheckinDismissedThisSession = true; overlay.remove();
        };
        overlay.querySelector('#weekly-submit').onclick = function() {
          var wk = getWeekKey();
          if (!state.weeklyCheckIns) state.weeklyCheckIns = {};
          state.weeklyCheckIns[wk] = {
            mood: selectedMood,
            confidence: selectedConf,
            challenge: (overlay.querySelector('#weekly-challenge').value || '').trim(),
            week: getGraduationWeek(state),
            eduProgress: { done: eduProg.done, total: eduProg.total },
            submittedAt: new Date().toISOString()
          };
          saveState(state);
          showWeeklyCheckin = false;
          overlay.remove();
          render();
        };
        container.appendChild(overlay);
      }

      function renderStoppedModal(container) {
        var overlay = document.createElement('div');
        overlay.className = 'modal-overlay';
        overlay.innerHTML = '<div class="modal"><h3>Dose change logged</h3><p>Your dose change has been recorded. Continue focusing on your weekly goals and building habits. ' + COPY.safety_clinician + '</p><div class="modal-actions"><button type="button" class="btn btn-primary" id="stopped-ok">OK</button></div></div>';
        overlay.querySelector('#stopped-ok').onclick = function() { showStoppedModal = false; overlay.remove(); render(); };
        container.appendChild(overlay);
      }

      seedWeeklyScoreHistory(state);
      recordCurrentWeekScore(state);

      window.__protoflow = {
        navigate: function(screen) { currentScreen = screen; render(); },
        setWeek: function(w) { openWeekNumber = w; },
        setCGM: function(val) { cgmOverride = val; },
        setInsightsTab: function(seg) { insightsSegment = seg; },
        setOnboardStep: function(s) { onboardStep = s; },
        setCheckin: function(w) { checkinWeek = w; post8Step = 0; post8Answers = {}; },
        setCheckinStep: function(s) { post8Step = s; },
        setEducationModule: function(id) { openEducationModuleId = id; },
        setEducationGame: function(type, title) {
          openEducationGameType = type;
          openEducationGameTitle = title || type;
          eduGameIndex = 0; eduGameAnswered = false;
        },
        resetCoach: function() { coachState = { scenario: null, branch: null, step: 0, path: [], haltSelected: null, scanStep: -1, followUpShown: false, timerActive: false, timerSeconds: 0, timerInterval: null, viewingLesson: null, mealTimerActive: false, mealTimerSeconds: 0, mealTimerInterval: null, strategyTracked: false }; },
        setCoachScenario: function(sc) { coachState.scenario = sc; coachState.branch = null; coachState.step = 0; coachState.path = []; },
        render: function() { render(); },
        getState: function() { return state; }
      };

      render();
    })();
    } catch (e) {
      var stack = (e && e.stack) ? e.stack : (e && e.message ? e.message : String(e));
      console.error('APP_INIT_CRASH', stack);
      document.body.style.background = '#c00';
      document.body.style.color = '#fff';
      document.body.style.padding = '20px';
      document.body.style.fontFamily = 'system-ui';
      document.body.innerHTML = '<h1>JS Error</h1><pre>' + stack + '</pre>';
    }
  </script>
</body>
</html>
